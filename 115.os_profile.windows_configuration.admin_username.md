# Task #115: os_profile.windows_configuration.admin_username

## Summary
Implemented `admin_username` field within `windows_configuration` block. This Required, ForceNew field specifies the administrator username for Windows VMs and is placed at the parent `osProfile` level in the Azure API (not inside `windowsConfiguration`), following the exact provider implementation pattern.

## Shadow Implementation

### variables.tf
```hcl
windows_configuration = optional(object({
  admin_password           = string # TODO: delete later - migrated to independent ephemeral variable (Task #114)
  admin_username           = string # ForceNew field, validation applied # <-
  computer_name_prefix     = optional(string)
  enable_automatic_updates = optional(bool, true)
```

### variables.tf - Validation Blocks
```hcl
validation {
  condition = ( # <-
    var.orchestrated_virtual_machine_scale_set_os_profile == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration == null ||
    length(var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.admin_username) >= 1 &&
    length(var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.admin_username) <= 20
  )
  error_message = "The admin_username must be between 1 and 20 characters in length."
}

validation {
  condition = ( # <-
    var.orchestrated_virtual_machine_scale_set_os_profile == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration == null ||
    !endswith(var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.admin_username, ".")
  )
  error_message = "The admin_username cannot end with a '.'."
}

validation {
  condition = ( # <-
    var.orchestrated_virtual_machine_scale_set_os_profile == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration == null ||
    !contains([
      " ", "administrator", "admin", "user", "user1", "test", "user2", "test1", "user3", "admin1", "1", "123", "a",
      "actuser", "adm", "admin2", "aspnet", "backup", "console", "david", "guest", "john", "owner", "root", "server",
      "sql", "support", "support_388945a0", "sys", "test2", "test3", "user4", "user5"
    ], lower(var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.admin_username))
  )
  error_message = "The admin_username cannot be one of the disallowed values: administrator, admin, user, user1, test, user2, test1, user3, admin1, 1, 123, a, actuser, adm, admin2, aspnet, backup, console, david, guest, john, owner, root, server, sql, support, support_388945a0, sys, test2, test3, user4, user5."
}
```

### migrate_main.tf - replace_triggers_external_values
```hcl
replace_triggers_external_values = {
  # ... other triggers ...
  windows_configuration_admin_username = { value = var.orchestrated_virtual_machine_scale_set_os_profile != null && var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.admin_username : "" } # <-
}
```

### migrate_main.tf - body (osProfile level)
```hcl
osProfile = merge(
  # ... other osProfile fields ...
  var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? { # <-
    adminUsername = var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.admin_username # <-
  } : {} # <-
)
```

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern Identified:** Single-phase creation with `CreateOrUpdateThenPoll`

**Go Code Evidence:**
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... initialization ...
    
    osProfileRaw := d.Get("os_profile").([]interface{})

    if len(osProfileRaw) > 0 && osProfileRaw[0] != nil {
        osProfile := osProfileRaw[0].(map[string]interface{})
        winConfigRaw = osProfile["windows_configuration"].([]interface{})
        
        // ... processing ...
        
        if len(winConfigRaw) > 0 && winConfigRaw[0] != nil {
            osType = virtualmachinescalesets.OperatingSystemTypesWindows
            winConfig := winConfigRaw[0].(map[string]interface{})
            vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(winConfig, customData)
            // ... validation logic ...
        }
        
        virtualMachineProfile.OsProfile = vmssOsProfile
    }
    
    // ... other profile setup ...
    
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, ...); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Field Classification:** Create phase - field is set before `CreateOrUpdateThenPoll` call

**Decision:** Implemented in `local.body` (NOT in `local.post_creation_updates`)

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.osProfile.adminUsername`

**Go Code Evidence:**
```go
// From expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration:
func expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(input map[string]interface{}, customData string) *virtualmachinescalesets.VirtualMachineScaleSetOSProfile {
    osProfile := virtualmachinescalesets.VirtualMachineScaleSetOSProfile{}
    winConfig := virtualmachinescalesets.WindowsConfiguration{}

    if len(input) > 0 {
        osProfile.CustomData = pointer.To(customData)
        osProfile.AdminUsername = pointer.To(input["admin_username"].(string))  // <-- Set at osProfile level
        osProfile.AdminPassword = pointer.To(input["admin_password"].(string))
        // ... other osProfile fields ...
        
        winConfig.EnableAutomaticUpdates = pointer.To(input["enable_automatic_updates"].(bool))
        // ... other windowsConfiguration fields ...
    }

    osProfile.WindowsConfiguration = &winConfig  // <-- winConfig nested inside osProfile

    return &osProfile
}

// In Create method:
virtualMachineProfile.OsProfile = vmssOsProfile  // Assignment: virtualMachineProfile.OsProfile
props.Properties.VirtualMachineProfile = &virtualMachineProfile  // Assignment: props.Properties.VirtualMachineProfile
```

**Verified Path:** `properties.virtualMachineProfile.osProfile.adminUsername`

**Path Comparison:** ✅ Match - Predicted path matches actual implementation

**Key Observation:** Unlike `windowsConfiguration` fields which go inside the nested `windowsConfiguration` object, `adminUsername` is placed directly at the `osProfile` level, paralleling the Linux configuration pattern where `adminUsername` is also at `osProfile` level.

## Provider Schema

**Source:** `OrchestratedVirtualMachineScaleSetWindowsConfigurationSchema()`

```go
"admin_username": {
    Type:         pluginsdk.TypeString,
    Required:     true,
    ForceNew:     true,
    ValidateFunc: validateAdminUsernameWindows,
},
```

**Validation Function:**
```go
func validateAdminUsernameWindows(input interface{}, key string) (warnings []string, errors []error) {
    v, ok := input.(string)
    if !ok {
        errors = append(errors, fmt.Errorf("expected %q to be a string", key))
        return
    }

    // **Disallowed values:**
    invalidUserNames := []string{
        " ", "administrator", "admin", "user", "user1", "test", "user2", "test1", "user3", "admin1", "1", "123", "a",
        "actuser", "adm", "admin2", "aspnet", "backup", "console", "david", "guest", "john", "owner", "root", "server",
        "sql", "support", "support_388945a0", "sys", "test2", "test3", "user4", "user5",
    }

    for _, str := range invalidUserNames {
        if strings.EqualFold(v, str) {
            errors = append(errors, fmt.Errorf("%q can not be one of %v, got %q", key, invalidUserNames, v))
            return warnings, errors
        }
    }

    // Cannot end in "."
    if strings.HasSuffix(input.(string), ".") {
        errors = append(errors, fmt.Errorf("%q can not end with a '.', got %q", key, v))
        return warnings, errors
    }

    if len(v) < 1 || len(v) > 20 {
        errors = append(errors, fmt.Errorf("%q must be between 1 and 20 characters in length, got %q(%d characters)", key, v, len(v)))
        return warnings, errors
    }

    return
}
```

## Azure API Schema

**Query:** `query_azapi_resource_document` for `body.properties.virtualMachineProfile.osProfile.adminUsername`

**Response:**
```
"Specifies the name of the administrator account. <br><br> **Windows-only restriction:** Cannot end in \".\" <br><br> **Disallowed values:** \"administrator\", \"admin\", \"user\", \"user1\", \"test\", \"user2\", \"test1\", \"user3\", \"admin1\", \"1\", \"123\", \"a\", \"actuser\", \"adm\", \"admin2\", \"aspnet\", \"backup\", \"console\", \"david\", \"guest\", \"john\", \"owner\", \"root\", \"server\", \"sql\", \"support\", \"support_388945a0\", \"sys\", \"test2\", \"test3\", \"user4\", \"user5\". <br><br> **Minimum-length (Linux):** 1  character <br><br> **Max-length (Linux):** 64 characters <br><br> **Max-length (Windows):** 20 characters"
```

**Property Path in Azure API:** `properties.virtualMachineProfile.osProfile.adminUsername`

## Hidden Fields
None - this is a standard user-visible field.

## Mapping
- **Terraform:** `os_profile.windows_configuration.admin_username`
- **Azure API:** `properties.virtualMachineProfile.osProfile.adminUsername`
- **Naming Convention:** snake_case → camelCase

## Special Handling

### 1. ForceNew Behavior
- **Schema:** `ForceNew: true`
- **Implementation:** Added to `replace_triggers_external_values` with stable key wrapping
- **Trigger Logic:** Direct value tracking - any change to username triggers replacement
```hcl
windows_configuration_admin_username = { value = var.orchestrated_virtual_machine_scale_set_os_profile != null && var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.admin_username : "" }
```

### 2. Validation Rules
Implemented three validation blocks in `variables.tf`:

**Validation 1 - Length Constraint:**
- **Condition:** Must be between 1 and 20 characters
- **Error Message:** "The admin_username must be between 1 and 20 characters in length."

**Validation 2 - Ending Constraint:**
- **Condition:** Cannot end with "."
- **Error Message:** "The admin_username cannot end with a '.'."

**Validation 3 - Disallowed Values:**
- **Condition:** Cannot be one of 35 disallowed values (case-insensitive)
- **Error Message:** Lists all disallowed values
- **Implementation Note:** Uses `lower()` for case-insensitive comparison, matching provider's `strings.EqualFold` behavior

### 3. Placement Strategy
**Critical Implementation Detail:** Unlike other `windowsConfiguration` fields, `adminUsername` is NOT placed inside the `windowsConfiguration` object. Instead, it's placed at the parent `osProfile` level.

**Rationale:** This follows the exact provider implementation where:
- Linux: `osProfile.AdminUsername` set at osProfile level, `LinuxConfiguration` nested separately
- Windows: `osProfile.AdminUsername` set at osProfile level, `WindowsConfiguration` nested separately

This symmetry ensures the Azure API receives the correct structure for both OS types.

## Deferred Work Completion
No work was deferred to this task from other tasks (checked `following.md`).

## Critical Review & Edge Case Analysis

### Null Semantics
- **Meaning:** Field is Required when `windows_configuration` block is present
- **Validation:** Terraform's type system enforces non-null when parent block exists
- **Implementation:** Safe to access directly when windows_configuration != null

### Boundary Conditions
1. **Minimum Length (1 character):** Validated at plan time
2. **Maximum Length (20 characters):** Validated at plan time
3. **Empty String:** Prevented by length validation (min 1)
4. **Trailing Period:** Explicitly validated and rejected

### Disallowed Values
- **Case Sensitivity:** Provider uses case-insensitive comparison (`strings.EqualFold`)
- **Implementation:** Used `lower()` function to match provider behavior exactly
- **Coverage:** All 35 disallowed values from provider validation function

### Idempotency
- **ForceNew Tracking:** Value tracked in `replace_triggers_external_values`
- **State Detection:** Changes trigger replacement as expected
- **Consistency:** Same value results in no changes

### Safe References
- **Null Check:** Always check `os_profile != null && windows_configuration != null` before accessing
- **Replace Triggers:** Uses safe navigation with null coalescing to empty string
- **Body Assignment:** Conditional merge prevents adding field when windows_configuration is absent

### Edge Cases
1. **Mixed Case Disallowed Values:** Handled via `lower()` comparison
2. **Whitespace-Only Username:** Caught by disallowed values list (includes " ")
3. **Unicode Characters:** Allowed (provider doesn't restrict to ASCII)
4. **Special Characters:** Allowed except trailing "."

## Checklist
- ✅ Property in correct local (`body.properties.virtualMachineProfile.osProfile`)
- ✅ ForceNew wrapped in `replace_triggers_external_values` with stable key
- ✅ All logic EXACTLY replicated from provider (validation, placement)
- ✅ Validations IMPLEMENTED in variables.tf (3 validation blocks)
- ✅ No TODO comment needed (not a sensitive field migration)
- ✅ Hidden fields checked (none)
- ✅ No work deferred to other tasks
- ✅ Checked following.md for deferred work TO this task (none found)
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis documented
- ✅ Proof created
- ✅ Ready to update track.md to "Pending for check"
- ✅ Self-Review: Only implemented admin_username field (Task #115) - no other fields added
