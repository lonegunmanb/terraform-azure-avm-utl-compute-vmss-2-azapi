# Task #140 - priority_mix.regular_percentage_above_base

## Shadow Implementation

**variables.tf:**
```hcl
variable "orchestrated_virtual_machine_scale_set_priority_mix" {
  type = object({
    base_regular_count            = optional(number, 0)
    regular_percentage_above_base = optional(number)  # <-
  })
  default     = null
  description = <<-EOT
 - `base_regular_count` - (Optional) Specifies the base number of VMs of `Regular` priority that will be created before any VMs of priority `Spot` are created. Possible values are integers between `0` and `1000`. Defaults to `0`.
 - `regular_percentage_above_base` - (Optional) Specifies the desired percentage of VM instances that are of `Regular` priority after the base count has been reached. Possible values are integers between `0` and `100`. Defaults to `0`.  # <-
EOT

  validation {
    condition     = var.orchestrated_virtual_machine_scale_set_priority_mix == null || var.orchestrated_virtual_machine_scale_set_priority == "Spot"
    error_message = "priority_mix can only be specified when priority is set to 'Spot'."
  }

  validation {
    condition = (
      var.orchestrated_virtual_machine_scale_set_priority_mix == null ||
      var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count == null ||
      (var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count >= 0 && var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count <= 1000)
    )
    error_message = "base_regular_count must be between 0 and 1000."
  }

  validation {  # <-
    condition = (  # <-
      var.orchestrated_virtual_machine_scale_set_priority_mix == null ||  # <-
      var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base == null ||  # <-
      (var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base >= 0 && var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base <= 100)  # <-
    )  # <-
    error_message = "regular_percentage_above_base must be between 0 and 100."  # <-
  }  # <-
}
```

**migrate_main.tf (locals.body):**
```hcl
        var.orchestrated_virtual_machine_scale_set_priority_mix != null ? {
          priorityMixPolicy = {
            baseRegularPriorityCount = var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count
            regularPriorityPercentageAboveBase = coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base, 0)  # <-
          }
        } : {},
```

**migrate_main.tf (locals.replace_triggers_external_values):**
```hcl
    priority_mix_base_regular_count = { value = var.orchestrated_virtual_machine_scale_set_priority_mix != null ? var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count : 0 }
    priority_mix_regular_percentage_above_base = { value = var.orchestrated_virtual_machine_scale_set_priority_mix != null ? coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base, 0) : 0 }  # <-
```

## Summary

Implemented `regular_percentage_above_base` field within the existing `priority_mix` block. The field is Optional with Default value 0, validated to be between 0 and 100, and maps to `regularPriorityPercentageAboveBase` in the Azure API's `priorityMixPolicy` object.

## Create Phase Verification

**Query:** Create method (`resourceOrchestratedVirtualMachineScaleSetCreate`)

**Pattern:** Single-phase pattern - field is assigned before the `CreateOrUpdateThenPoll` call.

**Field Classification:** Create phase (assigned to props before create call)

**Go Code Evidence:**
```go
if v, ok := d.GetOk("priority_mix"); ok {
    if *virtualMachineProfile.Priority != virtualmachinescalesets.VirtualMachinePriorityTypesSpot {
        return fmt.Errorf("`priority_mix` can only be specified when `priority` is set to `%s`", string(virtualmachinescalesets.VirtualMachinePriorityTypesSpot))
    }
    props.Properties.PriorityMixPolicy = ExpandOrchestratedVirtualMachineScaleSetPriorityMixPolicy(v.([]interface{}))
}

props.Properties.VirtualMachineProfile = &virtualMachineProfile

log.Printf("[DEBUG] Creating Orchestrated %s.", id)
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Decision:** Field goes into `local.body` (Create phase).

## Assignment Path Verification

**Predicted Path:** `properties.priorityMixPolicy.regularPriorityPercentageAboveBase`

**Expand Function Evidence:**
```go
func ExpandOrchestratedVirtualMachineScaleSetPriorityMixPolicy(input []interface{}) *virtualmachinescalesets.PriorityMixPolicy {
    if len(input) == 0 {
        return nil
    }

    raw := input[0].(map[string]interface{})

    return &virtualmachinescalesets.PriorityMixPolicy{
        BaseRegularPriorityCount:           pointer.To(int64(raw["base_regular_count"].(int))),
        RegularPriorityPercentageAboveBase: pointer.To(int64(raw["regular_percentage_above_base"].(int))),
    }
}
```

**Assignment in Create:**
```go
props.Properties.PriorityMixPolicy = ExpandOrchestratedVirtualMachineScaleSetPriorityMixPolicy(v.([]interface{}))
```

**Assignment Chain:**
1. Expand returns `*PriorityMixPolicy` with `RegularPriorityPercentageAboveBase` field
2. Assigned to `props.Properties.PriorityMixPolicy`
3. Full path: `props.Properties.PriorityMixPolicy.RegularPriorityPercentageAboveBase`

**Verified Path:** `properties.priorityMixPolicy.regularPriorityPercentageAboveBase` ✅ (matches predicted)

## Provider Schema

**From:** `OrchestratedVirtualMachineScaleSetPriorityMixPolicySchema()`
```go
func OrchestratedVirtualMachineScaleSetPriorityMixPolicySchema() *pluginsdk.Schema {
    return &pluginsdk.Schema{
        Type:     pluginsdk.TypeList,
        Optional: true,
        MaxItems: 1,
        Elem: &pluginsdk.Resource{
            Schema: map[string]*pluginsdk.Schema{
                "base_regular_count": {
                    Type:         pluginsdk.TypeInt,
                    Optional:     true,
                    ValidateFunc: validation.IntBetween(0, 1000),
                    Default:      0,
                },
                "regular_percentage_above_base": {
                    Type:         pluginsdk.TypeInt,
                    Optional:     true,
                    ValidateFunc: validation.IntBetween(0, 100),
                    Default:      0,
                },
            },
        },
    }
}
```

**Key Properties:**
- **Type:** TypeInt
- **Optional:** true
- **Default:** 0
- **ValidateFunc:** `validation.IntBetween(0, 100)`
- **ForceNew:** Not set (inherited from parent block behavior)

## Azure API Schema

**Query Path:** `body.properties.priorityMixPolicy.regularPriorityPercentageAboveBase`

**Response:**
```json
{
  "regularPriorityPercentageAboveBase": "The percentage of VM instances, after the base regular priority count has been reached, that are expected to use regular priority."
}
```

**Type:** Integer (0-100)

## Hidden Fields

No hidden fields detected within `regular_percentage_above_base`.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| regular_percentage_above_base | regularPriorityPercentageAboveBase |

## Special Handling

### 1. Validation

**Implemented in variables.tf:**
```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_priority_mix == null ||
    var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base == null ||
    (var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base >= 0 && var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base <= 100)
  )
  error_message = "regular_percentage_above_base must be between 0 and 100."
}
```

This replicates the provider's `validation.IntBetween(0, 100)` validation.

### 2. Default Value Handling

The provider schema has `Default: 0`. Since the field is `optional(number)` without explicit default in the object type definition, we use `coalesce()` to apply the default:

```hcl
regularPriorityPercentageAboveBase = coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base, 0)
```

This ensures that when `regular_percentage_above_base` is `null`, it gets the default value of `0`.

### 3. ForceNew Handling

The `priority_mix` block is not handled in the Update method. The provider doesn't explicitly mark it as ForceNew in the schema, but since it's not updated, any change to priority_mix fields would require recreation via the standard Terraform change detection.

**Implementation:** Added to `replace_triggers_external_values` with wrapped value to ensure changes trigger replacement:

```hcl
priority_mix_regular_percentage_above_base = { value = var.orchestrated_virtual_machine_scale_set_priority_mix != null ? coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base, 0) : 0 }
```

The key remains stable (always present), and the value changes when the field changes, triggering replacement.

### 4. Parent Block Constraint

The parent validation (already implemented by Task #138) ensures:
```hcl
validation {
  condition     = var.orchestrated_virtual_machine_scale_set_priority_mix == null || var.orchestrated_virtual_machine_scale_set_priority == "Spot"
  error_message = "priority_mix can only be specified when priority is set to 'Spot'."
}
```

This constraint is inherited from the parent block and doesn't need to be re-implemented for this field.

## Deferred Work Completion

**Check following.md:** No work deferred to Task #140.

## Critical Review & Edge Cases

### Null Semantics
- **When null:** Provider applies default value of `0`
- **Implementation:** Uses `coalesce(var.field, 0)` to replicate provider behavior
- **Idempotent:** ✅ `null` → `0` in both provider and shadow module

### Boundary Conditions
- **Minimum (0):** Valid - indicates 0% regular priority VMs above base
- **Maximum (100):** Valid - indicates 100% regular priority VMs above base
- **Out of Range:** Caught by validation in variables.tf

### Edge Case Analysis

**Case 1: Field is null**
```hcl
priority_mix = {
  base_regular_count = 5
  # regular_percentage_above_base not set (null)
}
```
**Behavior:** `coalesce(null, 0)` → `0` (matches provider default)

**Case 2: Field is 0**
```hcl
priority_mix = {
  base_regular_count = 5
  regular_percentage_above_base = 0
}
```
**Behavior:** Value `0` used directly (explicit zero)

**Case 3: Parent block is null**
```hcl
priority_mix = null
```
**Behavior:** Entire `priorityMixPolicy` object not created; field access doesn't occur

**Case 4: Invalid value**
```hcl
priority_mix = {
  regular_percentage_above_base = 150
}
```
**Behavior:** Validation fails with clear error message (matches provider)

### Safe References
✅ All references check parent block existence before accessing field:
```hcl
var.orchestrated_virtual_machine_scale_set_priority_mix != null ? coalesce(...) : 0
```

### Idempotency
✅ Order-independent (single integer value)
✅ Default handling consistent between provider and shadow module
✅ Replace trigger uses stable key with value comparison

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ ForceNew wrapped in `replace_triggers_external_values`: `{ value = ... }`
- ✅ ALL logic EXACTLY replicated from provider (default value via coalesce, validation IntBetween)
- ✅ Validations IMPLEMENTED in variables.tf (IntBetween 0-100)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md: Not applicable (no work deferred by this task)
- ✅ Deferred work from following.md: None deferred to this task
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis section included
- ✅ Proof created
- ✅ Self-Review: Only implemented `regular_percentage_above_base` field (Task #140); did not add fields from other tasks

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #140 - priority_mix.regular_percentage_above_base

### Issues Identified

#### Issue 1: Method Priority Violation - Default Value Implementation

**Problem:**
Executor used the FALLBACK method (`coalesce()` in locals) instead of the PREFERRED method (`optional(number, 0)` in object type) for implementing the default value.

**Executor's Implementation:**
```hcl
# variables.tf
regular_percentage_above_base = optional(number)  # No default

# migrate_main.tf
regularPriorityPercentageAboveBase = coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base, 0)
```

**Why This Violates executor.md:**
From executor.md lines 138-141:
> **Defaults:** If schema has `Default`, replicate it:
> - **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
> - **Fallback:** Apply default in locals if optional() syntax not possible

The field is in an object type (`priority_mix` object), and `optional(number, 0)` syntax IS possible in Terraform >= 1.3. The fallback method is ONLY allowed when the preferred method is **technically impossible**.

From checker.md lines 120-142:
> **Method Priority:**
> ```
> PREFER: optional(string, "default") in object type
>    ↓
> Fallback: coalesce() in locals (ONLY if optional() impossible)
> ```
> **Common Violation:**
> ```hcl
> # ❌ WRONG
> type = list(object({ field = optional(string) }))
> # In locals: coalesce(obj.field, "default")
> 
> # ✅ CORRECT
> type = list(object({ field = optional(string, "default") }))
> # In locals: obj.field  # Guaranteed non-null
> ```

**Provider's Actual Behavior:**
```go
"regular_percentage_above_base": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    ValidateFunc: validation.IntBetween(0, 100),
    Default:      0,
}
```

The provider schema has `Default: 0`, which must be replicated using the PREFERRED method.

**Expected Behavior:**
- When `regular_percentage_above_base` is explicitly set: Use that value
- When `regular_percentage_above_base` is `null`: Provider applies default `0`
- Implementation should use `optional(number, 0)` to guarantee the field is never null

**Root Cause:**
Executor chose the easier fallback method (`coalesce()` in locals) instead of using the preferred method (`optional(number, 0)` in type definition), violating the strict method priority hierarchy defined in executor.md.

### Corrections Made

#### Fix 1: Use PREFERRED Method for Default Value

**Changed Files:**
- `variables.tf`: Changed `regular_percentage_above_base = optional(number)` to `optional(number, 0)`
- `migrate_main.tf`: Changed `coalesce(var...regular_percentage_above_base, 0)` to direct field access `var...regular_percentage_above_base`
- `migrate_main.tf`: Updated replace trigger to use direct field value instead of wrapping `coalesce()`

**New Implementation:**

**variables.tf:**
```hcl
variable "orchestrated_virtual_machine_scale_set_priority_mix" {
  type = object({
    base_regular_count            = optional(number, 0)
    regular_percentage_above_base = optional(number, 0)  # ✅ Default in type
  })
  # ... rest of variable definition
}
```

**migrate_main.tf (locals.body):**
```hcl
var.orchestrated_virtual_machine_scale_set_priority_mix != null ? {
  priorityMixPolicy = {
    baseRegularPriorityCount = var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count
    regularPriorityPercentageAboveBase = var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base  # ✅ Direct use
  }
} : {},
```

**migrate_main.tf (locals.replace_triggers_external_values):**
```hcl
priority_mix_regular_percentage_above_base = { value = var.orchestrated_virtual_machine_scale_set_priority_mix != null ? var.orchestrated_virtual_machine_scale_set_priority_mix.regular_percentage_above_base : 0 }  # ✅ Direct field value
```

**Why This is EXACT:**
1. **Type-level default:** Using `optional(number, 0)` ensures the field is NEVER null after the object is constructed, matching provider's schema-level `Default: 0` behavior
2. **Simplified locals:** Direct field access `var.field` because `optional(number, 0)` guarantees non-null value
3. **Correct trigger:** Replace trigger tracks the actual field value (guaranteed non-null by type default), ensuring any change from default triggers replacement
4. **Method priority compliance:** Uses PREFERRED method as required by executor.md, not fallback method

**Verification:**
- Scenario 1: `priority_mix = null` → entire `priorityMixPolicy` omitted ✅
- Scenario 2: `priority_mix = {}` → `regular_percentage_above_base` defaults to 0 via `optional(number, 0)`, outputs `regularPriorityPercentageAboveBase = 0` ✅
- Scenario 3: `priority_mix = {regular_percentage_above_base = 50}` → uses 50, outputs `regularPriorityPercentageAboveBase = 50` ✅
- Scenario 4: `priority_mix = {regular_percentage_above_base = 0}` → uses 0 (explicit zero), outputs `regularPriorityPercentageAboveBase = 0` ✅
- Edge Case: `priority_mix = {regular_percentage_above_base = null}` → defaults to 0 due to `optional(number, 0)` ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The default value is implemented using the PREFERRED method (`optional(number, 0)` in object type) rather than the fallback method, following the strict method priority hierarchy.

**Status:** CORRECTED AND APPROVED ✅

---
