# Task #71: network_interface.ip_configuration.application_gateway_backend_address_pool_ids

## Shadow Implementation

```hcl
locals {
  body = {
    properties = {
      virtualMachineProfile = {
        networkProfile = {
          networkInterfaceConfigurations = [
            for nic in var.orchestrated_virtual_machine_scale_set_network_interface : {
              properties = {
                ipConfigurations = [
                  for ip_config in nic.ip_configuration : {
                    properties = merge(
                      ip_config.application_gateway_backend_address_pool_ids != null && length(ip_config.application_gateway_backend_address_pool_ids) > 0 ? { # <-
                        applicationGatewayBackendAddressPools = [ # <-
                          for id in ip_config.application_gateway_backend_address_pool_ids : { # <-
                            id = id # <-
                          } # <-
                        ] # <-
                      } : {}, # <-
                      {
                        # other fields...
                      }
                    )
                  }
                ]
              }
            }
          ]
        }
      }
    }
  }
}
```

## Summary

Implemented `application_gateway_backend_address_pool_ids` field which transforms a set of Application Gateway Backend Address Pool ID strings into an array of objects with `id` property as required by Azure API.

## Create Phase Verification

### Query Create Method

From `resourceOrchestratedVirtualMachineScaleSetCreate`:

```go
if v, ok := d.GetOk("network_interface"); ok {
    networkInterfaces, err := ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(v.([]interface{}))
    if err != nil {
        return fmt.Errorf("expanding `network_interface`: %w", err)
    }

    networkProfile.NetworkInterfaceConfigurations = networkInterfaces
    virtualMachineProfile.NetworkProfile = networkProfile
}

// ...

props.Properties.VirtualMachineProfile = &virtualMachineProfile

log.Printf("[DEBUG] Creating Orchestrated %s.", id)
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

### Pattern Identification

**Single-phase Create pattern** - The `network_interface` is expanded via `ExpandOrchestratedVirtualMachineScaleSetNetworkInterface`, which internally processes IP configurations, and the result is assigned to the properties before the `CreateOrUpdateThenPoll` call.

### Decision

Field belongs in **Create phase** → Added to `local.body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.applicationGatewayBackendAddressPools`

## Assignment Path Verification

### Predicted Path

```
body
└── properties
    └── virtualMachineProfile
        └── networkProfile
            └── networkInterfaceConfigurations[]
                └── properties
                    └── ipConfigurations[]
                        └── properties
                            └── applicationGatewayBackendAddressPools[]
                                └── id
```

### Provider Code Evidence

From the expand function chain in task #69 documentation:

**Step 1:** Extract and convert IDs in `expandOrchestratedVirtualMachineScaleSetIPConfiguration`:

```go
func expandOrchestratedVirtualMachineScaleSetIPConfiguration(raw map[string]interface{}) (*virtualmachinescalesets.VirtualMachineScaleSetIPConfiguration, error) {
	applicationGatewayBackendAddressPoolIdsRaw := raw["application_gateway_backend_address_pool_ids"].(*pluginsdk.Set).List()
	applicationGatewayBackendAddressPoolIds := expandIDsToSubResources(applicationGatewayBackendAddressPoolIdsRaw)
	
	// ...
	
	ipConfiguration := virtualmachinescalesets.VirtualMachineScaleSetIPConfiguration{
		Name: raw["name"].(string),
		Properties: &virtualmachinescalesets.VirtualMachineScaleSetIPConfigurationProperties{
			ApplicationGatewayBackendAddressPools: applicationGatewayBackendAddressPoolIds,
			// ...
		},
	}
	
	return &ipConfiguration, nil
}
```

The `expandIDsToSubResources` helper function converts a list of ID strings to SubResource objects with `id` property.

**Step 2:** IP configurations array assignment in `ExpandOrchestratedVirtualMachineScaleSetNetworkInterface`:

```go
config := virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration{
	Name: raw["name"].(string),
	Properties: &virtualmachinescalesets.VirtualMachineScaleSetNetworkConfigurationProperties{
		IPConfigurations: ipConfigurations,  // Contains applicationGatewayBackendAddressPools
		// ...
	},
}
```

**Step 3:** Assignment to virtual machine profile:

```go
networkProfile.NetworkInterfaceConfigurations = networkInterfaces
virtualMachineProfile.NetworkProfile = networkProfile
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

### Verified Path

```
body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.applicationGatewayBackendAddressPools[].id
```

### Path Comparison

✅ **MATCH** - Predicted path matches the verified assignment path exactly.

## Provider Schema

From `orchestratedVirtualMachineScaleSetIPConfigurationSchema()`:

```go
"application_gateway_backend_address_pool_ids": {
	Type:     pluginsdk.TypeSet,
	Optional: true,
	Elem:     &pluginsdk.Schema{Type: pluginsdk.TypeString},
	Set:      pluginsdk.HashString,
},
```

**Type:** `TypeSet` (Set of strings)  
**Required:** No (Optional)  
**Computed:** No  
**ForceNew:** No  
**ValidateFunc:** None  
**DiffSuppressFunc:** None  

## Azure API Schema

Queried path: `body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations.properties.ipConfigurations.properties.applicationGatewayBackendAddressPools`

```
List(ObjectWithOptionalAttrs(map[string]Type{"id":String}, []string{"id"}))
```

**Azure API Type:** Array of objects with `id` property  
**Required:** No (Optional)  
**Description:** Specifies an array of references to backend address pools of application gateways. A scale set can reference backend address pools of multiple application gateways.

## Hidden Fields

**NO HIDDEN FIELDS** - The expand function only processes the user-provided `application_gateway_backend_address_pool_ids` set and converts it to the required Azure API format (array of objects with `id` property). No hardcoded values or additional computed fields are added.

## Mapping

**Terraform Field:** `application_gateway_backend_address_pool_ids` (snake_case, set of strings)  
**Azure API Field:** `applicationGatewayBackendAddressPools` (camelCase, array of objects with `id` property)

**Transformation:**
- Input: `set(string)` - Set of Application Gateway Backend Address Pool IDs
- Output: `[{id: string}]` - Array of objects, each containing an `id` property
- Logic: Iterate over the set and wrap each ID string in an object with `id` key

## Special Handling

### 1. No Validation

**Provider has NO validation** for this field. The schema shows:
- No `ValidateFunc`
- No `MaxItems` constraint
- No format validation for the ID strings

**Implementation:** No validation blocks added to `variables.tf`. The field accepts any set of strings. Azure API will validate the resource IDs at runtime.

### 2. No ForceNew Behavior

**Schema shows `ForceNew: false`** (implicit, as ForceNew is not set). The resource function has no CustomizeDiff logic for this field.

**Implementation:** This field is NOT added to `replace_triggers_external_values`. Updates to this field can be applied without replacement.

### 3. Optional Field with Empty Set Handling

**Provider behavior:**
- When field is `null` or not set: Field is omitted from API request
- When field is an empty set `[]`: Field is omitted from API request (Go converts empty slice to nil)
- When field has values: Array is sent to API

**Implementation:**
```hcl
ip_config.application_gateway_backend_address_pool_ids != null && length(ip_config.application_gateway_backend_address_pool_ids) > 0 ? {
  applicationGatewayBackendAddressPools = [
    for id in ip_config.application_gateway_backend_address_pool_ids : {
      id = id
    }
  ]
} : {}
```

This ensures the field is only added when there are actual IDs to process, matching the provider's behavior.

### 4. No Sensitive Data

This field contains resource IDs (references), not sensitive data. It remains in `local.body`, not `local.sensitive_body`.

## Deferred Work Completion

Checked `following.md` - **File does not exist**. No deferred work to complete for this task.

## Critical Review & Edge Case

### Edge Case Analysis

**1. Null Semantics**
- `null` → Field omitted from merge result → Not sent to Azure API ✅
- Provider behavior: When not set, field is omitted ✅
- **Match:** Implementation correctly handles null by using conditional merge

**2. Empty Collection**
- Empty set `[]` → Condition `length(...) > 0` evaluates to false → Field omitted ✅
- Provider behavior: Empty slice is omitted (converted to nil in Go) ✅
- **Match:** Implementation correctly handles empty sets by checking length

**3. Boundary Conditions**
- Single ID: Works correctly, creates array with one object ✅
- Multiple IDs: Works correctly, creates array with multiple objects ✅
- Very long ID strings: No length validation in provider or implementation ✅

**4. Idempotency**
- Set type in Terraform ensures no duplicates in input ✅
- For loop over set maintains idempotency ✅
- Order doesn't matter for sets (Azure API treats as unordered collection) ✅

**5. Safe References**
- Check for `!= null` before accessing field ✅
- Check `length() > 0` before iterating ✅
- No risk of accessing undefined properties ✅

**6. Type Safety**
- Input: `set(string)` - enforced by variable type ✅
- Output: `[{id: string}]` - matches Azure API schema ✅
- No type coercion issues ✅

### Special Considerations

**Merge Pattern:**
The implementation uses a merge with an empty object fallback:
```hcl
merge(
  condition ? { field = value } : {},  # Conditional field
  { /* other fields */ }                 # Always-present fields
)
```

This pattern ensures:
- Key stability in the properties object (properties key always exists)
- Field is only added when condition is met
- No conflicts with other fields in the same properties object

## Checklist

- ✅ Property in correct local (`body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties`)
- ✅ ForceNew: Not required (field is not ForceNew)
- ✅ All logic EXACTLY replicated from provider (ID set → object array transformation)
- ✅ Validations: None required (provider has no validations)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work: None (no following.md file)
- ✅ Critical review completed (null handling, empty sets, idempotency, safe references)
- ✅ Edge Case Analysis completed
- ✅ Proof created
- ✅ Track.md ready to update
- ✅ Self-Review: Implementation adds ONLY Task #71 field, no content from other tasks

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #71 - network_interface.ip_configuration.application_gateway_backend_address_pool_ids

### Validation Results

✅ **ForceNew Logic:** Not a ForceNew field (schema shows no ForceNew, no CustomizeDiff logic)
✅ **Stable Keys:** Not applicable (not in replace_triggers_external_values)
✅ **Phase Detection:** Field correctly placed in local.body (Create phase)
✅ **Type Conversion:** Correct conversion from set(string) to [{id: string}] array format
✅ **Null Handling:** Correctly uses conditional `!= null && length() > 0` check before creating field
✅ **Validations:** None required (provider has no ValidateFunc)
✅ **Merge Pattern:** Correct use of conditional merge with empty object fallback
✅ **Deferred Work Completion:** No following.md file exists - no deferred work for this task
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null, empty set, single/multiple IDs, idempotency)
✅ **Exact Replication:** Implementation exactly matches provider's expandIDsToSubResources behavior

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field transformation from `set(string)` to array of objects with `id` property matches the provider's `expandIDsToSubResources` function precisely. Conditional logic correctly handles null and empty sets. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
