# Task #91 - os_disk.disk_size_gb

## Shadow Implementation

**variables.tf:**
```hcl
variable "orchestrated_virtual_machine_scale_set_os_disk" {
  type = object({
    caching                   = string
    disk_encryption_set_id    = optional(string)
    disk_size_gb              = optional(number)  # <-
    storage_account_type      = string
    write_accelerator_enabled = optional(bool)
    diff_disk_settings = optional(object({
      option    = string
      placement = optional(string)
    }))
  })
  default     = null
  description = <<-EOT
 - `caching` - (Required) The Type of Caching which should be used for the Internal OS Disk. Possible values are `None`, `ReadOnly` and `ReadWrite`.
 - `disk_encryption_set_id` - (Optional) The ID of the Disk Encryption Set which should be used to encrypt this OS Disk. Changing this forces a new resource to be created.
 - `disk_size_gb` - (Optional) The Size of the Internal OS Disk in GB, if you wish to vary from the size used in the image this Virtual Machine Scale Set is sourced from.
 - `storage_account_type` - (Required) The Type of Storage Account which should back this the Internal OS Disk. Possible values include `Standard_LRS`, `StandardSSD_LRS`, `StandardSSD_ZRS`, `Premium_LRS` and `Premium_ZRS`. Changing this forces a new resource to be created.
 - `write_accelerator_enabled` - (Optional) Specifies if Write Accelerator is enabled on the OS Disk. Defaults to `false`.

 `diff_disk_settings` block supports the following:
 - `option` - (Required) Specifies the Ephemeral Disk Settings for the OS Disk. At this time the only possible value is `Local`. Changing this forces a new resource to be created.
 - `placement` - (Optional) Specifies where to store the Ephemeral Disk. Possible values are `CacheDisk` and `ResourceDisk`. Defaults to `CacheDisk`. Changing this forces a new resource to be created.
EOT

  validation {  # <-
    condition = (  # <-
      var.orchestrated_virtual_machine_scale_set_os_disk == null ||  # <-
      var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb == null ||  # <-
      (var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb >= 0 && var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb <= 4095)  # <-
    )  # <-
    error_message = "The disk_size_gb must be between 0 and 4095."  # <-
  }  # <-
}
```

**migrate_main.tf:**
```hcl
locals {
  body = {
    properties = merge(
      var.orchestrated_virtual_machine_scale_set_sku_name != null ? {
        virtualMachineProfile = merge(
          var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
            storageProfile = merge(
              {
                osDisk = {
                  caching = var.orchestrated_virtual_machine_scale_set_os_disk.caching
                  osType  = null
                  managedDisk = merge(
                    {
                      storageAccountType = var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type
                    },
                    var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id != null && var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id != "" ? {
                      diskEncryptionSet = {
                        id = var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id
                      }
                    } : {}
                  )
                  diskSizeGB = var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb != null && var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb > 0 ? var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb : null  # <-
                }
              }
            )
          } : {}
        )
      } : {}
    )
  }
}
```

## Summary

Implemented `os_disk.disk_size_gb` as an optional computed field that maps to Azure API's `diskSizeGB` property. The field is only set when value is greater than 0, matching provider's expand logic.

## Create Phase Verification

**Query:** `query_terraform_block_implementation_source_code(block_type="resource", terraform_type="azurerm_orchestrated_virtual_machine_scale_set", entrypoint_name="create")`

**Pattern Identified:** Single-phase creation with `CreateOrUpdateThenPoll`

**Go Code Evidence:**
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... setup code ...
    
    if v, ok := d.GetOk("os_disk"); ok {
        virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)
    }
    
    // ... more profile setup ...
    
    if !isLegacy {
        props.Properties.VirtualMachineProfile = &virtualMachineProfile
    }
    
    log.Printf("[DEBUG] Creating Orchestrated %s.", id)
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Classification:** Create phase - field is set in `virtualMachineProfile.StorageProfile.OsDisk` before `CreateOrUpdateThenPoll` call.

**Decision:** Field belongs in `local.body`, not `local.post_creation_updates`.

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.storageProfile.osDisk.diskSizeGB`

**Go Code Evidence from ExpandOrchestratedVirtualMachineScaleSetOSDisk:**
```go
func ExpandOrchestratedVirtualMachineScaleSetOSDisk(input []interface{}, osType virtualmachinescalesets.OperatingSystemTypes) *virtualmachinescalesets.VirtualMachineScaleSetOSDisk {
    raw := input[0].(map[string]interface{})
    disk := virtualmachinescalesets.VirtualMachineScaleSetOSDisk{
        Caching: pointer.To(virtualmachinescalesets.CachingTypes(raw["caching"].(string))),
        ManagedDisk: &virtualmachinescalesets.VirtualMachineScaleSetManagedDiskParameters{
            StorageAccountType: pointer.To(virtualmachinescalesets.StorageAccountTypes(raw["storage_account_type"].(string))),
        },
        WriteAcceleratorEnabled: pointer.To(raw["write_accelerator_enabled"].(bool)),
        CreateOption: virtualmachinescalesets.DiskCreateOptionTypesFromImage,
    }

    // ... other fields ...

    if osDiskSize := raw["disk_size_gb"].(int); osDiskSize > 0 {
        disk.DiskSizeGB = pointer.To(int64(osDiskSize))
    }

    return &disk
}
```

**Assignment Trace:**
1. `ExpandOrchestratedVirtualMachineScaleSetOSDisk` returns `*virtualmachinescalesets.VirtualMachineScaleSetOSDisk`
2. In Create: `virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(...)`
3. Then: `props.Properties.VirtualMachineProfile = &virtualMachineProfile`
4. Finally: Set via `client.CreateOrUpdateThenPoll(ctx, id, props, ...)`

**Verified Path:** `properties.virtualMachineProfile.storageProfile.osDisk.diskSizeGB`

**Path Comparison:** ✅ Matches predicted path

## Provider Schema

**Query:** `query_terraform_block_implementation_source_code(block_type="resource", terraform_type="azurerm_orchestrated_virtual_machine_scale_set", entrypoint_name="schema")`

**Schema Definition:**
```go
"disk_size_gb": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    Computed:     true,
    ValidateFunc: validation.IntBetween(0, 4095),
},
```

**Key Properties:**
- **Type:** Int
- **Optional:** true
- **Computed:** true (can be computed from image)
- **ForceNew:** false (can be updated)
- **ValidateFunc:** `validation.IntBetween(0, 4095)`

## Azure API Schema

**Query:** `query_azapi_resource_schema(resource_type="Microsoft.Compute/virtualMachineScaleSets", api_version="2024-11-01", path="body.properties.virtualMachineProfile.storageProfile.osDisk.diskSizeGB")`

**Result:** `Number`

**Query:** `query_azapi_resource_document(resource_type="Microsoft.Compute/virtualMachineScaleSets", api_version="2024-11-01", path="body.properties.virtualMachineProfile.storageProfile.osDisk.diskSizeGB")`

**Description:** "Specifies the size of an empty data disk in gigabytes. This element can be used to overwrite the size of the disk in a virtual machine image. The property 'diskSizeGB' is the number of bytes x 1024^3 for the disk and the value cannot be larger than 1023."

**Note:** Azure API documentation states max value is 1023, but provider validates 0-4095. We replicate the provider's validation (0-4095) as that's the behavior users expect.

## Hidden Fields

None. The field is explicitly defined in the provider schema.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| disk_size_gb           | diskSizeGB          |

## Special Handling

### Validation

**Provider Validation:** `validation.IntBetween(0, 4095)`

**Implementation in variables.tf:**
```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_os_disk == null ||
    var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb == null ||
    (var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb >= 0 && var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb <= 4095)
  )
  error_message = "The disk_size_gb must be between 0 and 4095."
}
```

**Rationale:** Replicates exact provider validation. Note that Azure API documentation mentions max 1023, but provider allows up to 4095, so we follow provider behavior.

### Conditional Logic

**Provider Logic:**
```go
if osDiskSize := raw["disk_size_gb"].(int); osDiskSize > 0 {
    disk.DiskSizeGB = pointer.To(int64(osDiskSize))
}
```

**Shadow Implementation:**
```hcl
diskSizeGB = var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb != null && var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb > 0 ? var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb : null
```

**Rationale:** 
- Only set `diskSizeGB` when value is greater than 0
- This allows users to omit the value (use image default) or set to 0 (also uses image default)
- When value is > 0, it overrides the image's disk size

### ForceNew

The field does **not** have `ForceNew: true` in the provider schema, meaning updates are allowed without replacement. No entry needed in `replace_triggers_external_values`.

### Sensitive

Not marked as sensitive. Field goes in `local.body`, not `local.sensitive_body`.

## Deferred Work Completion

No deferred work from other tasks applies to this field (checked `following.md`).

## Critical Review & Edge Case Analysis

### Null Semantics
- **null:** Field is not set in API request - Azure uses the disk size from the source image
- **0:** Same as null - provider only sets field when > 0, so 0 is treated as "use image default"
- **> 0:** Explicitly overrides the image's disk size

### Boundary Conditions
- **Min (0):** Treated same as null - uses image default
- **Max (4095):** Maximum validated by provider, though Azure API docs mention 1023
- **Negative:** Blocked by validation (must be >= 0)

### Computed Behavior
Field is marked `Computed: true` because:
- If user doesn't provide a value, Azure sets it based on the source image
- The actual value can be read back from API after creation
- This is why the field is optional but has a determinable value

### Idempotency
- **First apply:** Sets diskSizeGB when > 0, omits when null or 0
- **Subsequent applies:** Value remains stable unless user changes it
- **No order dependencies:** Field is independent

### Safe References
```hcl
var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb != null && 
var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb > 0 ? 
  var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb : null
```
- Safe: Parent `os_disk` null check happens at merge level
- Safe: Two conditions ensure both null and zero values result in null output
- Safe: No nested property access without null guards

## Checklist

- ✅ Property in correct local (`body`, not `post_creation_updates`)
- ✅ Validation IMPLEMENTED in variables.tf (IntBetween(0, 4095))
- ✅ All logic EXACTLY replicated from provider (only set when > 0)
- ✅ Hidden fields checked (none)
- ✅ No deferred work in following.md
- ✅ Critical review completed (null semantics, boundaries, idempotency, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Task scope verified: only disk_size_gb implemented, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #91 - os_disk.disk_size_gb

### Validation Results

✅ **ForceNew Logic:** No ForceNew required - field can be updated without replacement (schema ForceNew: false)
✅ **Stable Keys:** N/A - field not in `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase - set before CreateOrUpdateThenPoll)
✅ **Type Conversion:** Correct conversion from Terraform `number` to Azure API `Number` (diskSizeGB)
✅ **Null Handling:** Correctly implements provider logic - only sets field when value > 0, returns null for null or 0 (uses image default)
✅ **Validations:** Provider validation `IntBetween(0, 4095)` exactly replicated in variables.tf
✅ **Deferred Work Completion:** No deferred work for this task (verified following.md)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed - null semantics (use image default), boundaries (0-4095), idempotency (stable values), safe references (proper null guards)
✅ **Conditional Logic:** Exactly matches provider's expand logic: `if osDiskSize > 0 { disk.DiskSizeGB = pointer.To(int64(osDiskSize)) }`
✅ **Assignment Path:** Verified path `properties.virtualMachineProfile.storageProfile.osDisk.diskSizeGB` matches provider struct assignments
✅ **Scope Compliance:** Only implements disk_size_gb field, leaves placeholders for other tasks (#92, #93-95)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The validation matches provider's `IntBetween(0, 4095)`, the conditional logic matches provider's "only set when > 0" behavior, and the field is correctly placed in the Create phase. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
