# Task #4: platform_fault_domain_count - Proof Document

## Shadow Implementation

```hcl
# In migrate_main.tf - local.replace_triggers_external_values
locals {
  replace_triggers_external_values = {
    location                      = { value = var.orchestrated_virtual_machine_scale_set_location }
    platform_fault_domain_count   = { value = var.orchestrated_virtual_machine_scale_set_platform_fault_domain_count }
    zone_balance                  = { value = var.orchestrated_virtual_machine_scale_set_zone_balance }
    zones                         = { value = local.zones_force_new_trigger }
    single_placement_group        = { value = local.single_placement_group_force_new_trigger }
    capacity_reservation_group_id = { value = var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id }
  }
}

# In migrate_main.tf - local.body
locals {
  body = merge(
    {
      properties = merge(
        {
          orchestrationMode = "Flexible"
        },
        {
          platformFaultDomainCount = var.orchestrated_virtual_machine_scale_set_platform_fault_domain_count
        },
        var.orchestrated_virtual_machine_scale_set_single_placement_group != null ? {
          singlePlacementGroup = var.orchestrated_virtual_machine_scale_set_single_placement_group
        } : {},
        # ... rest of properties ...
      )
    },
    # ... rest of body ...
  )
}
```

## Summary

The `platform_fault_domain_count` argument is a required root-level field that maps to `properties.platformFaultDomainCount` in the Azure API. It specifies the number of fault domains used by the Virtual Machine Scale Set and has `ForceNew: true`, requiring resource replacement on any change.

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern Identified:** Single-phase creation

**Field Assignment Phase:** Create phase (before `CreateOrUpdateThenPoll`)

**Go Code Evidence:**
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	props := virtualmachinescalesets.VirtualMachineScaleSet{
		Location: location.Normalize(d.Get("location").(string)),
		Tags:     tags.Expand(t),
		Properties: &virtualmachinescalesets.VirtualMachineScaleSetProperties{
			PlatformFaultDomainCount: pointer.To(int64(d.Get("platform_fault_domain_count").(int))),
			// OrchestrationMode needs to be hardcoded to Uniform, for the
			// standard VMSS resource, since virtualMachineProfile is now supported
			// in both VMSS and Orchestrated VMSS...
			OrchestrationMode: pointer.To(virtualmachinescalesets.OrchestrationModeFlexible),
		},
	}
	// ...
	log.Printf("[DEBUG] Creating Orchestrated %s.", id)
	if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Orchestrated %s: %w", id, err)
	}
	// ...
}
```

**Decision:** Field is assigned directly to `props.Properties.PlatformFaultDomainCount` before the `CreateOrUpdateThenPoll` call → **Create phase** → Add to `local.body.properties`

## Assignment Path Verification

**Predicted Path:** `properties.platformFaultDomainCount`

**Go Code Evidence:**
```go
// Step 1: Direct assignment to Properties struct
props := virtualmachinescalesets.VirtualMachineScaleSet{
	Properties: &virtualmachinescalesets.VirtualMachineScaleSetProperties{
		PlatformFaultDomainCount: pointer.To(int64(d.Get("platform_fault_domain_count").(int))),
		OrchestrationMode: pointer.To(virtualmachinescalesets.OrchestrationModeFlexible),
	},
}

// Step 2: Props sent to API
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
	return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Trace Analysis:**
1. Field value read from `d.Get("platform_fault_domain_count").(int)` - converted to `int64` with `pointer.To()`
2. Assigned to `props.Properties.PlatformFaultDomainCount`
3. No intermediate struct assignments
4. `props` directly passed to API call

**Verified Path:** `properties.platformFaultDomainCount`

**Path Comparison:** ✅ Match - Predicted path matches verified path

## Provider Schema

**Query Method:** `query_terraform_block_implementation_source_code` with `entrypoint_name=schema`

**Schema Definition:**
```go
"platform_fault_domain_count": {
	Type:     pluginsdk.TypeInt,
	Required: true,
	ForceNew: true,
},
```

**Schema Analysis:**
- **Type:** `TypeInt` (integer)
- **Required:** `true` - This field is mandatory
- **ForceNew:** `true` - Any change triggers resource replacement
- **Optional:** Not set (field is required)
- **Computed:** Not set
- **Default:** Not set
- **Validations:** None in schema definition
- **ConflictsWith:** None
- **AtLeastOneOf:** None
- **ExactlyOneOf:** None

## Azure API Schema

**API Version:** `2024-11-01`

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets`

**Property Path:** `body.properties.platformFaultDomainCount`

**Type:** `Number` (integer)

**API Schema Evidence:**
```
"properties":ObjectWithOptionalAttrs(map[string]Type{
	"platformFaultDomainCount":Number,
	// ... other properties
}, []string{
	"platformFaultDomainCount",
	// ... other properties
})
```

**Analysis:**
- Property is at `properties.platformFaultDomainCount` (root-level API property)
- Type is `Number` (aligns with Terraform's `TypeInt`)
- Listed in optional attributes array, indicating it's not strictly required by API but required by provider

## Hidden Fields

**Query Method:** Checked Create method for hardcoded values

**Analysis:**
No hidden fields detected for `platform_fault_domain_count`. The field is straightforward with direct assignment from user input to API property.

## Mapping

**Terraform (snake_case):** `platform_fault_domain_count`

**Azure API (camelCase):** `platformFaultDomainCount`

**Conversion:** Direct camelCase conversion, maintaining uppercase letters:
- `platform` → `platform`
- `fault` → `Fault`
- `domain` → `Domain`
- `count` → `Count`
- Result: `platformFaultDomainCount`

## Special Handling

### ForceNew Behavior

**Schema Definition:** `ForceNew: true`

**CustomizeDiff Check:** Reviewed full resource function - no `CustomizeDiff` logic for this field

**Implementation:**
```hcl
locals {
  replace_triggers_external_values = {
    platform_fault_domain_count = { value = var.orchestrated_virtual_machine_scale_set_platform_fault_domain_count }
    # ... other ForceNew fields
  }
}
```

**Reasoning:** Any change to `platform_fault_domain_count` must trigger resource replacement. The value itself is the trigger condition - when it changes, replacement occurs.

### Validation

**Provider Validations:** None in schema definition

**Implementation Decision:** No validation blocks added to `variables.tf` as provider schema has no validation constraints.

**Azure API Constraints:** While Azure API accepts integer values, there are no documented minimum/maximum constraints in the API schema or provider code that should be replicated.

### Type Handling

**Provider Type:** `pluginsdk.TypeInt` (Go `int`)

**API Type:** `Number` (JSON number)

**Conversion:** Provider converts to `int64` using `pointer.To(int64(d.Get("platform_fault_domain_count").(int)))`

**Shadow Module Implementation:** Use variable directly - AzAPI provider handles JSON number serialization automatically:
```hcl
platformFaultDomainCount = var.orchestrated_virtual_machine_scale_set_platform_fault_domain_count
```

## Critical Review & Edge Case Analysis

### Null Semantics

**Analysis:**
- Field is `Required: true` in schema
- Variable definition has `nullable = false`
- Provider code has no null handling - directly reads value with `d.Get()`
- Azure API lists it in optional attributes but provider enforces requirement

**Shadow Module Behavior:**
- Variable constraint `nullable = false` prevents null input
- Direct assignment without null check is safe due to required constraint
- Matches provider behavior exactly

### Boundary Conditions

**Valid Values:**
- Any positive integer representing fault domain count
- Common values: 1, 2, 3, 5 depending on Azure region capabilities
- Maximum typically 3 for most regions, 5 for select regions

**Edge Cases:**
- **Zero (0):** Provider accepts, API behavior depends on region
- **Negative values:** Not validated by provider schema, may be rejected by API
- **Large values:** Not validated by provider, API will enforce regional limits

**Shadow Module Handling:**
- No validation added (matches provider)
- Azure API will enforce valid ranges during creation
- User experience matches original provider exactly

### Idempotency

**Analysis:**
- Field has `ForceNew: true` - not subject to update idempotency
- Value changes always trigger replacement
- No ordering concerns (single integer value)
- No state drift issues

**Shadow Module Guarantees:**
- `replace_triggers_external_values` ensures replacement on change
- Value directly assigned, no transformations
- Perfect idempotency for create operations

### Safe References

**Variable Access:**
```hcl
platformFaultDomainCount = var.orchestrated_virtual_machine_scale_set_platform_fault_domain_count
```

**Safety Analysis:**
- Variable is non-nullable and required
- No nested access required
- No conditional logic needed
- Direct assignment is safe

**ForceNew Trigger Access:**
```hcl
platform_fault_domain_count = { value = var.orchestrated_virtual_machine_scale_set_platform_fault_domain_count }
```

**Safety Analysis:**
- Same safety guarantees as body assignment
- Value cannot be null due to variable constraint
- No additional safety checks needed

## Checklist

- ✅ Property in correct local: `body.properties.platformFaultDomainCount`
- ✅ ForceNew wrapped: `replace_triggers_external_values.platform_fault_domain_count = { value = var.orchestrated_virtual_machine_scale_set_platform_fault_domain_count }`
- ✅ All logic exactly replicated from provider: Direct integer assignment with no transformations
- ✅ Validations: None required (provider has no validations)
- ✅ Hidden fields checked: None found
- ✅ Critical review completed: Null semantics, boundary conditions, idempotency, safe references all verified
- ✅ Edge Case Analysis: Zero, negative, and large values handled same as provider (API validates)
- ✅ Proof document created: Complete with all required sections
- ✅ Task scope verified: Only `platform_fault_domain_count` implementation, no other fields added

## Implementation Verification

**Files Modified:**
1. `migrate_main.tf` - Added `platformFaultDomainCount` to `local.body.properties`
2. `migrate_main.tf` - Added `platform_fault_domain_count` to `local.replace_triggers_external_values`

**No Modifications Needed:**
- `variables.tf` - Variable already exists with correct definition
- `migrate_variables.tf` - No new variables needed
- `migrate_validation.tf` - No validations to add

**Behavior Match:**
- ✅ Field is required (enforced by variable constraint)
- ✅ Type is integer (direct assignment)
- ✅ ForceNew behavior replicated (in replace_triggers_external_values)
- ✅ No validations (matches provider)
- ✅ Direct value assignment (no transformations)
- ✅ Exact provider behavior replicated

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-04
**Task:** #4 - platform_fault_domain_count

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew with direct value tracking (Pattern 1 - unconditional ForceNew)
✅ **Stable Keys:** Key `platform_fault_domain_count` in `replace_triggers_external_values` is always present
✅ **Phase Detection:** Field correctly placed in `local.body.properties` (Create phase)
✅ **Type Conversion:** Correct direct assignment from Terraform `number` to Azure API `Number`
✅ **Null Handling:** Variable has `nullable = false` constraint, matches provider's required field
✅ **Validations:** None required (provider schema has no validations, none added)
✅ **Edge Cases:** Zero, negative, and large values handled same as provider (deferred to API validation)
✅ **Syntax Validation:** Only valid `value` parameter used, no invented parameters
✅ **Exact Replication:** Direct assignment with no transformations matches provider behavior exactly

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is:
- Directly assigned from variable to API property with no transformations
- Marked as ForceNew with simple value tracking
- Placed in the correct phase (Create)
- Has no validations (matching provider schema)
- Uses correct type conversion (Terraform number → JSON number)

No deviations, simplifications, or "safer alternatives" were found. The implementation is a perfect replication of the provider's behavior for this field.

**Status:** APPROVED ✅
