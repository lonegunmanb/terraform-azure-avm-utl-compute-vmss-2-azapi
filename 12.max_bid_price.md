# Task #12: max_bid_price

## Shadow Implementation

### variables.tf
```hcl
variable "orchestrated_virtual_machine_scale_set_max_bid_price" {
  type        = number
  default     = -1  # <-
  description = "(Optional) The maximum price you're willing to pay for each Virtual Machine in this Scale Set, in US Dollars; which must be greater than the current spot price. If this bid price falls below the current spot price the Virtual Machines in the Scale Set will be evicted using the eviction_policy. Defaults to `-1`, which means that each Virtual Machine in the Scale Set should not be evicted for price reasons."

  validation {  # <-
    condition = (  # <-
      var.orchestrated_virtual_machine_scale_set_max_bid_price == -1 ||  # <-
      var.orchestrated_virtual_machine_scale_set_max_bid_price >= 0.00001  # <-
    )  # <-
    error_message = "The max_bid_price must be either -1 (to use current VM price) or greater than or equal to 0.00001."  # <-
  }  # <-
}
```

### migrate_main.tf
```hcl
locals {
  body = merge(
    {
      properties = merge(
        # ... other properties ...
        var.orchestrated_virtual_machine_scale_set_os_profile != null || var.orchestrated_virtual_machine_scale_set_extensions_time_budget != null || var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id != null || var.orchestrated_virtual_machine_scale_set_encryption_at_host_enabled != null || var.orchestrated_virtual_machine_scale_set_eviction_policy != null || var.orchestrated_virtual_machine_scale_set_license_type != null ? {
          virtualMachineProfile = merge(
            # ... other profile properties ...
            var.orchestrated_virtual_machine_scale_set_max_bid_price > 0 ? {  # <-
              billingProfile = {  # <-
                maxPrice = var.orchestrated_virtual_machine_scale_set_max_bid_price  # <-
              }  # <-
            } : {},  # <-
          )
        } : {}
      )
    }
  )
}
```

## Summary

Migrated `max_bid_price` from azurerm to azapi as `properties.virtualMachineProfile.billingProfile.maxPrice`. The field is only included when value > 0, with default -1 and validation ensuring value is either -1 or >= 0.00001.

## Create Phase Verification

### Query Create Method
Queried the Create method using `query_terraform_block_implementation_source_code` with `entrypoint_name=create`.

### Pattern Identification
**Single-phase pattern**: The field is set directly in the Create phase before calling `CreateOrUpdateThenPoll`.

### Field Classification
The `max_bid_price` field is set **in Create phase** (before create call).

### Go Code Evidence
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... initialization ...
	
	virtualMachineProfile := virtualmachinescalesets.VirtualMachineScaleSetVMProfile{
		StorageProfile: &virtualmachinescalesets.VirtualMachineScaleSetStorageProfile{},
	}
	
	// ... other profile properties ...
	
	if v, ok := d.Get("max_bid_price").(float64); ok && v > 0 {
		if *virtualMachineProfile.Priority != virtualmachinescalesets.VirtualMachinePriorityTypesSpot {
			return fmt.Errorf("`max_bid_price` can only be configured when `priority` is set to `%s`", string(virtualmachinescalesets.VirtualMachinePriorityTypesSpot))
		}

		virtualMachineProfile.BillingProfile = &virtualmachinescalesets.BillingProfile{
			MaxPrice: pointer.To(v),
		}
	}
	
	// ... later in Create ...
	props.Properties.VirtualMachineProfile = &virtualMachineProfile
	
	log.Printf("[DEBUG] Creating Orchestrated %s.", id)
	if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Orchestrated %s: %w", id, err)
	}
}
```

### Decision
The field belongs to **`local.body`** (Create phase).

## Assignment Path Verification

### Predicted Path
`properties.virtualMachineProfile.billingProfile.maxPrice`

### Go Code Evidence - Tracing Assignments

**Step 1: Field assignment to virtualMachineProfile**
```go
if v, ok := d.Get("max_bid_price").(float64); ok && v > 0 {
	virtualMachineProfile.BillingProfile = &virtualmachinescalesets.BillingProfile{
		MaxPrice: pointer.To(v),
	}
}
```

**Step 2: virtualMachineProfile assigned to props.Properties**
```go
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Step 3: props structure**
```go
props := virtualmachinescalesets.VirtualMachineScaleSet{
	Location: location.Normalize(d.Get("location").(string)),
	Tags:     tags.Expand(t),
	Properties: &virtualmachinescalesets.VirtualMachineScaleSetProperties{
		// ...
	},
}
```

### Verified Path
Following all assignments:
1. Field â†’ `virtualMachineProfile.BillingProfile.MaxPrice`
2. `virtualMachineProfile` â†’ `props.Properties.VirtualMachineProfile`
3. Final path: `properties.virtualMachineProfile.billingProfile.maxPrice`

### Path Comparison
âœ… **MATCH** - Predicted path matches verified path.

## Provider Schema

### Schema Definition
```go
"max_bid_price": {
	Type:         pluginsdk.TypeFloat,
	Optional:     true,
	Default:      -1,
	ValidateFunc: computeValidate.SpotMaxPrice,
},
```

### Validation Function
```go
// SpotMaxPrice validates the price provided is a valid Spot Price for the Compute
// API (and downstream API's which use this like AKS)
func SpotMaxPrice(i interface{}, k string) (warnings []string, errors []error) {
	v, ok := i.(float64)
	if !ok {
		errors = append(errors, fmt.Errorf("expected type of %q to be float", k))
		return
	}

	// either -1 (the current VM price)
	if v == -1.0 {
		return
	}

	// at least 0.00001
	if v < 0.00001 {
		errors = append(errors, fmt.Errorf("expected %q to be > 0.00001 but got %.5f", k, v))
		return
	}

	return
}
```

**Key attributes:**
- Type: `TypeFloat`
- Optional: `true`
- Default: `-1`
- Validation: Must be -1 OR >= 0.00001
- ForceNew: **NO** (not in schema, not in CustomizeDiff)
- Sensitive: **NO**

## Azure API Schema

### Resource Type
`Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

### Property Path
`body.properties.virtualMachineProfile.billingProfile.maxPrice`

### Schema Type
From Azure API schema query:
```
"billingProfile":ObjectWithOptionalAttrs(map[string]Type{
  "maxPrice":Number
}, []string{"maxPrice"})
```

**Key attributes:**
- Type: `Number`
- Optional: `true`

## Hidden Fields

None identified. The `max_bid_price` field directly maps to `maxPrice` with no additional hidden fields.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| max_bid_price         | maxPrice             |

## Special Handling

### 1. Default Value
**Provider behavior:**
- Default: `-1`
- Changed from `null` to `-1` in variables.tf

**Implementation:**
```hcl
variable "orchestrated_virtual_machine_scale_set_max_bid_price" {
  type    = number
  default = -1
}
```

### 2. Validation
**Provider validation logic:**
```go
if v == -1.0 {
	return  // -1 is valid
}
if v < 0.00001 {
	errors = append(errors, fmt.Errorf("expected %q to be > 0.00001 but got %.5f", k, v))
	return
}
```

**Shadow Module replication:**
```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_max_bid_price == -1 ||
    var.orchestrated_virtual_machine_scale_set_max_bid_price >= 0.00001
  )
  error_message = "The max_bid_price must be either -1 (to use current VM price) or greater than or equal to 0.00001."
}
```

âœ… Exact replication of provider validation logic.

### 3. Conditional Inclusion
**Provider behavior:**
```go
if v, ok := d.Get("max_bid_price").(float64); ok && v > 0 {
	virtualMachineProfile.BillingProfile = &virtualmachinescalesets.BillingProfile{
		MaxPrice: pointer.To(v),
	}
}
```

**Key points:**
- Only included when `v > 0`
- When `-1` (default), the `billingProfile` block is NOT included
- When positive value provided, the block is included

**Shadow Module replication:**
```hcl
var.orchestrated_virtual_machine_scale_set_max_bid_price > 0 ? {
  billingProfile = {
    maxPrice = var.orchestrated_virtual_machine_scale_set_max_bid_price
  }
} : {}
```

âœ… Exact replication of conditional logic.

### 4. Priority Dependency Validation
**Provider validation:**
```go
if v, ok := d.Get("max_bid_price").(float64); ok && v > 0 {
	if *virtualMachineProfile.Priority != virtualmachinescalesets.VirtualMachinePriorityTypesSpot {
		return fmt.Errorf("`max_bid_price` can only be configured when `priority` is set to `%s`", string(virtualmachinescalesets.VirtualMachinePriorityTypesSpot))
	}
	// ... set billing profile
}
```

**Note:** This cross-field validation requires the `priority` field (Task #14) to be implemented. Once Task #14 is completed, this validation should be added to `migrate_validation.tf`:

```hcl
# To be added after Task #14 is completed:
check "max_bid_price_requires_spot_priority" {
  assert {
    condition = !(
      var.orchestrated_virtual_machine_scale_set_max_bid_price > 0 &&
      var.orchestrated_virtual_machine_scale_set_priority != "Spot"
    )
    error_message = "`max_bid_price` can only be configured when `priority` is set to `Spot`."
  }
}
```

**Current status:** Deferred until `priority` variable exists (Task #14).

### 5. ForceNew
**Provider schema:** No `ForceNew: true` in schema.
**CustomizeDiff:** No special handling for `max_bid_price` in CustomizeDiff.

**Conclusion:** Not a ForceNew field. Updates are allowed without replacement.

**Shadow Module:** No entry in `replace_triggers_external_values` for this field.

## Critical Review & Edge Case Analysis

### Null Semantics
**Provider behavior:**
- Default value: `-1` (not null)
- When user doesn't specify: uses `-1` (billing profile not included)
- When user specifies `-1`: billing profile not included (condition is `v > 0`)
- When user specifies positive value: billing profile included

**Shadow Module semantics:**
- Variable default: `-1`
- Condition: `max_bid_price > 0`
- When `-1`: empty object `{}` merged (no billing profile)
- When positive: billing profile included

âœ… Semantics match exactly.

### Boundary Conditions
**Test cases:**
1. Value = `-1` (default)
   - Provider: No billing profile
   - Shadow: Empty object `{}` (no billing profile)
   - âœ… Match

2. Value = `0`
   - Provider: No billing profile (condition `v > 0` false)
   - Shadow: Empty object `{}` (condition `v > 0` false)
   - âœ… Match

3. Value = `0.00001` (minimum valid positive)
   - Provider: Billing profile with `maxPrice: 0.00001`
   - Shadow: Billing profile with `maxPrice: 0.00001`
   - âœ… Match

4. Value = `0.000001` (below minimum)
   - Provider: Validation error
   - Shadow: Validation error
   - âœ… Match

### Idempotency
**Analysis:**
- Value is a simple number
- Direct assignment (no transformations)
- No order dependencies
- No collection operations

âœ… Implementation is idempotent.

### Safe References
**Analysis:**
- Direct variable reference: `var.orchestrated_virtual_machine_scale_set_max_bid_price`
- No nested object access
- No null dereference risk
- Condition `> 0` is safe for all numeric values

âœ… All references are safe.

### Type Safety
**Analysis:**
- Variable type: `number`
- Azure API type: `Number`
- Direct assignment (no conversion needed)
- Validation ensures valid numeric range

âœ… Type-safe implementation.

## Checklist

- âœ… Property in correct local (`local.body`)
- âœ… Default value replicated (`-1`)
- âœ… Validation IMPLEMENTED in variables.tf (value = -1 OR >= 0.00001)
- âœ… Conditional logic exactly matches provider (only include when > 0)
- âœ… Hidden fields checked (none)
- âœ… ForceNew checked (not ForceNew)
- âœ… Sensitive checked (not sensitive)
- âœ… Critical review completed (null semantics, boundaries, idempotency, safe refs)
- âœ… Edge Case Analysis included
- âœ… Proof document created
- â³ Track.md to be updated (next step)
- ðŸ“ Note: Cross-field validation with `priority` deferred to Task #14

## Cross-Task Dependencies

**Dependency on Task #14 (priority):**
Once `priority` is implemented, add this validation to `migrate_validation.tf`:
```hcl
check "max_bid_price_requires_spot_priority" {
  assert {
    condition = !(
      var.orchestrated_virtual_machine_scale_set_max_bid_price > 0 &&
      var.orchestrated_virtual_machine_scale_set_priority != "Spot"
    )
    error_message = "`max_bid_price` can only be configured when `priority` is set to `Spot`."
  }
}
```

---

## âœ… CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-04
**Task:** #12 - max_bid_price

### Validation Results

âœ… **ForceNew Logic:** Not a ForceNew field - correctly absent from replace_triggers_external_values
âœ… **Stable Keys:** Not applicable (not a ForceNew field)
âœ… **Phase Detection:** Field correctly placed in local.body (Create phase)
âœ… **Type Conversion:** Correct type mapping: number â†’ Number (direct assignment, no conversion needed)
âœ… **Null Semantics:** Default value -1 correctly implemented; conditional logic (> 0) exactly matches provider
âœ… **Validations:** Exact replication of provider validation (value == -1 OR value >= 0.00001)
âœ… **Default Value:** Default -1 correctly implemented in variables.tf
âœ… **Conditional Logic:** billingProfile only included when max_bid_price > 0 (exact match to provider)
âœ… **Assignment Path:** Correctly nested at properties.virtualMachineProfile.billingProfile.maxPrice
âœ… **Edge Cases:** All boundary conditions properly analyzed (value = -1, 0, 0.00001, 0.000001)
âœ… **Cross-Field Validation:** Dependency on priority field (Task #14) correctly identified and deferred with implementation plan

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. All aspects verified:

1. **Default Value (-1)**: Exactly matches provider schema default
2. **Validation Logic**: Exactly replicates `SpotMaxPrice` validation function (value == -1 OR >= 0.00001)
3. **Conditional Inclusion**: Exactly matches provider logic (only include billingProfile when v > 0)
4. **Type Handling**: Correct direct assignment from number to Number
5. **Phase Detection**: Correctly identified as Create phase, placed in local.body
6. **Assignment Path**: Correctly traced through all struct assignments to final path
7. **Edge Cases**: All boundary conditions analyzed and correctly handled
8. **Cross-Field Logic**: Priority dependency correctly identified and deferred to Task #14

No deviations, simplifications, or "safer alternatives" were found. The implementation uses the exact conditional logic from the provider (v > 0), the exact validation ranges, and the exact default value.

**Status:** APPROVED âœ…

---
