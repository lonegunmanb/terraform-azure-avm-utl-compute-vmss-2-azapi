# Task #19 - tags - Migration Proof Document

## Shadow Implementation

```hcl
# In migrate_main.tf
locals {
  azapi_header = {
    type      = "Microsoft.Compute/virtualMachineScaleSets@2024-11-01"
    name      = var.orchestrated_virtual_machine_scale_set_name
    location  = var.orchestrated_virtual_machine_scale_set_location
    parent_id = var.orchestrated_virtual_machine_scale_set_resource_group_id
  }

  tags = var.orchestrated_virtual_machine_scale_set_tags  # <-
}
```

## Summary

The `tags` argument is a simple map of strings passed directly to the `tags` parameter of `azapi_resource` (top-level, not in body). No ForceNew behavior, updatable.

## Create Phase Verification

### Query Create Method

Query: `query_terraform_block_implementation_source_code(block_type="resource", terraform_type="azurerm_orchestrated_virtual_machine_scale_set", entrypoint_name="create")`

### Pattern Identification

**Pattern:** Single-phase create

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    t := d.Get("tags").(map[string]interface{})

    props := virtualmachinescalesets.VirtualMachineScaleSet{
        Location: location.Normalize(d.Get("location").(string)),
        Tags:     tags.Expand(t),
        Properties: &virtualmachinescalesets.VirtualMachineScaleSetProperties{
            // ...
        },
    }
    // ...
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
    // ...
}
```

### Field Classification

**Classification:** Create phase (before create call)

**Evidence:** The `tags` field is retrieved with `d.Get("tags")`, expanded with `tags.Expand(t)`, and assigned to `props.Tags` before the `CreateOrUpdateThenPoll` call.

**Decision:** Implement in `local.tags` (top-level parameter for `azapi_resource`).

## Assignment Path Verification

### Predicted Path

**Terraform Path:** `tags` (root-level argument)
**Azure API Path:** `tags` (root-level property)

### Go Code Evidence

```go
// From Create method (line 40-44)
t := d.Get("tags").(map[string]interface{})

props := virtualmachinescalesets.VirtualMachineScaleSet{
    Location: location.Normalize(d.Get("location").(string)),
    Tags:     tags.Expand(t),
    // ...
}
```

Direct assignment to `props.Tags` at root level.

### Verified Path

`tags` (root-level in Azure API)

### Path Comparison

✅ **Match** - Predicted path matches verified path. The `tags` property is assigned directly at the root level of the `VirtualMachineScaleSet` struct, not nested in `Properties`.

## Provider Schema

```go
// From resource schema
"tags": commonschema.Tags(),
```

- **Type:** Map of strings
- **Required:** No (Optional)
- **ForceNew:** No
- **Default:** None
- **Computed:** No

## Azure API Schema

Query: `query_azapi_resource_schema(resource_type="Microsoft.Compute/virtualMachineScaleSets", api_version="2024-11-01", path="tags")`

**Result:** `Map(String)`

**API Location:** Root-level property (not in `properties`)

## Hidden Fields

None. The `tags` field is straightforward with no hidden logic or additional fields set by the provider.

## Mapping

| AzureRM Field | Azure API Field | Notes |
|---------------|-----------------|-------|
| `tags` | `tags` | Direct mapping, root-level in both |

## Special Handling

### Validation

No validation required. The `commonschema.Tags()` in the provider schema handles standard tag validation (map of strings).

### ForceNew Behavior

**ForceNew:** No

**Evidence from Create:**
```go
t := d.Get("tags").(map[string]interface{})
props := virtualmachinescalesets.VirtualMachineScaleSet{
    Tags: tags.Expand(t),
    // ...
}
```

**Evidence from Update:**
```go
func resourceOrchestratedVirtualMachineScaleSetUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    if d.HasChange("tags") {
        update.Tags = tags.Expand(d.Get("tags").(map[string]interface{}))
    }
    // ...
}
```

The Update method explicitly handles `tags` changes with `d.HasChange("tags")`, confirming tags are updatable without resource replacement.

**Implementation:** No entry in `replace_triggers_external_values`.

### Sensitive Data

**Sensitive:** No

Tags are not marked as sensitive in the schema.

### Post-Creation Updates

**Not Applicable:** Tags are updated directly during the standard update operation, not as a post-creation update.

### Default Value

**Default:** `null`

The variable in `variables.tf` already has `default = null`.

## Critical Review & Edge Case Analysis

### Null Semantics

- **`null`:** No tags will be set on the resource
- **Empty map `{}`:** Empty tags object sent to Azure API (functionally same as null)
- **Non-empty map:** Tags are applied to the resource

### Edge Cases

1. **Empty Map:** `tags = {}` - Valid, sends empty tags to Azure
2. **Tag Value Empty String:** `tags = { "key" = "" }` - Valid, Azure accepts empty string values
3. **Tag Key Rules:** Azure has restrictions on tag keys/values (length, characters), but this is enforced by Azure API, not the provider
4. **Update from null to non-null:** Supported via update operation
5. **Update from non-null to null:** While the provider supports this, Azure typically retains existing tags unless explicitly removed. The update with `null` or empty map should clear tags.

### Idempotency

✅ **Idempotent:** Map comparisons are straightforward. Order doesn't matter for maps in Terraform.

### Safe References

✅ **Safe:** Direct variable reference, no nested access required.

## Checklist

- ✅ Property in correct local: `tags` at root level (not in body)
- ✅ Not in body: Tags is a top-level `azapi_resource` parameter
- ✅ No ForceNew wrapper needed: Tags are updatable
- ✅ All logic exactly replicated: Simple pass-through of map value
- ✅ Validation: No custom validation needed (standard map of strings)
- ✅ No sensitive migration needed: Not a sensitive field
- ✅ Hidden fields checked: None
- ✅ Critical review completed: Null semantics, edge cases, idempotency verified
- ✅ Edge Case Analysis: Empty maps, null values, updates all handled correctly
- ✅ Proof created: This document
- ✅ Ready for track.md update

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-05
**Task:** #19 - tags

### Validation Results

✅ **ForceNew Logic:** No ForceNew required - tags are updatable via Update method, correctly excluded from `replace_triggers_external_values`
✅ **Stable Keys:** N/A (not in replace_triggers_external_values)
✅ **Phase Detection:** Field correctly placed in `local.tags` (top-level parameter, not in body)
✅ **Type Conversion:** Correct - `map(string)` passed directly to AzAPI's `tags` parameter, no conversion needed
✅ **Null Handling:** Correctly uses `default = null` in variables.tf, allowing optional tags
✅ **Validations:** No custom validation required - standard map(string) type validation is sufficient
✅ **Edge Cases:** Properly analyzed including empty maps, null values, and update transitions
✅ **Assignment Path:** Correctly identified as root-level Azure API property (not nested in properties)
✅ **Azure API Schema Compliance:** Correctly uses top-level `tags` parameter in AzAPI resource, not in `body`

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The `tags` field is correctly:
- Placed at the root level of the `azapi_resource` (via `local.tags`) rather than in the body
- Made updatable without ForceNew (matching provider's Update method behavior)
- Typed as optional `map(string)` with null default
- Free of unnecessary validations (standard map semantics are sufficient)

The proof document provides thorough evidence from Go source code showing:
- Tags are retrieved and set during Create phase
- Tags are explicitly handled in Update method with `d.HasChange("tags")`
- Tags are assigned directly to root-level `Tags` property, not nested in `Properties`

No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
