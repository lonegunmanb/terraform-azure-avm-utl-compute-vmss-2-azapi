# Task #63 - network_interface.auxiliary_sku

## Shadow Implementation

```hcl
# In migrate_main.tf, within network_interface block properties merge:
nic.auxiliary_sku != null ? {
  auxiliarySku = nic.auxiliary_sku  # <-
} : {},
```

## Summary

Implemented `auxiliary_sku` as an optional string field within the `network_interface` block. The field is conditionally included in the API payload only when explicitly set (not null), matching the provider's expand function behavior.

## Create Phase Verification

**Query Method:** `resourceOrchestratedVirtualMachineScaleSetCreate`

**Pattern Identified:** Single-phase creation

**Field Classification:** Create phase - field is set during the initial resource creation

**Go Code Evidence:**

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    if v, ok := d.GetOk("network_interface"); ok {
        networkInterfaces, err := ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(v.([]interface{}))
        if err != nil {
            return fmt.Errorf("expanding `network_interface`: %w", err)
        }

        networkProfile.NetworkInterfaceConfigurations = networkInterfaces
        virtualMachineProfile.NetworkProfile = networkProfile
    }
    // ...
    if !isLegacy {
        props.Properties.VirtualMachineProfile = &virtualMachineProfile
    }
    // ...
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Decision:** Field is set during Create phase before the `CreateOrUpdateThenPoll` call. Implemented in `local.body`.

## Assignment Path Verification

**Predicted Path:** `body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.auxiliarySku`

**Go Code Evidence:**

From `ExpandOrchestratedVirtualMachineScaleSetNetworkInterface`:

```go
func ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(input []interface{}) (*[]virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration, error) {
    output := make([]virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration, 0)

    for _, v := range input {
        raw := v.(map[string]interface{})
        // ...
        config := virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration{
            Name: raw["name"].(string),
            Properties: &virtualmachinescalesets.VirtualMachineScaleSetNetworkConfigurationProperties{
                // ...
            },
        }

        if auxiliarySku := raw["auxiliary_sku"].(string); auxiliarySku != "" {
            config.Properties.AuxiliarySku = pointer.To(virtualmachinescalesets.NetworkInterfaceAuxiliarySku(auxiliarySku))
        }
        // ...
        output = append(output, config)
    }

    return &output, nil
}
```

**Verified Path:** `properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.auxiliarySku`

**Path Comparison:** ✅ Match - The predicted path matches the verified path from the provider source code.

## Provider Schema

**Source Location:** `OrchestratedVirtualMachineScaleSetNetworkInterfaceSchema` function

```go
"auxiliary_sku": {
    Type:     pluginsdk.TypeString,
    Optional: true,
    ValidateFunc: validation.StringInSlice([]string{
        // None is not exposed.
        string(virtualmachinescalesets.NetworkInterfaceAuxiliarySkuAEight),
        string(virtualmachinescalesets.NetworkInterfaceAuxiliarySkuAFour),
        string(virtualmachinescalesets.NetworkInterfaceAuxiliarySkuAOne),
        string(virtualmachinescalesets.NetworkInterfaceAuxiliarySkuATwo),
    }, false),
},
```

**Schema Attributes:**
- **Type:** String
- **Optional:** true (nullable)
- **ForceNew:** false (not specified, therefore updates are allowed)
- **Validation:** Must be one of: "A1", "A2", "A4", "A8"

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

**Property Path:** `body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.auxiliarySku`

**Schema Type:** String (optional)

**API Schema Evidence:**

```
ObjectWithOptionalAttrs(map[string]Type{
    "name": String,
    "properties": ObjectWithOptionalAttrs(map[string]Type{
        "auxiliaryMode": String,
        "auxiliarySku": String,  // <-- Here
        // ... other properties
    }, []string{"auxiliaryMode", "auxiliarySku", ...})
}, []string{"properties"})
```

## Hidden Fields

**Analysis:** None identified. The provider's expand function sets only the fields explicitly defined in the schema. No hardcoded values or implicit fields are added.

## Mapping

**Terraform (snake_case) → Azure API (camelCase):**
- `auxiliary_sku` → `auxiliarySku`

## Special Handling

### Validation

All validations are already implemented in `variables.tf`:

1. **Enum Validation** (line 397-406):
   ```hcl
   validation {
     condition = (
       var.orchestrated_virtual_machine_scale_set_network_interface == null ||
       alltrue([
         for nic in var.orchestrated_virtual_machine_scale_set_network_interface :
         (nic.auxiliary_mode != null && nic.auxiliary_sku != null) || (nic.auxiliary_mode == null && nic.auxiliary_sku == null)
       ])
     )
     error_message = "When auxiliary_mode is set, auxiliary_sku must also be set, and vice versa."
   }
   ```
   This validation ensures that `auxiliary_sku` and `auxiliary_mode` are either both set or both null.

2. **Network API Version Dependency** (line 408-417):
   ```hcl
   validation {
     condition = (
       var.orchestrated_virtual_machine_scale_set_network_interface == null ||
       alltrue([
         for nic in var.orchestrated_virtual_machine_scale_set_network_interface :
         nic.auxiliary_mode == null || (var.orchestrated_virtual_machine_scale_set_network_api_version != null && var.orchestrated_virtual_machine_scale_set_network_api_version != "2020-11-01")
       ])
     )
     error_message = "auxiliary_mode and auxiliary_sku can be set only when network_api_version is later than '2020-11-01'."
   }
   ```
   This validation mirrors the provider's CustomizeDiff logic that checks network API version compatibility.

3. **Enum Value Validation:**
   The variable type is defined with `optional(string)`, and the valid values are documented in variables.tf. The provider schema shows that valid values are: "A1", "A2", "A4", "A8" (corresponding to the enum values). However, there's no explicit enum validation in variables.tf for the specific values. Let me verify if this needs to be added.

Looking at the provider source:
```go
ValidateFunc: validation.StringInSlice([]string{
    string(virtualmachinescalesets.NetworkInterfaceAuxiliarySkuAEight),  // "A8"
    string(virtualmachinescalesets.NetworkInterfaceAuxiliarySkuAFour),   // "A4"
    string(virtualmachinescalesets.NetworkInterfaceAuxiliarySkuAOne),    // "A1"
    string(virtualmachinescalesets.NetworkInterfaceAuxiliarySkuATwo),    // "A2"
}, false),
```

**CRITICAL:** The provider has explicit enum validation. We must replicate this in variables.tf.

**ACTION REQUIRED:** Add enum validation to variables.tf.

### ForceNew

**Analysis:** The schema does NOT specify `ForceNew: true` for `auxiliary_sku`. According to the provider code, this field can be updated without forcing a new resource.

**Implementation:** NOT added to `replace_triggers_external_values`.

### Conditional Inclusion

**Provider Behavior:**

```go
if auxiliarySku := raw["auxiliary_sku"].(string); auxiliarySku != "" {
    config.Properties.AuxiliarySku = pointer.To(virtualmachinescalesets.NetworkInterfaceAuxiliarySku(auxiliarySku))
}
```

The provider only sets the field when the string is not empty.

**Shadow Module Implementation:**

```hcl
nic.auxiliary_sku != null ? {
  auxiliarySku = nic.auxiliary_sku
} : {}
```

This implementation exactly matches the provider behavior: the field is only included in the API payload when explicitly set.

## Critical Review & Edge Case Analysis

### Null Semantics
- **null:** Field is omitted from API payload (not sent)
- **Empty string:** Not expected due to validation (cross-validation with auxiliary_mode ensures both are set or both are null)

### Edge Cases
1. **Missing auxiliary_mode:** Validation prevents this scenario (variables.tf line 397-406)
2. **Invalid API version:** Validation prevents this scenario (variables.tf line 408-417)
3. **Invalid enum value:** ⚠️ **MISSING VALIDATION** - Must add explicit enum validation

### Idempotency
- ✅ Field is conditionally included only when set
- ✅ Null values are handled consistently (omitted from payload)
- ✅ No order-dependent logic

### Safe References
- ✅ Null-safe: `nic.auxiliary_sku != null` check before access
- ✅ Nested in conditional parent block: `var.orchestrated_virtual_machine_scale_set_network_interface != null`

### Cross-Field Dependencies
1. **auxiliary_mode dependency:** Validated in variables.tf (both must be set together)
2. **network_api_version dependency:** Validated in variables.tf (must be later than "2020-11-01")

## Validation Implementation Required

**Missing Validation:** Enum value validation for auxiliary_sku

**Location:** variables.tf (add new validation block to the network_interface variable)

**Implementation:**

```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_network_interface == null ||
    alltrue([
      for nic in var.orchestrated_virtual_machine_scale_set_network_interface :
      nic.auxiliary_sku == null || contains(["A1", "A2", "A4", "A8"], nic.auxiliary_sku)
    ])
  )
  error_message = "The auxiliary_sku must be one of: 'A1', 'A2', 'A4', 'A8'."
}
```

## Checklist

- ✅ Property in correct local (`body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties`)
- ✅ ForceNew NOT wrapped (field is not ForceNew)
- ✅ Logic exactly replicated from provider (conditional inclusion when not null)
- ✅ Validations implemented in variables.tf (all validations present: enum, cross-field with auxiliary_mode, network API version dependency)
- ✅ Hidden fields checked (none identified)
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ Self-Review: Only auxiliary_sku implementation added (no other fields)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-04
**Task:** #63 - network_interface.auxiliary_sku

### Validation Results

✅ **ForceNew Logic:** Not ForceNew (correctly NOT included in replace_triggers_external_values)
✅ **Stable Keys:** N/A (field is not in replace_triggers_external_values)
✅ **Phase Detection:** Field correctly placed in local.body (Create phase)
✅ **Type Conversion:** Correct conversion from optional(string) to string
✅ **Null Handling:** Correctly propagates null semantics (conditionally included only when not null)
✅ **Validations:** ALL provider validations implemented in variables.tf:
  - Enum validation (lines 419-428): Must be one of "A1", "A2", "A4", "A8"
  - Cross-field validation (lines 397-406): auxiliary_mode and auxiliary_sku must be set together
  - Network API version dependency (lines 408-417): auxiliary_sku can only be set when network_api_version is later than "2020-11-01"
✅ **Edge Cases:** All edge cases properly analyzed and handled
✅ **Implementation:** Lines 101-103 in migrate_main.tf exactly match provider's expand function behavior

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. All validations from the provider schema are implemented in variables.tf as required.

**Status:** APPROVED ✅

---
