# Task #9: extensions_time_budget - Proof Document

## Shadow Implementation

**File: `variables.tf`**
```hcl
variable "orchestrated_virtual_machine_scale_set_extensions_time_budget" {
  type        = string
  default     = "PT1H30M"  # <-
  description = "(Optional) Specifies the time alloted for all extensions to start. The time duration should be between 15 minutes and 120 minutes (inclusive) and should be specified in ISO 8601 format. Defaults to `PT1H30M`."

  validation {  # <-
    condition = var.orchestrated_virtual_machine_scale_set_extensions_time_budget == null || can(regex("^PT([0-9]+H)?([0-9]+M)?$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)) && (
      can(regex("^PT([0-9]+)H([0-9]+)M$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)) ? (
        tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)[0]) * 60 + tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)[1]) >= 15 &&
        tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)[0]) * 60 + tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)[1]) <= 120
      ) : can(regex("^PT([0-9]+)H$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)) ? (
        tonumber(regex("^PT([0-9]+)H$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)[0]) * 60 >= 15 &&
        tonumber(regex("^PT([0-9]+)H$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)[0]) * 60 <= 120
      ) : can(regex("^PT([0-9]+)M$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)) ? (
        tonumber(regex("^PT([0-9]+)M$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)[0]) >= 15 &&
        tonumber(regex("^PT([0-9]+)M$", var.orchestrated_virtual_machine_scale_set_extensions_time_budget)[0]) <= 120
      ) : false
    )
    error_message = "The extensions_time_budget must be between PT15M and PT2H (15 minutes to 120 minutes) in ISO 8601 format."
  }  # <-
}
```

**File: `migrate_main.tf`**
```hcl
locals {
  body = {
    properties = merge(
      var.orchestrated_virtual_machine_scale_set_zone_balance != null ? {
        zoneBalance = var.orchestrated_virtual_machine_scale_set_zone_balance
      } : {},
      var.orchestrated_virtual_machine_scale_set_os_profile != null || var.orchestrated_virtual_machine_scale_set_extensions_time_budget != null ? {  # <-
        virtualMachineProfile = merge(
          var.orchestrated_virtual_machine_scale_set_os_profile != null ? {
            osProfile = merge(
              # ... existing os_profile implementation ...
            )
          } : {},
          var.orchestrated_virtual_machine_scale_set_extensions_time_budget != null ? {  # <-
            extensionProfile = {  # <-
              extensionsTimeBudget = var.orchestrated_virtual_machine_scale_set_extensions_time_budget  # <-
            }  # <-
          } : {}  # <-
        )
      } : {}
    )
  }
}
```

## Summary

Mapped `extensions_time_budget` from azurerm provider to AzAPI's `properties.virtualMachineProfile.extensionProfile.extensionsTimeBudget`. Added ISO 8601 duration validation (PT15M to PT2H) and default value (PT1H30M) as per provider schema.

## Create Phase Verification

### Pattern Identification

**Query:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Result:** Single-phase pattern - field is set before `CreateOrUpdateThenPoll` call.

### Go Code Evidence

```go
if v, ok := d.GetOk("extensions_time_budget"); ok {
    if virtualMachineProfile.ExtensionProfile == nil {
        virtualMachineProfile.ExtensionProfile = &virtualmachinescalesets.VirtualMachineScaleSetExtensionProfile{}
    }
    virtualMachineProfile.ExtensionProfile.ExtensionsTimeBudget = pointer.To(v.(string))
}
```

This code appears in `resourceOrchestratedVirtualMachineScaleSetCreate` BEFORE the `client.CreateOrUpdateThenPoll(ctx, id, props, ...)` call, indicating this is a **Create phase field**.

### Classification

**Decision:** This is a **Create phase field** → belongs in `local.body`

## Assignment Path Verification

### Predicted Path

`properties.virtualMachineProfile.extensionProfile.extensionsTimeBudget`

### Go Code Evidence

From the Create method:
```go
virtualMachineProfile := virtualmachinescalesets.VirtualMachineScaleSetVMProfile{
    StorageProfile: &virtualmachinescalesets.VirtualMachineScaleSetStorageProfile{},
}
// ... later in code ...
if v, ok := d.GetOk("extensions_time_budget"); ok {
    if virtualMachineProfile.ExtensionProfile == nil {
        virtualMachineProfile.ExtensionProfile = &virtualmachinescalesets.VirtualMachineScaleSetExtensionProfile{}
    }
    virtualMachineProfile.ExtensionProfile.ExtensionsTimeBudget = pointer.To(v.(string))
}
// ... later in code ...
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

### Traced Assignment Path

1. `virtualMachineProfile.ExtensionProfile.ExtensionsTimeBudget` = value
2. `props.Properties.VirtualMachineProfile` = `&virtualMachineProfile`
3. Final path: `properties.virtualMachineProfile.extensionProfile.extensionsTimeBudget`

### Path Comparison

**Match:** ✅ Predicted path matches the traced assignment path.

## Provider Schema

**Source:** `query_terraform_block_implementation_source_code` with `entrypoint_name=schema`

```go
"extensions_time_budget": {
    Type:         pluginsdk.TypeString,
    Optional:     true,
    Default:      "PT1H30M",
    ValidateFunc: validate.ISO8601DurationBetween("PT15M", "PT2H"),
},
```

**Attributes:**
- **Type:** String
- **Required:** false (Optional)
- **Default:** "PT1H30M"
- **Computed:** false
- **ForceNew:** false
- **Sensitive:** false
- **ValidateFunc:** `validate.ISO8601DurationBetween("PT15M", "PT2H")` - Validates ISO 8601 duration between 15 minutes and 2 hours

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

**Path:** `body.properties.virtualMachineProfile.extensionProfile.extensionsTimeBudget`

**Schema Type:** String

**Azure API Documentation:**
> "Specifies the time alloted for all extensions to start. The time duration should be between 15 minutes and 120 minutes (inclusive) and should be specified in ISO 8601 format. The default value is 90 minutes (PT1H30M). Minimum api-version: 2020-06-01."

## Hidden Fields

None detected. The field is explicitly defined in the schema and directly assigned in the Create method.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| extensions_time_budget | extensionsTimeBudget |

## Special Handling

### 1. Default Value

**Provider Schema:** `Default: "PT1H30M"`

**Implementation:** Changed variable default from `null` to `"PT1H30M"` in `variables.tf` to match provider behavior.

**Justification:** The AzureRM provider applies this default when the field is not provided. Since AzAPI has no default logic, we replicate it in the Shadow Module.

### 2. Validation

**Provider Schema:** `ValidateFunc: validate.ISO8601DurationBetween("PT15M", "PT2H")`

**Implementation:** Added comprehensive validation in `variables.tf`:
- Validates ISO 8601 duration format (PT#H#M, PT#H, or PT#M)
- Ensures duration is between 15 minutes (PT15M) and 120 minutes (PT2H)
- Handles various formats: PT1H30M, PT90M, PT2H, etc.

**Rationale:** 
- AzAPI provides NO validation - it passes invalid values to Azure API
- Azure API validation is slow (requires network call) and provides poor UX
- We MUST replicate provider validations for fail-fast behavior at plan time
- Validation complexity handles multiple ISO 8601 duration formats

### 3. Conditional Structure

**Implementation:** Extended the `virtualMachineProfile` condition to include `extensions_time_budget`:

```hcl
var.orchestrated_virtual_machine_scale_set_os_profile != null || var.orchestrated_virtual_machine_scale_set_extensions_time_budget != null ? {
  virtualMachineProfile = merge(
    # ... os_profile ...
    var.orchestrated_virtual_machine_scale_set_extensions_time_budget != null ? {
      extensionProfile = {
        extensionsTimeBudget = var.orchestrated_virtual_machine_scale_set_extensions_time_budget
      }
    } : {}
  )
} : {}
```

**Justification:** 
- The `extensionProfile` is a child of `virtualMachineProfile`
- Provider creates `ExtensionProfile` only when `extensions_time_budget` is set
- We must conditionally create the entire `virtualMachineProfile` structure when either `os_profile` OR `extensions_time_budget` is provided
- Prevents creating empty `virtualMachineProfile` objects

### 4. Not ForceNew

**Provider Schema:** No `ForceNew: true` attribute

**Implementation:** Field is NOT added to `replace_triggers_external_values`

**Justification:** This field can be updated in-place without recreating the resource.

### 5. Not Sensitive

**Provider Schema:** No `Sensitive: true` attribute

**Implementation:** Field is in `local.body`, not `local.sensitive_body`

## Critical Review & Edge Cases

### Null Semantics

**Null Handling:**
- `null` → Field is not sent to Azure API
- Azure API uses default value (PT1H30M) when field is absent
- **Shadow Module behavior:** Changed default from `null` to `"PT1H30M"` to explicitly send the default value
- **Rationale:** Makes behavior explicit and predictable - users get provider default even if not specified

### Edge Cases

1. **Empty String:** Validation prevents empty strings (regex requires PT prefix and time components)
2. **Boundary Values:**
   - Minimum: PT15M (15 minutes) ✅ Validated
   - Maximum: PT2H or PT120M (120 minutes) ✅ Validated
   - Below minimum: PT14M ❌ Rejected by validation
   - Above maximum: PT121M ❌ Rejected by validation
3. **Format Variations:**
   - PT1H30M ✅ Supported
   - PT90M ✅ Supported (equivalent)
   - PT2H ✅ Supported
   - PT0H15M ✅ Supported (15 minutes)
   - P1H30M ❌ Missing 'T' (rejected by regex)
   - 1H30M ❌ Missing 'PT' (rejected by regex)

### Idempotency

✅ **Idempotent:** String comparison is deterministic and order-independent.

### Safe References

✅ **Safe:** Direct variable reference, no nested object access that could fail on null.

### Conditional Logic

**Nested Merge Safety:**
- Parent condition checks: `os_profile != null || extensions_time_budget != null`
- Child condition checks: `extensions_time_budget != null`
- Prevents creating `virtualMachineProfile` with empty `extensionProfile`

### Interaction with Extensions

**Provider Code Context:**
```go
if v, ok := d.GetOk("extension"); ok {
    var err error
    virtualMachineProfile.ExtensionProfile, hasHealthExtension, err = expandOrchestratedVirtualMachineScaleSetExtensions(v.(*pluginsdk.Set).List())
    if err != nil {
        return err
    }
}

if hasHealthExtension {
    log.Printf("[DEBUG] Orchestrated %s has a Health Extension defined", id)
}

if v, ok := d.GetOk("extensions_time_budget"); ok {
    if virtualMachineProfile.ExtensionProfile == nil {
        virtualMachineProfile.ExtensionProfile = &virtualmachinescalesets.VirtualMachineScaleSetExtensionProfile{}
    }
    virtualMachineProfile.ExtensionProfile.ExtensionsTimeBudget = pointer.To(v.(string))
}
```

**Analysis:**
- Provider checks if `ExtensionProfile` is nil before setting `ExtensionsTimeBudget`
- Creates profile if needed (when no extensions defined but budget is set)
- Our implementation creates `extensionProfile` object conditionally when `extensions_time_budget` is set
- **Future note:** Task #43-56 will handle `extension` blocks, which will also populate `extensionProfile`
- **No conflict:** `merge()` will combine `extensionsTimeBudget` (this task) with `extensions` array (future tasks)

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ Not ForceNew (not in `replace_triggers_external_values`)
- ✅ Validation IMPLEMENTED in `variables.tf` (ISO 8601 duration PT15M to PT2H)
- ✅ Default value replicated (`"PT1H30M"`)
- ✅ Hidden fields checked (none found)
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ `track.md` ready to update
- ✅ Self-Review: Implementation only includes `extensions_time_budget` (Task #9), no fields from other tasks added

## Validation Approach

**Category:** Value Constraints (MANDATORY replication)

**Provider Validation:** `validate.ISO8601DurationBetween("PT15M", "PT2H")`

**Implementation Strategy:**
1. Regex validation for ISO 8601 duration format
2. Parse time components (hours, minutes)
3. Convert to minutes for range checking
4. Validate 15 ≤ total_minutes ≤ 120

**Why Not Defer to Azure API:**
- Azure API validation requires network round-trip (slow)
- Errors occur during apply phase (late detection)
- Poor user experience compared to immediate plan-time validation
- Provider does plan-time validation - we must replicate for parity
