# Task #93: os_disk.diff_disk_settings - STRUCTURE SKELETON

## Summary

Created structure skeleton for the `diff_disk_settings` block within `os_disk`. This is an optional ephemeral disk configuration block with comment placeholders for two child arguments (option and placement).

## Shadow Implementation

```hcl
locals {
  body = {
    properties = merge(
      var.orchestrated_virtual_machine_scale_set_sku_name != null ? {
        virtualMachineProfile = merge(
          var.orchestrated_virtual_machine_scale_set_data_disk != null || var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
            storageProfile = merge(
              var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
                osDisk = merge(
                  {
                    caching = var.orchestrated_virtual_machine_scale_set_os_disk.caching
                    managedDisk = merge(
                      {
                        storageAccountType = var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type
                      },
                      var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id != null && var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id != "" ? {
                        diskEncryptionSet = {
                          id = var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id
                        }
                      } : {}
                    )
                    diskSizeGB = var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb != null && var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb > 0 ? var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb : null
                    writeAcceleratorEnabled = var.orchestrated_virtual_machine_scale_set_os_disk.write_accelerator_enabled
                  },
                  var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? { # <-
                    diffDiskSettings = {                                                            # <-
                      # option = ... # Task #94                                                     # <-
                      # placement = ... # Task #95                                                  # <-
                    }                                                                               # <-
                  } : {}                                                                            # <-
                )
              } : {}
            )
          } : {}
        )
      } : {}
    )
  }
}
```

## Create Phase Verification

**Pattern:** Single-phase create with `CreateOrUpdateThenPoll`

**Evidence from Create method:**
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	virtualMachineProfile := virtualmachinescalesets.VirtualMachineScaleSetVMProfile{
		StorageProfile: &virtualmachinescalesets.VirtualMachineScaleSetStorageProfile{},
	}
	// ...
	if v, ok := d.GetOk("os_disk"); ok {
		virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)
	}
	// ...
	props.Properties.VirtualMachineProfile = &virtualMachineProfile
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Orchestrated %s: %w", id, err)
	}
}
```

**Classification:** The `os_disk` field (including `diff_disk_settings` block) is set in the `virtualMachineProfile.StorageProfile.OsDisk` before the single `CreateOrUpdateThenPoll` call. This is **Create phase** - implemented in `local.body`.

## Assignment Path Verification

**Predicted Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings`

**Evidence from Expand Function:**
```go
func ExpandOrchestratedVirtualMachineScaleSetOSDisk(input []interface{}, osType virtualmachinescalesets.OperatingSystemTypes) *virtualmachinescalesets.VirtualMachineScaleSetOSDisk {
	raw := input[0].(map[string]interface{})
	disk := virtualmachinescalesets.VirtualMachineScaleSetOSDisk{
		Caching: pointer.To(virtualmachinescalesets.CachingTypes(raw["caching"].(string))),
		ManagedDisk: &virtualmachinescalesets.VirtualMachineScaleSetManagedDiskParameters{
			StorageAccountType: pointer.To(virtualmachinescalesets.StorageAccountTypes(raw["storage_account_type"].(string))),
		},
		WriteAcceleratorEnabled: pointer.To(raw["write_accelerator_enabled"].(bool)),
		CreateOption: virtualmachinescalesets.DiskCreateOptionTypesFromImage,
	}
	// ...
	if diffDiskSettingsRaw := raw["diff_disk_settings"].([]interface{}); len(diffDiskSettingsRaw) > 0 && diffDiskSettingsRaw[0] != nil {
		diffDiskRaw := diffDiskSettingsRaw[0].(map[string]interface{})
		disk.DiffDiskSettings = &virtualmachinescalesets.DiffDiskSettings{
			Option:    pointer.To(virtualmachinescalesets.DiffDiskOptions(diffDiskRaw["option"].(string))),
			Placement: pointer.To(virtualmachinescalesets.DiffDiskPlacement(diffDiskRaw["placement"].(string))),
		}
	}
	return &disk
}
```

**Assignment Tracing:**
1. Expand function creates `disk.DiffDiskSettings` on `VirtualMachineScaleSetOSDisk` struct
2. In Create method: `virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(...)`
3. Then: `props.Properties.VirtualMachineProfile = &virtualMachineProfile`
4. Final path: `Properties.VirtualMachineProfile.StorageProfile.OsDisk.DiffDiskSettings`

**Verified Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings` ✅ **Match**

## Provider Schema

```go
"diff_disk_settings": {
	Type:     pluginsdk.TypeList,
	Optional: true,
	ForceNew: true,
	MaxItems: 1,
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			"option": {
				Type:     pluginsdk.TypeString,
				Required: true,
				ForceNew: true,
				ValidateFunc: validation.StringInSlice([]string{
					string(virtualmachinescalesets.DiffDiskOptionsLocal),
				}, false),
			},
			"placement": {
				Type:     pluginsdk.TypeString,
				Optional: true,
				ForceNew: true,
				Default:  string(virtualmachinescalesets.DiffDiskPlacementCacheDisk),
				ValidateFunc: validation.StringInSlice([]string{
					string(virtualmachinescalesets.DiffDiskPlacementCacheDisk),
					string(virtualmachinescalesets.DiffDiskPlacementResourceDisk),
				}, false),
			},
		},
	},
}
```

**Key Properties:**
- Type: List block (MaxItems: 1)
- Optional: true
- ForceNew: true (entire block)
- Contains 2 fields: `option` (Required, ForceNew), `placement` (Optional, ForceNew, Default: CacheDisk)

## Azure API Schema

**Query:** `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings`

**Result:** `ObjectWithOptionalAttrs(map[string]Type{"option":String, "placement":String}, []string{"option", "placement"})`

**Properties:**
- `option`: String (Required per provider schema)
- `placement`: String (Optional per provider schema, Default: "CacheDisk")

## Hidden Fields

**Check:** Reviewed the `ExpandOrchestratedVirtualMachineScaleSetOSDisk` expand function.

**Result:** No hidden fields detected. The expand function only sets:
- `option` from `diffDiskRaw["option"].(string)`
- `placement` from `diffDiskRaw["placement"].(string)`

Both fields map directly to Terraform schema fields and have corresponding child tasks (#94, #95).

## Mapping

| Terraform Field | Azure API Field |
|----------------|----------------|
| `diff_disk_settings` | `diffDiskSettings` |
| `diff_disk_settings.option` | `diffDiskSettings.option` (Task #94) |
| `diff_disk_settings.placement` | `diffDiskSettings.placement` (Task #95) |

## Special Handling

**ForceNew:** The entire `diff_disk_settings` block is marked `ForceNew: true` in provider schema. Both child arguments (`option` and `placement`) are also individually marked `ForceNew: true`. This will be handled in child tasks (#94, #95) by adding entries to `replace_triggers_external_values`.

**Conditional Block:** The block is optional. Implementation uses conditional merge: only include `diffDiskSettings` object when `var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null`.

**Default Value:** The `placement` field has a default value of `"CacheDisk"` in the provider schema. This will be handled in Task #95.

## Deferred Work Completion

Checked `following.md` - no work has been deferred to this task.

## Critical Review & Edge Cases

**Edge Case Analysis:**

1. **Null Semantics:** When `diff_disk_settings` is `null`, the entire `diffDiskSettings` object is omitted from the API request (using conditional merge with empty object fallback).

2. **Empty Collections:** The provider schema uses `MaxItems: 1` list. The expand function checks `len(diffDiskSettingsRaw) > 0 && diffDiskSettingsRaw[0] != nil`, handling empty list and null element cases gracefully.

3. **Idempotency:** The structure is idempotent - when the block is present, it always creates the same `diffDiskSettings` object structure. Child tasks will handle individual field idempotency.

4. **Safe References:** The implementation safely checks `var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null` before accessing the block, preventing null reference errors.

5. **Nested Merge:** The `osDisk` object now uses `merge()` to combine base fields with conditional `diffDiskSettings`, maintaining proper HCL structure and preventing field conflicts.

6. **Parent-Child Relationship:** The skeleton correctly nests within the existing `osDisk` structure, maintaining the proper hierarchy: `storageProfile` → `osDisk` → `diffDiskSettings`.

## Child Tasks Now Ready

The following child tasks are now ready for delegation:

- **Task #94:** `os_disk.diff_disk_settings.option` (Argument, Required, ForceNew)
- **Task #95:** `os_disk.diff_disk_settings.placement` (Argument, Optional, ForceNew, Default: CacheDisk)

## Checklist

- ✅ Property in correct local (`body`)
- ✅ Conditional merge pattern used for optional block
- ✅ Hidden fields checked (none found)
- ✅ Deferred work checked (none applicable)
- ✅ Critical review completed
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ track.md will be updated to Pending for check
- ✅ Self-Review: Only skeleton structure added, no individual field implementations (those belong to Tasks #94-95)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-10
**Task:** #93 - os_disk.diff_disk_settings

### Validation Results

✅ **Task Type:** Type 3 Block Structure Skeleton - correctly implemented with placeholders only
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, set before CreateOrUpdateThenPoll)
✅ **Assignment Path:** Correctly verified as `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings`
✅ **Conditional Structure:** Proper conditional merge pattern prevents null reference errors
✅ **Nested Merge:** Correctly nested within `osDisk` merge, no shallow merge issues
✅ **Skeleton Content:** Contains only comment placeholders for child tasks (#94, #95) - no premature implementation
✅ **ForceNew Handling:** Correctly deferred to child tasks (#94, #95) where individual fields will be tracked
✅ **Hidden Fields:** None found beyond documented child fields
✅ **Deferred Work Completion:** No deferred work for this task (verified in following.md)
✅ **Edge Cases:** Null semantics, safe references, and nested structure properly analyzed
✅ **Provider Schema Analysis:** Complete analysis with child field identification
✅ **Azure API Schema:** Correctly queried and documented

### Compliance Statement

This implementation EXACTLY follows executor.md requirements for Type 3 Block Structure Skeleton tasks. The executor correctly:
- Created only the conditional skeleton structure
- Did NOT implement child field values (those belong to Tasks #94, #95)
- Used proper merge patterns to avoid data loss
- Verified all paths with Go code evidence
- Documented comprehensively without premature implementation

No deviations, simplifications, or shortcuts found.

**Status:** APPROVED ✅

---
