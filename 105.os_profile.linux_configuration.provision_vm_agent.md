# Task #105: os_profile.linux_configuration.provision_vm_agent

## Summary
Implemented `provision_vm_agent` field in linux_configuration block as a standard ForceNew boolean field with default value `true`. The field maps to Azure API's `provisionVMAgent` property and controls whether the Azure VM Agent should be provisioned on VMs.

## Shadow Implementation

```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_os_profile" {
  type = object({
    linux_configuration = optional(object({
      provision_vm_agent = optional(bool, true)  # <-
    }))
  })
}

# migrate_main.tf - locals.body
linuxConfiguration = merge(
  {
    adminUsername                 = var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.admin_username
    disablePasswordAuthentication = var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.disable_password_authentication
    provisionVMAgent              = coalesce(var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent, true)  # <-
  },
  {
    patchSettings = {
      assessmentMode = var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_assessment_mode
      patchMode      = var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_mode
    }
  }
)

# migrate_main.tf - locals.replace_triggers_external_values
replace_triggers_external_values = {
  linux_configuration_provision_vm_agent = { value = var.orchestrated_virtual_machine_scale_set_os_profile != null && var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null ? coalesce(var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent, true) : true }  # <-
}
```

## Create Phase Verification

**Pattern Identification:** Single-phase Create

**Query:** `query_terraform_block_implementation_source_code(block_type="resource", terraform_type="azurerm_orchestrated_virtual_machine_scale_set", entrypoint_name="create")`

**Evidence from Create method:**
```go
if len(linConfigRaw) > 0 && linConfigRaw[0] != nil {
    osType = virtualmachinescalesets.OperatingSystemTypesLinux
    linConfig := linConfigRaw[0].(map[string]interface{})
    provisionVMAgent := linConfig["provision_vm_agent"].(bool)
    // ... validations ...
    vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithLinuxConfiguration(linConfig, customData)
    // ... more logic ...
}
```

**Evidence from expand function:**
```go
func expandOrchestratedVirtualMachineScaleSetOsProfileWithLinuxConfiguration(input map[string]interface{}, customData string) *virtualmachinescalesets.VirtualMachineScaleSetOSProfile {
    osProfile := virtualmachinescalesets.VirtualMachineScaleSetOSProfile{}
    linConfig := virtualmachinescalesets.LinuxConfiguration{}
    
    if len(input) > 0 {
        // ...
        linConfig.ProvisionVMAgent = pointer.To(input["provision_vm_agent"].(bool))
        // ...
    }
    
    osProfile.LinuxConfiguration = &linConfig
    return &osProfile
}
```

**Create call:**
```go
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Decision:** Field is set in Create phase (before the CreateOrUpdateThenPoll call) → Implement in `local.body`

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.osProfile.linuxConfiguration.provisionVMAgent`

**Evidence from Create method:**
```go
props := virtualmachinescalesets.VirtualMachineScaleSet{
    Location: location.Normalize(d.Get("location").(string)),
    Properties: &virtualmachinescalesets.VirtualMachineScaleSetProperties{
        // ...
    },
}

// Later:
virtualMachineProfile := virtualmachinescalesets.VirtualMachineScaleSetVMProfile{
    StorageProfile: &virtualmachinescalesets.VirtualMachineScaleSetStorageProfile{},
}

// Later:
osProfileRaw := d.Get("os_profile").([]interface{})
if len(osProfileRaw) > 0 && osProfileRaw[0] != nil {
    osProfile := osProfileRaw[0].(map[string]interface{})
    linConfigRaw := osProfile["linux_configuration"].([]interface{})
    
    if len(linConfigRaw) > 0 && linConfigRaw[0] != nil {
        linConfig := linConfigRaw[0].(map[string]interface{})
        vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithLinuxConfiguration(linConfig, customData)
    }
    
    vmssOsProfile.AllowExtensionOperations = pointer.To(extensionOperationsEnabled)
}

virtualMachineProfile.OsProfile = vmssOsProfile

// Finally:
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Traced assignments:**
1. `props.Properties` = pointer to `VirtualMachineScaleSetProperties`
2. `props.Properties.VirtualMachineProfile` = pointer to `virtualMachineProfile` (type `VirtualMachineScaleSetVMProfile`)
3. `virtualMachineProfile.OsProfile` = `vmssOsProfile` (type `VirtualMachineScaleSetOSProfile`)
4. `vmssOsProfile.LinuxConfiguration` = pointer to `linConfig` (type `LinuxConfiguration`)
5. `linConfig.ProvisionVMAgent` = pointer to bool value

**Verified Path:** `properties.virtualMachineProfile.osProfile.linuxConfiguration.provisionVMAgent`

**Path Comparison:** ✅ Match - Predicted path matches verified path

## Provider Schema

**Field Definition:**
```go
"provision_vm_agent": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  true,
    ForceNew: true,
},
```

**From:** `OrchestratedVirtualMachineScaleSetLinuxConfigurationSchema()` function

**Key Properties:**
- Type: Bool
- Optional: true
- Default: true
- ForceNew: true
- No DiffSuppressFunc
- No custom validation function

## Azure API Schema

**Query:** `query_azapi_resource_schema(resource_type="Microsoft.Compute/virtualMachineScaleSets", api_version="2024-11-01", path="body.properties.virtualMachineProfile.osProfile.linuxConfiguration")`

**Result:**
```
ObjectWithOptionalAttrs(map[string]Type{
    "provisionVMAgent": Bool,
    // ... other fields ...
}, []string{
    "provisionVMAgent",
    // ... other fields ...
})
```

**Property Type:** Bool (optional)

## Hidden Fields

None. The field is explicitly exposed in the provider schema.

## Mapping

**Terraform (snake_case)** → **Azure API (camelCase)**
- `provision_vm_agent` → `provisionVMAgent`

Standard boolean field, no transformation required beyond camelCase conversion.

## Special Handling

### 1. Default Value
**Provider Default:** `true` (specified in schema with `Default: true`)

**Implementation:** Applied using `optional(bool, true)` in variables.tf for automatic default handling, with additional `coalesce(var.provision_vm_agent, true)` in locals for safety.

### 2. ForceNew
**Provider Behavior:** `ForceNew: true` - Any change requires resource replacement

**Implementation:** Added to `replace_triggers_external_values` using Mode 1 (Direct Value Tracking):
```hcl
linux_configuration_provision_vm_agent = { 
    value = var.orchestrated_virtual_machine_scale_set_os_profile != null && 
            var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null ? 
            coalesce(var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent, true) : true 
}
```

Wrapped in object with stable key to ensure null ↔ non-null transitions are detected.

### 3. Cross-Field Validations (Already Implemented)

The following validations already exist in variables.tf from previous tasks:

**A. With extension_operations_enabled (Task #8):**
```hcl
validation {
    condition = (
        var.orchestrated_virtual_machine_scale_set_extension_operations_enabled == false ||
        (var.orchestrated_virtual_machine_scale_set_os_profile != null &&
         var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null &&
         var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent == false) == false
    )
    error_message = "`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false` in linux_configuration."
}
```

**B. With patch_assessment_mode (Task #103):**
```hcl
validation {
    condition = var.orchestrated_virtual_machine_scale_set_os_profile == null || 
                var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration == null || 
                var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_assessment_mode != "AutomaticByPlatform" || 
                var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent == true
    error_message = "When patch_assessment_mode is set to 'AutomaticByPlatform', provision_vm_agent must be set to true."
}
```

**C. With patch_mode (Task #104):**
```hcl
validation {
    condition = var.orchestrated_virtual_machine_scale_set_os_profile == null || 
                var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration == null || 
                var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_mode != "AutomaticByPlatform" || 
                var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent == true
    error_message = "When patch_mode is set to 'AutomaticByPlatform', provision_vm_agent must be set to true."
}
```

**Evidence from Create method:**
```go
provisionVMAgent := linConfig["provision_vm_agent"].(bool)

if extensionOperationsEnabled && !provisionVMAgent {
    return fmt.Errorf("`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false`")
}

if patchAssessmentMode == string(virtualmachinescalesets.LinuxPatchAssessmentModeAutomaticByPlatform) && !provisionVMAgent {
    return fmt.Errorf("when `patch_assessment_mode` is set to `%s`, `provision_vm_agent` must be set to `true`", virtualmachinescalesets.LinuxPatchAssessmentModeAutomaticByPlatform)
}

patchMode := linConfig["patch_mode"].(string)
if patchMode == string(virtualmachinescalesets.LinuxVMGuestPatchModeAutomaticByPlatform) {
    if !provisionVMAgent {
        return fmt.Errorf("when `patch_mode` is set to `%s`, `provision_vm_agent` must be set to `true`, got `%s`", patchMode, strconv.FormatBool(provisionVMAgent))
    }
}
```

All validations were already implemented by the owning tasks and are correctly replicated in variables.tf.

### 4. Update Behavior

**Evidence from Update method:**
```go
if d.HasChange("os_profile.0.linux_configuration.0.provision_vm_agent") {
    updateInstances = true
}

if d.HasChange("os_profile.0.linux_configuration.0.provision_vm_agent") {
    linuxConfig.ProvisionVMAgent = pointer.To(provisionVMAgent)
}
```

The Update method includes change tracking and update logic, but this is not relevant because the field is `ForceNew: true`. The resource will be replaced on any change, so the Update path will never be executed for this field's changes.

## Deferred Work Completion

**Check following.md:** No work deferred to Task #105.

## Critical Review & Edge Case Analysis

### Null Semantics
- **When null in config:** Defaults to `true` (via `optional(bool, true)`)
- **In locals:** Uses `coalesce(var.provision_vm_agent, true)` to ensure `true` when null
- **In replace_triggers:** Always evaluates to boolean (true or false), never null

### Boundary Conditions
- **Value false:** Valid - disables VM agent provisioning (requires extension_operations_enabled=false)
- **Value true:** Valid - enables VM agent provisioning (default behavior)
- **Field omitted:** Defaults to `true` via optional() syntax

### Idempotency
- ✅ Boolean field with deterministic default
- ✅ ForceNew tracking ensures changes are detected
- ✅ No ordering or state dependency issues

### Safe References
- ✅ Null checks: `var.os_profile != null && var.os_profile.linux_configuration != null`
- ✅ Coalesce: Ensures non-null boolean value in all code paths
- ✅ Default value: Matches provider default of `true`

### Type Safety
- ✅ Boolean type enforced in variables.tf
- ✅ No string-to-bool conversion required
- ✅ Azure API expects boolean (matches Terraform type)

### Validation Dependencies
All cross-field validations involving `provision_vm_agent` were already implemented by the owning tasks:
- Task #8 (extension_operations_enabled)
- Task #103 (patch_assessment_mode)
- Task #104 (patch_mode)

No new validations required for this task.

## Checklist

- ✅ Property in correct local (`body.properties.virtualMachineProfile.osProfile.linuxConfiguration.provisionVMAgent`)
- ✅ ForceNew wrapped: `{ value = ... }` in replace_triggers_external_values
- ✅ All logic EXACTLY replicated from provider (no shortcuts)
- ✅ Validations already implemented by other tasks (cross-checked and confirmed)
- ✅ Default value set: `optional(bool, true)` in variables.tf
- ✅ Hidden fields checked: None
- ✅ Deferred work checked: None in following.md
- ✅ Critical review completed: Null handling, defaults, ForceNew tracking
- ✅ Edge Case Analysis: Boundary conditions, idempotency, safe references
- ✅ Proof created: This document
- ✅ track.md will be updated to "Pending for check"
- ✅ Self-Review: Only provision_vm_agent field implemented, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-10
**Task:** #105 - os_profile.linux_configuration.provision_vm_agent

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew (schema `ForceNew: true`) correctly implemented using Mode 1 (Direct Value Tracking) with stable key wrapping
✅ **Stable Keys:** Key `linux_configuration_provision_vm_agent` is always present in `replace_triggers_external_values` with stable object wrapping
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase field)
✅ **Type Conversion:** Boolean type correctly preserved from Terraform to Azure API (no conversion needed)
✅ **Null Handling:** Correctly propagates null semantics with `coalesce(var.provision_vm_agent, true)` ensuring default value
✅ **Default Value:** Correctly implemented using PREFERRED method `optional(bool, true)` in variables.tf, matching provider's `Default: true`
✅ **Validations:** All cross-field validations already implemented by owning tasks (#8, #103, #104) - verified in variables.tf lines 411-423, 958-970
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled - null semantics, boundary conditions, idempotency verified
✅ **Assignment Path:** Correct path `properties.virtualMachineProfile.osProfile.linuxConfiguration.provisionVMAgent` with full trace evidence

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field uses the PREFERRED method for default values (`optional(bool, true)`), correctly implements ForceNew tracking with stable keys, and all cross-field validations were already implemented by the owning tasks. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
