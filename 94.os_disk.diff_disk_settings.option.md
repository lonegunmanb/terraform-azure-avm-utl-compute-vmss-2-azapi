# Task #94: os_disk.diff_disk_settings.option - IMPLEMENTATION

## Summary

Implemented the `option` field within the `diff_disk_settings` block of `os_disk`. This required field specifies the ephemeral disk option (only "Local" is supported) and includes validation, ForceNew trigger, and proper Azure API path mapping.

## Shadow Implementation

```hcl
# migrate_main.tf
locals {
  replace_triggers_external_values = {
    # ... other fields ...
    os_disk_diff_disk_settings_option = { value = var.orchestrated_virtual_machine_scale_set_os_disk != null && var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option : "" } # <-
  }

  body = {
    properties = merge(
      # ... other properties ...
      var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
        virtualMachineProfile = {
          storageProfile = {
            osDisk = merge(
              # ... base fields ...
              var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? {
                diffDiskSettings = {
                  option = var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option # <-
                  # placement = ... # Task #95
                }
              } : {}
            )
          }
        }
      } : {}
    )
  }
}
```

```hcl
# variables.tf - Added validation
variable "orchestrated_virtual_machine_scale_set_os_disk" {
  # ... existing type definition ...
  
  validation {
    condition = (
      var.orchestrated_virtual_machine_scale_set_os_disk == null ||
      var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings == null ||
      var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option == "Local" # <-
    )
    error_message = "The diff_disk_settings.option must be 'Local'." # <-
  }
}
```

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern Identified:** Single-phase create operation with `CreateOrUpdateThenPoll`

**Go Code Evidence:**
```go
if v, ok := d.GetOk("os_disk"); ok {
    virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)
}

// ... later in the function ...
props.Properties.VirtualMachineProfile = &virtualMachineProfile

// ...
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Classification:** The `os_disk.diff_disk_settings.option` field is set in the `virtualMachineProfile.StorageProfile.OsDisk` before the single `CreateOrUpdateThenPoll` call. This is **Create phase** - implemented in `local.body`.

**Decision:** Implement in `local.body` (not in `post_creation_updates`).

## Assignment Path Verification

**Predicted Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.option`

**Go Code Evidence - Expand Function:**
```go
func ExpandOrchestratedVirtualMachineScaleSetOSDisk(input []interface{}, osType virtualmachinescalesets.OperatingSystemTypes) *virtualmachinescalesets.VirtualMachineScaleSetOSDisk {
	raw := input[0].(map[string]interface{})
	disk := virtualmachinescalesets.VirtualMachineScaleSetOSDisk{
		// ... other fields ...
	}

	if diffDiskSettingsRaw := raw["diff_disk_settings"].([]interface{}); len(diffDiskSettingsRaw) > 0 && diffDiskSettingsRaw[0] != nil {
		diffDiskRaw := diffDiskSettingsRaw[0].(map[string]interface{})
		disk.DiffDiskSettings = &virtualmachinescalesets.DiffDiskSettings{
			Option:    pointer.To(virtualmachinescalesets.DiffDiskOptions(diffDiskRaw["option"].(string))),
			Placement: pointer.To(virtualmachinescalesets.DiffDiskPlacement(diffDiskRaw["placement"].(string))),
		}
	}

	return &disk
}
```

**Assignment Trace:**
1. Expand function reads `raw["diff_disk_settings"]` and creates `disk.DiffDiskSettings.Option`
2. Function returns `VirtualMachineScaleSetOSDisk` struct
3. In Create: `virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(...)`
4. Then: `props.Properties.VirtualMachineProfile = &virtualMachineProfile`
5. Final path: `Properties.VirtualMachineProfile.StorageProfile.OsDisk.DiffDiskSettings.Option`

**Verified Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.option` ✅ **Match**

## Provider Schema

**Source:** `query_terraform_block_implementation_source_code` with `entrypoint_name=schema`

```go
"diff_disk_settings": {
    Type:     pluginsdk.TypeList,
    Optional: true,
    ForceNew: true,
    MaxItems: 1,
    Elem: &pluginsdk.Resource{
        Schema: map[string]*pluginsdk.Schema{
            "option": {
                Type:     pluginsdk.TypeString,
                Required: true,
                ForceNew: true,
                ValidateFunc: validation.StringInSlice([]string{
                    string(virtualmachinescalesets.DiffDiskOptionsLocal),
                }, false),
            },
            "placement": {
                Type:     pluginsdk.TypeString,
                Optional: true,
                ForceNew: true,
                Default:  string(virtualmachinescalesets.DiffDiskPlacementCacheDisk),
                ValidateFunc: validation.StringInSlice([]string{
                    string(virtualmachinescalesets.DiffDiskPlacementCacheDisk),
                    string(virtualmachinescalesets.DiffDiskPlacementResourceDisk),
                }, false),
            },
        },
    },
},
```

**Key Characteristics:**
- **Type:** String (Required within the diff_disk_settings block)
- **ForceNew:** `true` - changes require resource replacement
- **Validation:** `StringInSlice` with only `"Local"` as valid value
- **Parent Block:** Optional with `MaxItems: 1`

## Azure API Schema

**Query Method:** `query_azapi_resource_schema` for full body structure

**API Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.option`

**Type in Azure API:** String (part of `diffDiskSettings` object)

The Azure API schema shows that `diffDiskSettings` is an optional object with `option` and `placement` properties. Both are strings representing the ephemeral disk configuration.

## Hidden Fields

**None.** The expand function only processes fields explicitly defined in the Terraform configuration. No additional hidden fields are set for `option`.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| `diff_disk_settings.option` | `diffDiskSettings.option` |

**Note:** The field name `option` remains the same in both Terraform and Azure API (no case conversion needed for this specific field name).

## Special Handling

### 1. Validation

**Implementation:** Added validation block in `variables.tf` to replicate provider's `StringInSlice` validation.

```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_os_disk == null ||
    var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings == null ||
    var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option == "Local"
  )
  error_message = "The diff_disk_settings.option must be 'Local'."
}
```

**Rationale:** The provider only accepts "Local" as a valid value. This validation ensures errors are caught at plan time, not during API calls.

### 2. ForceNew Trigger

**Implementation:** Added to `replace_triggers_external_values` using Mode 1 (Direct Value Tracking).

```hcl
os_disk_diff_disk_settings_option = { value = var.orchestrated_virtual_machine_scale_set_os_disk != null && var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option : "" }
```

**Rationale:** Provider schema marks `option` as `ForceNew: true`. Changes to this field require resource replacement. The key is always present (stable), and the value tracks the field's state.

**Null Handling:** When `diff_disk_settings` is null, the trigger value is empty string, ensuring the key remains stable across applies.

### 3. Field Assignment

**Implementation:** Direct assignment within the conditional `diffDiskSettings` object.

```hcl
var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? {
  diffDiskSettings = {
    option = var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option
    # placement = ... # Task #95
  }
} : {}
```

**Rationale:** The parent block skeleton (Task #93) already handles the conditional creation of `diffDiskSettings` object. This task simply adds the required `option` field.

## Deferred Work Completion

**Checked `following.md`:** No work was deferred to Task #94.

## Critical Review & Edge Cases

### Edge Case Analysis

1. **Null Semantics:**
   - When `diff_disk_settings` is `null`: Entire `diffDiskSettings` object is omitted (handled by parent block)
   - When `diff_disk_settings` is present: `option` is REQUIRED (cannot be null)
   - Implementation correctly handles both cases with proper null checks

2. **Validation Strength:**
   - Only "Local" is valid per provider schema
   - Validation implemented in `variables.tf` matches provider validation exactly
   - Error caught at plan time, not during apply

3. **ForceNew Behavior:**
   - Any change to `option` triggers replacement
   - Null → "Local" triggers replacement (correctly)
   - "Local" → null triggers replacement (correctly)
   - "Local" → "Local" no replacement (correctly)

4. **Safe References:**
   - Double null check: `var.orchestrated_virtual_machine_scale_set_os_disk != null && var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null`
   - Prevents null pointer errors when accessing nested field
   - Consistent pattern used in both body assignment and ForceNew trigger

5. **Idempotency:**
   - Field value is directly assigned without transformation
   - Same input always produces same output
   - No order-dependent operations

6. **Required Field Within Optional Block:**
   - Parent block (`diff_disk_settings`) is optional
   - When parent block is present, `option` is required
   - Terraform's type system enforces this constraint at the object level
   - No additional validation needed for "required within optional parent" scenario

## Checklist

- ✅ **Property in correct local:** `option` added to `local.body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.option`
- ✅ **ForceNew wrapped:** `{ value = ... }` pattern used in `replace_triggers_external_values`
- ✅ **All logic EXACTLY replicated:** Direct field assignment matches provider's expand function behavior
- ✅ **Validations IMPLEMENTED:** StringInSlice validation added to `variables.tf`
- ✅ **Hidden fields checked:** None found in expand function
- ✅ **Deferred work checked:** No work deferred to this task in `following.md`
- ✅ **Critical review:** Null handling, validation, ForceNew behavior all verified
- ✅ **Edge Case Analysis:** Documented above
- ✅ **Proof created:** This document
- ✅ **Assignment Path:** Correctly verified as `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.option`
- ✅ **Self-Review:** Only added `option` field implementation; did not add `placement` (belongs to Task #95)

---

**Task:** #94 - os_disk.diff_disk_settings.option  
**Status:** ✅ Completed  
**Type:** Block Argument (Required, ForceNew)  
**Phase:** Create phase in `local.body`

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-10
**Task:** #94 - os_disk.diff_disk_settings.option

### Validation Results

✅ **ForceNew Logic:** Schema-based ForceNew correctly implemented using Mode 1 (Direct Value Tracking) with `{ value = ... }` wrapping. Key is stable, value tracks field state with proper null handling (empty string when parent is null).

✅ **Stable Keys:** Key `os_disk_diff_disk_settings_option` always present in `replace_triggers_external_values`. No conditional key appearance/disappearance.

✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase). Single-phase create operation confirmed via Go code evidence.

✅ **Type Conversion:** Direct string assignment - no conversion needed. Matches Azure API schema.

✅ **Null Handling:** Proper null checks: `var.orchestrated_virtual_machine_scale_set_os_disk != null && var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null` before accessing nested field. Prevents null pointer errors.

✅ **Validations:** StringInSlice validation correctly replicated in `variables.tf` (lines 873-878). Only "Local" accepted, matching provider schema exactly. Error message clear and accurate.

✅ **Assignment Path:** Correctly verified as `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.option`. Proper nesting within conditional parent block (Task #93 skeleton).

✅ **Deferred Work Completion:** No work deferred to this task in `following.md`.

✅ **Edge Cases:** All edge cases properly analyzed in proof document:
- Null semantics (parent null = omit entire object, field is required when parent exists)
- Validation strength (only "Local" valid, caught at plan time)
- ForceNew behavior (all transitions handled correctly)
- Safe references (double null check pattern)
- Idempotency (direct assignment, no transformations)

✅ **Scope Compliance:** Only implements `option` field. Does not prematurely add `placement` (belongs to Task #95). Clean implementation without scope creep.

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:
- ForceNew trigger uses prescribed Mode 1 method (schema ForceNew: true → wrapped value tracking)
- Validation replicates provider's StringInSlice with identical constraint ("Local" only)
- Assignment path matches provider's expand function structure precisely
- No deviations, simplifications, or "safer alternatives"
- All null checks and edge cases properly handled

**Status:** APPROVED ✅

---
