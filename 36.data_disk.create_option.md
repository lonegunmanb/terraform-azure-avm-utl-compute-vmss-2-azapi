# Task #36 - data_disk.create_option

## Summary

Implemented the optional `create_option` argument for the `data_disk` block with a default value of "Empty". This field specifies the creation method for each data disk (Empty for new disk, FromImage for disk from source image).

## Shadow Implementation

```hcl
locals {
  body = {
    properties = {
      virtualMachineProfile = {
        storageProfile = {
          dataDisks = [
            for data_disk in var.orchestrated_virtual_machine_scale_set_data_disk : {
              createOption = data_disk.create_option # <-
            }
          ]
        }
      }
    }
  }
}
```

```hcl
variable "orchestrated_virtual_machine_scale_set_data_disk" {
  type = list(object({
    create_option = optional(string, "Empty") # <-
    # ... other fields
  }))
  
  validation { # <-
    condition = ( # <-
      var.orchestrated_virtual_machine_scale_set_data_disk == null || # <-
      alltrue([ # <-
        for disk in var.orchestrated_virtual_machine_scale_set_data_disk : # <-
        contains(["Empty", "FromImage"], disk.create_option) # <-
      ]) # <-
    ) # <-
    error_message = "The create_option must be one of: Empty, FromImage." # <-
  } # <-
}
```

## Create Phase Verification

**Pattern:** Single-phase creation

**Evidence from Create method:**

```go
if v, ok := d.GetOk("data_disk"); ok {
    ultraSSDEnabled := d.Get("additional_capabilities.0.ultra_ssd_enabled").(bool)
    dataDisks, err := ExpandOrchestratedVirtualMachineScaleSetDataDisk(v.([]interface{}), ultraSSDEnabled)
    if err != nil {
        return fmt.Errorf("expanding `data_disk`: %w", err)
    }
    virtualMachineProfile.StorageProfile.DataDisks = dataDisks
}
```

**Classification:** Create phase - The entire `data_disk` block including the `create_option` field is expanded and assigned to `virtualMachineProfile.StorageProfile.DataDisks` before the `CreateOrUpdateThenPoll` call.

**Decision:** Implement in `local.body`

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.storageProfile.dataDisks[].createOption`

**Tracing Assignment from Expand Function:**

```go
func ExpandOrchestratedVirtualMachineScaleSetDataDisk(input []interface{}, ultraSSDEnabled bool) (*[]virtualmachinescalesets.VirtualMachineScaleSetDataDisk, error) {
    disks := make([]virtualmachinescalesets.VirtualMachineScaleSetDataDisk, 0)
    
    for _, v := range input {
        raw := v.(map[string]interface{})
        
        disk := virtualmachinescalesets.VirtualMachineScaleSetDataDisk{
            Caching: pointer.To(virtualmachinescalesets.CachingTypes(raw["caching"].(string))),
            ManagedDisk: &virtualmachinescalesets.VirtualMachineScaleSetManagedDiskParameters{
                StorageAccountType: pointer.To(storageAccountType),
            },
            WriteAcceleratorEnabled: pointer.To(raw["write_accelerator_enabled"].(bool)),
            CreateOption:            virtualmachinescalesets.DiskCreateOptionTypes(raw["create_option"].(string)),
        }
        
        disks = append(disks, disk)
    }
    
    return &disks, nil
}
```

**Assignment Chain:**
1. `CreateOption: virtualmachinescalesets.DiskCreateOptionTypes(raw["create_option"].(string))` → Sets `CreateOption` field on disk struct
2. `virtualMachineProfile.StorageProfile.DataDisks = dataDisks` → Assigns to `StorageProfile.DataDisks`
3. `props.Properties.VirtualMachineProfile = &virtualMachineProfile` → Wraps in VirtualMachineProfile
4. Final API payload: `properties.virtualMachineProfile.storageProfile.dataDisks[].createOption`

**Verified Path:** `properties.virtualMachineProfile.storageProfile.dataDisks[].createOption` ✅

**Path Comparison:** Predicted path matches verified path.

## Provider Schema

```go
"create_option": {
    Type:     pluginsdk.TypeString,
    Optional: true,
    ValidateFunc: validation.StringInSlice([]string{
        string(virtualmachinescalesets.DiskCreateOptionTypesEmpty),
        string(virtualmachinescalesets.DiskCreateOptionTypesFromImage),
    }, false),
    Default: string(virtualmachinescalesets.DiskCreateOptionTypesEmpty),
},
```

**Key Properties:**
- **Type:** String
- **Required:** No (Optional)
- **ForceNew:** No
- **Validation:** Must be one of: `Empty`, `FromImage`
- **Default:** `Empty`
- **Computed:** No

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

**Property Path:** `body.properties.virtualMachineProfile.storageProfile.dataDisks[].createOption`

**Type:** String (optional in API schema)

**Valid Values:** Empty, FromImage

**Description:** Specifies how the data disk should be created. Empty creates a new empty disk. FromImage creates the disk from the data disk in the source image (only applicable when source image includes data disks).

## Hidden Fields

No hidden fields detected. The expand function shows the field is assigned directly without any additional hidden properties or special logic.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|----------------------|-------|
| `create_option` | `createOption` | Standard snake_case to camelCase conversion |

## Special Handling

### Validation

**Provider Validation:** The provider enforces an enum validation requiring the value to be one of `Empty` or `FromImage`.

**Implementation in variables.tf:**

```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_data_disk == null ||
    alltrue([
      for disk in var.orchestrated_virtual_machine_scale_set_data_disk :
      disk.create_option == null || contains(["Empty", "FromImage"], disk.create_option)
    ])
  )
  error_message = "The create_option must be one of: Empty, FromImage."
}
```

This validation:
- Allows null for the entire data_disk list
- Validates each disk's create_option value (guaranteed non-null due to `optional(string, "Empty")`)
- Uses `alltrue()` to ensure ALL disks have valid create_option values
- Replicates the exact provider validation

### Default Value

**Provider Default:** The schema specifies `Default: string(virtualmachinescalesets.DiskCreateOptionTypesEmpty)` which is "Empty".

**Implementation:** Using `optional(string, "Empty")` in the type definition per executor.md method priority (PREFER nested optional with default over fallback coalesce in locals). This ensures the field is always non-null with the default "Empty" value when not explicitly specified by the user.

**Why `optional(string, "Empty")` is correct:** Per executor.md lines 124-127 and checker.md lines 97-126, the PREFERRED method for defaults in nested blocks is `optional(type, default)` in the object type definition. The fallback `coalesce()` in locals should ONLY be used when the optional() syntax is technically impossible. Since we're in a `list(object({...}))` structure and `optional(string, "Empty")` works perfectly at any nesting depth, this is the correct approach.

### ForceNew

**Analysis:** The schema does NOT have `ForceNew: true` for this field, and there is no CustomizeDiff logic affecting it.

**Implementation:** No ForceNew handling required. The field can be updated in-place.

### Sensitive

**Analysis:** Not a sensitive field. It's a simple disk creation mode setting.

**Implementation:** Field is placed in `local.body`, not `local.sensitive_body`.

## Deferred Work Completion

**Check following.md:** No following.md file exists, indicating no work has been deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics

- **Field Level:** The `create_option` field is OPTIONAL within each data disk object. When not specified, the default "Empty" is applied via `optional(string, "Empty")` in the type definition.
- **List Level:** The entire `data_disk` list can be null, meaning no data disks are configured.
- **Empty String:** Not possible due to validation - empty string would fail the enum check.
- **Default Application:** `optional(string, "Empty")` ensures the field is always non-null with "Empty" as the default, matching provider's default behavior.

### Boundary Conditions

- **Valid Values:** Validation ensures only "Empty" or "FromImage" are accepted.
- **Case Sensitivity:** The Azure API enum values use PascalCase format. Provider constants match these exactly.
- **FromImage Usage:** According to documentation, "FromImage" should only be used if the source image includes data disks. This is a semantic constraint but not enforced by the provider.

### Idempotency

- **Direct Assignment with Default:** The field uses `optional(string, "Empty")` in type definition, ensuring consistent non-null behavior across applies.
- **No State Dependencies:** The create_option value doesn't depend on any other state or computed values (except the default).
- **Array Iteration:** Using `for` expression ensures consistent ordering based on input list order.
- **Null Handling:** Terraform's `optional(string, "Empty")` ensures the field is always non-null with the default value.

### Safe References

- **Null Check:** The parent conditional `var.orchestrated_virtual_machine_scale_set_data_disk != null` protects against null list references.
- **Field Access:** `data_disk.create_option` is safe because it's defined as `optional(string, "Empty")` in the object type, guaranteeing a non-null value.
- **No Nested Access:** Direct field access with no deep nesting.

### Edge Cases Handled

1. **Null data_disk list:** The parent conditional handles this by skipping the entire dataDisks array.
2. **Empty data_disk list:** Results in an empty `dataDisks` array `[]`, which is valid.
3. **Unspecified create_option:** Handled by `optional(string, "Empty")` which applies the default "Empty" value automatically.
4. **Invalid create_option value:** Caught by validation block at plan time.
5. **Mixed create_option values:** Supported - each disk can have a different creation mode.
6. **Explicit "Empty" vs unspecified:** Both result in the same value "Empty", ensuring idempotency.

### Provider Behavior Match

The implementation exactly replicates provider behavior:
- Optional field within data_disk objects
- Enum validation for valid values (Empty, FromImage)
- Default value of "Empty" when not specified
- Direct assignment with no transformations
- Not ForceNew (can be updated)
- Applied in Create phase (not post-creation update)

**Exact Replication Confirmed:** The implementation uses `optional(string, "Empty")` to replicate the provider's `Default:` schema property exactly as the provider's expand function expects the field to have a value (it doesn't check for nil before casting to string). Using the PREFER method per executor.md ensures correct behavior without runtime coalesce operations.

## Checklist

- ✅ Property in correct local (`body`)
- ✅ Validation IMPLEMENTED in variables.tf (MANDATORY)
- ✅ Default value applied using `optional(string, "Empty")` per executor.md PREFER method (not fallback coalesce)
- ✅ Not ForceNew (no wrapping needed)
- ✅ Hidden fields checked (none found)
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis documented
- ✅ Proof created
- ✅ Logic EXACTLY replicated from provider (no shortcuts)
- ✅ Self-Review: Added ONLY what Task #36 requires (data_disk.create_option field)
- ✅ Deferred work checked (no following.md exists, no deferred work)

---

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-08
**Task:** #36 - data_disk.create_option

### Issues Identified

#### Issue 1: Incorrect Default Value Implementation Method

**Problem:**
Executor used the **Fallback method** (`coalesce()` in locals) when the **PREFER method** (`optional(string, "Empty")` in type definition) was technically possible. This violates executor.md method priority rules (lines 124-127) and checker.md explicit guidance (lines 97-126).

**Executor's Original Implementation:**
```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_data_disk" {
  type = list(object({
    create_option = optional(string)
    # ...
  }))
  validation {
    condition = (
      var.orchestrated_virtual_machine_scale_set_data_disk == null ||
      alltrue([
        for disk in var.orchestrated_virtual_machine_scale_set_data_disk :
        disk.create_option == null || contains(["Empty", "FromImage"], disk.create_option)
      ])
    )
    error_message = "The create_option must be one of: Empty, FromImage."
  }
}

# migrate_main.tf
createOption = coalesce(data_disk.create_option, "Empty")
```

**Why This Violates executor.md:**
From executor.md lines 124-127:
> **Defaults:** If schema has `Default`, replicate it:
> - **Top-level:** `variable "field" { default = value }`
> - **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
> - **Fallback:** Apply default in locals if optional() syntax not possible

From checker.md lines 97-126:
> **Method Priority:**
> ```
> PREFER: optional(string, "default") in object type
>    ↓
> Fallback: coalesce() in locals (ONLY if optional() impossible)
> ```
> 
> **Common Violation:**
> ```hcl
> # ❌ WRONG
> type = list(object({ field = optional(string) }))
> # In locals: coalesce(obj.field, "default")
> 
> # ✅ CORRECT
> type = list(object({ field = optional(string, "default") }))
> # In locals: obj.field  # Guaranteed non-null
> ```

**Provider's Actual Behavior:**
The provider schema shows:
```go
"create_option": {
    Type:     pluginsdk.TypeString,
    Optional: true,
    Default:  string(virtualmachinescalesets.DiskCreateOptionTypesEmpty), // "Empty"
}
```

The provider guarantees this field has a value via the Default property. The expand function expects a non-nil value (directly casts to string without nil check).

**Expected Behavior:**
- Field declared as `optional(string, "Empty")` in type definition
- No runtime coalesce needed - default applied by Terraform type system
- Validation checks actual values (field guaranteed non-null)
- Direct assignment in locals: `createOption = data_disk.create_option`

**Root Cause:**
Executor incorrectly chose the Fallback method when the PREFER method was not only possible, but the correct approach. The field is in a `list(object({...}))` structure, and `optional(type, default)` works perfectly at any nesting depth per Terraform 1.3+ capabilities documented in checker.md.

### Corrections Made

#### Fix 1: Use PREFER Method for Default Value

**Changed Files:**
- `variables.tf`: Changed type definition from `optional(string)` to `optional(string, "Empty")`
- `variables.tf`: Updated validation to remove unnecessary `disk.create_option == null` check (field guaranteed non-null)
- `migrate_main.tf`: Changed from `coalesce(data_disk.create_option, "Empty")` to `data_disk.create_option`
- `36.data_disk.create_option.md`: Updated all explanations to reflect correct method

**New Implementation:**
```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_data_disk" {
  type = list(object({
    create_option = optional(string, "Empty")
    # ...
  }))
  validation {
    condition = (
      var.orchestrated_virtual_machine_scale_set_data_disk == null ||
      alltrue([
        for disk in var.orchestrated_virtual_machine_scale_set_data_disk :
        contains(["Empty", "FromImage"], disk.create_option)
      ])
    )
    error_message = "The create_option must be one of: Empty, FromImage."
  }
}

# migrate_main.tf
createOption = data_disk.create_option
```

**Why This is EXACT:**
1. **Follows Method Priority:** Uses PREFER method (`optional(string, "Empty")`) instead of Fallback
2. **Type System Guarantee:** Terraform's type system ensures field is always non-null with default value
3. **Cleaner Implementation:** No runtime coalesce needed - default applied automatically
4. **Matches Provider Behavior:** Provider's `Default:` property guarantees non-nil value, our type system does the same
5. **Better Performance:** Default applied at type level, not runtime evaluation
6. **Correct per checker.md:** This exact pattern is shown as the "✅ CORRECT" implementation

**Verification:**
- Scenario 1: User omits create_option → Value is "Empty" (type default) ✅
- Scenario 2: User sets create_option = "Empty" → Value is "Empty" ✅
- Scenario 3: User sets create_option = "FromImage" → Value is "FromImage" ✅
- Scenario 4: Field guaranteed non-null in all cases ✅
- Scenario 5: Validation correctly checks values (no null check needed) ✅

### Validation Results

✅ **ForceNew Logic:** Not applicable (not ForceNew)
✅ **Stable Keys:** Not applicable (not in replace_triggers_external_values)
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Direct string assignment, no conversion needed
✅ **Null Handling:** Correctly uses `optional(string, "Empty")` to guarantee non-null
✅ **Validations:** All provider validations implemented in variables.tf (enum check)
✅ **Deferred Work Completion:** No following.md exists, no deferred work
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** All edge cases properly analyzed and handled
✅ **Method Priority Compliance:** NOW uses PREFER method (corrected from Fallback)

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`, using the correct method priority (PREFER `optional(string, "Empty")` over Fallback coalesce).

**Status:** CORRECTED AND APPROVED ✅

---
