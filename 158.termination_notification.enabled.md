# Task #158: termination_notification.enabled

## Summary
Implemented `enabled` field within `termination_notification` block. This Required boolean argument maps to Azure API `enable` field and controls whether termination notification is enabled on the Virtual Machine Scale Set. The field is updatable and placed in `local.body` during Create phase.

## Shadow Implementation

```hcl
var.orchestrated_virtual_machine_scale_set_termination_notification != null ? {
  scheduledEventsProfile = {
    terminateNotificationProfile = {
      enable = var.orchestrated_virtual_machine_scale_set_termination_notification.enabled # <-
      # notBeforeTimeout = ... # Task #159
    }
  }
} : {}
```

## Create Phase Verification

### Pattern Identification
Queried Create method to identify creation pattern.

**Create Method Evidence:**
```go
if v, ok := d.GetOk("termination_notification"); ok {
    virtualMachineProfile.ScheduledEventsProfile = ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile(v.([]interface{}))
}

// Later in the function:
if !isLegacy {
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
}

// Single-phase pattern:
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Decision:** Single-phase Create - field is set in `virtualMachineProfile.ScheduledEventsProfile` before the single `CreateOrUpdateThenPoll` call. Field goes in `local.body`.

## Assignment Path Verification

### Predicted Path
`properties.virtualMachineProfile.scheduledEventsProfile.terminateNotificationProfile.enable`

### Provider Code Evidence
```go
// From ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile function:
func ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile(input []interface{}) *virtualmachinescalesets.ScheduledEventsProfile {
    if len(input) == 0 {
        return nil
    }

    raw := input[0].(map[string]interface{})
    enabled := raw["enabled"].(bool)
    timeout := raw["timeout"].(string)

    return &virtualmachinescalesets.ScheduledEventsProfile{
        TerminateNotificationProfile: &virtualmachinescalesets.TerminateNotificationProfile{
            Enable:           &enabled,  // <-- Field assigned here
            NotBeforeTimeout: &timeout,
        },
    }
}

// In Create method:
virtualMachineProfile.ScheduledEventsProfile = ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile(v.([]interface{}))

// Assignment chain:
// 1. virtualMachineProfile.ScheduledEventsProfile (local variable)
// 2. props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

### Verified Path
`properties.virtualMachineProfile.scheduledEventsProfile.terminateNotificationProfile.enable`

### Path Comparison
✅ **MATCH** - Predicted path matches verified path exactly.

## Provider Schema

**From AzureRM Provider Schema:**
```go
"termination_notification": OrchestratedVirtualMachineScaleSetTerminationNotificationSchema(),

func OrchestratedVirtualMachineScaleSetTerminationNotificationSchema() *pluginsdk.Schema {
    return &pluginsdk.Schema{
        Type:     pluginsdk.TypeList,
        Optional: true,
        Computed: true,
        MaxItems: 1,
        Elem: &pluginsdk.Resource{
            Schema: map[string]*pluginsdk.Schema{
                "enabled": {
                    Type:     pluginsdk.TypeBool,
                    Required: true,  // <-- Required field
                },
                "timeout": {
                    Type:         pluginsdk.TypeString,
                    Optional:     true,
                    ValidateFunc: azValidate.ISO8601DurationBetween("PT5M", "PT15M"),
                    Default:      "PT5M",
                },
            },
        },
    }
}
```

**Key Details:**
- Type: Bool
- Required: true
- No validations (boolean values are inherently validated by type system)
- No ForceNew: Not present in schema
- No DiffSuppressFunc
- No Default

## Azure API Schema

**From Azure API Schema:**
```
Query: Microsoft.Compute/virtualMachineScaleSets@2024-11-01
Path: body.properties.virtualMachineProfile.scheduledEventsProfile.terminateNotificationProfile.enable
Result: Bool
```

**Key Details:**
- Type: Bool (optional in Azure API)
- Path: `properties.virtualMachineProfile.scheduledEventsProfile.terminateNotificationProfile.enable`
- No restrictions or validation constraints

## Hidden Fields Check

**Expand Function Analysis:**
```go
func ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile(input []interface{}) *virtualmachinescalesets.ScheduledEventsProfile {
    if len(input) == 0 {
        return nil
    }

    raw := input[0].(map[string]interface{})
    enabled := raw["enabled"].(bool)  // Direct extraction, no hidden logic
    timeout := raw["timeout"].(string)

    return &virtualmachinescalesets.ScheduledEventsProfile{
        TerminateNotificationProfile: &virtualmachinescalesets.TerminateNotificationProfile{
            Enable:           &enabled,  // Direct assignment
            NotBeforeTimeout: &timeout,
        },
    }
}
```

**Hidden Fields Found:** ❌ None

The expand function performs direct extraction and assignment with no hardcoded values, no conditional logic, and no additional fields.

## Mapping

**Terraform (snake_case) → Azure API (camelCase):**
- `enabled` → `enable`

## Special Handling

### No ForceNew
**Schema Check:**
```go
"enabled": {
    Type:     pluginsdk.TypeBool,
    Required: true,
    // No ForceNew: true
},
```

**CustomizeDiff Check:**
Reviewed the complete resource function - no CustomizeDiff logic for `termination_notification` or `enabled` field.

**Conclusion:** Field is updatable, no ForceNew handling required.

### No Validation
Boolean field requires no validation - type system enforces valid values (true/false).

### No Sensitive
Field is not marked as Sensitive or WriteOnly - goes in `local.body`, not `local.sensitive_body`.

### Update Method Check
**Update Method Evidence:**
```go
if d.HasChange("termination_notification") {
    notificationRaw := d.Get("termination_notification").([]interface{})
    updateProps.VirtualMachineProfile.ScheduledEventsProfile = ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile(notificationRaw)
}
```

**Conclusion:** Field is fully updatable via Update method. No directional restrictions or conditional ForceNew logic.

## Deferred Work Completion
**No deferred work:** Checked `following.md` - no work was deferred to Task #158.

## Critical Review & Edge Case Analysis

### Null Semantics
- **Field level**: `enabled` is Required, cannot be null within the parent block
- **Parent level**: When `var.orchestrated_virtual_machine_scale_set_termination_notification` is null, the entire block is omitted (handled by Task #157 skeleton)
- **Terraform behavior**: Type system enforces non-null value for required boolean field
- **Azure API behavior**: API accepts boolean value when parent block is present

### Boundary Conditions
- **Boolean values**: Only `true` or `false` allowed (enforced by Terraform type system)
- **Parent block presence**: Field only included when parent variable is not null (conditional handled by skeleton)
- **Required field**: Must be provided by user when parent block is configured

### Idempotency
- **Same input → Same output**: `enabled = true` always produces `enable: true` in API payload
- **No ordering issues**: Single boolean value, no collection ordering concerns
- **Deterministic**: Boolean assignment is always deterministic

### Safe References
- **Parent null check**: Protected by skeleton's `var.orchestrated_virtual_machine_scale_set_termination_notification != null` check
- **Field access**: Safe to access `.enabled` because parent null check prevents execution when parent is null
- **No nested navigation**: Direct field access with no intermediate nullable objects

### Edge Cases
1. **Required field omission**: Terraform validation will catch this before reaching our module
2. **Type mismatch**: Terraform type system enforces boolean type
3. **Parent block without required field**: Terraform validates Required fields in parent block schema

## Checklist
- ✅ Property added to correct local (`local.body`)
- ✅ ForceNew checked: Not required (field is updatable)
- ✅ Implementation exactly matches provider behavior (direct boolean assignment)
- ✅ No validations to implement (boolean type is self-validating)
- ✅ Hidden fields checked in expand function (none found)
- ✅ Deferred work checked in `following.md` (none found)
- ✅ Critical review completed (null semantics, boundary conditions, idempotency, safe references)
- ✅ Edge case analysis documented
- ✅ Proof document created
- ✅ Self-review: Added ONLY `enabled` field implementation for Task #158
- ✅ Track.md ready to be updated to "Pending for check"

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent  
**Date:** 2025-12-11  
**Task:** #158 - termination_notification.enabled

### Validation Results

✅ **ForceNew Logic:** No ForceNew required (field is updatable)  
✅ **Stable Keys:** N/A - field not in replace_triggers_external_values  
✅ **Phase Detection:** Field correctly placed in local.body (Create phase)  
✅ **Type Conversion:** Correct conversion from boolean to boolean (enabled → enable)  
✅ **Null Handling:** Correctly propagates null semantics via parent block check  
✅ **Validations:** None required (boolean type self-validates)  
✅ **Deferred Work Completion:** No deferred work for this task  
✅ **Deferred Work Recording:** No deferrals made  
✅ **Edge Cases:** All edge cases properly analyzed and handled  

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The boolean field is directly assigned within the correct parent structure, matches the provider's expand function logic exactly, and is correctly placed in the Create phase body.

**Status:** APPROVED ✅

---

