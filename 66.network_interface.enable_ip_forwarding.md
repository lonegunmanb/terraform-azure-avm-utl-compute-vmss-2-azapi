# Task #66: network_interface.enable_ip_forwarding

## Summary

Implemented the `enable_ip_forwarding` argument within the `network_interface` block for `azurerm_orchestrated_virtual_machine_scale_set`. This boolean field controls whether IP forwarding is enabled on the network interface, with a default value of `false`. The field is directly assigned to the Azure API property `enableIPForwarding` within the network interface configuration properties.

## Shadow Implementation

```hcl
# In migrate_main.tf
locals {
  body = {
    properties = {
      virtualMachineProfile = {
        networkProfile = {
          networkInterfaceConfigurations = [
            for nic in var.orchestrated_virtual_machine_scale_set_network_interface : {
              name = nic.name
              properties = {
                enableAcceleratedNetworking = nic.enable_accelerated_networking
                enableIPForwarding          = nic.enable_ip_forwarding # <-
              }
            }
          ]
        }
      }
    }
  }
}
```

```hcl
# In variables.tf
variable "orchestrated_virtual_machine_scale_set_network_interface" {
  type = list(object({
    enable_ip_forwarding = optional(bool, false) # <-
  }))
}
```

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern Identified:** Single-phase creation pattern

**Go Code Evidence:**
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    if v, ok := d.GetOk("network_interface"); ok {
        networkInterfaces, err := ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(v.([]interface{}))
        if err != nil {
            return fmt.Errorf("expanding `network_interface`: %w", err)
        }

        networkProfile.NetworkInterfaceConfigurations = networkInterfaces
        virtualMachineProfile.NetworkProfile = networkProfile
    }
    // ...
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    // ...
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Classification:** Create phase - field is set before the CreateOrUpdateThenPoll call

**Decision:** Field goes in `local.body` (not `local.post_creation_updates`)

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.enableIPForwarding`

**Go Code Evidence from ExpandOrchestratedVirtualMachineScaleSetNetworkInterface:**
```go
func ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(input []interface{}) (*[]virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration, error) {
    output := make([]virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration, 0)

    for _, v := range input {
        raw := v.(map[string]interface{})
        // ...
        config := virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration{
            Name: raw["name"].(string),
            Properties: &virtualmachinescalesets.VirtualMachineScaleSetNetworkConfigurationProperties{
                EnableAcceleratedNetworking: pointer.To(raw["enable_accelerated_networking"].(bool)),
                EnableIPForwarding:          pointer.To(raw["enable_ip_forwarding"].(bool)),
                // ...
            },
        }
        // ...
        output = append(output, config)
    }

    return &output, nil
}
```

**Assignment Trace:**
1. `ExpandOrchestratedVirtualMachineScaleSetNetworkInterface` creates config with `.Properties.EnableIPForwarding`
2. Assigned to `networkProfile.NetworkInterfaceConfigurations`
3. `virtualMachineProfile.NetworkProfile = networkProfile`
4. `props.Properties.VirtualMachineProfile = &virtualMachineProfile`

**Verified Path:** `properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.enableIPForwarding`

**Path Comparison:** ✅ MATCH - Predicted path matches the actual assignment path

## Provider Schema

**From Schema Query:**
```go
"enable_ip_forwarding": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
},
```

**Field Details:**
- **Type:** Bool
- **Required:** false (Optional)
- **Default:** false
- **ForceNew:** Not specified (false)
- **Computed:** Not specified (false)
- **ValidateFunc:** None
- **DiffSuppressFunc:** None

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

**Property Path:** `body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.enableIPForwarding`

**Azure API Type:** Bool

## Hidden Fields

None. Field is explicitly defined in provider schema.

## Mapping

| Terraform Field | Azure API Property |
|----------------|-------------------|
| `enable_ip_forwarding` | `enableIPForwarding` |

**Naming Convention:** snake_case → camelCase

## Special Handling

### Default Value
- **Provider Default:** `false`
- **Implementation in variables.tf:** `optional(bool, false)` - PREFER method
- **Implementation in locals:** Direct assignment `nic.enable_ip_forwarding` - default already guaranteed by optional()

### ForceNew
- **Schema:** No `ForceNew: true` in schema
- **CustomizeDiff:** Checked resource function - no CustomizeDiff logic found for this field
- **Decision:** NOT a ForceNew field, no entry in `replace_triggers_external_values`

### Validation
**From variables.tf:**
```hcl
enable_ip_forwarding = optional(bool, false)
```

**Validation in Provider:** None - only type validation (bool)

**Implementation:** No validation needed beyond Terraform type system. The field accepts true/false values only.

### Sensitive Fields
- **Not Sensitive:** This field is not marked as sensitive or writeonly
- **Implementation:** Field placed in `local.body` (not `local.sensitive_body`)

## Deferred Work Completion

Checked for deferred work:
- No `following.md` file exists
- No deferred work for this task

## Critical Review & Edge Case Analysis

### Null Semantics
- **Null Meaning:** Use default value (false)
- **Implementation:** `optional(bool, false)` in variable definition guarantees field is never null
- **Provider Behavior:** Schema has `Default: false`, so null values are replaced with false

### Edge Cases
1. **Explicit false vs null:** Both are treated identically (as false) due to the default value
2. **Explicit true:** Sets `enableIPForwarding: true` in Azure API
3. **Empty list (no network_interface):** Field is not included in body (no network profile created)

### Idempotency
- **Safe:** Using `optional(bool, false)` ensures consistent output - field always has a definite value
- **No array ordering issues:** Field is a simple boolean on each network interface object

### Safe References
- **Safe:** Field is accessed directly from `nic.enable_ip_forwarding` where `nic` is guaranteed to exist within the for loop
- **No nested access:** No deep property access that could fail on null

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ ForceNew not applicable (not a ForceNew field)
- ✅ All logic exactly replicated from provider (pointer.To(bool) → direct bool with coalesce for default)
- ✅ Validations implemented in variables.tf (type system validation sufficient)
- ✅ TODO comment not applicable (not a sensitive field)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work checked (none exists)
- ✅ Critical review completed (null, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis in proof (included above)
- ✅ Proof created
- ✅ track.md ready to update to "Pending for check"
- ✅ Self-Review: Only implemented Task #66, no other fields added

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #66 - network_interface.enable_ip_forwarding

### Issues Identified

#### Issue 1: Violation of Method Priority - Redundant coalesce() with optional() Default

**Problem:**
Executor implemented default value using BOTH the PREFER method (`optional(bool, false)` in variables.tf) AND the Fallback method (`coalesce()` in locals), violating executor.md's method priority rules.

**Executor's Implementation:**
```hcl
# variables.tf
enable_ip_forwarding = optional(bool, false)  # PREFER method - guarantees non-null

# migrate_main.tf
enableIPForwarding = coalesce(nic.enable_ip_forwarding, false)  # Fallback method - redundant
```

**Why This Violates executor.md:**
From executor.md lines 124-131:
> **Defaults:** If schema has `Default`, replicate it:
> - **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
> - **Fallback:** Apply default in locals if optional() syntax not possible

From checker.md lines 121-125:
> **Common Violation:**
> ```hcl
> # ❌ WRONG
> type = list(object({ field = optional(string) }))
> # In locals: coalesce(obj.field, "default")
> 
> # ✅ CORRECT
> type = list(object({ field = optional(string, "default") }))
> # In locals: obj.field  # Guaranteed non-null
> ```

**Provider's Actual Behavior:**
```go
"enable_ip_forwarding": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
},
```

**Expected Behavior:**
- When field is not set → defaults to `false` via `optional(bool, false)`
- When field is explicitly set to `true` → value is `true`
- When field is explicitly set to `false` → value is `false`
- Field is NEVER null after `optional(bool, false)` is applied

**Root Cause:**
Executor used Fallback method (`coalesce()`) when PREFER method was already successfully implemented and sufficient. The `optional(bool, false)` syntax guarantees the field is never null, making `coalesce()` unnecessary and a violation of method priority.

### Corrections Made

#### Fix 1: Remove Redundant coalesce()

**Changed Files:**
- `migrate_main.tf`: Removed unnecessary `coalesce()` call

**Old Implementation:**
```hcl
enableIPForwarding = coalesce(nic.enable_ip_forwarding, false)
```

**New Implementation:**
```hcl
enableIPForwarding = nic.enable_ip_forwarding
```

**Why This is EXACT:**
With `optional(bool, false)` in the variable definition, `nic.enable_ip_forwarding` is guaranteed to be non-null (either user-provided value or default `false`). Direct assignment exactly matches provider behavior without redundant fallback logic.

**Verification:**
- Scenario 1: User omits field → `optional(bool, false)` provides `false` → `enableIPForwarding = false` ✅
- Scenario 2: User sets `enable_ip_forwarding = true` → `enableIPForwarding = true` ✅
- Scenario 3: User sets `enable_ip_forwarding = false` → `enableIPForwarding = false` ✅
- Edge Case: Field cannot be null after `optional()` default → no need for null handling ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The default value is applied using the PREFER method (`optional(bool, false)`) in the variable definition, with direct assignment in locals as mandated by the method priority rules.

**Status:** CORRECTED AND APPROVED ✅

---
