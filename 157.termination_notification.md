# Task #157: termination_notification Block Structure Skeleton

## Summary
Created structure skeleton for `termination_notification` block. This is a Type 3 task (Block Structure Skeleton) - only creating the framework with comment placeholders for child arguments (Task #158: enabled, Task #159: timeout). The block maps to Azure API path `properties.virtualMachineProfile.scheduledEventsProfile.terminateNotificationProfile`.

## Shadow Implementation

```hcl
var.orchestrated_virtual_machine_scale_set_termination_notification != null ? {
  scheduledEventsProfile = {
    terminateNotificationProfile = {
      # enable = ... # Task #158
      # notBeforeTimeout = ... # Task #159
    }
  }
} : {}
```

## Create Phase Verification

### Pattern Identification
Queried Create method to identify creation pattern.

**Create Method Evidence:**
```go
if v, ok := d.GetOk("termination_notification"); ok {
    virtualMachineProfile.ScheduledEventsProfile = ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile(v.([]interface{}))
}

// Later in the function:
if !isLegacy {
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
}

// Single-phase pattern:
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Decision:** Single-phase Create - field is set in `virtualMachineProfile` before the single `CreateOrUpdateThenPoll` call. Field goes in `local.body`.

## Assignment Path Verification

### Predicted Path
`properties.virtualMachineProfile.scheduledEventsProfile.terminateNotificationProfile`

### Provider Code Evidence
```go
// From ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile function:
func ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile(input []interface{}) *virtualmachinescalesets.ScheduledEventsProfile {
    if len(input) == 0 {
        return nil
    }

    raw := input[0].(map[string]interface{})
    enabled := raw["enabled"].(bool)
    timeout := raw["timeout"].(string)

    return &virtualmachinescalesets.ScheduledEventsProfile{
        TerminateNotificationProfile: &virtualmachinescalesets.TerminateNotificationProfile{
            Enable:           &enabled,
            NotBeforeTimeout: &timeout,
        },
    }
}

// In Create method:
virtualMachineProfile.ScheduledEventsProfile = ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile(v.([]interface{}))

// Assignment chain:
// 1. virtualMachineProfile (local variable)
// 2. props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

### Verified Path
`properties.virtualMachineProfile.scheduledEventsProfile.terminateNotificationProfile`

### Path Comparison
✅ **MATCH** - Predicted path matches verified path exactly.

## Provider Schema

**From AzureRM Provider Schema:**
```go
"termination_notification": OrchestratedVirtualMachineScaleSetTerminationNotificationSchema(),

func OrchestratedVirtualMachineScaleSetTerminationNotificationSchema() *pluginsdk.Schema {
    return &pluginsdk.Schema{
        Type:     pluginsdk.TypeList,
        Optional: true,
        Computed: true,
        MaxItems: 1,
        Elem: &pluginsdk.Resource{
            Schema: map[string]*pluginsdk.Schema{
                "enabled": {
                    Type:     pluginsdk.TypeBool,
                    Required: true,
                },
                "timeout": {
                    Type:         pluginsdk.TypeString,
                    Optional:     true,
                    ValidateFunc: azValidate.ISO8601DurationBetween("PT5M", "PT15M"),
                    Default:      "PT5M",
                },
            },
        },
    }
}
```

**Key Details:**
- Type: List (MaxItems: 1) - converted to object in variables.tf
- Optional: true
- Computed: true
- Contains 2 fields:
  - `enabled`: Required bool
  - `timeout`: Optional string with default "PT5M", validated ISO8601 duration between PT5M and PT15M

## Azure API Schema

**From Azure API Schema:**
```
scheduledEventsProfile: ObjectWithOptionalAttrs(
  map[string]Type{
    "osImageNotificationProfile": ObjectWithOptionalAttrs(
      map[string]Type{
        "enable": Bool, 
        "notBeforeTimeout": String
      }, 
      []string{"enable", "notBeforeTimeout"}
    ), 
    "terminateNotificationProfile": ObjectWithOptionalAttrs(
      map[string]Type{
        "enable": Bool, 
        "notBeforeTimeout": String
      }, 
      []string{"enable", "notBeforeTimeout"}
    )
  }, 
  []string{"osImageNotificationProfile", "terminateNotificationProfile"}
)
```

**Key Details:**
- Path: `properties.virtualMachineProfile.scheduledEventsProfile.terminateNotificationProfile`
- Contains 2 fields:
  - `enable`: Bool (optional)
  - `notBeforeTimeout`: String (optional)
- Both fields are optional in Azure API

## Hidden Fields Check

### Expand Function Analysis
```go
func ExpandOrchestratedVirtualMachineScaleSetScheduledEventsProfile(input []interface{}) *virtualmachinescalesets.ScheduledEventsProfile {
    if len(input) == 0 {
        return nil
    }

    raw := input[0].(map[string]interface{})
    enabled := raw["enabled"].(bool)
    timeout := raw["timeout"].(string)

    return &virtualmachinescalesets.ScheduledEventsProfile{
        TerminateNotificationProfile: &virtualmachinescalesets.TerminateNotificationProfile{
            Enable:           &enabled,
            NotBeforeTimeout: &timeout,
        },
    }
}
```

**Hidden Fields Found:** ❌ None

The expand function only processes the two schema-defined fields (`enabled` and `timeout`). No hardcoded values, no additional fields, no conditional logic that adds hidden fields.

**Note:** The Azure API schema shows `scheduledEventsProfile` also supports `osImageNotificationProfile`, but the AzureRM provider's expand function ONLY creates `terminateNotificationProfile`. The provider does not expose `osImageNotificationProfile` to users, so we should not add it either.

## Mapping

**Terraform (snake_case) → Azure API (camelCase):**
- `termination_notification` → `scheduledEventsProfile.terminateNotificationProfile`
- `enabled` → `enable`
- `timeout` → `notBeforeTimeout`

## Special Handling

### Block Type
- Type 3 task: Block Structure Skeleton only
- Creates conditional framework with comment placeholders
- Child arguments will be implemented by separate tasks:
  - Task #158: `enabled` field
  - Task #159: `timeout` field

### Conditional Logic
Block is conditionally included only when `var.orchestrated_virtual_machine_scale_set_termination_notification != null`.

### Location in locals.body
Placed within `properties.virtualMachineProfile` merge, after `extensionProfile` and before `storageProfile`.

### No ForceNew/Sensitive/Validation
This is a skeleton-only task. ForceNew, Sensitive, and Validation handling will be addressed by child tasks #158 and #159.

## Deferred Work Completion
**No deferred work:** Checked `following.md` - no work was deferred to Task #157.

## Critical Review & Edge Case Analysis

### Null Semantics
- `null` value: Block not included in API payload (correct behavior)
- Empty block not supported: Variable type requires at least `enabled` to be set (enforced by schema)

### Boundary Conditions
- Block presence: Controlled by null check on parent variable
- Schema enforces MaxItems: 1 in provider (converted to object in variables.tf)

### Idempotency
- Block structure is idempotent - same input always produces same output
- Conditional inclusion based on null check is deterministic

### Safe References
- All references check for null before accessing nested properties: `var.orchestrated_virtual_machine_scale_set_termination_notification != null`
- Child tasks will safely reference `var.orchestrated_virtual_machine_scale_set_termination_notification.enabled` and `.timeout` since the parent null check protects them

## Child Tasks Ready for Delegation

The following child tasks are now ready for implementation (skeleton exists):

- **Task #158**: `termination_notification.enabled` - Required bool argument
- **Task #159**: `termination_notification.timeout` - Optional string argument with default and validation

Both tasks can now proceed as the parent block structure skeleton is in place.

## Checklist
- ✅ Block skeleton created in `local.body`
- ✅ Conditional logic: only included when parent variable is not null
- ✅ Comment placeholders added for child fields with task numbers
- ✅ Hidden fields checked in expand function (none found)
- ✅ Assignment path verified from provider code
- ✅ Mapping documented (snake_case → camelCase)
- ✅ Deferred work checked in `following.md` (none found)
- ✅ Critical review completed (null semantics, boundary conditions, idempotency, safe references)
- ✅ Child tasks identified and documented
- ✅ Proof document created
- ✅ Track.md ready to be updated
- ✅ Self-review: Added ONLY block skeleton for Task #157, no child field implementations

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #157 - termination_notification

### Validation Results

✅ **Block Skeleton Structure:** Correctly created nested skeleton with `scheduledEventsProfile.terminateNotificationProfile`
✅ **Conditional Logic:** Properly uses null check on parent variable before creating block
✅ **Comment Placeholders:** Task #158 and #159 placeholders correctly positioned for child fields
✅ **Hidden Fields:** Expand function analysis complete - no hidden fields found
✅ **Assignment Path:** Verified path matches provider implementation exactly
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, single-phase pattern)
✅ **Type 3 Task Compliance:** Skeleton-only implementation with no child field implementations (correct)
✅ **Deferred Work Completion:** No deferred work found in following.md for Task #157
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Null semantics, boundary conditions, idempotency, and safe references properly analyzed

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. This is a Type 3 task (Block Structure Skeleton) and correctly:
- Creates only the skeleton structure without implementing child fields
- Uses conditional logic based on parent variable null check
- Includes comment placeholders for child tasks (#158: enabled, #159: timeout)
- Places the block at the correct path in `local.body` within `properties.virtualMachineProfile`
- No deviations, simplifications, or "safer alternatives" were found

**Status:** APPROVED ✅

---
