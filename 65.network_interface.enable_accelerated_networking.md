# Task #65: network_interface.enable_accelerated_networking

## Shadow Implementation

```hcl
properties = merge(
  nic.dns_servers != null ? {
    dnsSettings = {
      dnsServers = nic.dns_servers
    }
  } : {},
  {
    enableAcceleratedNetworking = coalesce(nic.enable_accelerated_networking, false) # <-
  }
)
```

## Summary

Implements `enable_accelerated_networking` field within network_interface block. Maps to Azure API property `enableAcceleratedNetworking` with default value of `false` from provider schema.

## Create Phase Verification

**Query Result:**
```go
networkInterfaces, err := ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(v.([]interface{}))
if err != nil {
    return fmt.Errorf("expanding `network_interface`: %w", err)
}

networkProfile.NetworkInterfaceConfigurations = networkInterfaces
virtualMachineProfile.NetworkProfile = networkProfile
```

**Pattern:** Single-phase creation - `CreateOrUpdateThenPoll` call.

**Classification:** Create phase - field is set before the CreateOrUpdateThenPoll operation.

**Decision:** Field belongs in `local.body`, NOT in `post_creation_updates`.

## Assignment Path Verification

**Predicted Path:**
```
body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.enableAcceleratedNetworking
```

**Go Code Evidence:**
From `ExpandOrchestratedVirtualMachineScaleSetNetworkInterface`:
```go
config := virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration{
    Name: raw["name"].(string),
    Properties: &virtualmachinescalesets.VirtualMachineScaleSetNetworkConfigurationProperties{
        DnsSettings: &virtualmachinescalesets.VirtualMachineScaleSetNetworkConfigurationDnsSettings{
            DnsServers: dnsServers,
        },
        EnableAcceleratedNetworking: pointer.To(raw["enable_accelerated_networking"].(bool)),
        EnableIPForwarding:          pointer.To(raw["enable_ip_forwarding"].(bool)),
        IPConfigurations:            ipConfigurations,
        Primary:                     pointer.To(raw["primary"].(bool)),
    },
}
```

From Create method:
```go
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Assignment Chain:**
1. `raw["enable_accelerated_networking"]` → `EnableAcceleratedNetworking` in `VirtualMachineScaleSetNetworkConfigurationProperties`
2. Properties assigned to `VirtualMachineScaleSetNetworkConfiguration`
3. Configuration added to `NetworkInterfaceConfigurations` array
4. Array assigned to `networkProfile.NetworkInterfaceConfigurations`
5. Network profile assigned to `virtualMachineProfile.NetworkProfile`
6. Virtual machine profile assigned to `props.Properties.VirtualMachineProfile`

**Verified Path:**
```
body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.enableAcceleratedNetworking
```

**Path Comparison:** ✅ Paths match exactly.

## Provider Schema

From `OrchestratedVirtualMachineScaleSetNetworkInterfaceSchema()`:
```go
// TODO 4.0: change this from enable_* to *_enabled
"enable_accelerated_networking": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
},
```

**Key Properties:**
- **Type:** Bool
- **Optional:** true
- **Default:** false
- **ForceNew:** Not specified (false)
- **Computed:** Not specified (false)
- **ValidateFunc:** None
- **DiffSuppressFunc:** None

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

**Property Path:** `body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.enableAcceleratedNetworking`

**Azure API Type:** Bool

## Hidden Fields

None. Field is explicitly defined in provider schema.

## Mapping

| Terraform Field | Azure API Property |
|----------------|-------------------|
| `enable_accelerated_networking` | `enableAcceleratedNetworking` |

**Naming Convention:** snake_case → camelCase

## Special Handling

### Default Value
- **Provider Default:** `false`
- **Implementation:** Use `coalesce(nic.enable_accelerated_networking, false)` to ensure default is applied when field is null.

### ForceNew
- **Schema:** No `ForceNew: true` in schema
- **CustomizeDiff:** No CustomizeDiff logic found for this field
- **Decision:** NOT a ForceNew field, no entry in `replace_triggers_external_values`

### Validation
**From variables.tf:**
```hcl
enable_accelerated_networking = optional(bool)
```

**Validation in Provider:** None - only type validation (bool)

**Implementation:** No validation needed beyond Terraform type system.

## Deferred Work Completion

Checked `following.md` - no deferred work for this task.

## Critical Review & Edge Case

### Null Semantics
- **Provider behavior:** When `enable_accelerated_networking` is not set, provider defaults to `false`
- **Implementation:** Using `coalesce(nic.enable_accelerated_networking, false)` ensures `false` is sent to API when field is null
- **Rationale:** Matches provider's default value behavior exactly

### Edge Cases
1. **Null value:** Handled by `coalesce()` - defaults to `false`
2. **Boolean false:** Explicitly set to `false` - correctly passed through
3. **Boolean true:** Explicitly set to `true` - correctly passed through

### Idempotency
- Fixed boolean value per network interface
- No ordering concerns
- Deterministic output

### Safe References
- Accessing `nic.enable_accelerated_networking` within loop over network interfaces
- Safe because we're iterating over validated list items
- Field is optional in the object type, null-safe access

## Checklist

- [x] Property in correct local (`body`)
- [x] Exact provider behavior replicated (default value handling)
- [x] No validations beyond type system required
- [x] No ForceNew required
- [x] No hidden fields
- [x] No deferred work
- [x] Critical review complete (null, edge cases, idempotency, safe refs)
- [x] Edge Case Analysis included
- [x] Proof created
- [x] Ready to update track.md

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #65 - network_interface.enable_accelerated_networking

### Issues Identified

#### Issue 1: Incorrect Default Value Implementation Method

**Problem:**
Executor used the Fallback method (coalesce in locals) for applying the default value when the PREFERRED method (optional() with default) was available and technically possible.

**Executor's Implementation:**
```hcl
# variables.tf
enable_accelerated_networking = optional(bool)

# migrate_main.tf
enableAcceleratedNetworking = coalesce(nic.enable_accelerated_networking, false)
```

**Why This Violates executor.md:**
From executor.md lines 124-131:
> **Defaults:** If schema has `Default`, replicate it:
> - **Top-level:** `variable "field" { default = value }`
> - **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
> - **Fallback:** Apply default in locals if optional() syntax not possible

From checker.md lines 99-126:
> **Method Priority:**
> ```
> PREFER: optional(string, "default") in object type
>    ↓
> Fallback: coalesce() in locals (ONLY if optional() impossible)
> ```
> **Checking:**
> - Is field in object/list(object)/set(object)? → `optional(type, default)` IS possible
> - Executor used coalesce()? → **VIOLATION** (unless proven impossible)

**Provider's Actual Behavior:**
```go
"enable_accelerated_networking": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
},
```

Provider defaults this field to `false` when not specified.

**Expected Behavior:**
- When field is null/unset → should be `false`
- When field is explicitly set to `true` → should be `true`
- When field is explicitly set to `false` → should be `false`

**Root Cause:**
The field is inside `list(object({...}))` type. The `optional(bool, false)` syntax IS supported in Terraform 1.3+ for nested objects at any depth. The executor unnecessarily used coalesce() when the preferred optional() modifier with default value would work correctly.

### Corrections Made

#### Fix 1: Use Preferred Method for Default Value

**Changed Files:**
- `variables.tf`: Changed `optional(bool)` to `optional(bool, false)`
- `migrate_main.tf`: Removed unnecessary `coalesce()` wrapper

**New Implementation:**
```hcl
# variables.tf
enable_accelerated_networking = optional(bool, false)

# migrate_main.tf
enableAcceleratedNetworking = nic.enable_accelerated_networking
```

**Why This is EXACT:**
- The `optional(bool, false)` modifier ensures that when the field is not provided, it defaults to `false` at the type constraint level
- This exactly matches the provider's `Default: false` behavior
- No runtime coalesce needed because Terraform guarantees the value is never null after applying the optional() default
- Simpler, cleaner, and follows the PREFERRED method priority from executor.md

**Verification:**
- Scenario 1: Field not set in input → `optional()` provides `false` → Azure API receives `false` ✅
- Scenario 2: Field set to `true` → Value passes through → Azure API receives `true` ✅
- Scenario 3: Field set to `false` → Value passes through → Azure API receives `false` ✅
- Edge Case: Null handling → Handled by `optional()` modifier before code execution ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md` using the PREFERRED method for default values.

**Status:** CORRECTED AND APPROVED ✅

---
