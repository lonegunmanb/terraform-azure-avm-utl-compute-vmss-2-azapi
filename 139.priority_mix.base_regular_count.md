# Task #139 - priority_mix.base_regular_count

## Summary

Implemented the `base_regular_count` field within the `priority_mix` block. This optional integer field (0-1000, default 0) specifies the base number of VMs with Regular priority before any Spot priority VMs are created. The field requires ForceNew behavior and is validated to ensure values stay within the valid range.

## Shadow Implementation

```hcl
# In migrate_main.tf local.body:
var.orchestrated_virtual_machine_scale_set_priority_mix != null ? {
  priorityMixPolicy = {
    baseRegularPriorityCount = coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count, 0)
    # regularPriorityPercentageAboveBase = ... # Task #140
  }
} : {}

# In migrate_main.tf replace_triggers_external_values:
priority_mix_base_regular_count = { value = var.orchestrated_virtual_machine_scale_set_priority_mix != null ? coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count, 0) : 0 }

# In variables.tf validation:
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_priority_mix == null ||
    var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count == null ||
    (var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count >= 0 && var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count <= 1000)
  )
  error_message = "base_regular_count must be between 0 and 1000."
}
```

## Create Phase Verification

**Pattern:** Single-phase creation

**Evidence from Create method:**

```go
if v, ok := d.GetOk("priority_mix"); ok {
	if *virtualMachineProfile.Priority != virtualmachinescalesets.VirtualMachinePriorityTypesSpot {
		return fmt.Errorf("`priority_mix` can only be specified when `priority` is set to `%s`", string(virtualmachinescalesets.VirtualMachinePriorityTypesSpot))
	}
	props.Properties.PriorityMixPolicy = ExpandOrchestratedVirtualMachineScaleSetPriorityMixPolicy(v.([]interface{}))
}

props.Properties.VirtualMachineProfile = &virtualMachineProfile

// ...
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
	return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Classification:** The `priority_mix` block is set **before** the `CreateOrUpdateThenPoll` call, placing it in the **Create phase**. Therefore, it belongs in `local.body`, NOT in `local.post_creation_updates`.

**Decision:** Implement in `local.body.properties.priorityMixPolicy.baseRegularPriorityCount`.

## Assignment Path Verification

**Predicted path:** `properties.priorityMixPolicy.baseRegularPriorityCount`

**Go code evidence:**
1. Field read: `d.GetOk("priority_mix")`
2. Expand function call: `props.Properties.PriorityMixPolicy = ExpandOrchestratedVirtualMachineScaleSetPriorityMixPolicy(v.([]interface{}))`
3. Expand function implementation:
```go
func ExpandOrchestratedVirtualMachineScaleSetPriorityMixPolicy(input []interface{}) *virtualmachinescalesets.PriorityMixPolicy {
	if len(input) == 0 {
		return nil
	}

	raw := input[0].(map[string]interface{})

	return &virtualmachinescalesets.PriorityMixPolicy{
		BaseRegularPriorityCount:           pointer.To(int64(raw["base_regular_count"].(int))),
		RegularPriorityPercentageAboveBase: pointer.To(int64(raw["regular_percentage_above_base"].(int))),
	}
}
```
4. Direct assignment to `props.Properties.PriorityMixPolicy.BaseRegularPriorityCount`

**Verified path:** `properties.priorityMixPolicy.baseRegularPriorityCount`

**Path comparison:** ✅ Match - predicted path matches actual assignment

## Provider Schema

```go
func OrchestratedVirtualMachineScaleSetPriorityMixPolicySchema() *pluginsdk.Schema {
	return &pluginsdk.Schema{
		Type:     pluginsdk.TypeList,
		Optional: true,
		MaxItems: 1,
		Elem: &pluginsdk.Resource{
			Schema: map[string]*pluginsdk.Schema{
				"base_regular_count": {
					Type:         pluginsdk.TypeInt,
					Optional:     true,
					ValidateFunc: validation.IntBetween(0, 1000),
					Default:      0,
				},
				"regular_percentage_above_base": {
					Type:         pluginsdk.TypeInt,
					Optional:     true,
					ValidateFunc: validation.IntBetween(0, 100),
					Default:      0,
				},
			},
		},
	}
}
```

**Key details:**
- Type: Optional integer
- ValidateFunc: `validation.IntBetween(0, 1000)`
- Default: `0`
- ForceNew: Not explicitly set in schema, but inferred from Update method behavior

## Azure API Schema

Azure API type: `int64` (from `pointer.To(int64(raw["base_regular_count"].(int)))`)

The field maps to `BaseRegularPriorityCount` in the API model `virtualmachinescalesets.PriorityMixPolicy`.

## Hidden Fields

No hidden fields detected. The expand function only maps the schema-defined fields with no additional hardcoded values.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|---|---|
| `base_regular_count` | `baseRegularPriorityCount` |

## Special Handling

### Validation

**Evidence from schema:**
```go
ValidateFunc: validation.IntBetween(0, 1000),
```

**Implementation:** Added validation block in `variables.tf`:
```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_priority_mix == null ||
    var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count == null ||
    (var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count >= 0 && var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count <= 1000)
  )
  error_message = "base_regular_count must be between 0 and 1000."
}
```

This validation exactly replicates the provider's `IntBetween(0, 1000)` validation.

### Default Value

**Evidence from schema:**
```go
Default: 0,
```

**Implementation:** Used `coalesce()` to apply the default:
```hcl
baseRegularPriorityCount = coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count, 0)
```

This ensures that when `base_regular_count` is `null`, the value defaults to `0`, exactly matching provider behavior.

### ForceNew Behavior

**Evidence from Update method:**

The Update method does NOT contain any handling for `priority_mix` fields. Searching the Update method code shows NO references to `priority_mix`, `PriorityMixPolicy`, or `base_regular_count`. This means updates to this field are NOT supported and would require resource replacement.

**Implementation:** Added field to `replace_triggers_external_values`:
```hcl
priority_mix_base_regular_count = { value = var.orchestrated_virtual_machine_scale_set_priority_mix != null ? coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count, 0) : 0 }
```

Used Mode 1 (Direct Value Tracking) with wrapped value `{ value = ... }` to ensure stable key presence. The value changes trigger replacement, which matches the provider's behavior of not supporting updates.

### Cross-Field Validation

The parent block validation (Task #138) already implements the validation that `priority_mix` can only be set when `priority` is `Spot`. No additional cross-field validation is needed for this child field.

## Deferred Work Completion

Checked `following.md` - no work was deferred TO this task.

## Edge Case Analysis

1. **Null semantics:** When `base_regular_count` is `null`, `coalesce()` applies the default value `0`, matching provider behavior. When entire `priority_mix` block is `null`, the conditional `!= null` ensures the entire `priorityMixPolicy` object is omitted.

2. **Boundary conditions:** Validation ensures values are between 0 and 1000 inclusive, matching `IntBetween(0, 1000)`.

3. **Zero value:** The default value is `0`, and zero is explicitly valid per the schema. The implementation correctly treats `0` as a meaningful value, not as "unset".

4. **Type conversion:** The expand function converts `int` to `int64` using `int64(raw["base_regular_count"].(int))`. Terraform's `number` type handles this conversion safely within the valid range (0-1000).

5. **Idempotency:** The stable key `priority_mix_base_regular_count` in `replace_triggers_external_values` ensures consistent detection of value changes. The wrapped `{ value = ... }` pattern ensures null values are properly tracked.

6. **Safe references:** All references check parent block nullability before accessing the field: `var.orchestrated_virtual_machine_scale_set_priority_mix != null ? ... : 0`

## Checklist

- ✅ Property in correct local (`local.body.properties.priorityMixPolicy.baseRegularPriorityCount`)
- ✅ ForceNew wrapped: `{ value = ... }` in `replace_triggers_external_values`
- ✅ All logic EXACTLY replicated from provider (default value, validation, no update support)
- ✅ Validations IMPLEMENTED in variables.tf (IntBetween 0-1000)
- ✅ No hidden fields
- ✅ Deferred work checked (none found)
- ✅ Critical review (null handling, boundary validation, idempotency, safe refs)
- ✅ Edge Case Analysis completed
- ✅ Proof created
- ✅ Ready to update track.md to "Pending for check"

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #139 - priority_mix.base_regular_count

### Issues Identified

#### Issue 1: Incorrect Default Value Implementation (Method Priority Violation)

**Problem:**
Executor used the fallback method (`coalesce()` in locals) when the PREFERRED method (`optional(type, default)`) is possible and should be used.

**Executor's Implementation:**
```hcl
# In variables.tf:
base_regular_count = optional(number)

# In migrate_main.tf:
baseRegularPriorityCount = coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count, 0)
priority_mix_base_regular_count = { value = var.orchestrated_virtual_machine_scale_set_priority_mix != null ? coalesce(var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count, 0) : 0 }
```

**Why This Violates executor.md:**
From `executor.md` lines 138-141:
> **Defaults:** If schema has `Default`, replicate it:
> - **Top-level:** `variable "field" { default = value }`
> - **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
> - **Fallback:** Apply default in locals if optional() syntax not possible

The field is nested in an object type (`priority_mix` object), and `optional(number, 0)` syntax IS possible in Terraform >= 1.3. The executor chose the fallback method (`coalesce()` in locals) without justification, violating the method priority rule. From checker.md lines 76-86, fallback methods are ONLY allowed when preferred methods are **technically impossible**, not when executor finds them inconvenient.

**Provider's Actual Behavior:**
```go
"base_regular_count": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    ValidateFunc: validation.IntBetween(0, 1000),
    Default:      0,
},
```
Provider applies default value of `0` when field is not set.

**Expected Behavior:**
- When `base_regular_count` is null → defaults to 0
- When `base_regular_count` is explicitly set (including 0) → uses that value
- Default applied by Terraform's type system, not in locals

**Root Cause:**
Executor used fallback method when PREFERRED method is available, violating executor.md's method priority rules.

### Corrections Made

#### Fix 1: Use PREFERRED Method for Default Value

**Changed Files:**
- `variables.tf` line 1337: Changed `optional(number)` to `optional(number, 0)`
- `migrate_main.tf` line 206: Removed `coalesce()` wrapper, changed to direct field access
- `migrate_main.tf` line 168: Removed `coalesce()` from replace_triggers_external_values

**New Implementation:**
```hcl
# In variables.tf:
variable "orchestrated_virtual_machine_scale_set_priority_mix" {
  type = object({
    base_regular_count = optional(number, 0)  # <- PREFERRED method
    ...
  })
}

# In migrate_main.tf local.body:
baseRegularPriorityCount = var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count

# In migrate_main.tf replace_triggers_external_values:
priority_mix_base_regular_count = { value = var.orchestrated_virtual_machine_scale_set_priority_mix != null ? var.orchestrated_virtual_machine_scale_set_priority_mix.base_regular_count : 0 }
```

**Why This is EXACT:**
- Uses PREFERRED method (`optional(number, 0)`) as specified in executor.md lines 138-141
- Default is applied automatically by Terraform's type system before any locals evaluation
- Matches provider behavior: when field is null/unset, it defaults to 0
- No redundant `coalesce()` calls needed - the field is guaranteed to be non-null when parent block exists
- Follows method priority: PREFER over Fallback

**Verification:**
- Scenario 1: `priority_mix = null` → entire `priorityMixPolicy` block omitted ✅
- Scenario 2: `priority_mix = {}` → `base_regular_count` defaults to 0, outputs `baseRegularPriorityCount = 0` ✅
- Scenario 3: `priority_mix = {base_regular_count = 5}` → uses 5, outputs `baseRegularPriorityCount = 5` ✅
- Scenario 4: `priority_mix = {base_regular_count = 0}` → uses 0 (not treated as null), outputs `baseRegularPriorityCount = 0` ✅
- Edge Case: `priority_mix = {base_regular_count = null}` → defaults to 0 due to `optional(number, 0)` ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The default value is applied using the PREFERRED method (`optional(number, 0)`), following the mandatory method priority. No fallback methods were used where preferred methods are possible.

**Status:** CORRECTED AND APPROVED ✅

---
