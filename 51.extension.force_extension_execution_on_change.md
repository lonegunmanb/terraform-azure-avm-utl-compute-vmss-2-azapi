# Task #51: extension.force_extension_execution_on_change

## Summary

Implemented the `force_extension_execution_on_change` argument for the `extension` block. This field maps to `forceUpdateTag` in the Azure API and is used to force re-execution of an extension even if its configuration hasn't changed. The field is optional and only included in the request when explicitly set.

## Shadow Implementation

```hcl
locals {
  body = {
    properties = merge(
      var.orchestrated_virtual_machine_scale_set_sku_name != null ? {
        virtualMachineProfile = merge(
          var.orchestrated_virtual_machine_scale_set_extension != null || var.orchestrated_virtual_machine_scale_set_extensions_time_budget != null ? {
            extensionProfile = merge(
              var.orchestrated_virtual_machine_scale_set_extension != null ? {
                extensions = [
                  for ext in var.orchestrated_virtual_machine_scale_set_extension : {
                    name = ext.name
                    properties = merge(
                      {
                        publisher               = ext.publisher
                        type                    = ext.type
                        typeHandlerVersion      = ext.type_handler_version
                        autoUpgradeMinorVersion = ext.auto_upgrade_minor_version_enabled
                      },
                      ext.extensions_to_provision_after_vm_creation != null ? {
                        provisionAfterExtensions = ext.extensions_to_provision_after_vm_creation
                      } : {},
                      {
                        suppressFailures = ext.failure_suppression_enabled
                      },
                      ext.force_extension_execution_on_change != null ? {
                        forceUpdateTag = ext.force_extension_execution_on_change
                      } : {}
                    )
                  }
                ]
              } : {},
            )
          } : {}
        )
      } : {}
    )
  }
}
```

## Create Phase Verification

**Query Result:** The Create method shows single-phase resource creation with extensions handled in the Create phase.

**Evidence from Go code:**

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... initialization code ...
    
    virtualMachineProfile := virtualmachinescalesets.VirtualMachineScaleSetVMProfile{
        StorageProfile: &virtualmachinescalesets.VirtualMachineScaleSetStorageProfile{},
    }
    
    // Extensions are configured in the Create phase
    if v, ok := d.GetOk("extension"); ok {
        var err error
        virtualMachineProfile.ExtensionProfile, hasHealthExtension, err = expandOrchestratedVirtualMachineScaleSetExtensions(v.(*pluginsdk.Set).List())
        if err != nil {
            return err
        }
    }
    
    // ... build props ...
    
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    
    // Single API call - no two-phase pattern
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
    
    return resourceOrchestratedVirtualMachineScaleSetRead(d, meta)
}
```

**Pattern Classification:** Single-phase creation (CreateOrUpdate API call)

**Field Classification:** Create phase - set during initial resource creation

**Decision:** Field belongs in `local.body`, not `local.post_creation_updates`

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.extensionProfile.extensions[].properties.forceUpdateTag`

**Trace from Go Code:**

1. Field is read from Terraform state:
```go
func expandOrchestratedVirtualMachineScaleSetExtensions(input []interface{}) (*virtualmachinescalesets.VirtualMachineScaleSetExtensionProfile, bool, error) {
    // ...
    for _, v := range input {
        extensionRaw := v.(map[string]interface{})
        extension := virtualmachinescalesets.VirtualMachineScaleSetExtension{
            Name: pointer.To(extensionRaw["name"].(string)),
        }
        
        extensionProps := virtualmachinescalesets.VirtualMachineScaleSetExtensionProperties{
            // ...
        }
        
        if forceUpdateTag := extensionRaw["force_extension_execution_on_change"]; forceUpdateTag != nil {
            extensionProps.ForceUpdateTag = pointer.To(forceUpdateTag.(string))
        }
        
        extension.Properties = &extensionProps
        extensions = append(extensions, extension)
    }
    extensionProfile.Extensions = &extensions
    return extensionProfile, hasHealthExtension, nil
}
```

2. Extension profile is assigned to virtualMachineProfile:
```go
virtualMachineProfile.ExtensionProfile = expandOrchestratedVirtualMachineScaleSetExtensions(...)
```

3. virtualMachineProfile is assigned to props:
```go
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

4. Props structure:
```go
props := virtualmachinescalesets.VirtualMachineScaleSet{
    Properties: &virtualmachinescalesets.VirtualMachineScaleSetProperties{
        VirtualMachineProfile: &virtualMachineProfile,
    },
}
```

**Verified Path:** `properties.virtualMachineProfile.extensionProfile.extensions[].properties.forceUpdateTag`

**Path Comparison:** ✅ Matches predicted path

## Provider Schema

**From Go Source Code:**

```go
func OrchestratedVirtualMachineScaleSetExtensionsSchema() *pluginsdk.Schema {
    return &pluginsdk.Schema{
        Type:     pluginsdk.TypeSet,
        Optional: true,
        Computed: true,
        Elem: &pluginsdk.Resource{
            Schema: map[string]*pluginsdk.Schema{
                // ...
                "force_extension_execution_on_change": {
                    Type:     pluginsdk.TypeString,
                    Optional: true,
                },
                // ...
            },
        },
    }
}
```

**Field Properties:**
- Type: String
- Optional: true
- No ForceNew
- No Default value
- No Validation
- Not Computed
- Not Sensitive

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

**API Path:** `properties.virtualMachineProfile.extensionProfile.extensions[].properties.forceUpdateTag`

**From Azure API Schema:**
```
extensionProfile:ObjectWithOptionalAttrs(map[string]Type{
    "extensions":List(ObjectWithOptionalAttrs(map[string]Type{
        "name":String, 
        "properties":ObjectWithOptionalAttrs(map[string]Type{
            "forceUpdateTag":String,
            // ... other properties
        }, []string{"forceUpdateTag", ...})
    }, []string{"name", "properties"}))
}, []string{"extensions", "extensionsTimeBudget"})
```

**Type:** String (optional)

## Hidden Fields

**None.** All extension fields come from explicit Terraform configuration. No hardcoded values added by the provider.

## Mapping

**Terraform → Azure API:**

| Terraform Field | Azure API Field | Notes |
|----------------|-----------------|-------|
| `extension[].force_extension_execution_on_change` | `extensions[].properties.forceUpdateTag` | snake_case → camelCase, different field name |

## Special Handling

### No ForceNew

The field does NOT have `ForceNew: true` in the schema. Changes to this field do NOT trigger resource replacement.

### Conditional Inclusion

The field is only included in the API request when explicitly set (non-null):

```go
if forceUpdateTag := extensionRaw["force_extension_execution_on_change"]; forceUpdateTag != nil {
    extensionProps.ForceUpdateTag = pointer.To(forceUpdateTag.(string))
}
```

**Shadow Module Implementation:**
```hcl
ext.force_extension_execution_on_change != null ? {
  forceUpdateTag = ext.force_extension_execution_on_change
} : {}
```

This ensures the field is omitted from the request when not specified, allowing Azure's default behavior.

### No Validation

The provider schema does NOT include any validation for this field. Any string value is accepted. The field serves as a simple tag/token to force extension re-execution when its value changes.

## Deferred Work Completion

**Checked `following.md`:** File does not exist. No work was deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics

**When `force_extension_execution_on_change` is null:**
- The field is NOT included in the API request (conditionally omitted)
- Azure does NOT force extension re-execution
- Extension only runs if its configuration changes

**When `force_extension_execution_on_change` is set:**
- The field IS included in the API request
- Any change to this value forces extension re-execution
- Extension runs even if other configuration is unchanged

### Edge Cases

**Empty String:**
```hcl
force_extension_execution_on_change = ""
```
- Valid: Provider accepts empty string
- Behavior: Field included with empty value
- Effect: Different from null (still triggers inclusion)

**Value Changes:**
```hcl
# First apply
force_extension_execution_on_change = "v1"

# Second apply - change value
force_extension_execution_on_change = "v2"
```
- Valid: Changing the value forces extension re-execution
- No resource replacement (not ForceNew)
- This is the intended use case

**Null to Value Transition:**
```hcl
# First apply - field not set
extension {
  name = "example"
  # force_extension_execution_on_change not specified
}

# Second apply - field added
extension {
  name = "example"
  force_extension_execution_on_change = "v1"
}
```
- Valid: Field can be added after creation
- Forces extension to run on next update

### Idempotency

**Same Value Across Applies:**
```hcl
force_extension_execution_on_change = "constant-value"
```
- Idempotent: No changes if value remains the same
- Azure compares the value to detect changes

**Implementation Safety:**
- Conditional merge ensures stable structure
- Field only added when not null
- No side effects from null values

### Safe References

**Array Iteration:**
```hcl
for ext in var.orchestrated_virtual_machine_scale_set_extension
```
- Safe: Parent check ensures extension list exists
- Safe: Individual extension fields accessed with null checks

**Null Check:**
```hcl
ext.force_extension_execution_on_change != null ? { ... } : {}
```
- Safe: Explicit null check before accessing value
- Safe: Empty object returned when null (no structure change)

## Checklist

- ✅ Property in correct local (`body`)
- ✅ No ForceNew required (field is not ForceNew in schema)
- ✅ Logic exactly replicated from provider (conditional null check)
- ✅ No validations required (schema has no validations)
- ✅ Hidden fields checked (none)
- ✅ Deferred work checked (`following.md` does not exist)
- ✅ Critical review completed (null semantics, edge cases analyzed)
- ✅ Edge Case Analysis documented
- ✅ Proof created
- ✅ track.md will be updated to "Pending for check"
- ✅ Self-Review: Only implemented Task #51 field, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #51 - extension.force_extension_execution_on_change

### Validation Results

✅ **ForceNew Logic:** Not ForceNew - correctly implemented without replacement triggers
✅ **Stable Keys:** N/A (field is not ForceNew)
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Direct assignment from optional string to optional String (no conversion needed)
✅ **Null Handling:** Correctly uses conditional merge to omit field when null
✅ **Validations:** None required - schema has no validations
✅ **Deferred Work Completion:** No deferred work for this task (`following.md` does not exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Comprehensive analysis of null semantics, empty string, value changes, and idempotency
✅ **Shared Path Merge Check:** No duplicate parent keys in merge - all keys unique
✅ **Conditional Inclusion:** Exactly matches provider pattern - field omitted when null
✅ **Assignment Path:** Correctly traced to `properties.virtualMachineProfile.extensionProfile.extensions[].properties.forceUpdateTag`

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The field is:
- Conditionally included only when non-null (exact provider behavior)
- Correctly placed in the extension properties merge structure
- Properly typed as optional string
- Free from validation logic (as per schema)
- Not a ForceNew field (correctly not in replace_triggers_external_values)

The implementation allows users to force extension re-execution by changing this value, matching the AzureRM provider's behavior precisely.

**Status:** APPROVED ✅

---
