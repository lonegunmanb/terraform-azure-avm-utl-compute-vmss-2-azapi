# Task #95: os_disk.diff_disk_settings.placement - IMPLEMENTATION

## Summary

Implemented the `placement` field within the `diff_disk_settings` block of `os_disk`. This optional field specifies where to store the ephemeral disk with a default value of "CacheDisk", includes validation for allowed values (CacheDisk/ResourceDisk), ForceNew trigger, and proper Azure API path mapping.

## Shadow Implementation

```hcl
# migrate_main.tf
locals {
  replace_triggers_external_values = {
    # ... other fields ...
    os_disk_diff_disk_settings_option = { value = var.orchestrated_virtual_machine_scale_set_os_disk != null && var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option : "" }
    os_disk_diff_disk_settings_placement = { value = var.orchestrated_virtual_machine_scale_set_os_disk != null && var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? coalesce(var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement, "CacheDisk") : "" } # <-
  }

  body = {
    properties = merge(
      # ... other properties ...
      var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
        virtualMachineProfile = {
          storageProfile = {
            osDisk = merge(
              # ... base fields ...
              var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? {
                diffDiskSettings = {
                  option = var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option
                  placement = coalesce(var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement, "CacheDisk") # <-
                }
              } : {}
            )
          }
        }
      } : {}
    )
  }
}
```

```hcl
# variables.tf - Added validation
variable "orchestrated_virtual_machine_scale_set_os_disk" {
  # ... existing type definition ...
  
  validation {
    condition = (
      var.orchestrated_virtual_machine_scale_set_os_disk == null ||
      var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings == null ||
      var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement == null ||
      contains(["CacheDisk", "ResourceDisk"], var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement) # <-
    )
    error_message = "The diff_disk_settings.placement must be either 'CacheDisk' or 'ResourceDisk'." # <-
  }
}
```

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern Identified:** Single-phase create operation with `CreateOrUpdateThenPoll`

**Go Code Evidence:**
```go
if v, ok := d.GetOk("os_disk"); ok {
    virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)
}

// ... later in the function ...
props.Properties.VirtualMachineProfile = &virtualMachineProfile

// ...
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Classification:** The `os_disk.diff_disk_settings.placement` field is set in the `virtualMachineProfile.StorageProfile.OsDisk` before the single `CreateOrUpdateThenPoll` call. This is **Create phase** - implemented in `local.body`.

**Decision:** Implement in `local.body` (not in `post_creation_updates`).

## Assignment Path Verification

**Predicted Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.placement`

**Go Code Evidence - Expand Function:**
```go
func ExpandOrchestratedVirtualMachineScaleSetOSDisk(input []interface{}, osType virtualmachinescalesets.OperatingSystemTypes) *virtualmachinescalesets.VirtualMachineScaleSetOSDisk {
	raw := input[0].(map[string]interface{})
	disk := virtualmachinescalesets.VirtualMachineScaleSetOSDisk{
		// ... other fields ...
	}

	if diffDiskSettingsRaw := raw["diff_disk_settings"].([]interface{}); len(diffDiskSettingsRaw) > 0 && diffDiskSettingsRaw[0] != nil {
		diffDiskRaw := diffDiskSettingsRaw[0].(map[string]interface{})
		disk.DiffDiskSettings = &virtualmachinescalesets.DiffDiskSettings{
			Option:    pointer.To(virtualmachinescalesets.DiffDiskOptions(diffDiskRaw["option"].(string))),
			Placement: pointer.To(virtualmachinescalesets.DiffDiskPlacement(diffDiskRaw["placement"].(string))),
		}
	}

	return &disk
}
```

**Assignment Trace:**
1. Expand function reads `raw["diff_disk_settings"]` and creates `disk.DiffDiskSettings.Placement`
2. Function returns `VirtualMachineScaleSetOSDisk` struct
3. In Create: `virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(...)`
4. Then: `props.Properties.VirtualMachineProfile = &virtualMachineProfile`
5. Final path: `Properties.VirtualMachineProfile.StorageProfile.OsDisk.DiffDiskSettings.Placement`

**Verified Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.placement` ✅ **Match**

## Provider Schema

**Source:** `query_terraform_block_implementation_source_code` with `entrypoint_name=schema`

```go
"diff_disk_settings": {
    Type:     pluginsdk.TypeList,
    Optional: true,
    ForceNew: true,
    MaxItems: 1,
    Elem: &pluginsdk.Resource{
        Schema: map[string]*pluginsdk.Schema{
            "option": {
                Type:     pluginsdk.TypeString,
                Required: true,
                ForceNew: true,
                ValidateFunc: validation.StringInSlice([]string{
                    string(virtualmachinescalesets.DiffDiskOptionsLocal),
                }, false),
            },
            "placement": {
                Type:     pluginsdk.TypeString,
                Optional: true,
                ForceNew: true,
                Default:  string(virtualmachinescalesets.DiffDiskPlacementCacheDisk),
                ValidateFunc: validation.StringInSlice([]string{
                    string(virtualmachinescalesets.DiffDiskPlacementCacheDisk),
                    string(virtualmachinescalesets.DiffDiskPlacementResourceDisk),
                }, false),
            },
        },
    },
},
```

**Key Characteristics:**
- **Type:** String (Optional within the diff_disk_settings block)
- **ForceNew:** `true` - changes require resource replacement
- **Default:** `"CacheDisk"` (DiffDiskPlacementCacheDisk)
- **Validation:** `StringInSlice` with `"CacheDisk"` and `"ResourceDisk"` as valid values
- **Parent Block:** Optional with `MaxItems: 1`

## Azure API Schema

**Query Method:** `query_azapi_resource_schema` for specific path

**API Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.placement`

**Type in Azure API:** String

The Azure API schema shows that `diffDiskSettings` is an optional object with `option` and `placement` properties. Both are strings representing the ephemeral disk configuration.

## Hidden Fields

**None.** The expand function only processes fields explicitly defined in the Terraform configuration. No additional hidden fields are set for `placement`.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| `diff_disk_settings.placement` | `diffDiskSettings.placement` |

**Note:** The field name `placement` remains the same in both Terraform and Azure API (no case conversion needed for this specific field name).

## Special Handling

### 1. Default Value

**Provider Behavior:** The provider schema specifies `Default: string(virtualmachinescalesets.DiffDiskPlacementCacheDisk)` which is `"CacheDisk"`.

**Implementation:** Applied default using `coalesce()` function in both body assignment and ForceNew trigger.

```hcl
placement = coalesce(var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement, "CacheDisk")
```

**Rationale:** When user doesn't specify `placement`, it defaults to `"CacheDisk"` matching provider behavior exactly. The `coalesce()` function returns the first non-null value, so:
- If `placement` is provided → use provided value
- If `placement` is null → use `"CacheDisk"`

### 2. Validation

**Implementation:** Added validation block in `variables.tf` to replicate provider's `StringInSlice` validation.

```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_os_disk == null ||
    var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings == null ||
    var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement == null ||
    contains(["CacheDisk", "ResourceDisk"], var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement)
  )
  error_message = "The diff_disk_settings.placement must be either 'CacheDisk' or 'ResourceDisk'."
}
```

**Rationale:** The provider only accepts "CacheDisk" or "ResourceDisk" as valid values. This validation ensures errors are caught at plan time, not during API calls. The validation allows null (optional field), and only validates when a value is provided.

### 3. ForceNew Trigger

**Implementation:** Added to `replace_triggers_external_values` using Mode 1 (Direct Value Tracking).

```hcl
os_disk_diff_disk_settings_placement = { value = var.orchestrated_virtual_machine_scale_set_os_disk != null && var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? coalesce(var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement, "CacheDisk") : "" }
```

**Rationale:** Provider schema marks `placement` as `ForceNew: true`. Changes to this field require resource replacement. The key is always present (stable), and the value tracks the field's effective state (including default).

**Null Handling:** When `diff_disk_settings` is null, the trigger value is empty string, ensuring the key remains stable across applies.

**Default Handling:** The ForceNew trigger uses `coalesce()` to track the effective value including the default. This ensures that:
- null → "CacheDisk" is correctly tracked (no change, both evaluate to "CacheDisk")
- "CacheDisk" → "ResourceDisk" triggers replacement
- "ResourceDisk" → null triggers replacement (null becomes "CacheDisk")

### 4. Field Assignment

**Implementation:** Direct assignment within the conditional `diffDiskSettings` object with default handling.

```hcl
var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? {
  diffDiskSettings = {
    option = var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option
    placement = coalesce(var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement, "CacheDisk")
  }
} : {}
```

**Rationale:** The parent block skeleton (Task #93) already handles the conditional creation of `diffDiskSettings` object. This task adds the `placement` field with proper default handling.

## Deferred Work Completion

**Checked `following.md`:** No work was deferred to Task #95.

## Critical Review & Edge Cases

### Edge Case Analysis

1. **Null Semantics:**
   - When `diff_disk_settings` is `null`: Entire `diffDiskSettings` object is omitted (handled by parent block)
   - When `diff_disk_settings` is present but `placement` is `null`: Default to `"CacheDisk"` (matches provider behavior)
   - Implementation correctly handles both cases with proper null checks and coalesce

2. **Default Behavior:**
   - Provider default: `"CacheDisk"`
   - Implementation default: `coalesce(..., "CacheDisk")` - matches exactly
   - Both body assignment and ForceNew trigger apply default consistently
   - null → "CacheDisk" → no replacement (both evaluate to same value)

3. **Validation Strength:**
   - Only "CacheDisk" or "ResourceDisk" are valid per provider schema
   - Validation implemented in `variables.tf` matches provider validation exactly
   - Error caught at plan time, not during apply
   - Allows null (optional field) - validation only applies when value is provided

4. **ForceNew Behavior:**
   - Any change to effective `placement` value triggers replacement
   - null → "CacheDisk" no replacement (same effective value)
   - "CacheDisk" → "ResourceDisk" triggers replacement
   - "ResourceDisk" → "CacheDisk" triggers replacement
   - "ResourceDisk" → null triggers replacement (null becomes "CacheDisk")

5. **Safe References:**
   - Double null check: `var.orchestrated_virtual_machine_scale_set_os_disk != null && var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null`
   - Prevents null pointer errors when accessing nested field
   - Consistent pattern used in both body assignment and ForceNew trigger

6. **Idempotency:**
   - Field value is assigned with coalesce for default handling
   - Same input always produces same output
   - No order-dependent operations
   - Default applied consistently in all locations

7. **Optional Field Within Optional Block:**
   - Parent block (`diff_disk_settings`) is optional
   - When parent block is present, `placement` is optional with default
   - When `placement` is not provided, default to `"CacheDisk"`
   - Terraform's type system + coalesce handles this correctly

8. **Consistency with Sibling Field:**
   - Task #94 implements `option` (required field)
   - Task #95 implements `placement` (optional field with default)
   - Both share same parent block condition
   - Both use ForceNew triggers (stable key pattern)
   - Default handling is the key difference between the two

## Checklist

- ✅ **Property in correct local:** `placement` added to `local.body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.placement`
- ✅ **ForceNew wrapped:** `{ value = ... }` pattern used in `replace_triggers_external_values`
- ✅ **All logic EXACTLY replicated:** Direct field assignment with default handling matches provider's expand function behavior
- ✅ **Validations IMPLEMENTED:** StringInSlice validation added to `variables.tf`
- ✅ **Default handling:** `coalesce()` used to apply "CacheDisk" default in both body and ForceNew trigger
- ✅ **Hidden fields checked:** None found in expand function
- ✅ **Deferred work checked:** No work deferred to this task in `following.md`
- ✅ **Critical review:** Null handling, default behavior, validation, ForceNew behavior all verified
- ✅ **Edge Case Analysis:** Documented above
- ✅ **Proof created:** This document
- ✅ **Assignment Path:** Correctly verified as `body.properties.virtualMachineProfile.storageProfile.osDisk.diffDiskSettings.placement`
- ✅ **Self-Review:** Only added `placement` field implementation; parent skeleton already existed from Task #93; sibling field `option` implemented in Task #94

---

**Task:** #95 - os_disk.diff_disk_settings.placement  
**Status:** ✅ Completed  
**Type:** Block Argument (Optional, ForceNew, Default: "CacheDisk")  
**Phase:** Create phase in `local.body`

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-10
**Task:** #95 - os_disk.diff_disk_settings.placement

### Issues Identified

#### Issue 1: Method Priority Violation - Default Value Implementation

**Problem:**
Executor used `coalesce()` in locals to apply the default value, violating the method priority rules specified in `executor.md`.

**Executor's Implementation:**
```hcl
# variables.tf
placement = optional(string)  # No default specified

# migrate_main.tf - ForceNew trigger
os_disk_diff_disk_settings_placement = { value = ... ? coalesce(var...placement, "CacheDisk") : "" }

# migrate_main.tf - body assignment
placement = coalesce(var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement, "CacheDisk")
```

**Why This Violates executor.md:**
From executor.md lines 138-142:
> **Defaults:** If schema has `Default`, replicate it:
> - **Top-level:** `variable "field" { default = value }`
> - **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
> - **Fallback:** Apply default in locals if optional() syntax not possible

From checker.md lines 120-147:
> **Method Priority:**
> ```
> PREFER: optional(string, "default") in object type
>    ↓
> Fallback: coalesce() in locals (ONLY if optional() impossible)
> ```
> 
> **Common Violation:**
> ```hcl
> # ❌ WRONG
> type = list(object({ field = optional(string) }))
> # In locals: coalesce(obj.field, "default")
> 
> # ✅ CORRECT
> type = list(object({ field = optional(string, "default") }))
> # In locals: obj.field  # Guaranteed non-null
> ```

**Provider's Actual Behavior:**
```go
"placement": {
    Type:     pluginsdk.TypeString,
    Optional: true,
    ForceNew: true,
    Default:  string(virtualmachinescalesets.DiffDiskPlacementCacheDisk),  // "CacheDisk"
    ValidateFunc: validation.StringInSlice([]string{
        string(virtualmachinescalesets.DiffDiskPlacementCacheDisk),
        string(virtualmachinescalesets.DiffDiskPlacementResourceDisk),
    }, false),
},
```

**Expected Behavior:**
- The field is inside `optional(object({ ... }))` 
- Using `optional(string, "CacheDisk")` is syntactically possible and preferred
- The default should be applied in the type definition, NOT in locals

**Root Cause:**
Executor chose the fallback method (coalesce in locals) when the preferred method (optional with default in type) was technically possible. This violates the method priority mandate.

### Corrections Made

#### Fix 1: Apply Default Using optional() in Type Definition

**Changed Files:**
- `variables.tf`: Changed `placement = optional(string)` to `placement = optional(string, "CacheDisk")`
- `migrate_main.tf`: Removed `coalesce()` calls, now directly use `var...placement` (guaranteed non-null by type system)

**New Implementation:**

```hcl
# variables.tf - CORRECTED
variable "orchestrated_virtual_machine_scale_set_os_disk" {
  type = object({
    # ...
    diff_disk_settings = optional(object({
      option    = string
      placement = optional(string, "CacheDisk")  # <- Default applied here
    }))
  })
  # ... validations ...
}

# migrate_main.tf - ForceNew trigger - CORRECTED
os_disk_diff_disk_settings_placement = { 
  value = var.orchestrated_virtual_machine_scale_set_os_disk != null && 
          var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? 
          var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement : ""  # <- Direct use, no coalesce
}

# migrate_main.tf - body assignment - CORRECTED
var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings != null ? {
  diffDiskSettings = {
    option = var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.option
    placement = var.orchestrated_virtual_machine_scale_set_os_disk.diff_disk_settings.placement  # <- Direct use, no coalesce
  }
} : {}
```

**Why This is EXACT:**
1. Uses `optional(string, "CacheDisk")` - the PREFERRED method per executor.md
2. Type system guarantees `placement` is never null (defaults to "CacheDisk")
3. Locals can directly reference the field without coalesce
4. Matches provider behavior: default applies when field is not specified
5. Follows method priority: preferred method used, not fallback

**Verification:**
- **Scenario 1:** User doesn't specify `diff_disk_settings` → Block is null, no placement field → ✅
- **Scenario 2:** User specifies `diff_disk_settings` but omits `placement` → Defaults to "CacheDisk" → ✅
- **Scenario 3:** User specifies `placement = "ResourceDisk"` → Uses "ResourceDisk" → ✅
- **Scenario 4:** ForceNew trigger tracks actual value correctly in all scenarios → ✅
- **Edge Case:** null → "CacheDisk" (via default) → No replacement (key stable, value same as default) → ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md` using the PREFERRED method for default values.

**All Validations:**
- ✅ **ForceNew Logic:** Simple ForceNew correctly implemented with stable key pattern
- ✅ **Stable Keys:** All keys in `replace_triggers_external_values` are stable
- ✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
- ✅ **Type Conversion:** String to String - no conversion needed
- ✅ **Null Handling:** Correctly propagates null semantics with proper guards
- ✅ **Validations:** StringInSlice validation correctly implemented in `variables.tf`
- ✅ **Default Value:** Now correctly applied using `optional(string, "CacheDisk")` - PREFERRED method
- ✅ **Deferred Work Completion:** No deferred work for this task (checked `following.md`)
- ✅ **Deferred Work Recording:** No deferrals made
- ✅ **Edge Cases:** All edge cases properly analyzed and handled

**Status:** CORRECTED AND APPROVED ✅

---
