# Task #47: extension.type_handler_version - Implementation Proof

## Shadow Implementation

```hcl
# In migrate_main.tf:
var.orchestrated_virtual_machine_scale_set_extension != null ? {
  extensions = [
    for ext in var.orchestrated_virtual_machine_scale_set_extension : {
      name = ext.name
      properties = {
        publisher          = ext.publisher
        type               = ext.type
        typeHandlerVersion = ext.type_handler_version # <-
        # autoUpgradeMinorVersion = ... # Task #48
        # ...
      }
    }
  ]
} : {}

# In variables.tf (validation added):
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_extension == null ||
    alltrue([for ext in var.orchestrated_virtual_machine_scale_set_extension : ext.type_handler_version != ""]) # <-
  )
  error_message = "The extension type_handler_version must not be empty." # <-
}
```

## Summary

Implemented `type_handler_version` field for extension block. This Required string field specifies the version of the VM extension. Direct mapping with validation replicating provider's `StringIsNotEmpty` check.

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code(entrypoint_name="create")`

**Pattern Identified:** Single-phase Create

**Go Code Evidence:**
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    if v, ok := d.GetOk("extension"); ok {
        var err error
        virtualMachineProfile.ExtensionProfile, hasHealthExtension, err = expandOrchestratedVirtualMachineScaleSetExtensions(v.(*pluginsdk.Set).List())
        if err != nil {
            return err
        }
    }
    // ...
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    // ...
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Classification:** Create phase - field is set in `virtualMachineProfile.ExtensionProfile` before `CreateOrUpdateThenPoll` call.

**Decision:** Implemented in `local.body` (Create phase).

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.extensionProfile.extensions[].properties.typeHandlerVersion`

**Go Code Evidence from expandOrchestratedVirtualMachineScaleSetExtensions:**
```go
func expandOrchestratedVirtualMachineScaleSetExtensions(input []interface{}) (*virtualmachinescalesets.VirtualMachineScaleSetExtensionProfile, bool, error) {
    // ...
    for _, v := range input {
        extensionRaw := v.(map[string]interface{})
        extension := virtualmachinescalesets.VirtualMachineScaleSetExtension{
            Name: pointer.To(extensionRaw["name"].(string)),
        }
        
        extensionProps := virtualmachinescalesets.VirtualMachineScaleSetExtensionProperties{
            Publisher:               pointer.To(extensionRaw["publisher"].(string)),
            Type:                    &extensionType,
            TypeHandlerVersion:      pointer.To(extensionRaw["type_handler_version"].(string)), // <- Assigns to TypeHandlerVersion
            AutoUpgradeMinorVersion: pointer.To(autoUpgradeMinorVersion),
        }
        // ...
        extension.Properties = &extensionProps // <- Assigns to Properties
        extensions = append(extensions, extension)
    }
    extensionProfile.Extensions = &extensions // <- Assigns to Extensions
    return extensionProfile, hasHealthExtension, nil
}
```

**Assignment Trace:**
1. `TypeHandlerVersion` field in `VirtualMachineScaleSetExtensionProperties` struct
2. `extension.Properties = &extensionProps` → Nested under `properties`
3. `extensionProfile.Extensions = &extensions` → Nested under `extensions` array
4. `virtualMachineProfile.ExtensionProfile = extensionProfile` → Nested under `extensionProfile`
5. `props.Properties.VirtualMachineProfile = &virtualMachineProfile` → Nested under `virtualMachineProfile`

**Verified Path:** `properties.virtualMachineProfile.extensionProfile.extensions[].properties.typeHandlerVersion`

**Path Comparison:** ✅ MATCH - Predicted path matches verified path.

## Provider Schema

From `OrchestratedVirtualMachineScaleSetExtensionsSchema()`:

```go
"type_handler_version": {
    Type:         pluginsdk.TypeString,
    Required:     true,
    ValidateFunc: validation.StringIsNotEmpty,
},
```

**Key Properties:**
- **Type:** `TypeString`
- **Required:** `true`
- **Validation:** `validation.StringIsNotEmpty` - ensures the version string is not empty

## Azure API Schema

**Query Result:**
- **Path:** `body.properties.virtualMachineProfile.extensionProfile.extensions.properties.typeHandlerVersion`
- **Type:** `String`
- **Description:** Specifies the version of the script handler

## Hidden Fields

None - straightforward string field assignment.

## Mapping

| Terraform Field | Azure API Field | Transformation |
|----------------|-----------------|----------------|
| `extension[].type_handler_version` | `extensions[].properties.typeHandlerVersion` | snake_case → camelCase |

## Special Handling

### 1. Validation

**Provider Validation:** `validation.StringIsNotEmpty`

**Implementation:** Added validation block in `variables.tf`:
```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_extension == null ||
    alltrue([for ext in var.orchestrated_virtual_machine_scale_set_extension : ext.type_handler_version != ""])
  )
  error_message = "The extension type_handler_version must not be empty."
}
```

**Compliance:** EXACTLY replicates provider's `StringIsNotEmpty` validation.

### 2. ForceNew

**Schema Check:** No `ForceNew: true` in schema.

**CustomizeDiff Check:** No CustomizeDiff logic for this field in resource function.

**Implementation:** Not added to `replace_triggers_external_values`.

### 3. Create Phase

**Classification:** Create phase field.

**Implementation:** Added to `local.body.properties.virtualMachineProfile.extensionProfile.extensions[].properties.typeHandlerVersion`.

### 4. Sensitive/WriteOnly

**Check:** Not marked as `Sensitive: true` in schema.

**Implementation:** Placed in `local.body` (not `sensitive_body`).

## Deferred Work Completion

**Check in following.md:** File does not exist - no deferred work for this task.

## Critical Review & Edge Case

### Null Semantics
- **Required field:** Must always be provided when extension is configured
- **Parent null:** When `extension` block is null, this field is not rendered (correct behavior)
- **Empty string:** Validation prevents empty strings

### Boundary Conditions
- **Empty string:** Blocked by validation `ext.type_handler_version != ""`
- **Extension without type_handler_version:** Type system enforces presence (Required field)

### Idempotency
- **Direct passthrough:** String value passed directly without transformation
- **No ordering issues:** Field is not a collection

### Safe References
- **Parent check:** Field only accessed when `extension` block exists (checked by `var.orchestrated_virtual_machine_scale_set_extension != null`)
- **Loop iteration:** Safe access via `ext.type_handler_version` in for-loop

### Edge Case Analysis

**Scenario 1: Version string with special characters**
- Provider behavior: Accepts any non-empty string
- Our implementation: Direct passthrough matches provider

**Scenario 2: Numeric version (e.g., "1.0")**
- Provider behavior: Stored as string
- Our implementation: String type matches provider

**Scenario 3: Extension array with mixed versions**
- Provider behavior: Each extension has independent version
- Our implementation: Correct - each `ext.type_handler_version` is independent in loop

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ Field assigned to correct path (`extensions[].properties.typeHandlerVersion`)
- ✅ Validation IMPLEMENTED in variables.tf (MANDATORY - `StringIsNotEmpty` replicated)
- ✅ No ForceNew required (not in schema or CustomizeDiff)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work checked (no following.md file)
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis completed
- ✅ Proof created
- ✅ Ready for track.md update

---

## Implementation Compliance Statement

This implementation EXACTLY replicates the provider behavior:

1. **Field Type:** String (matches provider)
2. **Required:** Yes (matches provider)
3. **Validation:** `StringIsNotEmpty` replicated in variables.tf validation block
4. **Assignment Path:** Correctly placed in `extensions[].properties.typeHandlerVersion`
5. **No Transformations:** Direct passthrough of string value
6. **Create Phase:** Single-phase create, field included in initial API call

No deviations, no simplifications, no "safer" alternatives - EXACT replication as required by executor.md.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-08
**Task:** #47 - extension.type_handler_version

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew - not applicable (no ForceNew in schema or CustomizeDiff)
✅ **Stable Keys:** Not applicable - field not in `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Correct - String type matches provider
✅ **Null Handling:** Correctly propagates null semantics (parent-level null check)
✅ **Validations:** `StringIsNotEmpty` validation implemented in variables.tf validation block
✅ **Sensitive/WriteOnly:** Correctly placed in `local.body` (not sensitive or writeonly)
✅ **Deferred Work Completion:** No deferred work for this task (no following.md file)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled
✅ **Merge Structure:** No shared path merge issues - extensions array correctly structured

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found.

**Verification Details:**
- ✅ Field implemented at correct path: `extensions[].properties.typeHandlerVersion`
- ✅ Validation exactly matches provider's `validation.StringIsNotEmpty`
- ✅ Required field correctly enforced in variable type definition
- ✅ Create phase correctly identified and field placed in `local.body`
- ✅ No ForceNew logic needed (correctly absent from `replace_triggers_external_values`)
- ✅ Loop iteration safe with proper parent null checks
- ✅ Proof document contains all required sections with proper evidence

**Status:** APPROVED ✅

---
