# Task #92 - os_disk.write_accelerator_enabled

## Summary

Implemented the `write_accelerator_enabled` field for the `os_disk` block. This is an optional boolean field with a default value of `false` that specifies if Write Accelerator is enabled on the OS Disk. The field is updatable and placed directly in the osDisk object.

## Shadow Implementation

```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_os_disk" {
  type = object({
    caching                   = string
    disk_encryption_set_id    = optional(string)
    disk_size_gb              = optional(number)
    storage_account_type      = string
    write_accelerator_enabled = optional(bool, false) # <- Task #92: Default value applied
    diff_disk_settings = optional(object({
      option    = string
      placement = optional(string)
    }))
  })
  # ...
}

# migrate_main.tf
locals {
  body = {
    properties = merge(
      var.orchestrated_virtual_machine_scale_set_sku_name != null ? {
        virtualMachineProfile = merge(
          var.orchestrated_virtual_machine_scale_set_data_disk != null || var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
            storageProfile = merge(
              var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
                osDisk = {
                  caching = var.orchestrated_virtual_machine_scale_set_os_disk.caching
                  managedDisk = { /* ... */ }
                  diskSizeGB = var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb != null && var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb > 0 ? var.orchestrated_virtual_machine_scale_set_os_disk.disk_size_gb : null
                  writeAcceleratorEnabled = var.orchestrated_virtual_machine_scale_set_os_disk.write_accelerator_enabled # <- Task #92
                }
              } : {}
            )
          } : {}
        )
      } : {}
    )
  }
}
```

## Create Phase Verification

**Pattern:** Single-phase creation

**Evidence from Create method:**

```go
if v, ok := d.GetOk("os_disk"); ok {
    virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)
}

// ... later in Create method ...
props.Properties.VirtualMachineProfile = &virtualMachineProfile

// Single-phase creation
if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Classification:** The `write_accelerator_enabled` field is set during the Create phase (within the `ExpandOrchestratedVirtualMachineScaleSetOSDisk` function before the CreateOrUpdateThenPoll call). The field is added to `local.body`.

## Assignment Path Verification

**Predicted Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.writeAcceleratorEnabled`

**Go Code Evidence:**

From `ExpandOrchestratedVirtualMachineScaleSetOSDisk`:

```go
func ExpandOrchestratedVirtualMachineScaleSetOSDisk(input []interface{}, osType virtualmachinescalesets.OperatingSystemTypes) *virtualmachinescalesets.VirtualMachineScaleSetOSDisk {
	raw := input[0].(map[string]interface{})
	disk := virtualmachinescalesets.VirtualMachineScaleSetOSDisk{
		Caching: pointer.To(virtualmachinescalesets.CachingTypes(raw["caching"].(string))),
		ManagedDisk: &virtualmachinescalesets.VirtualMachineScaleSetManagedDiskParameters{
			StorageAccountType: pointer.To(virtualmachinescalesets.StorageAccountTypes(raw["storage_account_type"].(string))),
		},
		WriteAcceleratorEnabled: pointer.To(raw["write_accelerator_enabled"].(bool)),  // <- Field assigned here
		CreateOption: virtualmachinescalesets.DiskCreateOptionTypesFromImage,
	}
	// ...
	return &disk
}
```

From Create method:
```go
if v, ok := d.GetOk("os_disk"); ok {
    virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)
}

// Later:
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Path Tracing:**
1. `disk.WriteAcceleratorEnabled` = pointer.To(raw["write_accelerator_enabled"].(bool))
2. `virtualMachineProfile.StorageProfile.OsDisk` = &disk
3. `props.Properties.VirtualMachineProfile` = &virtualMachineProfile
4. Final path: `properties.virtualMachineProfile.storageProfile.osDisk.writeAcceleratorEnabled`

**Verified Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.writeAcceleratorEnabled` ✅

## Provider Schema

From `OrchestratedVirtualMachineScaleSetOSDiskSchema()`:

```go
"write_accelerator_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
},
```

**Field Properties:**
- **Type:** Boolean
- **Required:** No (Optional)
- **Default:** false
- **ForceNew:** No
- **Computed:** No
- **Validation:** None (boolean type)

## Azure API Schema

**Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.writeAcceleratorEnabled`

**Query Result:**
```
Bool
```

**Schema Type:** Boolean - Azure API accepts true/false values for enabling/disabling Write Accelerator on the OS disk.

## Hidden Fields

None. The field is directly exposed and has no additional processing or hidden related fields.

## Mapping

Terraform (snake_case) → Azure API (camelCase):

| Terraform Field | Azure API Field |
|----------------|-----------------|
| `write_accelerator_enabled` | `writeAcceleratorEnabled` |

## Special Handling

### Default Value Implementation

The provider schema specifies `Default: false`. This is replicated using Terraform's `optional()` function with default value:

```hcl
write_accelerator_enabled = optional(bool, false)
```

This ensures that when users don't specify the field, it defaults to `false`, matching the exact AzureRM provider behavior.

### No ForceNew

The field does NOT have `ForceNew: true` in the schema, meaning changes to this field can be applied via Update without recreating the resource. The Update method handles this field:

```go
// From Update method - ExpandOrchestratedVirtualMachineScaleSetOSDiskUpdate
if d.HasChange("os_disk") {
    osDiskRaw := d.Get("os_disk").([]interface{})
    updateProps.VirtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDiskUpdate(osDiskRaw)
}
```

```go
func ExpandOrchestratedVirtualMachineScaleSetOSDiskUpdate(input []interface{}) *virtualmachinescalesets.VirtualMachineScaleSetUpdateOSDisk {
	raw := input[0].(map[string]interface{})
	disk := virtualmachinescalesets.VirtualMachineScaleSetUpdateOSDisk{
		Caching: pointer.To(virtualmachinescalesets.CachingTypes(raw["caching"].(string))),
		ManagedDisk: &virtualmachinescalesets.VirtualMachineScaleSetManagedDiskParameters{
			StorageAccountType: pointer.To(virtualmachinescalesets.StorageAccountTypes(raw["storage_account_type"].(string))),
		},
		WriteAcceleratorEnabled: pointer.To(raw["write_accelerator_enabled"].(bool)),  // <- Updatable
	}
	// ...
	return &disk
}
```

Since the field is updatable and not ForceNew, no entry is needed in `replace_triggers_external_values`.

### No Validation

The field has no custom validation in the provider beyond being a boolean type. No validation block is needed in `variables.tf`.

### Direct Assignment

The field value is assigned directly without conditional logic:

```hcl
writeAcceleratorEnabled = var.orchestrated_virtual_machine_scale_set_os_disk.write_accelerator_enabled
```

The default value (`false`) is automatically applied by the `optional(bool, false)` type definition, so no coalesce or conditional is needed in the locals.

## Deferred Work Completion

Checked `following.md` - no work was deferred to Task #92. ✅

## Critical Review & Edge Case Analysis

### Null Semantics

- **When field is not specified:** The `optional(bool, false)` ensures the value defaults to `false`, matching provider behavior
- **When explicitly set to false:** Sends `false` to the API, same as default
- **When explicitly set to true:** Sends `true` to the API

The field always has a value (never null) due to the default, which matches the provider's `Default: false` schema property.

### Boundary Conditions

- **Boolean values only:** The field only accepts `true` or `false`, enforced by Terraform's type system
- **Parent block existence:** The field is only included when `os_disk` block is present (checked by parent conditional)
- **VM SKU requirement:** The field is only included when `sku_name != null` (enforced by parent virtualMachineProfile condition)

### Idempotency

- **Stable assignment:** Direct field assignment without conditional logic ensures stable API payloads
- **Default handling:** The `optional(bool, false)` syntax ensures consistent default application across plan/apply cycles
- **No merge complexity:** Boolean field assignment is deterministic and doesn't involve merge operations

### Safe References

- **Parent null check:** Field access is protected by `var.orchestrated_virtual_machine_scale_set_os_disk != null` at the osDisk block level
- **No nested access:** Direct boolean field access with no nested object traversal
- **Type safety:** Boolean type enforced by variable definition

### Edge Cases

1. **Default behavior:** When users omit the field, it defaults to `false` via `optional(bool, false)`, exactly matching the AzureRM provider's `Default: false`
2. **Explicit false:** Users can explicitly set `write_accelerator_enabled = false`, which produces the same API payload as the default
3. **Update scenario:** Field can be toggled between `true` and `false` without resource recreation (not ForceNew)
4. **Legacy mode:** When `sku_name` is not set, the entire `virtualMachineProfile` (including this field) is omitted - handled by existing parent condition
5. **Missing os_disk block:** When `os_disk` is null, this field is not sent to the API - correct behavior

## Checklist

- ✅ Field added to correct path: `body.properties.virtualMachineProfile.storageProfile.osDisk.writeAcceleratorEnabled`
- ✅ Default value replicated: `optional(bool, false)` in variables.tf
- ✅ No ForceNew handling needed: Field is updatable, not in replace_triggers_external_values
- ✅ No validation needed: Boolean type, no custom validation in provider
- ✅ Comment placeholder replaced in migrate_main.tf
- ✅ Direct assignment: No conditional logic needed, default handled by optional()
- ✅ Update method verified: Field is updatable via ExpandOrchestratedVirtualMachineScaleSetOSDiskUpdate
- ✅ No DiffSuppressFunc: Field has no diff suppression logic
- ✅ No CustomizeDiff: Field has no custom diff logic
- ✅ Deferred work checked: No work deferred to this task in following.md
- ✅ No work deferred from this task: Simple boolean field with no cross-field dependencies
- ✅ Edge case analysis completed: Null semantics, defaults, idempotency verified
- ✅ Self-review: Added only the write_accelerator_enabled field, no content from other tasks
- ✅ Proof document created
- ✅ Ready to update track.md status to "Pending for check"

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-10
**Task:** #92 - os_disk.write_accelerator_enabled

### Validation Results

✅ **Default Value Implementation:** EXACT replication using preferred `optional(bool, false)` syntax matching provider's `Default: false`
✅ **Field Assignment:** Direct assignment correct - default value ensures non-null
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Assignment Path:** Verified path `body.properties.virtualMachineProfile.storageProfile.osDisk.writeAcceleratorEnabled` matches Go code
✅ **ForceNew Logic:** Correctly NOT in `replace_triggers_external_values` - field is updatable per Update method evidence
✅ **Validation:** None required - boolean type with no custom validation in provider
✅ **Sensitive/WriteOnly:** Correctly placed in `local.body` (not sensitive)
✅ **Type Conversion:** Direct boolean assignment - no conversion needed
✅ **Null Handling:** Default value via `optional(bool, false)` ensures consistent behavior
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made - simple boolean field with no cross-field dependencies
✅ **Edge Cases:** Comprehensive analysis in proof document - null semantics, boundary conditions, idempotency, safe references all verified
✅ **Proof Document Quality:** Complete with all required sections, no prohibited content
✅ **Implementation Scope:** Only write_accelerator_enabled field added - proper scope adherence

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The default value is implemented using the PREFERRED `optional(bool, false)` method (executor.md lines 140-141), not the fallback coalesce() approach. The field is correctly recognized as updatable (not ForceNew) based on Update method evidence. Direct assignment is appropriate since the default ensures the field is never null. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
