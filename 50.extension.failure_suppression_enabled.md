# Task #50: extension.failure_suppression_enabled

## Shadow Implementation

```hcl
# In variables.tf
variable "orchestrated_virtual_machine_scale_set_extension" {
  type = set(object({
    failure_suppression_enabled               = optional(bool, false) # <-
  }))
}

# In migrate_main.tf
extensions = [
  for ext in var.orchestrated_virtual_machine_scale_set_extension : {
    properties = merge(
      ext.failure_suppression_enabled != null ? { # <-
        suppressFailures = ext.failure_suppression_enabled # <-
      } : {} # <-
    )
  }
]
```

## Summary

Implemented `failure_suppression_enabled` as an optional boolean field within the extension block with a default value of `false`, mapping to Azure API's `suppressFailures` property.

## Create Phase Verification

### Query Create Method

Queried `resourceOrchestratedVirtualMachineScaleSetCreate` to identify field handling pattern.

### Go Code Evidence

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    if v, ok := d.GetOk("extension"); ok {
        var err error
        virtualMachineProfile.ExtensionProfile, hasHealthExtension, err = expandOrchestratedVirtualMachineScaleSetExtensions(v.(*pluginsdk.Set).List())
        if err != nil {
            return err
        }
    }
    // ...
}
```

### Pattern Identification

**Single-phase creation**: The field is assigned before `client.CreateOrUpdateThenPoll()` call.

### Field Classification

**Create phase**: Field is set in the `virtualMachineProfile.ExtensionProfile` before the create call.

### Decision

Field belongs in `local.body`, not `local.post_creation_updates`.

## Assignment Path Verification

### Predicted Path

```
body.properties.virtualMachineProfile.extensionProfile.extensions[].properties.suppressFailures
```

### Go Code Evidence - Expand Function

```go
func expandOrchestratedVirtualMachineScaleSetExtensions(input []interface{}) (*virtualmachinescalesets.VirtualMachineScaleSetExtensionProfile, bool, error) {
    // ...
    extensions := make([]virtualmachinescalesets.VirtualMachineScaleSetExtension, 0)
    for _, v := range input {
        extensionRaw := v.(map[string]interface{})
        extension := virtualmachinescalesets.VirtualMachineScaleSetExtension{
            Name: pointer.To(extensionRaw["name"].(string)),
        }
        extensionType := extensionRaw["type"].(string)

        autoUpgradeMinorVersion, _ := extensionRaw["auto_upgrade_minor_version_enabled"].(bool)

        extensionProps := virtualmachinescalesets.VirtualMachineScaleSetExtensionProperties{
            Publisher:               pointer.To(extensionRaw["publisher"].(string)),
            Type:                    &extensionType,
            TypeHandlerVersion:      pointer.To(extensionRaw["type_handler_version"].(string)),
            AutoUpgradeMinorVersion: pointer.To(autoUpgradeMinorVersion),
        }

        // Health extension detection
        if extensionType == "ApplicationHealthLinux" || extensionType == "ApplicationHealthWindows" {
            hasHealthExtension = true
        }

        if val, ok := extensionRaw["failure_suppression_enabled"]; ok {
            extensionProps.SuppressFailures = pointer.To(val.(bool))
        }
        // ...
        extension.Properties = &extensionProps
        extensions = append(extensions, extension)
    }
    // ...
    return &virtualmachinescalesets.VirtualMachineScaleSetExtensionProfile{
        Extensions: &extensions,
    }, hasHealthExtension, nil
}
```

### Verified Path

1. `extensionProps.SuppressFailures` is set from `failure_suppression_enabled`
2. `extension.Properties = &extensionProps` assigns properties to extension
3. Extensions are returned in `VirtualMachineScaleSetExtensionProfile.Extensions`
4. Final path: `properties.virtualMachineProfile.extensionProfile.extensions[].properties.suppressFailures`

### Path Comparison

**Match**: Predicted path matches the verified path from source code.

## Provider Schema

```go
"failure_suppression_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
},
```

### Schema Analysis
- **Type**: Boolean
- **Required**: No (Optional)
- **Default**: `false`
- **ForceNew**: No
- **Sensitive**: No
- **Computed**: No
- **DiffSuppressFunc**: None

## Azure API Schema

**Property Path**: `body.properties.virtualMachineProfile.extensionProfile.extensions[].properties.suppressFailures`

**Type**: `Bool`

## Hidden Fields

None identified for this field.

## Mapping

| Terraform Field | Azure API Field | Notes |
|-----------------|-----------------|-------|
| `extension[].failure_suppression_enabled` | `extensions[].properties.suppressFailures` | Direct boolean mapping, different naming |

## Special Handling

### Default Value

Provider schema shows `Default: false`. This must be replicated in the variable definition using the `optional(bool, false)` syntax:

```hcl
failure_suppression_enabled = optional(bool, false)
```

### ForceNew

Not a ForceNew field - updates are allowed without replacement.

### Validation

No validations required - simple boolean field with no constraints.

### Sensitive

Not a sensitive field.

### Conditional Logic

The field is only assigned when not null:

```hcl
ext.failure_suppression_enabled != null ? {
  suppressFailures = ext.failure_suppression_enabled
} : {}
```

This follows the standard pattern for optional fields within merge() operations.

## Deferred Work Completion

No work was deferred to this task in `following.md` (file does not exist).

## Critical Review & Edge Case Analysis

### Null Semantics

- **`null` value**: When user does not specify the field, the default value `false` applies due to `optional(bool, false)` in the object type definition
- **Explicit `false`**: User explicitly sets to `false`, same effect as default
- **Explicit `true`**: User explicitly sets to `true`, failures will be suppressed

### Edge Cases

1. **Empty extension set**: If no extensions are defined, this field is never evaluated ✓
2. **Multiple extensions**: Each extension can have its own `failure_suppression_enabled` value ✓
3. **Boolean conversion**: Direct boolean mapping, no conversion issues ✓

### Idempotency

The implementation is idempotent:
- Default value behavior is consistent
- Conditional assignment prevents null values in API payload
- No order-dependent logic

### Safe References

All references are safe:
- `ext.failure_suppression_enabled` is accessed within iteration context where `ext` is guaranteed to exist
- Null check prevents null values from being sent to API
- No nested access that could fail

### Default Value Strategy

Using `optional(bool, false)` ensures:
1. When field is omitted, value is `false` (matching provider default)
2. When field is `null`, value is `false` (matching provider default)
3. When field is explicitly set, user value is preserved
4. API receives either `true` or `false`, never `null`

This matches the provider's behavior where the default is applied at schema level.

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ ForceNew: Not applicable (not a ForceNew field)
- ✅ All logic EXACTLY replicated from provider
- ✅ Validations: None required (simple boolean)
- ✅ Default value replicated using `optional(bool, false)` syntax
- ✅ Hidden fields checked: None
- ✅ Deferred work in following.md: Not applicable (no deferral)
- ✅ Deferred work from following.md: None (file does not exist)
- ✅ Critical review completed
- ✅ Edge Case Analysis completed
- ✅ Proof created
- ✅ Self-Review: Only implemented `failure_suppression_enabled` field, did not add fields from other tasks

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #50 - extension.failure_suppression_enabled

### Issues Identified

#### Issue 1: Incorrect Conditional Logic for Field with Default Value

**Problem:**
The original implementation used a null check before assigning the `suppressFailures` field:

```hcl
ext.failure_suppression_enabled != null ? {
  suppressFailures = ext.failure_suppression_enabled
} : {}
```

**Why This Violates executor.md:**

The provider schema shows:
```go
"failure_suppression_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
}
```

From executor.md lines 124-127:
> **Defaults:** If schema has `Default`, replicate it:
> - **Nested (PREFER):** `optional(bool, false)` in object type

The executor correctly used `optional(bool, false)` in the variable definition, which means:
1. The field will **NEVER be null**
2. If not explicitly set by user, it will have value `false`
3. The field ALWAYS has a concrete boolean value

**Provider's Actual Behavior:**
```go
if val, ok := extensionRaw["failure_suppression_enabled"]; ok {
    extensionProps.SuppressFailures = pointer.To(val.(bool))
}
```

With Terraform's `optional(bool, false)`, the field always exists in the map with a value (either user-provided or default `false`), so the provider always sets `SuppressFailures` with that value.

**Expected Behavior:**
- User omits field → value is `false` → API receives `suppressFailures: false`
- User sets to `false` → value is `false` → API receives `suppressFailures: false`
- User sets to `true` → value is `true` → API receives `suppressFailures: true`

**Root Cause:**
The null check `!= null` is meaningless when `optional(bool, false)` guarantees a non-null value. The conditional prevents nothing and adds confusion.

### Corrections Made

#### Fix 1: Remove Unnecessary Null Check

**Changed Files:**
- `migrate_main.tf`: Removed conditional wrapper around `suppressFailures` field

**New Implementation:**
```hcl
ext.extensions_to_provision_after_vm_creation != null ? {
  provisionAfterExtensions = ext.extensions_to_provision_after_vm_creation
} : {},
{
  suppressFailures = ext.failure_suppression_enabled
}
```

**Why This is EXACT:**

1. **Matches provider behavior:** Provider always sets `SuppressFailures` when field exists in map
2. **Respects default value:** With `optional(bool, false)`, field always has a value
3. **No null risk:** `ext.failure_suppression_enabled` is guaranteed to be a boolean (never null)
4. **API receives correct values:** Always sends boolean value to API (matching provider)

**Verification:**
- Scenario 1: User omits field → `optional(bool, false)` provides `false` → API receives `suppressFailures: false` ✅
- Scenario 2: User sets to `false` → value is `false` → API receives `suppressFailures: false` ✅
- Scenario 3: User sets to `true` → value is `true` → API receives `suppressFailures: true` ✅
- Edge Case: Field is part of `set(object(...))` → Terraform ensures object structure integrity ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The default value is properly applied via `optional(bool, false)`, and the field is unconditionally sent to the API with its boolean value, matching the provider's behavior.

**Status:** CORRECTED AND APPROVED ✅

---
