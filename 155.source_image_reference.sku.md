# Task #155: source_image_reference.sku - Block Argument

## Summary
Implemented `sku` field within `source_image_reference` block at `properties.virtualMachineProfile.storageProfile.imageReference.sku`. Field is Required, no ForceNew behavior for Orchestrated VMSS, and includes validation for non-empty string.

## Shadow Implementation

```hcl
# In variables.tf
variable "orchestrated_virtual_machine_scale_set_source_image_reference" {
  type = object({
    offer     = string
    publisher = string
    sku       = string
    version   = string
  })
  default     = null
  description = <<-EOT
 - `offer` - (Required) Specifies the offer of the image used to create the virtual machines. Changing this forces a new resource to be created.
 - `publisher` - (Required) Specifies the publisher of the image used to create the virtual machines. Changing this forces a new resource to be created.
 - `sku` - (Required) Specifies the SKU of the image used to create the virtual machines.
 - `version` - (Required) Specifies the version of the image used to create the virtual machines.
EOT

  validation {
    condition     = var.orchestrated_virtual_machine_scale_set_source_image_reference == null || (var.orchestrated_virtual_machine_scale_set_source_image_reference.sku != null && var.orchestrated_virtual_machine_scale_set_source_image_reference.sku != "")
    error_message = "The `sku` field in `source_image_reference` must not be empty."
  }
}

# In migrate_main.tf - local.body
var.orchestrated_virtual_machine_scale_set_source_image_reference != null ? {
  imageReference = {
    offer     = var.orchestrated_virtual_machine_scale_set_source_image_reference.offer
    publisher = var.orchestrated_virtual_machine_scale_set_source_image_reference.publisher
    sku       = var.orchestrated_virtual_machine_scale_set_source_image_reference.sku
    # ... other fields
  }
} : {}
```

## Create Phase Verification

**Pattern:** Single-phase Create (inherited from parent block Task #152)

**Evidence from Create method:**
```go
sourceImageReferenceRaw := d.Get("source_image_reference").([]interface{})
sourceImageId := d.Get("source_image_id").(string)
if len(sourceImageReferenceRaw) != 0 || sourceImageId != "" {
    sourceImageReference := expandSourceImageReferenceVMSS(sourceImageReferenceRaw, sourceImageId)
    virtualMachineProfile.StorageProfile.ImageReference = sourceImageReference
}
```

**Classification:** Create phase - The field is set directly in `virtualMachineProfile.StorageProfile.ImageReference` before the `CreateOrUpdateThenPoll` call.

**Decision:** Implement in `local.body`, not `post_creation_updates`.

## Assignment Path Verification

**Predicted Path:**
```
properties.virtualMachineProfile.storageProfile.imageReference.sku
```

**Go Code Evidence:**
```go
func expandSourceImageReferenceVMSS(referenceInput []interface{}, imageId string) *virtualmachinescalesets.ImageReference {
    // ... imageId handling omitted ...
    
    raw := referenceInput[0].(map[string]interface{})
    return &virtualmachinescalesets.ImageReference{
        Publisher: pointer.To(raw["publisher"].(string)),
        Offer:     pointer.To(raw["offer"].(string)),
        Sku:       pointer.To(raw["sku"].(string)),
        Version:   pointer.To(raw["version"].(string)),
    }
}

// In Create method:
if len(sourceImageReferenceRaw) != 0 || sourceImageId != "" {
    sourceImageReference := expandSourceImageReferenceVMSS(sourceImageReferenceRaw, sourceImageId)
    virtualMachineProfile.StorageProfile.ImageReference = sourceImageReference
}

// Finally:
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Traced Assignments:**
1. `raw["sku"]` → `ImageReference.Sku`
2. `virtualMachineProfile.StorageProfile.ImageReference = sourceImageReference`
3. `props.Properties.VirtualMachineProfile = &virtualMachineProfile`
4. Final path: `properties.virtualMachineProfile.storageProfile.imageReference.sku`

**Verified Path:** `properties.virtualMachineProfile.storageProfile.imageReference.sku`

**Path Comparison:** ✅ MATCH

## Provider Schema

```go
"source_image_reference": sourceImageReferenceSchemaOrchestratedVMSS(),

func sourceImageReferenceSchemaOrchestratedVMSS() *pluginsdk.Schema {
    return &pluginsdk.Schema{
        Type:     pluginsdk.TypeList,
        Optional: true,
        MaxItems: 1,
        ConflictsWith: []string{
            "source_image_id",
        },
        Elem: &pluginsdk.Resource{
            Schema: map[string]*pluginsdk.Schema{
                "publisher": {
                    Type:         pluginsdk.TypeString,
                    Required:     true,
                    ForceNew:     true,
                    ValidateFunc: validation.StringIsNotEmpty,
                },
                "offer": {
                    Type:         pluginsdk.TypeString,
                    Required:     true,
                    ForceNew:     true,
                    ValidateFunc: validation.StringIsNotEmpty,
                },
                "sku": {
                    Type:         pluginsdk.TypeString,
                    Required:     true,
                    ValidateFunc: validation.StringIsNotEmpty,
                },
                "version": {
                    Type:         pluginsdk.TypeString,
                    Required:     true,
                    ValidateFunc: validation.StringIsNotEmpty,
                },
            },
        },
    }
}
```

**Key Observations:**
- `Required: true` - Must be provided
- **NO `ForceNew: true`** - Unlike `offer` and `publisher`, `sku` does NOT have ForceNew for Orchestrated VMSS
- `ValidateFunc: validation.StringIsNotEmpty` - Must be non-empty string
- Part of `source_image_reference` block which has `ConflictsWith: ["source_image_id"]`

## Azure API Schema

**Query:**
```
resource_type: Microsoft.Compute/virtualMachineScaleSets
api_version: 2024-11-01
path: body.properties.virtualMachineProfile.storageProfile.imageReference.sku
```

**Result:** `String`

## Hidden Fields

None. The field directly maps to `sku` in the Azure API `ImageReference` object.

## Mapping

**Terraform (snake_case):** `sku`
**Azure API (camelCase):** `sku`
**Mapping:** Direct - no transformation needed (both lowercase)

## Special Handling

### 1. Validation

**Provider Validation:**
```go
"sku": {
    Type:         pluginsdk.TypeString,
    Required:     true,
    ValidateFunc: validation.StringIsNotEmpty,
}
```

**Implementation in variables.tf:**
```hcl
validation {
  condition     = var.orchestrated_virtual_machine_scale_set_source_image_reference == null || (var.orchestrated_virtual_machine_scale_set_source_image_reference.sku != null && var.orchestrated_virtual_machine_scale_set_source_image_reference.sku != "")
  error_message = "The `sku` field in `source_image_reference` must not be empty."
}
```

This validation ensures:
- If `source_image_reference` is set (not null), then `sku` must be non-null and non-empty
- Replicates the provider's `StringIsNotEmpty` validation

### 2. ForceNew Behavior

**Critical Observation:** Unlike `publisher` and `offer` which have `ForceNew: true`, the `sku` field does **NOT** have ForceNew for Orchestrated VMSS.

**Provider Schema Evidence:**
```go
// For Orchestrated VMSS - NO ForceNew
func sourceImageReferenceSchemaOrchestratedVMSS() *pluginsdk.Schema {
    // ...
    "sku": {
        Type:         pluginsdk.TypeString,
        Required:     true,
        ValidateFunc: validation.StringIsNotEmpty,  // NO ForceNew!
    },
}

// For comparison - Regular VMSS HAS ForceNew controlled by isVirtualMachine parameter
func sourceImageReferenceSchema(isVirtualMachine bool) *pluginsdk.Schema {
    // ...
    "sku": {
        Type:         pluginsdk.TypeString,
        Required:     true,
        ForceNew:     isVirtualMachine,  // ForceNew varies
        ValidateFunc: validation.StringIsNotEmpty,
    },
}
```

**Implementation Decision:** Since the provider schema shows NO ForceNew for Orchestrated VMSS, `sku` is NOT added to `replace_triggers_external_values`. The field can be updated in-place.

### 3. No Replace Trigger

Because `sku` does not have ForceNew behavior for Orchestrated VMSS, it is intentionally **NOT** added to `local.replace_triggers_external_values`.

## Deferred Work Completion

**Checked `following.md`:** 
- Row #2: Task #118 defers hotpatching validation to multiple tasks including #152-156 (source_image_reference fields)
- This validation requires implementing `isValidHotPatchSourceImageReference()` logic which depends on parsing all source_image_reference fields
- Status: Marked as "Pending" - will be completed when all source_image_reference fields (#153-156) are implemented
- No action required in this task as the complex validation depends on the complete block

## Critical Review & Edge Case Analysis

### Null Semantics
- **`sku = null`:** Not allowed - field is Required in provider schema, validation enforces non-null/non-empty
- **Parent block null:** When `source_image_reference` is null, entire `imageReference` block is omitted (correct behavior)

### Boundary Conditions
- **Empty string:** Blocked by validation - must be non-empty
- **Valid values:** Any non-empty string is accepted (Azure validates specific SKU availability)

### Idempotency
- Direct string assignment ensures idempotent behavior
- No ordering or transformation that could cause drift

### Safe References
- Field access is safe: `var.orchestrated_virtual_machine_scale_set_source_image_reference.sku` only occurs after null check on parent
- Validation ensures if parent is set, child field is non-null

### Cross-Field Dependencies
- Mutually exclusive with `source_image_id` (enforced at parent block level)
- Used in hotpatch validation logic (deferred to Task #118 completion)

## Checklist

- ✅ Property in correct local (`body`)
- ✅ NOT in `replace_triggers_external_values` (no ForceNew for Orchestrated VMSS)
- ✅ Logic EXACTLY replicated from provider (Required field, no ForceNew, validation)
- ✅ Validation IMPLEMENTED in variables.tf (StringIsNotEmpty)
- ✅ No TODO comments needed (field already existed in variables.tf)
- ✅ Hidden fields checked (none)
- ✅ Deferred work: Checked `following.md` - hotpatch validation pending completion of all fields
- ✅ Critical review completed (null semantics, boundaries, idempotency, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Self-Review: Only implemented Task #155 (sku field), did not add hidden fields or other tasks' content

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #155 - source_image_reference.sku

### Validation Results

✅ **Field Implementation:** Field correctly placed in `local.body` under `properties.virtualMachineProfile.storageProfile.imageReference.sku` with proper conditional wrapping
✅ **ForceNew Logic:** Correctly NOT included in `replace_triggers_external_values` - provider schema shows NO ForceNew for sku in Orchestrated VMSS (unlike offer/publisher which have ForceNew)
✅ **Stable Keys:** N/A - Field is not in replace_triggers_external_values
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Direct string assignment, no conversion needed
✅ **Null Handling:** Correctly propagates null semantics - parent block conditional prevents access when null
✅ **Validations:** Provider's `StringIsNotEmpty` validation correctly implemented in `variables.tf` (lines 1508-1511)
✅ **Deferred Work Completion:** No deferred work for this specific task - hotpatch validation in `following.md` correctly identified as pending completion of all source_image_reference fields
✅ **Deferred Work Recording:** No new deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed - null semantics, empty string blocking, safe references, cross-field dependencies

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The critical distinction between ForceNew behavior for offer/publisher (have ForceNew) vs sku/version (no ForceNew) is correctly implemented. The proof document properly documents this difference with Go code evidence from both Orchestrated and regular VMSS schemas. Validation correctly replicates `StringIsNotEmpty` logic. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
