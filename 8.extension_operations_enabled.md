# Task #8 - extension_operations_enabled - Migration Proof

## Shadow Implementation

### variables.tf
```hcl
variable "orchestrated_virtual_machine_scale_set_extension_operations_enabled" {
  type        = bool
  default     = true  # <-
  description = "(Optional) Should extension operations be allowed on the Virtual Machine Scale Set? Possible values are `true` or `false`. Defaults to `true`. Changing this forces a new Virtual Machine Scale Set to be created."

  validation {  # <-
    condition = (
      var.orchestrated_virtual_machine_scale_set_extension_operations_enabled == false ||
      (var.orchestrated_virtual_machine_scale_set_os_profile != null &&
        var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null &&
        var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent == false) == false
    )
    error_message = "`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false` in windows_configuration."
  }

  validation {  # <-
    condition = (
      var.orchestrated_virtual_machine_scale_set_extension_operations_enabled == false ||
      (var.orchestrated_virtual_machine_scale_set_os_profile != null &&
        var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null &&
        var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent == false) == false
    )
    error_message = "`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false` in linux_configuration."
  }
}
```

### migrate_main.tf
```hcl
locals {
  replace_triggers_external_values = {
    # ... other fields ...
    extension_operations_enabled   = { value = var.orchestrated_virtual_machine_scale_set_extension_operations_enabled }  # <-
  }

  body = merge(
    {
      properties = merge(
        # ... orchestrationMode, platformFaultDomainCount, etc. ...
        var.orchestrated_virtual_machine_scale_set_os_profile != null || ... ? {
          virtualMachineProfile = merge(
            # ... other profile fields ...
            var.orchestrated_virtual_machine_scale_set_os_profile != null ? {
              osProfile = merge(
                {
                  allowExtensionOperations = var.orchestrated_virtual_machine_scale_set_extension_operations_enabled  # <-
                },
                # ... customData, linuxConfiguration, windowsConfiguration ...
              )
            } : {},
            # ... extensionProfile ...
          )
        } : {}
      )
    },
    # ... zones ...
  )
}
```

## Summary

Migrated `extension_operations_enabled` from `azurerm_orchestrated_virtual_machine_scale_set` to `azapi_resource`. This is a root-level boolean argument with default value `true` and `ForceNew: true`. The field is assigned to `body.properties.virtualMachineProfile.osProfile.allowExtensionOperations` and includes cross-field validations with `provision_vm_agent` in both Linux and Windows configurations.

## Create Phase Verification

### Query Result Analysis

Queried the Create method using `query_terraform_block_implementation_source_code` with `entrypoint_name=create`.

**Pattern Identified**: Single-phase create (no two-phase update)

**Field Classification**: Create phase

### Evidence from Create Method

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... setup code ...
	
	extensionOperationsEnabled := d.Get("extension_operations_enabled").(bool)
	osProfileRaw := d.Get("os_profile").([]interface{})

	if len(osProfileRaw) > 0 && osProfileRaw[0] != nil {
		osProfile := osProfileRaw[0].(map[string]interface{})
		winConfigRaw = osProfile["windows_configuration"].([]interface{})
		linConfigRaw = osProfile["linux_configuration"].([]interface{})
		customData := ""

		// Pass custom data if it is defined in the config file
		if v := osProfile["custom_data"]; v != nil {
			customData = v.(string)
		}

		if len(winConfigRaw) > 0 && winConfigRaw[0] != nil {
			osType = virtualmachinescalesets.OperatingSystemTypesWindows
			winConfig := winConfigRaw[0].(map[string]interface{})
			provisionVMAgent := winConfig["provision_vm_agent"].(bool)
			// ...
			vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(winConfig, customData)
			// ...
			if extensionOperationsEnabled && !provisionVMAgent {
				return fmt.Errorf("`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false`")
			}
			// ...
		}

		if len(linConfigRaw) > 0 && linConfigRaw[0] != nil {
			osType = virtualmachinescalesets.OperatingSystemTypesLinux
			linConfig := linConfigRaw[0].(map[string]interface{})
			provisionVMAgent := linConfig["provision_vm_agent"].(bool)
			// ...
			vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithLinuxConfiguration(linConfig, customData)
			// ...
			if extensionOperationsEnabled && !provisionVMAgent {
				return fmt.Errorf("`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false`")
			}
			// ...
		}

		if vmssOsProfile != nil {
			vmssOsProfile.AllowExtensionOperations = pointer.To(extensionOperationsEnabled)
		}

		virtualMachineProfile.OsProfile = vmssOsProfile
	}
	
	// ... later in the function ...
	props.Properties.VirtualMachineProfile = &virtualMachineProfile
	
	// ... single-phase create ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Orchestrated %s: %w", id, err)
	}
}
```

**Decision**: The field is read during Create phase, validated against `provision_vm_agent`, and assigned to `vmssOsProfile.AllowExtensionOperations`. The value is then sent in the single CreateOrUpdate API call. **This is NOT a two-phase update field.** → Place in `local.body`.

## Assignment Path Verification

### Predicted Path
`body.properties.virtualMachineProfile.osProfile.allowExtensionOperations`

### Go Code Evidence

```go
// Step 1: Read the value
extensionOperationsEnabled := d.Get("extension_operations_enabled").(bool)

// Step 2: Assign to vmssOsProfile
if vmssOsProfile != nil {
	vmssOsProfile.AllowExtensionOperations = pointer.To(extensionOperationsEnabled)
}

// Step 3: Assign osProfile to virtualMachineProfile
virtualMachineProfile.OsProfile = vmssOsProfile

// Step 4: Assign virtualMachineProfile to props
props.Properties.VirtualMachineProfile = &virtualMachineProfile

// Step 5: Send to API
client.CreateOrUpdateThenPoll(ctx, id, props, ...)
```

**Struct assignment chain**:
- `vmssOsProfile.AllowExtensionOperations` ← Direct field assignment
- `virtualMachineProfile.OsProfile` ← `vmssOsProfile` (adds `.osProfile` level)
- `props.Properties.VirtualMachineProfile` ← `&virtualMachineProfile` (adds `.properties.virtualMachineProfile` level)

### Verified Path
`properties.virtualMachineProfile.osProfile.allowExtensionOperations`

In `azapi_resource` body, this becomes:
`body.properties.virtualMachineProfile.osProfile.allowExtensionOperations`

### Path Comparison
✅ **Match** - Predicted path matches verified path from Go code analysis.

## Provider Schema

### From Go Source (Primary)

```go
"extension_operations_enabled": {
	Type:     pluginsdk.TypeBool,
	Optional: true,
	Default:  true,
	ForceNew: true,
},
```

**Attributes**:
- **Type**: `TypeBool` → Terraform type: `bool`
- **Optional**: `true`
- **Default**: `true`
- **ForceNew**: `true` → Changes force resource recreation
- **Required**: `false`

### Validation Logic from Create Method

```go
// Windows configuration validation
if extensionOperationsEnabled && !provisionVMAgent {
	return fmt.Errorf("`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false`")
}

// Linux configuration validation
if extensionOperationsEnabled && !provisionVMAgent {
	return fmt.Errorf("`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false`")
}
```

**Validation rules**:
1. When `extension_operations_enabled` is `true`, `provision_vm_agent` must not be `false` (in Windows configuration)
2. When `extension_operations_enabled` is `true`, `provision_vm_agent` must not be `false` (in Linux configuration)

## Azure API Schema

### From API Version 2024-11-01

**Property Path**: `body.properties.virtualMachineProfile.osProfile.allowExtensionOperations`

**Schema Type**: `Bool`

**Documentation**: "Specifies whether extension operations should be allowed on the virtual machine scale set. This may only be set to False when no extensions are present on the virtual machine scale set."

## Hidden Fields

**None** - The field maps directly without any hidden fields. No expand function adds additional properties.

## Mapping

| AzureRM Field | AzAPI Field | Transformation |
|---------------|-------------|----------------|
| `extension_operations_enabled` | `allowExtensionOperations` | Direct boolean value mapping (snake_case → camelCase) |

**Naming Convention**: snake_case → camelCase

## Special Handling

### 1. Default Value

The provider schema specifies `Default: true`. This is implemented in `variables.tf`:

```hcl
variable "orchestrated_virtual_machine_scale_set_extension_operations_enabled" {
  type    = bool
  default = true  # Replicate provider default
}
```

### 2. ForceNew Behavior

The provider schema has `ForceNew: true`. This is implemented in `replace_triggers_external_values`:

```hcl
replace_triggers_external_values = {
  extension_operations_enabled = { value = var.orchestrated_virtual_machine_scale_set_extension_operations_enabled }
}
```

### 3. Cross-Field Validation

The provider performs runtime validations with `provision_vm_agent`. These are replicated in `variables.tf`:

```hcl
# Windows configuration validation
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_extension_operations_enabled == false ||
    (var.orchestrated_virtual_machine_scale_set_os_profile != null &&
      var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null &&
      var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent == false) == false
  )
  error_message = "`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false` in windows_configuration."
}

# Linux configuration validation
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_extension_operations_enabled == false ||
    (var.orchestrated_virtual_machine_scale_set_os_profile != null &&
      var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null &&
      var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent == false) == false
  )
  error_message = "`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false` in linux_configuration."
}
```

**Logic Translation**:
- Provider Go: `if extensionOperationsEnabled && !provisionVMAgent { return error }`
- Terraform validation: Condition passes when NOT (`extension_operations_enabled == true` AND `provision_vm_agent == false`)
- Double negation: `(condition == false) == false` ensures validation passes when the nested condition is false

### 4. Conditional Inclusion

The field is only included in the API body when `os_profile` is defined. This is handled by the parent conditional:

```hcl
var.orchestrated_virtual_machine_scale_set_os_profile != null ? {
  osProfile = merge(
    {
      allowExtensionOperations = var.orchestrated_virtual_machine_scale_set_extension_operations_enabled
    },
    # ... other osProfile fields ...
  )
} : {}
```

## Critical Review & Edge Case

### Null Semantics

**Field Behavior**:
- Variable default: `true` (never null)
- Provider default: `true`
- Interpretation: The field always has a value

### Edge Case Analysis

1. **When `os_profile` is null**:
   - Provider behavior: Field is not set in the API call
   - Shadow implementation: The entire `osProfile` object is omitted from `virtualMachineProfile`
   - ✅ Behavior matches: Field is only sent when `os_profile` is defined

2. **When `extension_operations_enabled` is `true` and `provision_vm_agent` is `false`**:
   - Provider behavior: Returns validation error
   - Shadow implementation: Validation blocks prevent this configuration
   - ✅ Behavior matches: Both Windows and Linux validation rules are implemented

3. **When `extension_operations_enabled` is `false`**:
   - Provider behavior: Allows disabling extension operations
   - Azure API note: "This may only be set to False when no extensions are present"
   - Shadow implementation: Passes the value to API
   - ℹ️ Note: The Azure API enforces the "no extensions present" constraint; we don't replicate this as it's an API-level check

4. **Default value interaction**:
   - When user doesn't specify the field: Uses `true` (provider default)
   - When user explicitly sets `false`: Uses `false`
   - ✅ Behavior matches: Default value is correctly set in variable definition

### Idempotency

The field is always set to the same value when `os_profile` is defined, ensuring idempotent behavior.

### Safe References

The cross-field validations safely navigate the nested structure:
```hcl
var.orchestrated_virtual_machine_scale_set_os_profile != null &&
var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null &&
var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent == false
```

This prevents null reference errors when checking nested fields.

## Checklist

- ✅ Property in correct local (`body`)
- ✅ ForceNew wrapped in `replace_triggers_external_values`
- ✅ All logic EXACTLY replicated from provider (default, validations, ForceNew)
- ✅ Validations IMPLEMENTED in variables.tf (cross-field with provision_vm_agent)
- ✅ No TODO comment needed (not a sensitive field migration)
- ✅ Hidden fields checked (none found)
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ Ready for track.md update
- ✅ Self-Review: Only Task #8 content added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent  
**Date:** 2025-12-04  
**Task:** #8 - extension_operations_enabled

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew (schema `ForceNew: true`) correctly wrapped with `{ value = var.field }`  
✅ **Stable Keys:** Key `extension_operations_enabled` is always present in `replace_triggers_external_values`  
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, single-phase operation)  
✅ **Type Conversion:** Direct boolean to boolean mapping (no conversion needed)  
✅ **Null Handling:** Variable has default value `true`; field only included when `os_profile != null`  
✅ **Validations:** Both Windows and Linux cross-field validations with `provision_vm_agent` correctly implemented in `variables.tf`  
✅ **Default Value:** Provider default `true` correctly replicated  
✅ **Assignment Path:** Correct path `body.properties.virtualMachineProfile.osProfile.allowExtensionOperations` verified from Go code  
✅ **Edge Cases:** All scenarios properly analyzed (os_profile null, validation conflicts, default behavior)  
✅ **Proof Document:** Complete with all required sections, no forbidden content

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:
- Simple ForceNew behavior is correctly implemented
- All provider validations are replicated in Terraform variable validations
- Default value matches provider schema
- Assignment path matches Go code struct assignments
- Conditional inclusion matches provider behavior
- No deviations, simplifications, or "safer alternatives" were found

The executor correctly identified this as a simple ForceNew case (not requiring CustomizeDiff state comparison), implemented both cross-field validations exactly as they appear in the provider's Create method, and properly placed the field in the Create phase.

**Status:** APPROVED ✅

---
