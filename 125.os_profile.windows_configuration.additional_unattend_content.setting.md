# Task #125: os_profile.windows_configuration.additional_unattend_content.setting

## Summary

Implemented the `setting` field within `additional_unattend_content` nested block. This required field specifies the name of the setting to which the content applies, with valid values being "AutoLogon" or "FirstLogonCommands". The implementation includes enum validation and maps the field to `settingName` in the Azure API.

## Shadow Implementation

```hcl
# migrate_main.tf
locals {
  body = {
    properties = {
      virtualMachineProfile = {
        osProfile = {
          windowsConfiguration = {
            additionalUnattendContent = [
              for idx, content in var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.additional_unattend_content : {
                componentName = "Microsoft-Windows-Shell-Setup"
                passName      = "OobeSystem"
                # content = ... # Task #124 - in sensitive_body
                settingName = content.setting # <-
              }
            ]
          }
        }
      }
    }
  }
}

# variables.tf - validation added
variable "orchestrated_virtual_machine_scale_set_os_profile" {
  # ...
  windows_configuration = optional(object({
    # ...
    additional_unattend_content = optional(list(object({
      content = string # TODO: delete later - migrated to independent ephemeral variable (Task #124)
      setting = string
    })))
  }))

  validation { # <-
    condition = ( # <-
      var.orchestrated_virtual_machine_scale_set_os_profile == null || # <-
      var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration == null || # <-
      var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.additional_unattend_content == null || # <-
      alltrue([ # <-
        for item in var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.additional_unattend_content : contains(["AutoLogon", "FirstLogonCommands"], item.setting) # <-
      ]) # <-
    ) # <-
    error_message = "Each additional_unattend_content setting must be either 'AutoLogon' or 'FirstLogonCommands'." # <-
  } # <-
}
```

## Create Phase Verification

### Query Results

Queried the Create method using `query_terraform_block_implementation_source_code` with `entrypoint_name=create`.

**Pattern:** Single-phase creation

From the Create method (same as documented in Task #124):

```go
osProfileRaw := d.Get("os_profile").([]interface{})

if len(osProfileRaw) > 0 && osProfileRaw[0] != nil {
    osProfile := osProfileRaw[0].(map[string]interface{})
    winConfigRaw = osProfile["windows_configuration"].([]interface{})
    customData := ""

    if v := osProfile["custom_data"]; v != nil {
        customData = v.(string)
    }

    if len(winConfigRaw) > 0 && winConfigRaw[0] != nil {
        osType = virtualmachinescalesets.OperatingSystemTypesWindows
        winConfig := winConfigRaw[0].(map[string]interface{})
        vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(winConfig, customData)
        // ...
    }

    if vmssOsProfile != nil {
        osProfile.AllowExtensionOperations = pointer.To(extensionOperationsEnabled)
    }

    virtualMachineProfile.OsProfile = vmssOsProfile
}

props := virtualmachinescalesets.VirtualMachineScaleSet{
    Properties: &virtualmachinescalesets.VirtualMachineScaleSetProperties{
        VirtualMachineProfile: &virtualMachineProfile,
        // ...
    },
}

if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Classification:** Create phase - the field is processed during the expand function call before the CreateOrUpdateThenPoll call.

**Decision:** Place in `local.body` (not in `post_creation_updates`).

## Assignment Path Verification

### Predicted Path

```
properties.virtualMachineProfile.osProfile.windowsConfiguration.additionalUnattendContent[].settingName
```

### Go Code Evidence

From Task #123 proof document, the expand function for additional_unattend_content:

```go
func expandWindowsConfigurationAdditionalUnattendContent(input []interface{}) *[]virtualmachinescalesets.AdditionalUnattendContent {
    output := make([]virtualmachinescalesets.AdditionalUnattendContent, 0)

    for _, v := range input {
        raw := v.(map[string]interface{})

        output = append(output, virtualmachinescalesets.AdditionalUnattendContent{
            SettingName: pointer.To(virtualmachinescalesets.SettingNames(raw["setting"].(string))),
            Content:     pointer.To(raw["content"].(string)),

            // no other possible values
            PassName:      pointer.To(virtualmachinescalesets.PassNameOobeSystem),
            ComponentName: pointer.To(virtualmachinescalesets.ComponentNameMicrosoftNegativeWindowsNegativeShellNegativeSetup),
        })
    }

    return &output
}
```

Tracing the assignment:
1. `SettingName: pointer.To(virtualmachinescalesets.SettingNames(raw["setting"].(string)))` - reads `setting` from Terraform input and casts it to `SettingNames` enum type
2. Sets on `AdditionalUnattendContent` struct which is part of the array
3. `winConfig.AdditionalUnattendContent = expandWindowsConfigurationAdditionalUnattendContent(...)` - assigns to WindowsConfiguration
4. `osProfile.WindowsConfiguration = &winConfig` - assigns to VirtualMachineScaleSetOSProfile.WindowsConfiguration
5. `virtualMachineProfile.OsProfile = vmssOsProfile` - assigns to VirtualMachineProfile.OsProfile
6. `props.Properties.VirtualMachineProfile = &virtualMachineProfile` - assigns to props

### Verified Path

```
properties.virtualMachineProfile.osProfile.windowsConfiguration.additionalUnattendContent[].settingName
```

### Path Comparison

✅ **MATCH** - Predicted path matches verified path exactly.

## Provider Schema

From Task #123 proof document:

```go
"additional_unattend_content": additionalUnattendContentSchema(),

func additionalUnattendContentSchema() *pluginsdk.Schema {
    return &pluginsdk.Schema{
        Type:     pluginsdk.TypeList,
        Optional: true,
        ForceNew: true,
        Elem: &pluginsdk.Resource{
            Schema: map[string]*pluginsdk.Schema{
                "content": {
                    Type:      pluginsdk.TypeString,
                    Required:  true,
                    ForceNew:  true,
                    Sensitive: true,
                },
                "setting": {
                    Type:     pluginsdk.TypeString,
                    Required: true,
                    ForceNew: true,
                    ValidateFunc: validation.StringInSlice([]string{
                        string(virtualmachines.SettingNamesAutoLogon),
                        string(virtualmachines.SettingNamesFirstLogonCommands),
                    }, false),
                },
            },
        },
    }
}
```

**Key Attributes for `setting`:**
- **Type:** `TypeString`
- **Required:** `true` (within each list item)
- **ForceNew:** `true`
- **ValidateFunc:** `StringInSlice(["AutoLogon", "FirstLogonCommands"], false)` - case-sensitive enum validation

**Enum Values:**
- `virtualmachines.SettingNamesAutoLogon` = `"AutoLogon"`
- `virtualmachines.SettingNamesFirstLogonCommands` = `"FirstLogonCommands"`

## Azure API Schema

From Task #123 proof document:

```
"additionalUnattendContent": List(ObjectWithOptionalAttrs(map[string]Type{
    "componentName": String,
    "content": String,
    "passName": String,
    "settingName": String
}, []string{"componentName", "content", "passName", "settingName"}))
```

**Property Path:** `body.properties.virtualMachineProfile.osProfile.windowsConfiguration.additionalUnattendContent[].settingName`

**API Type:** String (optional in API spec, but required by Azure)

**Mapping:** Terraform `setting` → Azure API `settingName`

## Hidden Fields

From Task #123 and #124, the hidden fields `componentName` and `passName` were already added in Task #124. No additional hidden fields are required for this task.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Implementation Location |
|---|---|---|
| setting | settingName | body |

**Name Transformation:** `setting` → `settingName` (snake_case to camelCase)

## Special Handling

### ForceNew Behavior

The `setting` field is marked `ForceNew: true`. However, the entire parent block `additional_unattend_content` is also `ForceNew: true` (as documented in Task #123). Therefore, any change to the setting or to the list structure triggers resource replacement.

**Implementation:** ForceNew is already tracked at the parent block level in Task #113 (windows_configuration). No additional ForceNew tracking needed for this individual field.

### Enum Validation

The provider schema includes `ValidateFunc: validation.StringInSlice(...)` with two valid values:
- `"AutoLogon"`
- `"FirstLogonCommands"`

**Case Sensitivity:** The validation is case-sensitive (`false` parameter to `StringInSlice`), meaning exact casing is required.

**Implementation:** Validation block added to the `orchestrated_virtual_machine_scale_set_os_profile` variable in `variables.tf`:

```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_os_profile == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.additional_unattend_content == null ||
    alltrue([
      for item in var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.additional_unattend_content : contains(["AutoLogon", "FirstLogonCommands"], item.setting)
    ])
  )
  error_message = "Each additional_unattend_content setting must be either 'AutoLogon' or 'FirstLogonCommands'."
}
```

**Why `alltrue` with `for`:** Since `additional_unattend_content` is a list, we need to validate each item's `setting` field. The `alltrue()` function ensures every item passes the validation.

### List-Based Structure

The field is part of a list iteration established in Task #123. The implementation accesses the field via the loop variable:

```hcl
for idx, content in var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.additional_unattend_content : {
  settingName = content.setting
}
```

This correctly preserves list order and correlates each `setting` value with its corresponding list item.

## Validation

### Category 1 - Value Constraints

**Enum Validation (MANDATORY):**

From the provider schema, the field has `ValidateFunc: validation.StringInSlice(...)` with valid values `["AutoLogon", "FirstLogonCommands"]`.

**Implementation:** Added validation block in `variables.tf`:

```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_os_profile == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.additional_unattend_content == null ||
    alltrue([
      for item in var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.additional_unattend_content : contains(["AutoLogon", "FirstLogonCommands"], item.setting)
    ])
  )
  error_message = "Each additional_unattend_content setting must be either 'AutoLogon' or 'FirstLogonCommands'."
}
```

**Rationale:**
- ✅ Replicates EXACT enum validation from provider schema
- ✅ Uses `contains()` with exact string values (case-sensitive)
- ✅ Uses `alltrue()` to validate all list items
- ✅ Null-safe: checks parent nullability before accessing nested fields
- ✅ Error message clearly states the valid values

**Azure Behavior:**
- `AutoLogon`: Specifies autologon settings for Windows setup
- `FirstLogonCommands`: Specifies commands to run on first logon

### Category 2 - Cross-Field Constraints

None for the `setting` field. No `ConflictsWith`, `RequiredWith`, `ExactlyOneOf`, or `AtLeastOneOf` constraints.

### Category 3 - Custom Logic

No custom validation logic beyond the enum validation already implemented.

## Deferred Work Completion

### Checking following.md

Checked `following.md` - no work deferred TO this task (#125).

### New Deferrals

None. This task does not defer any work to other tasks.

## Critical Review & Edge Case Analysis

### Null Semantics

- **Parent block `null`:** When `additional_unattend_content` is `null`, the entire conditional block is skipped, and no `additionalUnattendContent` key appears in the Azure API payload
- **Empty list `[]`:** If the parent list is empty, the iteration produces no items, resulting in `additionalUnattendContent: []` in the API
- **Null `setting` value:** Not possible - the schema marks the field as `Required: true`, so Terraform will error if users try to provide a list item without setting

### Boundary Conditions

- **Empty string `""`:** Not a valid enum value. Validation will reject it.
- **Invalid values:** Any value other than "AutoLogon" or "FirstLogonCommands" will be rejected by validation.
- **Case variations:** The validation is case-sensitive. Values like "autologon", "AUTOLOGON", or "autoLogon" will be rejected.
- **Multiple list items:** Each item can have a different setting value. Both AutoLogon and FirstLogonCommands can be present in the same list.

### Idempotency

- **Field access:** The `content.setting` access is deterministic - reads from the same list item in each evaluation
- **List iteration:** The `for idx, content in ...` loop preserves list order and produces consistent indexes
- **Enum mapping:** The value is passed through directly without transformation (just renamed to `settingName`)
- **Merge operations:** The conditional merge in the parent structure is deterministic

### Safe References

- **Null safety:** The conditional check `var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.additional_unattend_content != null` in the parent merge protects against null reference errors
- **Loop variable:** The `content.setting` access is safe because the loop only executes when the list is non-null
- **Parent existence:** This field is nested deep (os_profile → windows_configuration → additional_unattend_content). All parent checks are in place from previous tasks
- **Validation null safety:** The validation uses safe null checks before accessing nested fields

### Edge Case: Setting Purpose

The two setting values have specific purposes in Windows setup:

1. **AutoLogon:** Configures automatic logon behavior for Windows. The content typically contains XML with credentials and logon count.

2. **FirstLogonCommands:** Specifies commands to run on first user logon. The content typically contains XML with a list of commands.

These are distinct Windows OOBE configuration phases, and users may configure both in the same VMSS (hence the list structure allowing multiple items).

### Edge Case: Content Correlation

The `setting` field and the `content` field (Task #124) are correlated:
- Each list item has both a `setting` and a `content`
- The `setting` determines how Azure interprets the `content`
- The XML in `content` must match the schema expected by the corresponding `setting` value

**Example:**
```hcl
additional_unattend_content = [
  {
    content = "<base64-encoded-autologon-xml>",
    setting = "AutoLogon"
  },
  {
    content = "<base64-encoded-commands-xml>",
    setting = "FirstLogonCommands"
  }
]
```

The implementation correctly preserves this correlation through the list iteration.

### Edge Case: ForceNew Cascade

Any change to `setting` triggers replacement because:
1. The field itself is `ForceNew: true`
2. The parent block `additional_unattend_content` is `ForceNew: true`
3. The grandparent `windows_configuration` is `ForceNew: true` (per Task #113)

This cascade ensures that any modification to Windows setup configuration results in a new VM scale set, which is Azure's requirement.

### Edge Case: Enum Type Casting

The Go code casts the string value to an enum type:

```go
SettingName: pointer.To(virtualmachinescalesets.SettingNames(raw["setting"].(string)))
```

The cast `virtualmachinescalesets.SettingNames(...)` is just a type conversion - it doesn't validate the enum. The validation happens earlier via `ValidateFunc` in the schema. Our validation replicates this exact behavior.

## Completion Checklist

- ✅ Property in correct local (`local.body`)
- ✅ ForceNew: Handled at parent block level (entire block is ForceNew)
- ✅ All logic exactly replicated from provider (field mapping, enum validation)
- ✅ Validations IMPLEMENTED in variables.tf (MANDATORY enum validation)
- ✅ Hidden fields: None specific to this task (componentName and passName already added in Task #124)
- ✅ Deferred work: None from following.md, none deferred to other tasks
- ✅ Critical review completed
- ✅ Edge case analysis included
- ✅ Proof document created
- ✅ `track.md` will be updated to "Pending for check"
- ✅ Self-Review: Only implemented setting field. Did not modify content field (Task #124) or parent structure (Task #123).

## Notes

1. **Enum Validation:** The validation exactly replicates the provider's `StringInSlice` validation with case-sensitive matching for the two valid enum values.

2. **Field Mapping:** The field is renamed from `setting` (Terraform snake_case) to `settingName` (Azure API camelCase), consistent with Azure API naming conventions.

3. **List Structure:** The field is accessed via loop variable `content.setting` within the list comprehension established by Task #123, preserving list order and item correlation.

4. **Windows OOBE Context:** These settings control specific phases of Windows Out-of-Box Experience (OOBE) setup. AutoLogon handles automatic logon, and FirstLogonCommands runs commands on first logon.

5. **Multiple Items Supported:** The list structure allows both settings to be configured simultaneously, which is a valid Windows configuration scenario.

6. **ForceNew Scope:** The entire block is ForceNew, so any change to setting values (add/remove/modify items) triggers replacement. This is already tracked at the parent level.

7. **Integration with Task #124:** Task #124 implemented the `content` field (sensitive) in `sensitive_body`, while this task implements the `setting` field in `body`. Together they complete the full `additionalUnattendContent` object structure.

8. **Validation Placement:** The validation is added to the parent `orchestrated_virtual_machine_scale_set_os_profile` variable rather than creating a separate variable, following executor.md guidance for nested block fields.

9. **No TODO Comments:** Unlike the sensitive `content` field which required independent ephemeral variables, the `setting` field is a regular non-sensitive field, so no TODO comments or variable migrations are needed.

10. **Exact Provider Replication:** The implementation exactly matches the provider's behavior:
    - Same enum values
    - Same case sensitivity
    - Same field mapping (setting → settingName)
    - Same validation error behavior

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #125 - os_profile.windows_configuration.additional_unattend_content.setting

### Validation Results

✅ **ForceNew Logic:** ForceNew handled at parent block level (Task #113 windows_configuration is ForceNew). No additional tracking needed for this field per executor.md.

✅ **Stable Keys:** N/A - Direct field mapping within list iteration, not using replace_triggers_external_values.

✅ **Phase Detection:** Field correctly placed in `local.body` - set during Create phase before CreateOrUpdateThenPoll call.

✅ **Type Conversion:** Correct conversion from Terraform string `setting` to Azure API string `settingName` with proper snake_case → camelCase transformation.

✅ **Null Handling:** Correctly propagates null semantics - parent conditionals prevent null reference errors. Field is Required within each list item per provider schema.

✅ **Validations:** All provider validations implemented:
- ✅ Enum validation `StringInSlice(["AutoLogon", "FirstLogonCommands"], false)` exactly replicated in variables.tf
- ✅ Uses `alltrue()` with `contains()` for list-based validation
- ✅ Null-safe parent checks before accessing nested fields
- ✅ Case-sensitive matching as per provider
- ✅ Error message clearly states valid values

✅ **Deferred Work Completion:** No deferred work for this task in following.md.

✅ **Deferred Work Recording:** No deferrals made by this task.

✅ **Edge Cases:** All edge cases properly analyzed and handled:
- Parent null blocks handled via conditionals
- Empty string validation rejects invalid values  
- Case sensitivity enforced in validation
- List iteration preserves order and correlation
- Multiple items with different settings supported

✅ **Sensitive Field Placement:** N/A - Non-sensitive field correctly placed in `body`. Sensitive `content` field properly handled in Task #124 using `sensitive_body`.

✅ **Shared Path Merge Check:** No merge conflicts - field is part of list comprehension, not using merge() at this level.

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found.

**Specific compliance points:**
- ✅ Exact enum values: "AutoLogon" and "FirstLogonCommands"
- ✅ Exact case sensitivity: validation rejects case variations
- ✅ Exact field mapping: setting → settingName
- ✅ Exact validation behavior: matches provider's StringInSlice validation
- ✅ Exact structural integration: properly nested within list comprehension established in Task #123

**Status:** APPROVED ✅

---
