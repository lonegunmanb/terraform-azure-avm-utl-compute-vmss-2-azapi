# Task #114: os_profile.windows_configuration.admin_password

## Summary

Implemented the `admin_password` field for Windows configuration from `azurerm_orchestrated_virtual_machine_scale_set` to `azapi_resource`. This is a Required, Sensitive, ForceNew field that requires an independent ephemeral variable. The field is placed at the parent `osProfile` level (not inside `windowsConfiguration`) per the provider's expand function logic. The implementation includes password complexity validation exactly matching the provider's requirements (8-123 characters, 3 of 4 complexity criteria, disallowed values list). The field has a DiffSuppressFunc but it provides no actual suppression in normal operation (only for import scenarios with "ignored-as-imported").

## Shadow Implementation

**migrate_variables.tf:**
```hcl
# Task #114: os_profile.windows_configuration.admin_password - independent ephemeral variable for nested block sensitive field
variable "migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password" {
  type        = string
  nullable    = false
  ephemeral   = true
  description = "(Required) The Password which should be used for the local-administrator on this Virtual Machine. Changing this forces a new resource to be created."

  validation {
    condition = (
      length(var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password) >= 8 &&
      length(var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password) <= 123
    )
    error_message = "admin_password must be at least 6 characters long and less than 72 characters long."
  }

  validation {
    condition = (
      length(regexall("[a-z]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0 &&
      length(regexall("[A-Z]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0 &&
      length(regexall("[0-9]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0
    ) || (
      length(regexall("[a-z]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0 &&
      length(regexall("[A-Z]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0 &&
      length(regexall("[\\W_]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0
    ) || (
      length(regexall("[a-z]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0 &&
      length(regexall("[0-9]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0 &&
      length(regexall("[\\W_]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0
    ) || (
      length(regexall("[A-Z]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0 &&
      length(regexall("[0-9]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0 &&
      length(regexall("[\\W_]", var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)) > 0
    )
    error_message = "admin_password did not meet minimum password complexity requirements. A password must contain at least 3 of the 4 following conditions: a lower case character, a upper case character, a digit and/or a special character."
  }

  validation {
    condition = !contains([
      "abc@123", "P@$$w0rd", "P@ssw0rd", "P@ssword123", "Pa$$word",
      "pass@word1", "Password!", "Password1", "Password22", "iloveyou!"
    ], var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)
    error_message = "admin_password cannot be one of the disallowed values: 'abc@123', 'P@$$w0rd', 'P@ssw0rd', 'P@ssword123', 'Pa$$word', 'pass@word1', 'Password!', 'Password1', 'Password22', 'iloveyou!'."
  }
}

variable "migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password_version" {
  type        = number
  default     = null
  description = "(Optional) Version tracker for admin_password. Must be set when admin_password is provided."

  validation {
    condition     = var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password_version != null
    error_message = "When admin_password is set, admin_password_version must also be set."
  }
}
```

**variables.tf:**
```hcl
windows_configuration = optional(object({
  admin_password           = string # TODO: delete later - migrated to independent ephemeral variable (Task #114)
  admin_username           = string
  # ... other fields ...
}))
```

**migrate_main.tf - sensitive_body:**
```hcl
sensitive_body = {
  properties = merge(
    # ... other properties ...
    var.orchestrated_virtual_machine_scale_set_sku_name != null ? {
      virtualMachineProfile = merge(
        # ... other virtualMachineProfile properties ...
        var.orchestrated_virtual_machine_scale_set_os_profile != null ? {
          osProfile = merge(
            # ... other osProfile properties ...
            var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? {
              adminPassword = var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password
            } : {}
          )
        } : {}
      )
    } : {}
  )
}
```

**migrate_main.tf - sensitive_body_version:**
```hcl
sensitive_body_version = {
  # ... other paths ...
  "properties.virtualMachineProfile.osProfile.adminPassword" = var.orchestrated_virtual_machine_scale_set_os_profile != null && var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null ? try(tostring(var.migrate_orchestrated_virtual_machine_scale_set_os_profile_linux_configuration_admin_password_version), "null") : var.orchestrated_virtual_machine_scale_set_os_profile != null && var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? try(tostring(var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password_version), "null") : "null"
  # ... other paths ...
}
```

**migrate_main.tf - replace_triggers_external_values:**
```hcl
replace_triggers_external_values = {
  # ... other triggers ...
  windows_configuration_admin_password = { value = var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password }
}
```

## Create Phase Verification

### Pattern Identification

Queried the Create method to understand how `admin_password` is processed.

**Pattern:** Single-phase creation

The `admin_password` field is processed during the Create phase through the expand function `expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration`:

```go
func expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(input map[string]interface{}, customData string) *virtualmachinescalesets.VirtualMachineScaleSetOSProfile {
	osProfile := virtualmachinescalesets.VirtualMachineScaleSetOSProfile{}
	winConfig := virtualmachinescalesets.WindowsConfiguration{}
	patchSettings := virtualmachinescalesets.PatchSettings{}

	if len(input) > 0 {
		osProfile.CustomData = pointer.To(customData)
		osProfile.AdminUsername = pointer.To(input["admin_username"].(string))
		osProfile.AdminPassword = pointer.To(input["admin_password"].(string))

		if computerPrefix := input["computer_name_prefix"].(string); computerPrefix != "" {
			osProfile.ComputerNamePrefix = pointer.To(computerPrefix)
		}
		// ... rest of configuration ...
	}

	osProfile.WindowsConfiguration = &winConfig

	return &osProfile
}
```

From Create method:
```go
if len(winConfigRaw) > 0 && winConfigRaw[0] != nil {
    osType = virtualmachinescalesets.OperatingSystemTypesWindows
    winConfig := winConfigRaw[0].(map[string]interface{})
    vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(winConfig, customData)
    // ... validation logic ...
}

if vmssOsProfile != nil {
    vmssOsProfile.AllowExtensionOperations = pointer.To(extensionOperationsEnabled)
}

virtualMachineProfile.OsProfile = vmssOsProfile

// Later assignment:
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Classification:** Create phase ‚Üí Assign to `local.sensitive_body` (sensitive field)

### Decision

The `admin_password` field is set during the single-phase create operation. Since it is marked as `Sensitive: true`, it must be placed in `local.sensitive_body` and tracked via `sensitive_body_version`.

## Assignment Path Verification

### Predicted Path

`sensitive_body.properties.virtualMachineProfile.osProfile.adminPassword`

### Go Code Evidence

From the expand function:

```go
osProfile.AdminPassword = pointer.To(input["admin_password"].(string))
```

The assignment chain:
1. `osProfile.AdminPassword` is set directly on the osProfile struct
2. `osProfile.WindowsConfiguration = &winConfig` (nested configuration)
3. `virtualMachineProfile.OsProfile = vmssOsProfile` (where `vmssOsProfile` is the returned `osProfile`)
4. `props.Properties.VirtualMachineProfile = &virtualMachineProfile`

The complete path: `VirtualMachineScaleSet.Properties.VirtualMachineProfile.OsProfile.AdminPassword`

**Important:** The admin_password is set at the `osProfile` level, NOT inside `windowsConfiguration`. This is the same pattern as Linux configuration.

### Verified Path

`sensitive_body.properties.virtualMachineProfile.osProfile.adminPassword`

### Path Comparison

‚úÖ **MATCH** - Predicted path matches the verified assignment chain from Go source code. The field is set at osProfile level as documented.

## Provider Schema

From `OrchestratedVirtualMachineScaleSetWindowsConfigurationSchema()`:

```go
"admin_password": {
    Type:             pluginsdk.TypeString,
    Required:         true,
    ForceNew:         true,
    Sensitive:        true,
    DiffSuppressFunc: adminPasswordDiffSuppressFunc,
    ValidateFunc:     validatePasswordComplexityWindows,
},
```

**Key Properties:**
- **Type:** String
- **Required:** Yes (unlike Linux where it's optional)
- **ForceNew:** Yes (changing password forces replacement)
- **Sensitive:** Yes (must be in `sensitive_body`)
- **DiffSuppressFunc:** `adminPasswordDiffSuppressFunc` (special handling)
- **ValidateFunc:** `validatePasswordComplexityWindows` (custom validation)

### DiffSuppressFunc

```go
func adminPasswordDiffSuppressFunc(_, old, new string, _ *pluginsdk.ResourceData) bool {
	// this is not the greatest hack in the world, this is just a tribute.
	if old == "ignored-as-imported" || new == "ignored-as-imported" {
		return true
	}

	return false
}
```

**Analysis:** This DiffSuppressFunc only suppresses diff when either old or new value is the special string "ignored-as-imported". This is a provider-specific workaround for import scenarios. In normal operation (create, update, read), this function provides **no suppression** and acts like a regular field.

**Implementation Decision:** Since the DiffSuppressFunc provides no effective suppression in normal operation, we treat this as a standard ForceNew sensitive field without DiffSuppressFunc special handling.

### Validation Function - validatePasswordComplexityWindows

```go
func validatePasswordComplexityWindows(input interface{}, key string) (warnings []string, errors []error) {
	return validatePasswordComplexity(input, key, 8, 123)
}

func validatePasswordComplexity(input interface{}, key string, min int, max int) (warnings []string, errors []error) {
	password, ok := input.(string)
	if !ok {
		errors = append(errors, fmt.Errorf("expected %q to be a string", key))
		return warnings, errors
	}

	complexityMatch := 0
	re := regexp.MustCompile(`[a-z]{1,}`)
	if re != nil && re.MatchString(password) {
		complexityMatch++
	}

	re = regexp.MustCompile(`[A-Z]{1,}`)
	if re != nil && re.MatchString(password) {
		complexityMatch++
	}

	re = regexp.MustCompile(`[0-9]{1,}`)
	if re != nil && re.MatchString(password) {
		complexityMatch++
	}

	re = regexp.MustCompile(`[\W_]{1,}`)
	if re != nil && re.MatchString(password) {
		complexityMatch++
	}

	if complexityMatch < 3 {
		errors = append(errors, fmt.Errorf("%q did not meet minimum password complexity requirements. A password must contain at least 3 of the 4 following conditions: a lower case character, a upper case character, a digit and/or a special character. Got %q", key, password))
		return warnings, errors
	}

	if len(password) < min || len(password) > max {
		errors = append(errors, fmt.Errorf("%q must be at least 6 characters long and less than 72 characters long. Got %q(%d characters)", key, password, len(password)))
		return warnings, errors
	}

	// NOTE: I realize that some of these will not pass the above complexity checks, but they are in the API so I am checking
	// the same values that the API is...
	disallowedValues := []string{
		"abc@123", "P@$$w0rd", "P@ssw0rd", "P@ssword123", "Pa$$word", "pass@word1", "Password!", "Password1", "Password22", "iloveyou!",
	}

	for _, str := range disallowedValues {
		if password == str {
			errors = append(errors, fmt.Errorf("%q can not be one of %s, got %q", key, azure.QuotedStringSlice(disallowedValues), password))
			return warnings, errors
		}
	}

	return warnings, errors
}
```

**Validation Requirements:**
1. **Length:** Between 8 and 123 characters (Windows: min=8, max=123)
2. **Complexity:** Must contain at least 3 of 4 character categories:
   - Lowercase letters: `[a-z]`
   - Uppercase letters: `[A-Z]`
   - Digits: `[0-9]`
   - Special characters: `[\W_]` (non-word characters or underscore)
3. **Disallowed Values:** Cannot be any of: "abc@123", "P@$$w0rd", "P@ssw0rd", "P@ssword123", "Pa$$word", "pass@word1", "Password!", "Password1", "Password22", "iloveyou!"

**Note on Error Message:** The error message in the function says "at least 6 characters long and less than 72 characters long" but the actual validation uses min=8 and max=123 for Windows. This is a documentation inconsistency in the provider's error message.

## Azure API Schema

Query result for `body.properties.virtualMachineProfile.osProfile.adminPassword`:

```
String
```

**Azure API Properties:**
- **Type:** String
- **Required:** No (API level - but provider requires it for Windows)
- **Description:** Not exposed (WriteOnly field)

The Azure API treats `adminPassword` as a write-only field that is never returned in GET responses. This is standard for passwords.

## Hidden Fields

No hidden fields detected for `admin_password`. The field is straightforward with no additional Azure API properties that the provider doesn't expose.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|---|---|---|
| admin_password | adminPassword | Set at osProfile level |

**Important:** Despite being defined within `windows_configuration` in the Terraform schema, the actual Azure API placement is at `osProfile.adminPassword`, not inside `windowsConfiguration`.

## Special Handling

### 1. Nested Block Sensitive Field - Independent Ephemeral Variable

Per executor.md requirements for nested block sensitive fields, `admin_password` requires an **independent ephemeral variable** in `migrate_variables.tf`:

- **Variable name:** `migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password`
- **Type:** `string`
- **Nullable:** `false` (Required for Windows)
- **Ephemeral:** `true` (sensitive data)
- **Version variable:** `migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password_version` (required, not null)

### 2. Validation - Category 1: Value Constraints

Implemented three validation blocks exactly matching provider logic:

**Validation 1: Length Check**
```hcl
validation {
  condition = (
    length(var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password) >= 8 &&
    length(var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password) <= 123
  )
  error_message = "admin_password must be at least 6 characters long and less than 72 characters long."
}
```
Note: Error message kept from provider (says 6-72) but actual validation is 8-123 for Windows.

**Validation 2: Complexity Check**
```hcl
validation {
  condition = (
    # At least 3 of 4 conditions: lowercase, uppercase, digit, special char
    (has_lowercase && has_uppercase && has_digit) ||
    (has_lowercase && has_uppercase && has_special) ||
    (has_lowercase && has_digit && has_special) ||
    (has_uppercase && has_digit && has_special)
  )
  error_message = "admin_password did not meet minimum password complexity requirements. A password must contain at least 3 of the 4 following conditions: a lower case character, a upper case character, a digit and/or a special character."
}
```

**Validation 3: Disallowed Values**
```hcl
validation {
  condition = !contains([
    "abc@123", "P@$$w0rd", "P@ssw0rd", "P@ssword123", "Pa$$word",
    "pass@word1", "Password!", "Password1", "Password22", "iloveyou!"
  ], var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password)
  error_message = "admin_password cannot be one of the disallowed values: ..."
}
```

### 3. ForceNew Handling

Schema has `ForceNew: true`. Implemented as:

```hcl
replace_triggers_external_values = {
  windows_configuration_admin_password = { value = var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password }
}
```

**Key stable:** Always present in the map.
**Value tracking:** Direct value reference ensures any change triggers replacement.

### 4. Sensitive Field in sensitive_body

Since the field is marked `Sensitive: true`, it's placed in `sensitive_body` (not `body`):

```hcl
sensitive_body = {
  properties = {
    virtualMachineProfile = {
      osProfile = {
        adminPassword = var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password
      }
    }
  }
}
```

### 5. Version Tracking

The field is tracked in `sensitive_body_version` map. Since there's only one `adminPassword` key at the API level (shared between Linux and Windows), the version tracking logic uses a conditional:

```hcl
sensitive_body_version = {
  "properties.virtualMachineProfile.osProfile.adminPassword" = 
    var.orchestrated_virtual_machine_scale_set_os_profile != null && var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null ? 
      try(tostring(var.migrate_orchestrated_virtual_machine_scale_set_os_profile_linux_configuration_admin_password_version), "null") : 
    var.orchestrated_virtual_machine_scale_set_os_profile != null && var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? 
      try(tostring(var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password_version), "null") : 
      "null"
}
```

### 6. TODO Comment in variables.tf

Added TODO comment on the same line as the original field definition:

```hcl
admin_password = string # TODO: delete later - migrated to independent ephemeral variable (Task #114)
```

### 7. DiffSuppressFunc Analysis

The `adminPasswordDiffSuppressFunc` only suppresses diff when old or new value is "ignored-as-imported". This is a provider import workaround and provides **no effective suppression** in normal operation.

**Decision:** Treat as a standard ForceNew field without DiffSuppressFunc special handling. No need for `post_creation_updates` logic.

## Deferred Work Completion

Checked `following.md` - no work was deferred TO this task.

## Critical Review & Edge Case Analysis

### Null Semantics

- **`null` admin_password:** Invalid for Windows - the field is Required when `windows_configuration` is present. The validation in the version variable enforces this.
- **Empty string:** Not allowed - minimum length is 8 characters.
- **Version tracking:** The variable is ephemeral and nullable=false, so it must be provided when windows_configuration is used.

### Boundary Conditions

1. **Minimum length:** 8 characters (validated)
2. **Maximum length:** 123 characters (validated)
3. **Complexity:** Requires exactly 3 of 4 character categories (validated with all possible combinations)
4. **Disallowed values:** List of 10 common passwords (validated)
5. **Required field:** Must be provided when windows_configuration is present

### Idempotency

The implementation is idempotent:
- Same password value produces same API payload
- ForceNew tracking ensures password changes trigger replacement
- Version tracking enables controlled password rotation

### Safe References

- The field is only accessed when `var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null`
- All references use conditional checks before accessing the independent ephemeral variable
- The nullable=false constraint on the variable ensures it's always present when windows_configuration exists

### Edge Case: Shared adminPassword Key

**Issue:** Both Linux and Windows configurations set `adminPassword` at the `osProfile` level. The Azure API has a single `adminPassword` field, not separate fields for Linux and Windows.

**Resolution:** The `sensitive_body_version` map uses a conditional expression to select the appropriate version variable based on which configuration (Linux or Windows) is active. This ensures proper version tracking for the shared API field.

### Edge Case: Error Message Inconsistency

**Issue:** The provider's error message says "at least 6 characters long and less than 72 characters long" but the actual validation uses min=8, max=123 for Windows (min=6, max=72 for Linux).

**Resolution:** Kept the provider's error message for consistency, but the actual validation correctly uses 8-123.

### Edge Case: Complexity Validation Logic

**Issue:** The provider uses a counter-based approach (complexityMatch >= 3). Terraform doesn't have a simple counter.

**Resolution:** Explicitly enumerate all possible combinations where 3 of 4 conditions are met using OR logic. This is more verbose but exactly replicates the provider behavior.

### Edge Case: Version Variable Required

**Issue:** Unlike Linux admin_password which is optional, Windows admin_password is required. The version variable must also be required.

**Resolution:** The version variable has `default = null` but a validation that enforces `!= null`. This ensures users must explicitly set the version when providing a password, while maintaining the standard variable pattern.

## Completion Checklist

- ‚úÖ Property in correct local (`local.sensitive_body`)
- ‚úÖ ForceNew wrapped: `{ value = var.field }`
- ‚úÖ ALL logic EXACTLY replicated from provider (validations, DiffSuppressFunc analysis)
- ‚úÖ Validations IMPLEMENTED in migrate_variables.tf (length, complexity, disallowed values)
- ‚úÖ TODO comment added to original field in variables.tf (same line)
- ‚úÖ Hidden fields checked (none)
- ‚úÖ Deferred work in following.md: None deferred from this task
- ‚úÖ Deferred work from following.md: No work deferred TO this task
- ‚úÖ Critical review (null, edge, idempotent, safe refs)
- ‚úÖ Edge Case Analysis included (shared adminPassword key, error message inconsistency, complexity validation, version required)
- ‚úÖ Proof created
- ‚úÖ `track.md` to be updated to Pending for check
- ‚úÖ Self-Review: Only admin_password implemented, no other windows_configuration fields added

## Notes

1. **Independent Ephemeral Variable:** Following executor.md requirements for nested block sensitive fields, created independent ephemeral variable instead of reusing the field in windows_configuration object.

2. **Required Field:** Unlike Linux where admin_password is optional (SSH keys can be used), Windows requires admin_password. The variable is marked `nullable = false` and the version variable has a non-null validation.

3. **osProfile Level Placement:** Despite being defined in `windows_configuration` schema, the field is set at `osProfile.adminPassword` (parent level), not inside `windowsConfiguration` object. This matches Linux behavior.

4. **Complexity Validation:** The provider uses regex patterns and a counter. Replicated by explicitly checking all combinations where 3 of 4 conditions are met.

5. **Length Difference:** Windows uses 8-123 characters (vs Linux 6-72). Error message kept from provider but validation is correct.

6. **Disallowed Values:** The provider comment notes some disallowed values wouldn't pass complexity checks anyway, but they're validated for API consistency.

7. **DiffSuppressFunc:** The adminPasswordDiffSuppressFunc only handles import scenarios with "ignored-as-imported". In normal operation, it provides no suppression. Treated as standard ForceNew field.

8. **Shared adminPassword:** Both Linux and Windows share the same `osProfile.adminPassword` API field. Version tracking uses conditional logic to select the appropriate version variable.

9. **Version Required:** The version variable validation enforces non-null value when admin_password is set, ensuring proper version tracking for password rotation.

10. **Next Task:** Task #115 (admin_username) will also be set at osProfile level, following the same pattern as admin_password.

---

## ‚ö†Ô∏è CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #114 - os_profile.windows_configuration.admin_password

### Issues Identified

#### Issue 1: Version Variable Validation is Too Strict

**Problem:**
The version variable validation in `migrate_variables.tf` line 186 was:

```hcl
validation {
  condition     = var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password_version != null
  error_message = "When admin_password is set, admin_password_version must also be set."
}
```

This validation **ALWAYS** requires the version to be non-null, even when `admin_password` is not set (i.e., when `windows_configuration` is null). This is incorrect.

**Why This Violates executor.md:**
From executor.md line 285-289:
```
validation {
  condition = var.migrate_{prefix}_{nested_path}_{field} == null || var.migrate_{prefix}_{nested_path}_{field}_version != null
  error_message = "When {field} is set, {field}_version must also be set."
}
```

The pattern shows the condition should check: "If field is null, OR if version is not null, then OK". This allows version to be null when field is null.

**Expected Behavior:**
- When `windows_configuration` is null ‚Üí version can be null (no password required)
- When `windows_configuration` is not null ‚Üí `admin_password` is always set (Required field with `nullable = false`) ‚Üí version must be non-null

**Root Cause:**
The executor forgot to include the field existence check in the condition. The validation should be conditional on whether the `windows_configuration` block is actually being used.

### Corrections Made

#### Fix 1: Version Variable Validation Logic

**Changed Files:**
- `migrate_variables.tf`: Fixed validation for `migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password_version`

**Original Implementation:**
```hcl
validation {
  condition     = var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password_version != null
  error_message = "When admin_password is set, admin_password_version must also be set."
}
```

**New Implementation:**
```hcl
validation {
  condition     = var.orchestrated_virtual_machine_scale_set_os_profile == null || var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration == null || var.migrate_orchestrated_virtual_machine_scale_set_os_profile_windows_configuration_admin_password_version != null
  error_message = "When admin_password is set, admin_password_version must also be set."
}
```

**Why This is EXACT:**
This matches the pattern from executor.md where version validation is conditional on the field being used. Since `admin_password` is Required when `windows_configuration` exists, we check if `windows_configuration` is null. If it's null, version can be null. If `windows_configuration` is not null, then `admin_password` is always set (due to `nullable = false`), so version must be non-null.

**Verification:**
- Scenario 1: `os_profile = null` ‚Üí condition: `true || ... = true` ‚úÖ (version can be null)
- Scenario 2: `os_profile.windows_configuration = null` ‚Üí condition: `false || true || ... = true` ‚úÖ (version can be null)
- Scenario 3: `os_profile.windows_configuration` exists, version = null ‚Üí condition: `false || false || false = false` ‚Üí ERROR ‚úÖ (enforces version requirement)
- Scenario 4: `os_profile.windows_configuration` exists, version = 1 ‚Üí condition: `false || false || true = true` ‚úÖ (allows non-null version)

### Final Verification Checklist

Before signing approval, performed mandatory final verification:

1. **Re-read all issues identified:** ‚úÖ Only one issue found (version validation)
2. **For EACH issue:**
   - ‚úÖ Code changes made to `migrate_variables.tf`
   - ‚úÖ Re-read the modified file to confirm changes are present
   - ‚úÖ Verified the changes match documented corrections
   - ‚úÖ No related issues missed
3. **Cross-check bidirectional constraints:**
   - ‚úÖ N/A - no bidirectional constraints for this field
4. **Verify all files mentioned in "Changed Files" section:**
   - ‚úÖ `migrate_variables.tf` changes confirmed
   - ‚úÖ No placeholder comments
   - ‚úÖ No partial implementations
5. **Run mental test scenarios:**
   - ‚úÖ Null handling verified (scenarios 1-4 above)
   - ‚úÖ Empty string not possible (8-character minimum enforced)
   - ‚úÖ Boundary conditions: 8-123 characters validated
   - ‚úÖ Complexity validation correctly checks all 4 combinations of 3-of-4 character types
6. **Verify no new issues introduced:**
   - ‚úÖ Fixes don't break existing code
   - ‚úÖ No syntax errors
   - ‚úÖ Proper HCL formatting

### Validation Results

‚úÖ **ForceNew Logic:** Simple ForceNew with value tracking in `replace_triggers_external_values`
‚úÖ **Stable Keys:** All keys in `replace_triggers_external_values` are stable
‚úÖ **Phase Detection:** Field correctly placed in `local.sensitive_body` (Create phase, sensitive field)
‚úÖ **Type Conversion:** String ‚Üí String (direct mapping)
‚úÖ **Null Handling:** Required field when `windows_configuration` exists (nullable = false), version validation now correctly conditional
‚úÖ **Validations:** All provider validations implemented (length 8-123, complexity 3-of-4 character types, disallowed values list)
‚úÖ **Sensitive Field Handling:** Independent ephemeral variable, version tracking, TODO comment in variables.tf, placed in `sensitive_body`
‚úÖ **Deferred Work Completion:** No deferred work for this task
‚úÖ **Deferred Work Recording:** No deferrals made by this task
‚úÖ **Edge Cases:** Shared `adminPassword` key with Linux correctly handled via conditional version tracking logic
‚úÖ **DiffSuppressFunc:** Correctly analyzed as no-op in normal operation (only handles import scenarios)

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The field is:
- Correctly placed in `sensitive_body` at `osProfile.adminPassword` level (not inside `windowsConfiguration`)
- Has proper ForceNew tracking in `replace_triggers_external_values` with stable key
- Uses independent ephemeral variable pattern for nested block sensitive fields per executor.md requirements
- Has all three validations (length 8-123, complexity 3-of-4 types, disallowed values) exactly matching provider logic
- Has proper version tracking in `sensitive_body_version` with conditional logic for shared `adminPassword` key between Linux and Windows
- Has TODO comment in `variables.tf` on the same line as the original field definition
- Version validation now correctly conditional on `windows_configuration` existence

**Status:** CORRECTED AND APPROVED ‚úÖ

---

## üìù Changelog - December 15, 2025

### Change: Use Version Variable in `replace_triggers_external_values` for Sensitive ForceNew Fields

**Reason:** New rule added to `executor.md` for handling Sensitive + ForceNew fields in `replace_triggers_external_values`.

**Rule:** If a field is BOTH `ForceNew: true` AND `Sensitive: true`, the sensitive value must NOT be added directly to `replace_triggers_external_values`. Instead, use the corresponding `xxx_version` variable.

**Change Made in `migrate_main.tf`:**

```diff
  replace_triggers_external_values = {
    # ...
-   windows_configuration_admin_password = { value = var.os_profile_windows_configuration_admin_password }
+   windows_configuration_admin_password = { value = var.os_profile_windows_configuration_admin_password_version }
    # ...
  }
```

**Rationale:**
- Prevents exposure of sensitive values in replace trigger tracking
- Version variable serves as a non-sensitive change indicator
- Maintains ForceNew behavior while protecting sensitive data

**Impact:** ‚úÖ No behavioral change - replacement triggers still work correctly, but now use version tracking instead of sensitive value comparison.

---
