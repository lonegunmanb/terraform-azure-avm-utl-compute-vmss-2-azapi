# Task #42 - data_disk.write_accelerator_enabled

## Summary

Implemented the `write_accelerator_enabled` argument for the `data_disk` block, mapping to `writeAcceleratorEnabled` in the Azure API. This field is Optional with a default value of `false`, is NOT ForceNew, and is supported in Update operations.

## Shadow Implementation

```hcl
locals {
  body = {
    properties = merge(
      var.orchestrated_virtual_machine_scale_set_sku_name != null ? {
        virtualMachineProfile = merge(
          var.orchestrated_virtual_machine_scale_set_data_disk != null || var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
            storageProfile = merge(
              var.orchestrated_virtual_machine_scale_set_data_disk != null ? {
                dataDisks = [
                  for data_disk in var.orchestrated_virtual_machine_scale_set_data_disk : {
                    caching = data_disk.caching
                    managedDisk = merge(
                      {
                        storageAccountType = data_disk.storage_account_type
                      },
                      data_disk.disk_encryption_set_id != null && data_disk.disk_encryption_set_id != "" ? {
                        diskEncryptionSet = {
                          id = data_disk.disk_encryption_set_id
                        }
                      } : {}
                    )
                    createOption            = data_disk.create_option
                    diskSizeGB              = data_disk.disk_size_gb != null && data_disk.disk_size_gb > 0 ? data_disk.disk_size_gb : null
                    lun                     = data_disk.lun
                    writeAcceleratorEnabled = data_disk.write_accelerator_enabled # <-
                    diskIOPSReadWrite       = data_disk.ultra_ssd_disk_iops_read_write != null && data_disk.ultra_ssd_disk_iops_read_write > 0 ? data_disk.ultra_ssd_disk_iops_read_write : null
                    diskMBpsReadWrite       = data_disk.ultra_ssd_disk_mbps_read_write != null && data_disk.ultra_ssd_disk_mbps_read_write > 0 ? data_disk.ultra_ssd_disk_mbps_read_write : null
                  }
                ]
              } : {}
            )
          } : {}
        )
      } : {}
    )
  }
}
```

## Create Phase Verification

**Pattern:** Single-phase creation

**Evidence from Create method:**
```go
if v, ok := d.GetOk("data_disk"); ok {
    ultraSSDEnabled := d.Get("additional_capabilities.0.ultra_ssd_enabled").(bool)
    dataDisks, err := ExpandOrchestratedVirtualMachineScaleSetDataDisk(v.([]interface{}), ultraSSDEnabled)
    if err != nil {
        return fmt.Errorf("expanding `data_disk`: %w", err)
    }
    virtualMachineProfile.StorageProfile.DataDisks = dataDisks
}
```

The `data_disk` block (including `write_accelerator_enabled`) is expanded and assigned to `virtualMachineProfile.StorageProfile.DataDisks` before the `CreateOrUpdateThenPoll` call.

**Classification:** Create phase - Field is set before the create operation.

**Decision:** Implement in `local.body`

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.storageProfile.dataDisks[].writeAcceleratorEnabled`

**Tracing Assignment in Create:**
1. `ExpandOrchestratedVirtualMachineScaleSetDataDisk` returns `*[]virtualmachinescalesets.VirtualMachineScaleSetDataDisk`
2. Inside expand function:
   ```go
   disk := virtualmachinescalesets.VirtualMachineScaleSetDataDisk{
       WriteAcceleratorEnabled: pointer.To(raw["write_accelerator_enabled"].(bool)),
       // ... other fields
   }
   ```
3. `virtualMachineProfile.StorageProfile.DataDisks = dataDisks` → Assigns to `StorageProfile.DataDisks`
4. `props.Properties.VirtualMachineProfile = &virtualMachineProfile` → Wraps in VirtualMachineProfile
5. Final API payload: `properties.virtualMachineProfile.storageProfile.dataDisks[].writeAcceleratorEnabled`

**Verified Path:** `properties.virtualMachineProfile.storageProfile.dataDisks[].writeAcceleratorEnabled` ✅

**Path Comparison:** Predicted path matches verified path exactly.

## Provider Schema

```go
"write_accelerator_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
},
```

**Key Attributes:**
- **Type:** `TypeBool`
- **Optional:** `true`
- **Default:** `false`
- **ForceNew:** NOT present (field is updatable)
- **Validation:** None (any boolean value is valid)
- **Computed:** `false`

## Azure API Schema

From the provider's expand function and Update method evidence, the field exists in the Azure API at:
- **Path:** `properties.virtualMachineProfile.storageProfile.dataDisks[].writeAcceleratorEnabled`
- **Type:** Boolean
- **Description:** Specifies whether write accelerator should be enabled on the data disk

## Hidden Fields

None. The field directly maps from Terraform to the Azure API without any additional hidden properties.

## Mapping

**Terraform → Azure API:**
- `write_accelerator_enabled` → `writeAcceleratorEnabled`

**Naming Convention:** snake_case to camelCase, maintaining exact field name semantics.

## Special Handling

### 1. Default Value

The provider schema specifies `Default: false`. We replicate this using the PREFERRED `optional()` method:

```hcl
write_accelerator_enabled = optional(bool, false)
```

This ensures:
- When `write_accelerator_enabled` is explicitly set (true or false), use that value
- When `write_accelerator_enabled` is `null` (not specified), default to `false`
- Exact replication of provider's default behavior using the PREFERRED method (not Fallback)

### 2. Update Support

**Evidence from Update method:**
```go
if d.HasChange("data_disk") {
    ultraSSDEnabled := false // Currently not supported in orchestrated vmss
    dataDisks, err := ExpandOrchestratedVirtualMachineScaleSetDataDisk(d.Get("data_disk").([]interface{}), ultraSSDEnabled)
    if err != nil {
        return fmt.Errorf("expanding `data_disk`: %w", err)
    }
    updateProps.VirtualMachineProfile.StorageProfile.DataDisks = dataDisks
}
```

The Update method processes the entire `data_disk` block, including `write_accelerator_enabled`. The field is NOT ForceNew, meaning changes to this field can be applied without replacement.

**Implementation:** Field is placed in `local.body` (not in `replace_triggers_external_values`), allowing updates without resource replacement.

### 3. No Validation Required

The field accepts any boolean value without restrictions. No validation block is needed in `variables.tf`.

### 4. Nested Block Context

The field is part of the `data_disk` nested block, which is a list of objects. The implementation uses a `for` expression to iterate over each data disk and set the field individually:

```hcl
for data_disk in var.orchestrated_virtual_machine_scale_set_data_disk : {
  writeAcceleratorEnabled = data_disk.write_accelerator_enabled
  // ... other fields
}
```

## Deferred Work Completion

Checked `following.md` - file does not exist. No deferred work to complete for this task.

## Critical Review & Edge Cases

### Edge Case Analysis

#### 1. Null vs False Semantics
- **Null:** When not specified, defaults to `false` via `optional(bool, false)` in type definition
- **False:** Explicitly disabled (same as default)
- **True:** Explicitly enabled
- **Implementation:** `optional(bool, false)` in type definition ensures field is guaranteed non-null with correct default

#### 2. Boolean Values
- **Valid values:** `true`, `false`, `null` (converted to `false` by type constraint)
- **Behavior:** All values handled correctly by `optional(bool, false)` type modifier
- **No edge cases:** Boolean type is straightforward with no boundary conditions

#### 3. Idempotency
- **First apply:** Sets `writeAcceleratorEnabled` to the specified value (or default `false`)
- **Subsequent applies:** Only changes if value changes
- **Safe:** No order dependencies, boolean comparison is deterministic

#### 4. Safe References
- **Field access:** `data_disk.write_accelerator_enabled` - safe because we're inside the `for` loop iterating over `var.orchestrated_virtual_machine_scale_set_data_disk`
- **Null check:** Not needed - field is guaranteed non-null by `optional(bool, false)` type constraint
- **No cascading nulls:** Field is at the data_disk level, no nested object access required

#### 5. Update Behavior
- **Change detection:** Any change to `write_accelerator_enabled` triggers data_disk update
- **No ForceNew:** Changes don't require resource replacement
- **Consistent:** Provider Update method re-expands entire data_disk list on change

#### 6. Multiple Data Disks
- **Scenario:** User configures multiple data disks with different `write_accelerator_enabled` values
- **Behavior:** Each disk in the list gets its own independent value
- **Safe:** `for` expression ensures proper per-disk configuration

#### 7. Empty vs Null
- **Empty collection:** When `var.orchestrated_virtual_machine_scale_set_data_disk == null`, the entire dataDisks block is not created (handled by parent conditional)
- **Null field:** When individual `write_accelerator_enabled` is null, type constraint applies default of `false`
- **Correct:** Both scenarios handled appropriately by type system

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ No ForceNew required (field is updatable)
- ✅ Default value replicated exactly (`false` via `optional(bool, false)`)
- ✅ Logic exactly matches provider (boolean field with default, no special logic)
- ✅ No validations required (any boolean value is valid)
- ✅ Hidden fields checked (none present)
- ✅ No deferred work (following.md does not exist)
- ✅ Critical review completed (see Edge Case Analysis)
- ✅ Edge Case Analysis documented
- ✅ Proof document created
- ✅ track.md ready for update to Pending

## Implementation Notes

1. **Placement:** Field is in `local.body` within the data_disk for loop
2. **No ForceNew:** Changes to this field do not trigger resource replacement
3. **Update Support:** Provider supports updating this field without replacement
4. **Default Applied:** Uses `optional(bool, false)` to ensure `false` when not specified
5. **No Cross-Field Dependencies:** This field has no dependencies on other fields
6. **Idempotent:** Repeated applies with same value produce no changes

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-08
**Task:** #42 - data_disk.write_accelerator_enabled

### Issues Identified

#### Issue 1: Incorrect Default Value Implementation Method - Method Priority Violation

**Problem:**
Executor used the **Fallback method** (`coalesce()` in locals) when the **PREFER method** (`optional(bool, false)` in type definition) was technically possible. This violates executor.md method priority rules (lines 124-127) and checker.md explicit guidance (lines 97-126).

**Executor's Original Implementation:**
```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_data_disk" {
  type = list(object({
    write_accelerator_enabled = optional(bool)  # ❌ No default
    # ...
  }))
}

# migrate_main.tf
writeAcceleratorEnabled = coalesce(data_disk.write_accelerator_enabled, false)  # ❌ Fallback method
```

**Why This Violates executor.md:**

From executor.md lines 124-127:
```
**Defaults:** If schema has `Default`, replicate it:
- **Top-level:** `variable "field" { default = value }`
- **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
- **Fallback:** Apply default in locals if optional() syntax not possible
```

The field is:
- Inside a nested `list(object({...}))` structure
- Has a provider schema default of `false`
- The `optional(bool, false)` syntax IS possible (proven by Tasks #36, #39 which were corrected by Checker)

**From checker.md lines 97-126:**
> **Key Rule:** `optional(type, default)` works in `list(object({...}))`, `object({...})`, and `set(object({...}))` at any nesting depth.
> 
> **Method Priority:**
> ```
> PREFER: optional(string, "default") in object type
>    ↓
> Fallback: coalesce() in locals (ONLY if optional() impossible)
> ```
> 
> **Common Violation:**
> ```hcl
> # ❌ WRONG
> type = list(object({ field = optional(string) }))
> # In locals: coalesce(obj.field, "default")
> 
> # ✅ CORRECT
> type = list(object({ field = optional(string, "default") }))
> # In locals: obj.field  # Guaranteed non-null
> ```

**Provider's Actual Behavior:**
```go
"write_accelerator_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
},
```

The provider specifies `Default: false`, which must be replicated using the PREFERRED method in the type definition.

**Expected Behavior:**
- When user omits `write_accelerator_enabled`: field defaults to `false`
- When user sets `write_accelerator_enabled = true`: field is `true`
- When user sets `write_accelerator_enabled = false`: field is `false`

**Root Cause:**
Executor incorrectly chose the Fallback method (`coalesce()`) when the PREFER method (`optional(bool, false)`) was technically possible. This is the same violation pattern corrected by Checker in Tasks #36 (create_option) and #39 (lun).

### Corrections Made

#### Fix 1: Use PREFER Method with `optional(bool, false)`

**Changed Files:**
- `variables.tf`: Changed `write_accelerator_enabled = optional(bool)` to `write_accelerator_enabled = optional(bool, false)`
- `migrate_main.tf`: Changed `writeAcceleratorEnabled = coalesce(data_disk.write_accelerator_enabled, false)` to `writeAcceleratorEnabled = data_disk.write_accelerator_enabled`
- `42.data_disk.write_accelerator_enabled.md`: Updated Implementation Notes to reflect correct method

**New Implementation:**

In `variables.tf`:
```hcl
variable "orchestrated_virtual_machine_scale_set_data_disk" {
  type = list(object({
    caching                        = string
    create_option                  = optional(string, "Empty")
    disk_encryption_set_id         = optional(string)
    disk_size_gb                   = optional(number)
    lun                            = optional(number, 0)
    storage_account_type           = string
    ultra_ssd_disk_iops_read_write = optional(number)
    ultra_ssd_disk_mbps_read_write = optional(number)
    write_accelerator_enabled      = optional(bool, false)  # ✅ PREFERRED method
  }))
  # ... validations
}
```

In `migrate_main.tf`:
```hcl
for data_disk in var.orchestrated_virtual_machine_scale_set_data_disk : {
  caching = data_disk.caching
  managedDisk = merge(
    {
      storageAccountType = data_disk.storage_account_type
    },
    data_disk.disk_encryption_set_id != null && data_disk.disk_encryption_set_id != "" ? {
      diskEncryptionSet = {
        id = data_disk.disk_encryption_set_id
      }
    } : {}
  )
  createOption            = data_disk.create_option
  diskSizeGB              = data_disk.disk_size_gb != null && data_disk.disk_size_gb > 0 ? data_disk.disk_size_gb : null
  lun                     = data_disk.lun
  writeAcceleratorEnabled = data_disk.write_accelerator_enabled  # ✅ Direct access - guaranteed non-null by optional() default
  diskIOPSReadWrite       = data_disk.ultra_ssd_disk_iops_read_write != null && data_disk.ultra_ssd_disk_iops_read_write > 0 ? data_disk.ultra_ssd_disk_iops_read_write : null
  diskMBpsReadWrite       = data_disk.ultra_ssd_disk_mbps_read_write != null && data_disk.ultra_ssd_disk_mbps_read_write > 0 ? data_disk.ultra_ssd_disk_mbps_read_write : null
}
```

**Why This is EXACT:**

1. **Method Priority Compliance:** Uses the PREFERRED `optional(bool, false)` method as mandated by executor.md
2. **Exact Replication:** The `optional()` modifier with default value exactly replicates the provider's `Default: false` behavior
3. **Type System Guarantee:** Field is guaranteed to be non-null after type constraint application, eliminating need for runtime coalesce
4. **Consistency:** Matches the corrected pattern from Tasks #36 (create_option) and #39 (lun)
5. **Terraform 1.3+ Support:** The `optional()` modifier with defaults is fully supported in Terraform 1.3+

**Verification:**

Scenario 1: User omits field
```hcl
data_disk = [{
  caching              = "ReadWrite"
  storage_account_type = "Premium_LRS"
  # write_accelerator_enabled not specified
}]
```
- Type constraint applies: `write_accelerator_enabled = false` (default)
- Result: `writeAcceleratorEnabled: false` ✅

Scenario 2: User sets to true
```hcl
data_disk = [{
  caching                   = "ReadWrite"
  storage_account_type      = "Premium_LRS"
  write_accelerator_enabled = true
}]
```
- Type constraint applies: `write_accelerator_enabled = true` (explicit)
- Result: `writeAcceleratorEnabled: true` ✅

Scenario 3: User sets to false
```hcl
data_disk = [{
  caching                   = "ReadWrite"
  storage_account_type      = "Premium_LRS"
  write_accelerator_enabled = false
}]
```
- Type constraint applies: `write_accelerator_enabled = false` (explicit)
- Result: `writeAcceleratorEnabled: false` ✅

### Validation Results After Corrections

✅ **ForceNew Logic:** Not ForceNew - field is updatable without replacement
✅ **Stable Keys:** N/A - not in `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Boolean to Boolean - direct mapping
✅ **Null Handling:** Null prevented by `optional(bool, false)` - field guaranteed non-null
✅ **Validations:** No validations required (boolean field accepts any boolean value)
✅ **Default Value Method:** Now uses PREFERRED `optional(bool, false)` method (CORRECTED ✅)
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** All edge cases properly analyzed and handled
✅ **Method Priority Compliance:** Now follows executor.md method priority rules (CORRECTED ✅)

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The default value is applied using the PREFERRED `optional(bool, false)` method, not the Fallback `coalesce()` method. This ensures consistency with other corrected tasks (#36, #39) and follows the strict method priority rules.

**Status:** CORRECTED AND APPROVED ✅

---
