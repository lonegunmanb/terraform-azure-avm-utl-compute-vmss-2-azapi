# Task #29 - automatic_instance_repair.action

## Summary

Implemented `automatic_instance_repair.action` as an Optional string field that maps to Azure API `properties.automaticRepairsPolicy.repairAction`. The field is conditionally set only when non-null and non-empty, matching the provider's expand function behavior.

## Shadow Implementation

```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_automatic_instance_repair" {
  type = object({
    action       = optional(string) # <-
    enabled      = bool
    grace_period = optional(string)
  })
  default     = null
  
  validation { # <-
    condition = ( # <-
      var.orchestrated_virtual_machine_scale_set_automatic_instance_repair == null || # <-
      var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action == null || # <-
      contains(["Replace", "Restart", "Reimage"], var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action) # <-
    ) # <-
    error_message = "The action must be one of: Replace, Restart, Reimage." # <-
  } # <-
}

# migrate_main.tf
locals {
  body = {
    properties = merge(
      var.orchestrated_virtual_machine_scale_set_automatic_instance_repair != null ? {
        automaticRepairsPolicy = merge(
          {
            enabled = var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.enabled
          },
          var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action != null && var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action != "" ? { # <-
            repairAction = var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action # <-
          } : {} # <-
        )
      } : {}
    )
  }
}
```

## Create Phase Verification

### Query Create Method

Queried Create method to verify field assignment phase.

### Pattern Identification

**Single-Phase Pattern**: The Create method uses `CreateOrUpdateThenPoll` which handles creation in a single API call.

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... properties construction ...
    
    if v, ok := d.GetOk("automatic_instance_repair"); ok {
        if !hasHealthExtension {
            return fmt.Errorf("`automatic_instance_repair` can only be enabled when an application health extension is configured")
        }
        
        props.Properties.AutomaticRepairsPolicy = ExpandVirtualMachineScaleSetAutomaticRepairsPolicy(v.([]interface{}))
    }
    
    // ... more properties ...
    
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

### Field Classification

**Create Phase Assignment**: The field is set BEFORE the `CreateOrUpdateThenPoll` call via the expand function, making it a Create phase field.

**Decision**: Implement in `local.body` (not in `post_creation_updates`).

## Assignment Path Verification

### Predicted Path

```
automatic_instance_repair.action (Terraform variable)
  └─> AutomaticRepairsPolicy.RepairAction (props.Properties field)
    └─> properties.automaticRepairsPolicy.repairAction (Azure API)
```

### Go Code Evidence

From Expand function:

```go
func ExpandVirtualMachineScaleSetAutomaticRepairsPolicy(input []interface{}) *virtualmachinescalesets.AutomaticRepairsPolicy {
    if len(input) == 0 {
        return nil
    }

    v := input[0].(map[string]interface{})

    result := virtualmachinescalesets.AutomaticRepairsPolicy{}

    result.Enabled = pointer.To(v["enabled"].(bool))
    result.GracePeriod = pointer.To(v["grace_period"].(string))

    if v["action"].(string) != "" {
        result.RepairAction = pointer.To(virtualmachinescalesets.RepairAction(v["action"].(string)))
    }

    return &result
}
```

From Create method:
```go
props.Properties.AutomaticRepairsPolicy = ExpandVirtualMachineScaleSetAutomaticRepairsPolicy(v.([]interface{}))
```

### Verified Path

```
automatic_instance_repair.action (Terraform)
  └─> v["action"].(string) (expand function input)
    └─> result.RepairAction (expand function output - ONLY IF NOT EMPTY)
      └─> props.Properties.AutomaticRepairsPolicy.RepairAction (Go struct)
        └─> properties.automaticRepairsPolicy.repairAction (Azure API)
```

### Path Comparison

✅ **Match**: The predicted path matches the verified path. The field is extracted from the Terraform object, checked for empty string, converted to RepairAction enum type via type casting, wrapped in pointer via `pointer.To()`, and assigned to `result.RepairAction`. The key behavior is that the field is ONLY set when the string is NOT empty.

## Provider Schema

From provider schema:

```go
func VirtualMachineScaleSetAutomaticRepairsPolicySchema() *pluginsdk.Schema {
    return &pluginsdk.Schema{
        Type:     pluginsdk.TypeList,
        Optional: true,
        Computed: true,
        MaxItems: 1,
        Elem: &pluginsdk.Resource{
            Schema: map[string]*pluginsdk.Schema{
                "enabled": {
                    Type:     pluginsdk.TypeBool,
                    Required: true,
                },
                // NOTE: O+C 'grace_period' and 'action' will always return a value once they've been set.
                "grace_period": {
                    Type:         pluginsdk.TypeString,
                    Optional:     true,
                    Computed:     true,
                    ValidateFunc: azValidate.ISO8601DurationBetween("PT10M", "PT90M"),
                },
                "action": {
                    Type:         pluginsdk.TypeString,
                    Optional:     true,
                    Computed:     true,
                    ValidateFunc: validation.StringInSlice(virtualmachinescalesets.PossibleValuesForRepairAction(), false),
                },
            },
        },
    }
}
```

**Field Schema**:
- **Type**: `TypeString`
- **Optional**: `true`
- **Computed**: `true` (Azure API returns a value once set)
- **Validation**: `validation.StringInSlice(virtualmachinescalesets.PossibleValuesForRepairAction(), false)` - must be one of the allowed enum values
- **ForceNew**: Not present (defaults to `false`)

**Note**: The schema comment says "O+C 'grace_period' and 'action' will always return a value once they've been set." This means these fields are Computed - Azure API may return default values if not explicitly set.

## Azure API Schema

From SDK type definition:

```go
type RepairAction string

func PossibleValuesForRepairAction() []string {
    return []string{
        string(RepairActionReimage),
        string(RepairActionReplace),
        string(RepairActionRestart),
    }
}

// Enum constants
RepairActionReimage RepairAction = "Reimage"
RepairActionReplace RepairAction = "Replace"
RepairActionRestart RepairAction = "Restart"
```

**API Property**:
- **Path**: `properties.automaticRepairsPolicy.repairAction`
- **Type**: `String` (enum)
- **Allowed values**: `"Replace"`, `"Restart"`, `"Reimage"`
- **Optional**: Yes (at API level)

## Hidden Fields Check

No hidden fields for this argument. The expand function conditionally sets the field based on whether the input string is empty.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| automatic_instance_repair.action | automaticRepairsPolicy.repairAction |

**Enum Value Mapping** (case-sensitive, direct mapping):
| Terraform Value | Azure API Value |
|----------------|-----------------|
| "Replace" | "Replace" |
| "Restart" | "Restart" |
| "Reimage" | "Reimage" |

## Special Handling

### No ForceNew

The field is **NOT** marked as `ForceNew: true` in the provider schema. This means changes to this field can be updated in place without forcing resource replacement. No entry needed in `replace_triggers_external_values`.

### Validation Added to variables.tf

The provider schema includes `ValidateFunc: validation.StringInSlice(virtualmachinescalesets.PossibleValuesForRepairAction(), false)`.

**Implementation in variables.tf**:
```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_automatic_instance_repair == null ||
    var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action == null ||
    contains(["Replace", "Restart", "Reimage"], var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action)
  )
  error_message = "The action must be one of: Replace, Restart, Reimage."
}
```

This validation:
1. Allows the parent block to be null
2. Allows the action field to be null (it's Optional)
3. When action is provided, enforces it must be one of the three valid enum values
4. Uses `contains()` for exact string matching (case-sensitive)

### Conditional Assignment Based on Empty String

**CRITICAL PROVIDER BEHAVIOR**: The expand function only sets `RepairAction` when the string is NOT empty:

```go
if v["action"].(string) != "" {
    result.RepairAction = pointer.To(virtualmachinescalesets.RepairAction(v["action"].(string)))
}
```

This means:
- When `action` is `null` → field NOT set in API body
- When `action` is `""` (empty string) → field NOT set in API body
- When `action` has a value → field IS set in API body

**Shadow Module Implementation**:
```hcl
var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action != null && var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action != "" ? {
  repairAction = var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action
} : {}
```

This EXACTLY replicates the provider behavior by checking both null and empty string conditions before including the field.

### Optional + Computed Semantics

The field is marked as both **Optional** and **Computed**:
- **Optional**: User can choose to set it or leave it unset
- **Computed**: Azure API may return a default value if not set by the user

The schema comment indicates: "O+C 'grace_period' and 'action' will always return a value once they've been set."

This means:
1. First apply with `action` not set → Azure API may return a computed default
2. Subsequent applies → the computed value persists unless explicitly changed
3. User can override by explicitly setting a value

The Shadow Module handles this by:
- Only including the field in the request body when user explicitly provides a non-empty value
- Not setting a default in `variables.tf`, allowing Terraform to handle the Computed behavior via state

### No Sensitive or WriteOnly Fields

The field is a regular string configuration value, not marked as Sensitive or WriteOnly in the provider. It goes in `local.body`, not `local.sensitive_body`.

### Using merge() for Conditional Field

Since `action` is Optional and only added when non-null and non-empty, we use `merge()` to conditionally include the field:

```hcl
automaticRepairsPolicy = merge(
  {
    enabled = var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.enabled
  },
  var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action != null && var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action != "" ? {
    repairAction = var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action
  } : {}
)
```

This ensures:
1. `enabled` is always present (it's Required in parent block)
2. `repairAction` is only present when action has a non-empty value
3. The structure remains clean and matches provider behavior

## Critical Review & Edge Case Analysis

### Null Semantics

**Parent block is null**: When `var.orchestrated_virtual_machine_scale_set_automatic_instance_repair` is `null`, the entire `automaticRepairsPolicy` object is omitted from the API body (handled by parent block skeleton in Task #27). This field is not evaluated.

**Field is null**: When the parent block exists but `action` is `null`, the conditional returns `{}`, meaning `repairAction` is NOT included in the API body. This matches provider behavior where the expand function doesn't set the field.

**Field is empty string**: When `action` is `""` (empty string), the condition `action != ""` evaluates to `false`, so `repairAction` is NOT included in the API body. This EXACTLY matches the provider's expand function check: `if v["action"].(string) != "" { ... }`.

**Field has value**: When `action` contains one of the valid enum values ("Replace", "Restart", "Reimage"), the field is included in the API body and sent to Azure.

### Boundary Conditions

**Empty string handling**: The provider explicitly checks `!= ""` before setting the field. The Shadow Module replicates this with `action != null && action != ""`.

**Invalid enum values**: The validation block in `variables.tf` enforces that only the three valid enum values can be used. Terraform will fail at plan time if an invalid value is provided.

**Case sensitivity**: The enum values are case-sensitive ("Replace", not "replace"). The validation uses exact string matching via `contains()`, enforcing correct casing.

### Idempotency

**Deterministic mapping**: The field value directly maps to the API without any transformations. Each valid input produces the same output consistently.

**Computed field behavior**: Since the field is marked as Computed, Azure API may return a default value. However:
1. The Shadow Module only sets the field when explicitly provided by the user
2. Terraform's state management will track the computed value from Azure
3. If the user doesn't specify a value, Terraform won't include it in subsequent updates, allowing Azure to maintain its computed value
4. This is the correct behavior for Optional+Computed fields

**No order dependencies**: String enum values have no ordering or sequencing concerns.

### Safe References

**Null-safe parent access**: The implementation only accesses `.action` when the parent object is non-null, protected by the parent block's conditional.

**Double null-safety**: The condition checks both `!= null` AND `!= ""` to handle all cases where the field should not be set:
```hcl
action != null && action != "" ? { repairAction = ... } : {}
```

This prevents:
1. Attempting to access properties on a null value
2. Setting the field to an empty string in the API body (which would differ from provider behavior)

**Optional field access**: Since `action` is `optional(string)` in the parent object type, it can be null even when the parent is non-null. The null check handles this correctly.

### Edge Cases

1. **Null vs empty string**: 
   - Provider treats both as "don't set field"
   - Shadow Module replicates this with `!= null && != ""`
   - Both result in field being omitted from API body

2. **Invalid enum value**:
   - Validation in `variables.tf` catches this at plan time
   - Error: "The action must be one of: Replace, Restart, Reimage."
   - Users get immediate feedback before any API calls

3. **Case-sensitive values**:
   - Validation enforces exact casing
   - "replace" or "REPLACE" would fail validation
   - Matches provider behavior which uses exact enum constants

4. **Computed field persistence**:
   - Once Azure returns a computed value, it persists in Terraform state
   - Users can override by explicitly setting a value
   - Shadow Module doesn't interfere with this - it only controls what's sent in the request

5. **Mixing with other fields**:
   - `enabled` (Required) is always present
   - `action` (Optional) may or may not be present
   - `grace_period` (Optional, Task #30) may or may not be present
   - The `merge()` pattern ensures all combinations work correctly

6. **Update behavior**:
   - Not marked as ForceNew, so updates are in-place
   - User can change from "Replace" to "Restart" without recreating resource
   - User can change from set to null (removes from next API call)
   - Azure API handles all these transitions

## Checklist

- ✅ Property in correct local (`body`)
- ✅ No ForceNew wrapping needed (field not marked ForceNew)
- ✅ Logic exactly replicated from provider (conditional on non-empty string)
- ✅ Validation implemented in variables.tf (enum value constraint)
- ✅ Hidden fields checked (none found)
- ✅ Critical review completed
- ✅ Edge case analysis documented
- ✅ Proof created
- ✅ Task ready for track.md update

## Implementation Exactly Matches Provider Behavior

The implementation EXACTLY replicates the provider's expand function behavior:

**Provider expand function**:
```go
if v["action"].(string) != "" {
    result.RepairAction = pointer.To(virtualmachinescalesets.RepairAction(v["action"].(string)))
}
```

**Shadow Module implementation**:
```hcl
var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action != null && var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action != "" ? {
  repairAction = var.orchestrated_virtual_machine_scale_set_automatic_instance_repair.action
} : {}
```

**Key behaviors matched**:
1. ✅ Field only set when string is NOT empty
2. ✅ Empty string treated same as null (field omitted)
3. ✅ Value used directly without transformation
4. ✅ Validation enforces enum values (Replace, Restart, Reimage)
5. ✅ Optional + Computed semantics preserved
6. ✅ Not marked as ForceNew (updates in place)

The Shadow Module achieves identical behavior using Terraform's conditional expressions and merge patterns.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-08
**Task:** #29 - automatic_instance_repair.action

### Validation Results

✅ **ForceNew Logic:** Not applicable - field is not marked ForceNew, correctly omitted from `replace_triggers_external_values`
✅ **Stable Keys:** Not applicable - field is not in `replace_triggers_external_values`
✅ **Phase Detection:** Correctly placed in `local.body` (Create phase, set before CreateOrUpdateThenPoll)
✅ **Type Conversion:** Direct string assignment, no conversion needed - correct
✅ **Null Handling:** Correctly handles null and empty string (both result in field omission)
✅ **Validations:** Enum validation correctly implemented in `variables.tf` with case-sensitive exact matching
✅ **Edge Cases:** Empty string handling exactly matches provider's `!= ""` check
✅ **Shared Path Merge:** No duplicate keys - `automaticRepairsPolicy` appears once, nested merge used correctly
✅ **Exact Replication:** Implementation EXACTLY matches provider's expand function conditional logic

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The conditional logic `action != null && action != ""` precisely matches the provider's `if v["action"].(string) != ""` check. The validation enforces the three allowed enum values ("Replace", "Restart", "Reimage") with case-sensitive exact matching. No deviations, simplifications, or "safer alternatives" were found.

**Key Behaviors Verified:**
1. Field only set when string is NOT null AND NOT empty
2. Empty string treated identically to null (field omitted from API body)
3. Enum validation enforces exact values at plan time
4. Optional + Computed semantics preserved
5. Updates in-place (not ForceNew)
6. Nested merge pattern correctly used within `automaticRepairsPolicy`

**Status:** APPROVED ✅

---
