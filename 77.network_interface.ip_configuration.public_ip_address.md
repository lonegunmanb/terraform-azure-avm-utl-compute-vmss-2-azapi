# Task #77: network_interface.ip_configuration.public_ip_address - Block Structure Skeleton

## Summary

Created the block structure skeleton for `network_interface.ip_configuration.public_ip_address` with conditional inclusion based on whether the user provides public IP configuration. The skeleton includes comment placeholders for all child fields (Tasks #78-86) that will be implemented in subsequent tasks.

## Shadow Implementation

```hcl
ip_config.public_ip_address != null && length(ip_config.public_ip_address) > 0 ? { # <-
  publicIPAddressConfiguration = { # <-
    # name = ... # Task #78 # <-
    # properties = { # Task #79-83 # <-
    #   domainNameLabel = ... # Task #79 # <-
    #   idleTimeoutInMinutes = ... # Task #80 # <-
    #   publicIPPrefix = { id = ... } # Task #81 # <-
    #   publicIPAddressVersion = ... # Task #83 # <-
    #   ipTags = [ # Task #84-86 # <-
    #     { tag = ..., ipTagType = ... } # Task #85, #86 # <-
    #   ] # <-
    # } # <-
    # sku = { name = ... } # Task #82 # <-
  } # <-
} : {} # <-
```

## Create Phase Verification

### Query Result

Queried the Create method with `query_terraform_block_implementation_source_code`:

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... (setup code)
    
    if v, ok := d.GetOk("network_interface"); ok {
        networkInterfaces, err := ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(v.([]interface{}))
        if err != nil {
            return fmt.Errorf("expanding `network_interface`: %w", err)
        }

        networkProfile.NetworkInterfaceConfigurations = networkInterfaces
        virtualMachineProfile.NetworkProfile = networkProfile
    }
    
    // ...
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

### Create Pattern

**Pattern:** Single-phase create

The resource uses `CreateOrUpdateThenPoll` which is a single-phase creation pattern. The `public_ip_address` block is part of the network interface configuration that is expanded before the API call and included in the initial create request.

### Field Phase Classification

**Phase:** Create phase

The `public_ip_address` field is:
1. Expanded via `ExpandOrchestratedVirtualMachineScaleSetNetworkInterface` → `expandOrchestratedVirtualMachineScaleSetIPConfiguration` → `expandOrchestratedVirtualMachineScaleSetPublicIPAddress`
2. Set in the `virtualMachineProfile.NetworkProfile` before the create call
3. Sent to the API in the initial `CreateOrUpdateThenPoll` request

**Decision:** Implement in `local.body` (Create phase)

## Assignment Path Verification

### Predicted Path

Based on Azure API schema and parent block structure:
```
body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.publicIPAddressConfiguration
```

### Go Code Evidence

From `expandOrchestratedVirtualMachineScaleSetIPConfiguration`:

```go
func expandOrchestratedVirtualMachineScaleSetIPConfiguration(raw map[string]interface{}) (*virtualmachinescalesets.VirtualMachineScaleSetIPConfiguration, error) {
    // ... (other fields)
    
    ipConfiguration := virtualmachinescalesets.VirtualMachineScaleSetIPConfiguration{
        Name: raw["name"].(string),
        Properties: &virtualmachinescalesets.VirtualMachineScaleSetIPConfigurationProperties{ // ← .Properties assignment
            Primary:                               pointer.To(primary),
            PrivateIPAddressVersion:               pointer.To(version),
            // ... other fields
        },
    }
    
    publicIPConfigsRaw := raw["public_ip_address"].([]interface{})
    if len(publicIPConfigsRaw) > 0 && publicIPConfigsRaw[0] != nil {
        publicIPConfigRaw := publicIPConfigsRaw[0].(map[string]interface{})
        publicIPAddressConfig := expandOrchestratedVirtualMachineScaleSetPublicIPAddress(publicIPConfigRaw)
        ipConfiguration.Properties.PublicIPAddressConfiguration = publicIPAddressConfig // ← Assignment to .Properties.PublicIPAddressConfiguration
    }
    
    return &ipConfiguration, nil
}
```

From the Create method:

```go
networkProfile.NetworkInterfaceConfigurations = networkInterfaces // ← Assigned to networkProfile
virtualMachineProfile.NetworkProfile = networkProfile // ← Assigned to virtualMachineProfile.NetworkProfile
props.Properties.VirtualMachineProfile = &virtualMachineProfile // ← Assigned to props.Properties.VirtualMachineProfile
```

### Verified Path

```
body
└── properties (assigned via props.Properties)
    └── virtualMachineProfile (assigned via props.Properties.VirtualMachineProfile)
        └── networkProfile (assigned via virtualMachineProfile.NetworkProfile)
            └── networkInterfaceConfigurations (assigned via networkProfile.NetworkInterfaceConfigurations)
                └── [array elements]
                    └── properties (assigned via config.Properties in ExpandOrchestratedVirtualMachineScaleSetNetworkInterface)
                        └── ipConfigurations (assigned via config.Properties.IPConfigurations)
                            └── [array elements]
                                └── properties (assigned via ipConfiguration.Properties)
                                    └── publicIPAddressConfiguration (assigned via ipConfiguration.Properties.PublicIPAddressConfiguration)
```

### Path Comparison

**Match:** ✅ The predicted path matches the verified path exactly.

The assignment follows this chain:
1. `ipConfiguration.Properties.PublicIPAddressConfiguration = publicIPAddressConfig`
2. `config.Properties.IPConfigurations` includes the ipConfiguration
3. `networkProfile.NetworkInterfaceConfigurations` includes the config
4. `virtualMachineProfile.NetworkProfile = networkProfile`
5. `props.Properties.VirtualMachineProfile = &virtualMachineProfile`

## Provider Schema

```go
func orchestratedVirtualMachineScaleSetIPConfigurationSchema() *pluginsdk.Schema {
    return &pluginsdk.Schema{
        Type:     pluginsdk.TypeList,
        Required: true,
        Elem: &pluginsdk.Resource{
            Schema: map[string]*pluginsdk.Schema{
                // ... other fields
                "public_ip_address": orchestratedVirtualMachineScaleSetPublicIPAddressSchema(),
                // ... other fields
            },
        },
    }
}

func orchestratedVirtualMachineScaleSetPublicIPAddressSchema() *pluginsdk.Schema {
    return &pluginsdk.Schema{
        Type:     pluginsdk.TypeList,
        Optional: true, // ← Optional block
        Elem: &pluginsdk.Resource{
            Schema: map[string]*pluginsdk.Schema{
                "name": {
                    Type:         pluginsdk.TypeString,
                    Required:     true,
                    ValidateFunc: validation.StringIsNotEmpty,
                },
                "domain_name_label": {
                    Type:         pluginsdk.TypeString,
                    Optional:     true,
                    ValidateFunc: validate.OrchestratedDomainNameLabel,
                },
                "idle_timeout_in_minutes": {
                    Type:         pluginsdk.TypeInt,
                    Optional:     true,
                    Computed:     true,
                    ValidateFunc: validation.IntBetween(4, 32),
                },
                "ip_tag": {
                    Type:     pluginsdk.TypeList,
                    Optional: true,
                    ForceNew: true,
                    Elem: &pluginsdk.Resource{
                        Schema: map[string]*pluginsdk.Schema{
                            "tag": {
                                Type:         pluginsdk.TypeString,
                                Required:     true,
                                ForceNew:     true,
                                ValidateFunc: validation.StringIsNotEmpty,
                            },
                            "type": {
                                Type:         pluginsdk.TypeString,
                                Required:     true,
                                ForceNew:     true,
                                ValidateFunc: validation.StringIsNotEmpty,
                            },
                        },
                    },
                },
                "public_ip_prefix_id": {
                    Type:         pluginsdk.TypeString,
                    Optional:     true,
                    ForceNew:     true,
                    ValidateFunc: publicipprefixes.ValidatePublicIPPrefixID,
                },
                "sku_name": {
                    Type:         pluginsdk.TypeString,
                    Optional:     true,
                    ForceNew:     true,
                    ValidateFunc: validate.OrchestratedVirtualMachineScaleSetPublicIPSku,
                },
                "version": {
                    Type:     pluginsdk.TypeString,
                    Optional: true,
                    ForceNew: true,
                    Default:  string(virtualmachinescalesets.IPVersionIPvFour),
                    ValidateFunc: validation.StringInSlice([]string{
                        string(virtualmachinescalesets.IPVersionIPvFour),
                        string(virtualmachinescalesets.IPVersionIPvSix),
                    }, false),
                },
            },
        },
    }
}
```

**Block Type:** `TypeList` (Optional)

**Child Fields:**
- `name` (String, Required) - Task #78
- `domain_name_label` (String, Optional) - Task #79
- `idle_timeout_in_minutes` (Int, Optional, Computed) - Task #80
- `public_ip_prefix_id` (String, Optional, ForceNew) - Task #81
- `sku_name` (String, Optional, ForceNew) - Task #82
- `version` (String, Optional, ForceNew, Default: "IPv4") - Task #83
- `ip_tag` (List, Optional, ForceNew) - Task #84-86

## Azure API Schema

Query: `body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations.properties.ipConfigurations.properties.publicIPAddressConfiguration`

Result:
```
ObjectWithOptionalAttrs(map[string]Type{
  "name": String,
  "properties": ObjectWithOptionalAttrs(map[string]Type{
    "deleteOption": String,
    "dnsSettings": ObjectWithOptionalAttrs(map[string]Type{
      "domainNameLabel": String,
      "domainNameLabelScope": String
    }, []string{"domainNameLabelScope"}),
    "idleTimeoutInMinutes": Number,
    "ipTags": List(ObjectWithOptionalAttrs(map[string]Type{
      "ipTagType": String,
      "tag": String
    }, []string{"ipTagType", "tag"})),
    "publicIPAddressVersion": String,
    "publicIPPrefix": ObjectWithOptionalAttrs(map[string]Type{
      "id": String
    }, []string{"id"})
  }, []string{"deleteOption", "dnsSettings", "idleTimeoutInMinutes", "ipTags", "publicIPAddressVersion", "publicIPPrefix"}),
  "sku": ObjectWithOptionalAttrs(map[string]Type{
    "name": String,
    "tier": String
  }, []string{"name", "tier"})
}, []string{"properties", "sku"})
```

**Structure:**
- Root object contains: `name`, `properties`, `sku`
- `properties` contains: `dnsSettings`, `idleTimeoutInMinutes`, `ipTags`, `publicIPAddressVersion`, `publicIPPrefix`, `deleteOption`
- `dnsSettings` contains: `domainNameLabel`, `domainNameLabelScope`
- `sku` contains: `name`, `tier`

**Note:** The API schema includes `deleteOption` and `domainNameLabelScope` which are NOT exposed in the Terraform provider schema. These are hidden fields not accessible to users.

## Hidden Fields Check

### Expand Function Analysis

Queried `expandOrchestratedVirtualMachineScaleSetPublicIPAddress`:

```go
func expandOrchestratedVirtualMachineScaleSetPublicIPAddress(raw map[string]interface{}) *virtualmachinescalesets.VirtualMachineScaleSetPublicIPAddressConfiguration {
    ipTagsRaw := raw["ip_tag"].([]interface{})
    ipTags := make([]virtualmachinescalesets.VirtualMachineScaleSetIPTag, 0)
    for _, ipTagV := range ipTagsRaw {
        ipTagRaw := ipTagV.(map[string]interface{})
        ipTags = append(ipTags, virtualmachinescalesets.VirtualMachineScaleSetIPTag{
            Tag:       pointer.To(ipTagRaw["tag"].(string)),
            IPTagType: pointer.To(ipTagRaw["type"].(string)),
        })
    }

    publicIPAddressConfig := virtualmachinescalesets.VirtualMachineScaleSetPublicIPAddressConfiguration{
        Name: raw["name"].(string),
        Properties: &virtualmachinescalesets.VirtualMachineScaleSetPublicIPAddressConfigurationProperties{
            IPTags: &ipTags,
        },
    }

    if domainNameLabel := raw["domain_name_label"].(string); domainNameLabel != "" {
        dns := &virtualmachinescalesets.VirtualMachineScaleSetPublicIPAddressConfigurationDnsSettings{
            DomainNameLabel: domainNameLabel,
        }
        publicIPAddressConfig.Properties.DnsSettings = dns
    }

    if idleTimeout := raw["idle_timeout_in_minutes"].(int); idleTimeout > 0 {
        publicIPAddressConfig.Properties.IdleTimeoutInMinutes = pointer.To(int64(raw["idle_timeout_in_minutes"].(int)))
    }

    if publicIPPrefixID := raw["public_ip_prefix_id"].(string); publicIPPrefixID != "" {
        publicIPAddressConfig.Properties.PublicIPPrefix = &virtualmachinescalesets.SubResource{
            Id: pointer.To(publicIPPrefixID),
        }
    }

    if sku := raw["sku_name"].(string); sku != "" {
        v := expandOrchestratedVirtualMachineScaleSetPublicIPSku(sku)
        publicIPAddressConfig.Sku = v
    }

    if version := raw["version"].(string); version != "" {
        publicIPAddressConfig.Properties.PublicIPAddressVersion = pointer.To(virtualmachinescalesets.IPVersion(version))
    }

    return &publicIPAddressConfig
}
```

### Hidden Fields Result

**NO HIDDEN FIELDS FOUND** - The expand function only uses fields that are explicitly defined in the schema:
- `name` (from schema)
- `domain_name_label` (from schema - conditional)
- `idle_timeout_in_minutes` (from schema - conditional)
- `public_ip_prefix_id` (from schema - conditional)
- `sku_name` (from schema - conditional, expanded via separate function)
- `version` (from schema - conditional)
- `ip_tag` (from schema - list of objects)

All fields are user-provided from the Terraform configuration. No hardcoded values or computed fields are added by the provider.

**Note:** The Azure API includes `deleteOption` and `domainNameLabelScope` fields that are NOT set by the provider and NOT exposed in Terraform. These are omitted entirely and left for Azure to manage with defaults.

## Mapping

| Terraform Field | Azure API Field | Task # |
|----------------|----------------|--------|
| `public_ip_address` | `publicIPAddressConfiguration` | #77 |
| `public_ip_address[0].name` | `publicIPAddressConfiguration.name` | #78 |
| `public_ip_address[0].domain_name_label` | `publicIPAddressConfiguration.properties.dnsSettings.domainNameLabel` | #79 |
| `public_ip_address[0].idle_timeout_in_minutes` | `publicIPAddressConfiguration.properties.idleTimeoutInMinutes` | #80 |
| `public_ip_address[0].public_ip_prefix_id` | `publicIPAddressConfiguration.properties.publicIPPrefix.id` | #81 |
| `public_ip_address[0].sku_name` | `publicIPAddressConfiguration.sku.name` | #82 |
| `public_ip_address[0].version` | `publicIPAddressConfiguration.properties.publicIPAddressVersion` | #83 |
| `public_ip_address[0].ip_tag` | `publicIPAddressConfiguration.properties.ipTags` | #84-86 |

**Note:** The Terraform schema defines `public_ip_address` as a `TypeList`, but the provider logic treats it as a single-item list (maxItems = 1 implicit). The expand function accesses `publicIPConfigsRaw[0]` directly after checking length > 0, confirming single-item behavior.

## Special Handling

### Block Structure

**Structure Type:** Type 3 - Block Structure Skeleton

This is a structure skeleton task that creates the framework for the `public_ip_address` block without implementing individual fields. Child tasks (#78-86) will replace comment placeholders with actual implementations.

### Conditional Inclusion

The skeleton uses a conditional check:
```hcl
ip_config.public_ip_address != null && length(ip_config.public_ip_address) > 0
```

This matches the provider's expand logic:
```go
publicIPConfigsRaw := raw["public_ip_address"].([]interface{})
if len(publicIPConfigsRaw) > 0 && publicIPConfigsRaw[0] != nil {
    // ... expand and assign
}
```

**Rationale:** The `public_ip_address` block is optional. When not provided by the user, the entire `publicIPAddressConfiguration` field is omitted from the API request, allowing Azure to use its defaults.

### Single-Item List Pattern

Although defined as `TypeList`, the schema effectively enforces maxItems = 1 through the expand logic:
```go
publicIPConfigRaw := publicIPConfigsRaw[0].(map[string]interface{})
```

The provider accesses the first (and only) element directly. This is a common Terraform pattern for optional nested blocks that should only appear once.

### Integration with Parent Block

The skeleton is properly nested within the `ip_configuration` block:
- Parent: `for ip_config in nic.ip_configuration`
- Location: Inside the `properties` merge for each ip_config
- Condition: Checks `ip_config.public_ip_address` from the iteration variable

### Placeholder Organization

Comment placeholders are organized to mirror the Azure API structure:
1. **Root level:** `name` (Task #78)
2. **properties object:** Contains most fields (Tasks #79-81, #83-86)
   - `domainNameLabel` (Task #79)
   - `idleTimeoutInMinutes` (Task #80)
   - `publicIPPrefix.id` (Task #81)
   - `publicIPAddressVersion` (Task #83)
   - `ipTags` array (Tasks #84-86)
3. **sku object:** Separate from properties (Task #82)

This organization matches the Azure API schema structure and makes it clear which fields belong to which parent object.

## Deferred Work Completion

Checked `following.md` for any work deferred to Task #77: **None found.**

No validation, logic, or implementation was deferred to this task from earlier tasks.

## Critical Review & Edge Case Analysis

### Null Semantics

**Null meaning:** "Do not configure public IP address for this IP configuration"

When `public_ip_address` is null or empty:
- The entire `publicIPAddressConfiguration` object is omitted
- Azure does not assign a public IP to the VMSS instances on this IP configuration
- This is the correct behavior for private-only network configurations

### Edge Cases

1. **Empty list vs null:**
   - Check: `ip_config.public_ip_address != null && length(ip_config.public_ip_address) > 0`
   - Both null and empty list result in omitting the configuration
   - Provider expand checks `len(publicIPConfigsRaw) > 0`, matching our logic

2. **Null first element:**
   - Provider checks: `publicIPConfigsRaw[0] != nil`
   - Our check: `length(ip_config.public_ip_address) > 0` ensures at least one element exists
   - Terraform's type system prevents null elements in non-null lists with our object type definition

3. **Multiple elements:**
   - Provider accesses only `[0]`, ignoring additional elements
   - Schema is `TypeList` without explicit MaxItems, but effectively single-item
   - Our variables.tf defines it as `optional(list(object({...})))` allowing the pattern
   - First element behavior matches provider exactly

### Idempotency

**Idempotent:** ✅ Yes

- Conditional check is deterministic based on input
- No state-dependent logic
- Order doesn't matter (single-item list)
- Repeated applies with same input produce same output

### Safe References

**Safe:** ✅ Yes

- Check `ip_config.public_ip_address != null` before accessing length
- Check `length(ip_config.public_ip_address) > 0` before creating configuration
- Provider's logic matches: checks length before accessing `[0]`
- No nested access without null checks

### Integration with Parent Blocks

The skeleton is safely integrated:
1. Accessed via `ip_config` iteration variable from parent loop
2. Nested within existing `merge()` calls
3. Returns empty object `{}` when condition is false
4. No interference with sibling fields

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ ForceNew handling (N/A for structure skeleton - child fields will handle)
- ✅ All logic exactly replicated from provider (conditional inclusion matches expand logic)
- ✅ Validations implemented (N/A for structure skeleton - child fields will handle)
- ✅ TODO comments (N/A - no independent ephemeral variables for structure skeleton)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md (N/A - structure skeleton doesn't defer work)
- ✅ Deferred work from following.md (checked - none found)
- ✅ Critical review (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis section included
- ✅ Proof created
- ✅ `track.md` updated to "Pending for check"
- ✅ Self-review: Added ONLY structure skeleton for task #77, no implementation of child fields

## Child Tasks Now Ready for Delegation

The following child tasks are now **ready for delegation** as the parent structure skeleton is complete:

1. **Task #78** - `network_interface.ip_configuration.public_ip_address.name` (Required)
2. **Task #79** - `network_interface.ip_configuration.public_ip_address.domain_name_label` (Optional)
3. **Task #80** - `network_interface.ip_configuration.public_ip_address.idle_timeout_in_minutes` (Optional)
4. **Task #81** - `network_interface.ip_configuration.public_ip_address.public_ip_prefix_id` (Optional, ForceNew)
5. **Task #82** - `network_interface.ip_configuration.public_ip_address.sku_name` (Optional, ForceNew)
6. **Task #83** - `network_interface.ip_configuration.public_ip_address.version` (Optional, ForceNew, Default: "IPv4")
7. **Task #84** - `network_interface.ip_configuration.public_ip_address.ip_tag` (Block, Optional, ForceNew)
8. **Task #85** - `network_interface.ip_configuration.public_ip_address.ip_tag.tag` (Required, ForceNew)
9. **Task #86** - `network_interface.ip_configuration.public_ip_address.ip_tag.type` (Required, ForceNew)

**Dependencies:** All child tasks (78-86) are now unblocked and can be executed in parallel or in any order, as they each replace independent comment placeholders within the structure skeleton.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #77 - network_interface.ip_configuration.public_ip_address

### Validation Results

✅ **Structure Type:** Type 3 - Block Structure Skeleton correctly implemented
✅ **Conditional Logic:** Exactly replicates provider expand logic (`len(publicIPConfigsRaw) > 0 && publicIPConfigsRaw[0] != nil`)
✅ **Placement:** Correctly placed in `local.body` (Create phase, verified with Go code evidence)
✅ **Null Handling:** Safe null check before length access
✅ **Placeholder Organization:** All child tasks (#78-86) properly marked with comments
✅ **Integration Safety:** No interference with sibling fields, returns empty object when false
✅ **Assignment Path:** Correctly traced through all nested struct assignments
✅ **Hidden Fields:** Comprehensive expand function analysis completed (none found)
✅ **Deferred Work Completion:** No deferred work for this task (checked following.md)
✅ **Deferred Work Recording:** N/A for structure skeleton
✅ **Edge Cases:** Null semantics, empty list handling, idempotency all properly analyzed
✅ **Proof Document:** Complete with all required sections and evidence
✅ **Self-Review:** Only structure skeleton added, no child field implementations
✅ **track.md Status:** Correctly set to "Pending for check"

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The conditional inclusion logic matches the provider's expand function line-for-line:

**Provider Logic:**
```go
publicIPConfigsRaw := raw["public_ip_address"].([]interface{})
if len(publicIPConfigsRaw) > 0 && publicIPConfigsRaw[0] != nil {
    publicIPConfigRaw := publicIPConfigsRaw[0].(map[string]interface{})
    publicIPAddressConfig := expandOrchestratedVirtualMachineScaleSetPublicIPAddress(publicIPConfigRaw)
    ipConfiguration.Properties.PublicIPAddressConfiguration = publicIPAddressConfig
}
```

**Shadow Implementation:**
```hcl
ip_config.public_ip_address != null && length(ip_config.public_ip_address) > 0 ? {
  publicIPAddressConfiguration = {
    # placeholders for child tasks
  }
} : {}
```

The structure skeleton creates the correct framework for child tasks (#78-86) to implement individual fields. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
