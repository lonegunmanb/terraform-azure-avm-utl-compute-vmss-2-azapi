# Task #151: sku_profile.vm_sizes

## Summary

Implemented the required argument `vm_sizes` within the `sku_profile` block from azurerm_orchestrated_virtual_machine_scale_set to azapi_resource. This field specifies the VM sizes for the virtual machine scale set when using Mix SKU mode. The field is ForceNew and maps to `properties.skuProfile.vmSizes` in the Azure API.

## Shadow Implementation

```hcl
# migrate_main.tf - locals.body
var.orchestrated_virtual_machine_scale_set_sku_profile != null ? {
  skuProfile = {
    allocationStrategy = var.orchestrated_virtual_machine_scale_set_sku_profile.allocation_strategy
    vmSizes = [
      for vm_size in var.orchestrated_virtual_machine_scale_set_sku_profile.vm_sizes : {
        name = vm_size
      }
    ]
  }
} : {},

# migrate_main.tf - replace_triggers_external_values (already exists from Task #150)
sku_profile_vm_sizes = { value = var.orchestrated_virtual_machine_scale_set_sku_profile != null ? jsonencode(var.orchestrated_virtual_machine_scale_set_sku_profile.vm_sizes) : "" }
```

## Create Phase Verification

Queried `resourceOrchestratedVirtualMachineScaleSetCreate` to identify the phase where vm_sizes is set.

**Provider Source Evidence:**
```go
if v, ok := d.GetOk("sku_profile"); ok {
    props.Properties.SkuProfile = expandOrchestratedVirtualMachineScaleSetSkuProfile(v.([]interface{}))
}

// ... later in Create method ...

if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Classification:** The `vm_sizes` field is part of `sku_profile` which is set in the **Create phase** (before the CreateOrUpdateThenPoll call) → belongs in `local.body`.

**Pattern:** Single-phase creation - all sku_profile fields including vm_sizes are set before the CreateOrUpdateThenPoll call.

## Assignment Path Verification

**Predicted Path:** `properties` → `skuProfile` → `vmSizes`

**Provider Expand Function Evidence:**
```go
func expandOrchestratedVirtualMachineScaleSetSkuProfile(input []interface{}) *virtualmachinescalesets.SkuProfile {
    if len(input) == 0 || input[0] == nil {
        return nil
    }

    v := input[0].(map[string]interface{})
    vmSizesRaw := v["vm_sizes"].(*pluginsdk.Set).List()
    vmSizes := make([]virtualmachinescalesets.SkuProfileVMSize, 0)
    for _, vmSize := range vmSizesRaw {
        vmSizes = append(vmSizes, virtualmachinescalesets.SkuProfileVMSize{
            Name: pointer.To(vmSize.(string)),
        })
    }

    return &virtualmachinescalesets.SkuProfile{
        AllocationStrategy: pointer.To((virtualmachinescalesets.AllocationStrategy)(v["allocation_strategy"].(string))),
        VMSizes:            pointer.To(vmSizes),
    }
}
```

**Assignment Trace:**
1. `vmSizes` is set in returned `SkuProfile` struct
2. In Create method: `props.Properties.SkuProfile = expandOrchestratedVirtualMachineScaleSetSkuProfile(...)`
3. This assigns to `.Properties.SkuProfile` field

**Verified Path:** `properties.skuProfile.vmSizes` ✅ **MATCHES** predicted path

## Provider Schema

**Field Definition (from schema):**
```go
"sku_profile": {
    Type:     pluginsdk.TypeList,
    Optional: true,
    ForceNew: true,
    MaxItems: 1,
    Elem: &pluginsdk.Resource{
        Schema: map[string]*pluginsdk.Schema{
            "allocation_strategy": {
                Type:     pluginsdk.TypeString,
                Required: true,
                ValidateFunc: validation.StringInSlice(
                    virtualmachinescalesets.PossibleValuesForAllocationStrategy(),
                    false,
                ),
            },

            "vm_sizes": {
                Type:     pluginsdk.TypeSet,
                Required: true,
                MinItems: 1,
                Elem: &pluginsdk.Schema{
                    Type:         pluginsdk.TypeString,
                    ValidateFunc: validation.StringIsNotEmpty,
                },
            },
        },
    },
},
```

**Key Properties:**
- **Type:** `TypeSet` (set of strings)
- **Required:** Yes (within sku_profile block)
- **Validation:** `MinItems: 1`, `StringIsNotEmpty` for each item
- **ForceNew:** Yes (inherited from parent block)
- **Description:** Specifies the VM sizes for the virtual machine scale set

## Azure API Schema

**Property Path:** `properties.skuProfile.vmSizes`

**Schema Analysis (from Task #149):**
```
"skuProfile": ObjectWithOptionalAttrs(map[string]Type{
    "allocationStrategy": String,
    "vmSizes": List(ObjectWithOptionalAttrs(map[string]Type{
        "name": String,
        "rank": Number
    }, []string{"name", "rank"}))
}, []string{"allocationStrategy", "vmSizes"})
```

**Key Properties:**
- **Type:** List of objects
- **Object Fields:** `name` (String), `rank` (Number, optional)
- **Required:** No (at API level, but required by provider when sku_profile is set)

**Important Note:** The Azure API schema shows that `vmSizes` objects have both `name` and `rank` fields, but the Terraform provider only exposes and sets the `name` field from user input. The `rank` field is not exposed in the Terraform schema.

## Hidden Fields

**Analysis:** No hidden fields found. The provider's expand function only sets the `Name` field for each VM size object and does NOT set the optional `rank` field.

## Mapping

| Terraform | Azure API | Notes |
|-----------|-----------|-------|
| `vm_sizes` | `vmSizes` | Field name (camelCase) |
| `set(string)` | `array of objects` | Type conversion required |
| Each string item | Object with `name` field | Conversion in locals |

**Conversion Logic:**
- Terraform input: `set(string)` - e.g., `["Standard_D2s_v5", "Standard_D4s_v5"]`
- Shadow output: `list of objects` - e.g., `[{name = "Standard_D2s_v5"}, {name = "Standard_D4s_v5"}]`
- The `for` expression handles the conversion from string set to object list

## Validations

**From Provider Schema:**

1. **Required Field (within parent block):** Enforced by Terraform type system - `vm_sizes = set(string)` is a required field in the parent object type in `variables.tf` (line 1451)

2. **MinItems: 1** - At least one VM size must be specified:
```go
"vm_sizes": {
    Type:     pluginsdk.TypeSet,
    Required: true,
    MinItems: 1,
    // ...
}
```

**Implementation:** Added validation block to `orchestrated_virtual_machine_scale_set_sku_profile` variable in `variables.tf`:
```hcl
validation {
  condition     = var.orchestrated_virtual_machine_scale_set_sku_profile == null || length(var.orchestrated_virtual_machine_scale_set_sku_profile.vm_sizes) > 0
  error_message = "The `vm_sizes` set must contain at least one VM size when `sku_profile` is configured."
}
```

3. **StringIsNotEmpty** - Each VM size string must not be empty:
```go
Elem: &pluginsdk.Schema{
    Type:         pluginsdk.TypeString,
    ValidateFunc: validation.StringIsNotEmpty,
},
```

**Implementation:** Added validation block to `orchestrated_virtual_machine_scale_set_sku_profile` variable in `variables.tf`:
```hcl
validation {
  condition = var.orchestrated_virtual_machine_scale_set_sku_profile == null || alltrue([
    for size in var.orchestrated_virtual_machine_scale_set_sku_profile.vm_sizes : size != null && size != ""
  ])
  error_message = "All VM sizes in `vm_sizes` must be non-empty strings."
}
```

## ForceNew Handling

The entire `sku_profile` block is marked as `ForceNew: true`, meaning any change to `vm_sizes` (or `allocation_strategy`) requires resource replacement.

**Implementation:** ForceNew tracking already implemented in Task #150 - the `sku_profile_vm_sizes` key is already present in `replace_triggers_external_values` (line 172 of migrate_main.tf):

```hcl
replace_triggers_external_values = {
  # ... other fields ...
  sku_profile_allocation_strategy = { value = var.orchestrated_virtual_machine_scale_set_sku_profile != null ? var.orchestrated_virtual_machine_scale_set_sku_profile.allocation_strategy : "" }
  sku_profile_vm_sizes            = { value = var.orchestrated_virtual_machine_scale_set_sku_profile != null ? jsonencode(var.orchestrated_virtual_machine_scale_set_sku_profile.vm_sizes) : "" }
}
```

**Key Points:**
- Both fields (`allocation_strategy` and `vm_sizes`) are tracked together since they're both part of the ForceNew sku_profile block
- When sku_profile is null, both fields return empty string to maintain key presence
- The `vm_sizes` field is jsonencoded since it's a set (to ensure consistent comparison across applies)
- Uses Mode 1 (Direct Value Tracking) with wrapping: `{ value = ... }`

## Deferred Work Completion

Checked `following.md` - no work has been deferred to this task.

## Special Handling

### 1. Type Conversion (set → list of objects)

The Terraform provider accepts `vm_sizes` as a `set(string)` but Azure API expects a list of objects with `name` field. The shadow module handles this conversion:

```hcl
vmSizes = [
  for vm_size in var.orchestrated_virtual_machine_scale_set_sku_profile.vm_sizes : {
    name = vm_size
  }
]
```

### 2. Relationship with sku_name

From Task #17 and Task #149, the `sku_profile` block (including `vm_sizes`) has a tight coupling with `sku_name`:
- When `sku_name = "Mix"`, `sku_profile` is **required** (and thus `vm_sizes` is required)
- When `sku_name != "Mix"`, `sku_profile` must **not** be set

This validation is enforced at the parent block level in `variables.tf` (lines 1438-1444).

### 3. Optional rank Field Not Exposed

The Azure API schema shows that vmSizes objects can have an optional `rank` field, but the Terraform provider does NOT expose this field. The provider only sets the `name` field. This is consistent with the provider's design - users specify simple VM size names, and Azure handles any internal ranking logic.

## Critical Review & Edge Case Analysis

### Null Semantics

- **`sku_profile = null`:** The entire block is not included in the request body (conditional returns `{}`). This is correct - null means "do not configure sku_profile".
- **Field within object:** Since this is a required field within the `sku_profile` object, Terraform's type system ensures it cannot be null when the parent object is provided.

### Boundary Conditions

1. **Empty Set:** The validation `MinItems: 1` ensures the set cannot be empty when sku_profile is provided.
2. **Empty Strings:** The validation `StringIsNotEmpty` ensures no VM size string can be empty.
3. **Set Ordering:** Using a `set` type means the order is not preserved. However, since we iterate with `for`, the order in the final list may vary. This is acceptable because the Azure API treats vmSizes as an unordered collection.

### Idempotency

- **Set vs List:** Terraform uses `set(string)` to ensure uniqueness and ignore order. The shadow module converts to a list, but the order doesn't matter to Azure.
- **ForceNew Tracking:** The jsonencode ensures consistent comparison - set {"A", "B"} will always produce the same JSON regardless of internal ordering.

### Safe References

- **Null check:** The implementation checks `var.orchestrated_virtual_machine_scale_set_sku_profile != null` before accessing the `vm_sizes` field.
- **For loop safety:** The `for` expression safely handles empty sets (though validation prevents this).

### Type Conversion Safety

- **Set to List:** The `for` expression reliably converts set elements to list elements.
- **Object creation:** Each string is wrapped in an object with a `name` field, exactly matching Azure API expectations.

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ ForceNew wrapped: `{ value = jsonencode(var.orchestrated_virtual_machine_scale_set_sku_profile.vm_sizes) }` (already in place from Task #150)
- ✅ All logic EXACTLY replicated from provider (type conversion from set to list of objects)
- ✅ Validations IMPLEMENTED in variables.tf (MinItems: 1, StringIsNotEmpty)
- ✅ Hidden fields checked (none - rank field not exposed by provider)
- ✅ Deferred work: None to this task
- ✅ Critical review completed
- ✅ Edge Case Analysis completed
- ✅ Proof created
- ✅ Ready to update track.md

## Files Modified

1. `variables.tf` - Added validation blocks to `orchestrated_virtual_machine_scale_set_sku_profile` variable
2. `migrate_main.tf` - Replaced comment placeholder with vmSizes implementation using for expression
3. No changes to `migrate_main.tf` ForceNew tracking (already implemented in Task #150)

## Notes

- The conversion from `set(string)` to list of objects is handled inline using a `for` expression
- The Azure API's optional `rank` field is intentionally not set, matching provider behavior
- Task #150 already set up the ForceNew tracking for this field
- Both allocation_strategy (Task #150) and vm_sizes (Task #151) complete the sku_profile block implementation

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #151 - sku_profile.vm_sizes

### Validation Results

✅ **ForceNew Logic:** Direct Value Tracking (Mode 1) - correctly implemented in Task #150 with stable key and jsonencode for set comparison
✅ **Stable Keys:** Key `sku_profile_vm_sizes` is stable in `replace_triggers_external_values`, parent `skuProfile` key is stable in body
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase before CreateOrUpdateThenPoll)
✅ **Type Conversion:** Correct conversion from `set(string)` to `list of objects with name field` using for expression
✅ **Null Handling:** Correctly checks parent object null before accessing vm_sizes field
✅ **Validations:** All provider validations implemented - MinItems: 1 (lines 1465-1467) and StringIsNotEmpty (lines 1470-1474) in variables.tf
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Empty set prevented by validation, empty strings prevented by validation, set ordering handled correctly with jsonencode

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is correctly:
- Converted from set to list of objects matching the provider's expand function
- Validated with MinItems and StringIsNotEmpty constraints
- Tracked for ForceNew using stable keys and jsonencode
- Placed in the Create phase body
- Mapped to the correct Azure API path `properties.skuProfile.vmSizes`

No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
