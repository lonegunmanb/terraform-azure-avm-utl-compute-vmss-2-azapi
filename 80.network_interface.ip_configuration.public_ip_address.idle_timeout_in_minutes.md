# Task #80: network_interface.ip_configuration.public_ip_address.idle_timeout_in_minutes

## Shadow Implementation

```hcl
# In migrate_main.tf - locals.body
ip_config.public_ip_address != null && length(ip_config.public_ip_address) > 0 ? {
  publicIPAddressConfiguration = merge(
    {
      name = ip_config.public_ip_address[0].name
    },
    ip_config.public_ip_address[0].domain_name_label != null && ip_config.public_ip_address[0].domain_name_label != "" ? {
      properties = merge(
        {
          dnsSettings = {
            domainNameLabel = ip_config.public_ip_address[0].domain_name_label
          }
        },
        ip_config.public_ip_address[0].idle_timeout_in_minutes != null && ip_config.public_ip_address[0].idle_timeout_in_minutes > 0 ? {
          idleTimeoutInMinutes = ip_config.public_ip_address[0].idle_timeout_in_minutes
        } : {}
      )
    } : ip_config.public_ip_address[0].idle_timeout_in_minutes != null && ip_config.public_ip_address[0].idle_timeout_in_minutes > 0 ? {
      properties = {
        idleTimeoutInMinutes = ip_config.public_ip_address[0].idle_timeout_in_minutes
      }
    } : {}
  )
} : {}
```

```hcl
# In variables.tf - validation block added
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_network_interface == null ||
    alltrue([
      for nic in var.orchestrated_virtual_machine_scale_set_network_interface : alltrue([
        for ip_config in nic.ip_configuration :
        ip_config.public_ip_address == null || alltrue([
          for pub_ip in ip_config.public_ip_address :
          pub_ip.idle_timeout_in_minutes == null || (pub_ip.idle_timeout_in_minutes >= 4 && pub_ip.idle_timeout_in_minutes <= 32)
        ])
      ])
    ])
  )
  error_message = "The idle_timeout_in_minutes must be between 4 and 32."
}
```

## Summary

Implemented `idle_timeout_in_minutes` for public IP addresses in network interface IP configurations. The field is optional and only included in the API payload when non-null and greater than 0, matching the provider's behavior.

## Create Phase Verification

**Pattern**: Single-phase (CreateOrUpdate)

**Evidence from Create method**:
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    if v, ok := d.GetOk("network_interface"); ok {
        networkInterfaces, err := ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(v.([]interface{}))
        if err != nil {
            return fmt.Errorf("expanding `network_interface`: %w", err)
        }

        networkProfile.NetworkInterfaceConfigurations = networkInterfaces
        virtualMachineProfile.NetworkProfile = networkProfile
    }
    // ...
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    // ...
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Classification**: The field is expanded during the Create phase and included in the single CreateOrUpdate call. No two-phase pattern detected.

**Decision**: Implement in `local.body` (not `post_creation_updates`).

## Assignment Path Verification

**Predicted path**: 
```
properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.publicIPAddressConfiguration.properties.idleTimeoutInMinutes
```

**Go code evidence**:

From `expandOrchestratedVirtualMachineScaleSetPublicIPAddress`:
```go
func expandOrchestratedVirtualMachineScaleSetPublicIPAddress(raw map[string]interface{}) *virtualmachinescalesets.VirtualMachineScaleSetPublicIPAddressConfiguration {
    publicIPAddressConfig := virtualmachinescalesets.VirtualMachineScaleSetPublicIPAddressConfiguration{
        Name: raw["name"].(string),
        Properties: &virtualmachinescalesets.VirtualMachineScaleSetPublicIPAddressConfigurationProperties{
            IPTags: &ipTags,
        },
    }

    if idleTimeout := raw["idle_timeout_in_minutes"].(int); idleTimeout > 0 {
        publicIPAddressConfig.Properties.IdleTimeoutInMinutes = pointer.To(int64(raw["idle_timeout_in_minutes"].(int)))
    }
    // ...
    return &publicIPAddressConfig
}
```

From `expandOrchestratedVirtualMachineScaleSetIPConfiguration`:
```go
func expandOrchestratedVirtualMachineScaleSetIPConfiguration(raw map[string]interface{}) (*virtualmachinescalesets.VirtualMachineScaleSetIPConfiguration, error) {
    ipConfiguration := virtualmachinescalesets.VirtualMachineScaleSetIPConfiguration{
        Name: raw["name"].(string),
        Properties: &virtualmachinescalesets.VirtualMachineScaleSetIPConfigurationProperties{
            // ...
        },
    }

    publicIPConfigsRaw := raw["public_ip_address"].([]interface{})
    if len(publicIPConfigsRaw) > 0 && publicIPConfigsRaw[0] != nil {
        publicIPConfigRaw := publicIPConfigsRaw[0].(map[string]interface{})
        publicIPAddressConfig := expandOrchestratedVirtualMachineScaleSetPublicIPAddress(publicIPConfigRaw)
        ipConfiguration.Properties.PublicIPAddressConfiguration = publicIPAddressConfig
    }

    return &ipConfiguration, nil
}
```

From `ExpandOrchestratedVirtualMachineScaleSetNetworkInterface`:
```go
func ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(input []interface{}) (*[]virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration, error) {
    // ...
    config := virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration{
        Name: raw["name"].(string),
        Properties: &virtualmachinescalesets.VirtualMachineScaleSetNetworkConfigurationProperties{
            IPConfigurations: ipConfigurations,
            // ...
        },
    }
    // ...
    return &output, nil
}
```

From Create method:
```go
networkProfile.NetworkInterfaceConfigurations = networkInterfaces
virtualMachineProfile.NetworkProfile = networkProfile
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Verified path**: 
```
properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.publicIPAddressConfiguration.properties.idleTimeoutInMinutes
```

**Path comparison**: Exact match ✅

## Provider Schema

From `orchestratedVirtualMachineScaleSetPublicIPAddressSchema`:
```go
"idle_timeout_in_minutes": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    Computed:     true,
    ValidateFunc: validation.IntBetween(4, 32),
},
```

**Key attributes**:
- Type: `TypeInt`
- Optional: `true`
- Computed: `true`
- ForceNew: `false` (not specified, defaults to false)
- ValidateFunc: `validation.IntBetween(4, 32)`

## Azure API Schema

The field exists at:
```
properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.publicIPAddressConfiguration.properties.idleTimeoutInMinutes
```

Type: integer (int64 in Go SDK)

## Hidden Fields

None detected. The expand function only sets fields explicitly defined in the Terraform schema.

## Mapping

**Terraform (snake_case)** → **Azure API (camelCase)**:
- `idle_timeout_in_minutes` → `idleTimeoutInMinutes`

## Special Handling

### Validation
Implemented in `variables.tf`:
```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_network_interface == null ||
    alltrue([
      for nic in var.orchestrated_virtual_machine_scale_set_network_interface : alltrue([
        for ip_config in nic.ip_configuration :
        ip_config.public_ip_address == null || alltrue([
          for pub_ip in ip_config.public_ip_address :
          pub_ip.idle_timeout_in_minutes == null || (pub_ip.idle_timeout_in_minutes >= 4 && pub_ip.idle_timeout_in_minutes <= 32)
        ])
      ])
    ])
  )
  error_message = "The idle_timeout_in_minutes must be between 4 and 32."
}
```

Replicates `validation.IntBetween(4, 32)` from provider schema.

### Conditional Logic
The provider only sets the field when the value is greater than 0:
```go
if idleTimeout := raw["idle_timeout_in_minutes"].(int); idleTimeout > 0 {
    publicIPAddressConfig.Properties.IdleTimeoutInMinutes = pointer.To(int64(raw["idle_timeout_in_minutes"].(int)))
}
```

This is replicated in the Shadow Module:
```hcl
ip_config.public_ip_address[0].idle_timeout_in_minutes != null && ip_config.public_ip_address[0].idle_timeout_in_minutes > 0 ? {
  idleTimeoutInMinutes = ip_config.public_ip_address[0].idle_timeout_in_minutes
} : {}
```

### Nested Merge Pattern
Since `idle_timeout_in_minutes` can exist with or without `domain_name_label`, the implementation uses conditional nested merges:
- When `domain_name_label` exists: Use `merge()` to add `idleTimeoutInMinutes` to the existing `properties` block containing `dnsSettings`
- When `domain_name_label` doesn't exist: Create a new `properties` block with only `idleTimeoutInMinutes` if the field is set

This ensures the properties block is only created when at least one field exists.

### ForceNew
NOT a ForceNew field. Updates are allowed in-place.

### Sensitive
NOT a sensitive field.

### Post-Creation Update
NOT required. Field is set in the initial Create call.

## Deferred Work Completion

Checked `following.md` - no work was deferred to Task #80.

## Edge Case Analysis

### Null Semantics
- **null**: Field not set, omitted from API payload. Azure will use its default (typically 4 minutes).
- **0**: Treated as null (not sent to API) due to `> 0` condition in provider expand function. This matches the schema's `Computed: true` behavior - when not explicitly set or set to 0, the API computes the default.
- **Valid range (4-32)**: Explicitly set in API payload.

### Boundary Conditions
- **Minimum (4)**: Valid, explicitly allowed by validation.
- **Maximum (32)**: Valid, explicitly allowed by validation.
- **Below minimum (e.g., 3)**: Rejected by validation at plan time.
- **Above maximum (e.g., 33)**: Rejected by validation at plan time.

### Idempotency
The field is a simple integer value. No ordering concerns. Idempotent by nature.

### Safe References
The implementation safely checks for null and existence:
```hcl
ip_config.public_ip_address != null && length(ip_config.public_ip_address) > 0
```
Then accesses:
```hcl
ip_config.public_ip_address[0].idle_timeout_in_minutes != null && ip_config.public_ip_address[0].idle_timeout_in_minutes > 0
```

This prevents null pointer errors when `public_ip_address` is not configured.

### Nested Conditional Logic
The implementation correctly handles all combinations:
1. No `public_ip_address`: Entire block omitted
2. `public_ip_address` with neither `domain_name_label` nor `idle_timeout_in_minutes`: Only `name` included
3. `public_ip_address` with `domain_name_label` but no `idle_timeout_in_minutes`: `properties.dnsSettings` included
4. `public_ip_address` with `idle_timeout_in_minutes` but no `domain_name_label`: `properties.idleTimeoutInMinutes` included
5. `public_ip_address` with both: `properties` includes both `dnsSettings` and `idleTimeoutInMinutes`

## Checklist

- ✅ Property in correct local (`body`)
- ✅ ForceNew: Not applicable (field is not ForceNew)
- ✅ ALL logic EXACTLY replicated from provider (conditional `> 0` check replicated)
- ✅ Validations IMPLEMENTED in variables.tf (IntBetween(4, 32))
- ✅ TODO comment: Not applicable (not a sensitive field)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md: Not applicable (no work deferred to other tasks)
- ✅ Deferred work from following.md: Checked, none found for Task #80
- ✅ Critical review (null semantics: 0 treated as null; edge cases: boundary validation; idempotent: simple integer; safe refs: null checks)
- ✅ Edge Case Analysis in proof (completed above)
- ✅ Proof created
- ✅ track.md update: Next step
- ✅ Self-Review: Only implemented idle_timeout_in_minutes (Task #80), did not add other public_ip_address fields

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #80 - network_interface.ip_configuration.public_ip_address.idle_timeout_in_minutes

### Validation Results

✅ **ForceNew Logic:** Not a ForceNew field - no special handling required
✅ **Stable Keys:** Not applicable (no replace_triggers_external_values entry)
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Correct - `TypeInt` (Terraform) to `int64` (Azure API)
✅ **Null Handling:** Correctly implements provider's `> 0` conditional logic - values of 0 or null are omitted from API payload
✅ **Validations:** Provider validation `IntBetween(4, 32)` correctly implemented in `variables.tf` with proper nested iteration
✅ **Nested Merge Pattern:** Correctly uses nested merge to avoid overwriting shared `properties` path when both `domain_name_label` and `idle_timeout_in_minutes` exist
✅ **Deferred Work Completion:** No deferred work for this task in `following.md`
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled (null semantics, boundary conditions, safe references)
✅ **Scope Compliance:** Only implemented idle_timeout_in_minutes (Task #80) - did not add fields from other tasks

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:
- The conditional logic (`> 0` check) matches the provider's expand function exactly
- The validation replicates `validation.IntBetween(4, 32)` precisely
- The nested merge pattern correctly handles the shared `properties` path
- No deviations, simplifications, or "safer alternatives" were found

**Status:** APPROVED ✅

---
