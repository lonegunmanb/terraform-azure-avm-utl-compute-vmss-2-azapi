# Task #154: source_image_reference.publisher - Block Argument

## Summary
Implemented `publisher` field within `source_image_reference` block at `properties.virtualMachineProfile.storageProfile.imageReference.publisher`. Field is Required, has ForceNew behavior, and includes validation for non-empty string.

## Shadow Implementation

```hcl
# In variables.tf
variable "orchestrated_virtual_machine_scale_set_source_image_reference" {
  type = object({
    offer     = string
    publisher = string
    sku       = string
    version   = string
  })
  default     = null
  description = <<-EOT
 - `offer` - (Required) Specifies the offer of the image used to create the virtual machines. Changing this forces a new resource to be created.
 - `publisher` - (Required) Specifies the publisher of the image used to create the virtual machines. Changing this forces a new resource to be created.
 - `sku` - (Required) Specifies the SKU of the image used to create the virtual machines.
 - `version` - (Required) Specifies the version of the image used to create the virtual machines.
EOT

  validation {
    condition     = var.orchestrated_virtual_machine_scale_set_source_image_reference == null || (var.orchestrated_virtual_machine_scale_set_source_image_reference.publisher != null && var.orchestrated_virtual_machine_scale_set_source_image_reference.publisher != "")
    error_message = "The `publisher` field in `source_image_reference` must not be empty."
  }
}

# In migrate_main.tf - local.body
var.orchestrated_virtual_machine_scale_set_source_image_reference != null ? {
  imageReference = {
    offer     = var.orchestrated_virtual_machine_scale_set_source_image_reference.offer
    publisher = var.orchestrated_virtual_machine_scale_set_source_image_reference.publisher
    # ... other fields
  }
} : {}

# In migrate_main.tf - local.replace_triggers_external_values
source_image_reference_publisher = { value = var.orchestrated_virtual_machine_scale_set_source_image_reference != null ? var.orchestrated_virtual_machine_scale_set_source_image_reference.publisher : "" }
```

## Create Phase Verification

**Pattern:** Single-phase Create (inherited from parent block Task #152)

**Evidence from Create method:**
```go
sourceImageReferenceRaw := d.Get("source_image_reference").([]interface{})
sourceImageId := d.Get("source_image_id").(string)
if len(sourceImageReferenceRaw) != 0 || sourceImageId != "" {
    sourceImageReference := expandSourceImageReferenceVMSS(sourceImageReferenceRaw, sourceImageId)
    virtualMachineProfile.StorageProfile.ImageReference = sourceImageReference
}
```

**Classification:** Create phase - The field is set directly in `virtualMachineProfile.StorageProfile.ImageReference` before the `CreateOrUpdateThenPoll` call.

**Decision:** Implement in `local.body`, not `post_creation_updates`.

## Assignment Path Verification

**Predicted Path:**
```
properties.virtualMachineProfile.storageProfile.imageReference.publisher
```

**Go Code Evidence:**
```go
func expandSourceImageReferenceVMSS(referenceInput []interface{}, imageId string) *virtualmachinescalesets.ImageReference {
    // ... imageId handling omitted ...
    
    raw := referenceInput[0].(map[string]interface{})
    return &virtualmachinescalesets.ImageReference{
        Publisher: pointer.To(raw["publisher"].(string)),
        Offer:     pointer.To(raw["offer"].(string)),
        Sku:       pointer.To(raw["sku"].(string)),
        Version:   pointer.To(raw["version"].(string)),
    }
}

// In Create method:
if len(sourceImageReferenceRaw) != 0 || sourceImageId != "" {
    sourceImageReference := expandSourceImageReferenceVMSS(sourceImageReferenceRaw, sourceImageId)
    virtualMachineProfile.StorageProfile.ImageReference = sourceImageReference
}

// Finally:
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Traced Assignments:**
1. `raw["publisher"]` → `ImageReference.Publisher`
2. `virtualMachineProfile.StorageProfile.ImageReference = sourceImageReference`
3. `props.Properties.VirtualMachineProfile = &virtualMachineProfile`
4. Final path: `properties.virtualMachineProfile.storageProfile.imageReference.publisher`

**Verified Path:** `properties.virtualMachineProfile.storageProfile.imageReference.publisher`

**Path Comparison:** ✅ MATCH

## Provider Schema

```go
"publisher": {
    Type:         pluginsdk.TypeString,
    Required:     true,
    ForceNew:     true,
    ValidateFunc: validation.StringIsNotEmpty,
},
```

**Key Points:**
- **Type:** String
- **Required:** true
- **ForceNew:** true - Changes to this field require resource replacement
- **Validation:** `validation.StringIsNotEmpty` - Field must not be empty

## Azure API Schema

**Query:** `body.properties.virtualMachineProfile.storageProfile.imageReference.publisher`
**Result:** `String`

**Property Path:** `body.properties.virtualMachineProfile.storageProfile.imageReference.publisher`

## Hidden Fields

**Query:** Checked `expandSourceImageReferenceVMSS` function (Task #152 already verified).

**Result:** ✅ **NO hidden fields** - The expand function directly maps the `publisher` field from Terraform to Azure API with no additional logic, defaults, or transformations.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|----------------------|-------|
| publisher | publisher | Direct 1:1 mapping |

## Special Handling

### 1. Validation

**Provider Validation:**
```go
ValidateFunc: validation.StringIsNotEmpty,
```

**Implementation in variables.tf:**
```hcl
validation {
  condition     = var.orchestrated_virtual_machine_scale_set_source_image_reference == null || (var.orchestrated_virtual_machine_scale_set_source_image_reference.publisher != null && var.orchestrated_virtual_machine_scale_set_source_image_reference.publisher != "")
  error_message = "The `publisher` field in `source_image_reference` must not be empty."
}
```

**Rationale:** The validation ensures the field is not empty when the parent block is present. This exactly replicates the provider's `StringIsNotEmpty` validation.

### 2. ForceNew Behavior

**Schema Analysis:** `ForceNew: true` in provider schema.

**Implementation:**
```hcl
replace_triggers_external_values = {
  source_image_reference_publisher = { value = var.orchestrated_virtual_machine_scale_set_source_image_reference != null ? var.orchestrated_virtual_machine_scale_set_source_image_reference.publisher : "" }
}
```

**Key Stability:** The key `source_image_reference_publisher` is always present. The value changes from empty string to actual value when the parent block is set, ensuring proper ForceNew tracking.

**Mode:** Mode 1 - Direct Value Tracking (wrapping in object with `value` key to maintain stable key).

### 3. Required Field

The field is Required within the parent block. Since the parent block itself is Optional, the validation ensures the field is present and non-empty when the block exists.

## Deferred Work Completion

**Checked `following.md`:** Task #118 deferred hotpatching validation work to multiple tasks including Tasks #152-156 (image reference fields).

**Deferred Validation:** Complex hotpatching validation requiring image reference parsing:
1. When using hotpatch-enabled images: must validate patch_mode, provision_vm_agent, health extension, hotpatching_enabled
2. When NOT using hotpatch-enabled images: hotpatching_enabled must be false

**Status:** This validation requires the complete image reference (publisher, offer, sku, version) to identify hotpatch-enabled images. The validation logic in the provider uses `isValidHotPatchSourceImageReference()` which checks specific combinations of publisher, offer, and sku values.

**Partial Implementation in Task #154:** This task implements only the `publisher` field. The complete hotpatching validation cannot be implemented until ALL four image reference fields are complete (Tasks #153-156). 

**Plan:** Defer completion of hotpatching validation to Task #156 (the last image reference field task), which will have access to all four fields needed for the validation logic.

**Action:** No update to `following.md` status yet - will be updated when Task #156 completes the full validation.

## Critical Review & Edge Cases

### Null Semantics
- **Field Level:** Required field - cannot be null when parent block exists
- **Parent Block Level:** When `source_image_reference` is null, the field is not accessed (no error)
- **Empty String:** Validation prevents empty string via `StringIsNotEmpty` check

### Boundary Conditions
- **Empty String:** Caught by validation - error message displayed
- **Special Characters:** Azure API accepts any non-empty string
- **Case Sensitivity:** Azure image publishers are case-sensitive

### Idempotency
- ✅ Field value is deterministic
- ✅ No order-dependent logic
- ✅ ForceNew tracking ensures proper replacement behavior

### Safe References
- ✅ Parent null check: `var.orchestrated_virtual_machine_scale_set_source_image_reference != null`
- ✅ Field access is safe within conditional blocks
- ✅ ForceNew tracking uses safe access with null coalescing to empty string

### Edge Case Analysis

**Case 1: publisher changes from "MicrosoftWindowsServer" to "Canonical"**
- Result: ForceNew triggered via `replace_triggers_external_values.source_image_reference_publisher`
- Behavior: Resource replacement occurs
- Correct: Matches provider behavior (ForceNew: true)

**Case 2: Parent block added (null → non-null)**
- Result: ForceNew triggered (value changes from "" to actual publisher)
- Behavior: Resource replacement occurs
- Correct: Adding image reference changes fundamental resource definition

**Case 3: Parent block removed (non-null → null)**
- Result: ForceNew triggered (value changes from publisher to "")
- Behavior: Resource replacement occurs  
- Correct: Removing image reference changes fundamental resource definition

**Case 4: Hotpatching image validation**
- Specific image publishers like "MicrosoftWindowsServer" with hotpatch-enabled images require special validation
- Cannot be fully validated until all image reference fields (publisher, offer, sku, version) are available
- Deferred to Task #156 for complete implementation

## Checklist

- ✅ Field added to `local.body` at correct path
- ✅ ForceNew tracking in `replace_triggers_external_values` with stable key
- ✅ Validation implemented in `variables.tf` (StringIsNotEmpty)
- ✅ Create phase verified (single-phase, direct assignment)
- ✅ Assignment path traced and verified
- ✅ No hidden fields (verified in parent Task #152)
- ✅ Deferred work from `following.md` checked (hotpatching validation deferred to Task #156)
- ✅ Critical review completed with edge case analysis
- ✅ Proof document created
- ✅ Self-review: Only `publisher` field implemented, no other fields added
- ✅ Track.md will be updated to "Pending for check"

## Implementation Exactly Matches Provider Behavior

This implementation exactly replicates the provider behavior:
1. ✅ Field is Required - enforced via object type definition
2. ✅ Validation matches provider's `StringIsNotEmpty` check
3. ✅ ForceNew behavior tracked in replace_triggers_external_values
4. ✅ Direct 1:1 mapping to Azure API (no transformations)
5. ✅ No additional logic beyond provider's expand function
6. ✅ Safe null handling with parent block conditional

**No deviations, simplifications, or "safer alternatives" - exact provider replication achieved.**

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #154 - source_image_reference.publisher

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew (schema `ForceNew: true`) correctly implemented with Mode 1 (Direct Value Tracking) using stable key wrapper
✅ **Stable Keys:** Key `source_image_reference_publisher` always present in `replace_triggers_external_values`, uses empty string when parent null
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, line 679)
✅ **Type Conversion:** Direct 1:1 mapping String → String, no conversion needed
✅ **Null Handling:** Safe parent block null check and field access within conditional blocks
✅ **Validations:** Provider's `validation.StringIsNotEmpty` exactly replicated in variables.tf (lines 1503-1506)
✅ **Nested Merge Check:** No duplicate parent keys - storageProfile appears once, imageReference appears once, proper nested structure
✅ **Deferred Work Completion:** Task #118 hotpatching validation appropriately deferred to Task #156 (requires all 4 image reference fields)
✅ **Assignment Path:** Correctly traced to `properties.virtualMachineProfile.storageProfile.imageReference.publisher`
✅ **Edge Cases:** Null semantics, empty string validation, idempotency, and safe references all properly handled
✅ **Scope Compliance:** Only `publisher` field implemented, no other fields added

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is Required within its parent block, has proper ForceNew tracking with stable keys, validation exactly matches provider's StringIsNotEmpty check, uses direct 1:1 mapping to Azure API, and maintains safe null handling. The nested merge structure is correct with no duplicate parent keys. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
