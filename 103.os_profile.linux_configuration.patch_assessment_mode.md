# Task #103: os_profile.linux_configuration.patch_assessment_mode

## Summary

Implemented the `patch_assessment_mode` argument for Linux configuration in the Shadow Module. This field controls the mode of VM Guest Patching for Linux virtual machines, with allowed values "AutomaticByPlatform" and "ImageDefault" (default). The field maps to `patchSettings.assessmentMode` in the Azure API.

## Shadow Implementation

```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_os_profile" {
  type = object({
    linux_configuration = optional(object({
      patch_assessment_mode = optional(string, "ImageDefault") # <-
    }))
  })

  validation { # <-
    condition = var.orchestrated_virtual_machine_scale_set_os_profile == null || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration == null || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_assessment_mode == null || contains(["AutomaticByPlatform", "ImageDefault"], var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_assessment_mode) # <-
    error_message = "The patch_assessment_mode must be either 'AutomaticByPlatform' or 'ImageDefault'." # <-
  } # <-

  validation { # <-
    condition = var.orchestrated_virtual_machine_scale_set_os_profile == null || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration == null || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_assessment_mode != "AutomaticByPlatform" || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent == true # <-
    error_message = "When patch_assessment_mode is set to 'AutomaticByPlatform', provision_vm_agent must be set to true." # <-
  } # <-
}

# migrate_main.tf
locals {
  body = {
    properties = merge(
      var.orchestrated_virtual_machine_scale_set_os_profile != null ? {
        virtualMachineProfile = merge(
          {
            osProfile = merge(
              var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null ? merge( # <-
                { # <-
                  linuxConfiguration = merge( # <-
                    { # <-
                      adminUsername                 = var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.admin_username # <-
                      disablePasswordAuthentication = var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.disable_password_authentication # <-
                    }, # <-
                    { # <-
                      patchSettings = { # <-
                        assessmentMode = var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_assessment_mode # <-
                      } # <-
                    } # <-
                  ) # <-
                } # <-
              ) : {} # <-
            )
          }
        )
      } : {}
    )
  }
}
```

## Create Phase Verification

### Pattern Identification

**Queried Create Method:**

```go
if len(linConfigRaw) > 0 && linConfigRaw[0] != nil {
    osType = virtualmachinescalesets.OperatingSystemTypesLinux
    linConfig := linConfigRaw[0].(map[string]interface{})
    provisionVMAgent := linConfig["provision_vm_agent"].(bool)
    patchAssessmentMode := linConfig["patch_assessment_mode"].(string)
    vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithLinuxConfiguration(linConfig, customData)

    // Validation logic
    if patchAssessmentMode == string(virtualmachinescalesets.LinuxPatchAssessmentModeAutomaticByPlatform) && !provisionVMAgent {
        return fmt.Errorf("when `patch_assessment_mode` is set to `%s`, `provision_vm_agent` must be set to `true`", virtualmachinescalesets.LinuxPatchAssessmentModeAutomaticByPlatform)
    }

    // ... later assignment
    virtualMachineProfile.OsProfile = vmssOsProfile
}

// Final assignment in single phase
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Pattern:** Single-phase creation. The field is set during the Create phase before the `CreateOrUpdateThenPoll` call.

**Classification:** Create phase → Assign to `local.body`

### Decision

The `patch_assessment_mode` field will be added to `local.body` as it's set during the single-phase create operation. No two-phase pattern detected.

## Assignment Path Verification

### Predicted Path

`body.properties.virtualMachineProfile.osProfile.linuxConfiguration.patchSettings.assessmentMode`

### Go Code Evidence

From the expand function `expandOrchestratedVirtualMachineScaleSetOsProfileWithLinuxConfiguration`:

```go
func expandOrchestratedVirtualMachineScaleSetOsProfileWithLinuxConfiguration(input map[string]interface{}, customData string) *virtualmachinescalesets.VirtualMachineScaleSetOSProfile {
    osProfile := virtualmachinescalesets.VirtualMachineScaleSetOSProfile{}
    linConfig := virtualmachinescalesets.LinuxConfiguration{}
    patchSettings := virtualmachinescalesets.LinuxPatchSettings{}

    if len(input) > 0 {
        // ... other fields ...
        
        linConfig.DisablePasswordAuthentication = pointer.To(input["disable_password_authentication"].(bool))
        linConfig.ProvisionVMAgent = pointer.To(input["provision_vm_agent"].(bool))
        
        patchSettings.AssessmentMode = pointer.To(virtualmachinescalesets.LinuxPatchAssessmentMode(input["patch_assessment_mode"].(string)))
        patchSettings.PatchMode = pointer.To(virtualmachinescalesets.LinuxVMGuestPatchMode(input["patch_mode"].(string)))
        linConfig.PatchSettings = &patchSettings
    }

    osProfile.LinuxConfiguration = &linConfig

    return &osProfile
}
```

**Assignment Chain:**
1. `patchSettings.AssessmentMode = pointer.To(virtualmachinescalesets.LinuxPatchAssessmentMode(input["patch_assessment_mode"].(string)))`
2. `linConfig.PatchSettings = &patchSettings`
3. `osProfile.LinuxConfiguration = &linConfig`
4. Return `&osProfile` which becomes `vmssOsProfile`
5. `virtualMachineProfile.OsProfile = vmssOsProfile`
6. `props.Properties.VirtualMachineProfile = &virtualMachineProfile`

### Verified Path

`body.properties.virtualMachineProfile.osProfile.linuxConfiguration.patchSettings.assessmentMode`

### Path Comparison

✅ **MATCH** - Predicted path matches the verified assignment chain from Go source code.

## Provider Schema

From `OrchestratedVirtualMachineScaleSetLinuxConfigurationSchema()`:

```go
"patch_assessment_mode": {
    Type:     pluginsdk.TypeString,
    Optional: true,
    Default:  string(virtualmachinescalesets.LinuxPatchAssessmentModeImageDefault),
    ValidateFunc: validation.StringInSlice([]string{
        string(virtualmachinescalesets.LinuxPatchAssessmentModeAutomaticByPlatform),
        string(virtualmachinescalesets.LinuxPatchAssessmentModeImageDefault),
    }, false),
},
```

**Key Properties:**
- **Type:** String
- **Optional:** Yes
- **Default:** "ImageDefault" (LinuxPatchAssessmentModeImageDefault)
- **ValidateFunc:** StringInSlice with two allowed values:
  - "AutomaticByPlatform" (LinuxPatchAssessmentModeAutomaticByPlatform)
  - "ImageDefault" (LinuxPatchAssessmentModeImageDefault)
- **ForceNew:** No (updates are allowed)

## Azure API Schema

The field maps to `patchSettings.assessmentMode` within the Linux configuration object at:
`properties.virtualMachineProfile.osProfile.linuxConfiguration.patchSettings.assessmentMode`

**Note:** The Azure API schema query failed to resolve this path, which is expected for deeply nested objects. The path is confirmed by the Go source code assignment chain shown above.

## Hidden Fields

None. The `patchSettings` object in the provider only exposes `assessmentMode` and `patchMode`. Other fields like `automaticByPlatformSettings` exist in the Azure API but are NOT exposed by the provider.

From the provider code:
```go
patchSettings.AssessmentMode = pointer.To(virtualmachinescalesets.LinuxPatchAssessmentMode(input["patch_assessment_mode"].(string)))
patchSettings.PatchMode = pointer.To(virtualmachinescalesets.LinuxVMGuestPatchMode(input["patch_mode"].(string)))
linConfig.PatchSettings = &patchSettings
```

Only `assessmentMode` and `patchMode` are set. No other fields in `patchSettings`.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|------------------------|-------|
| patch_assessment_mode | assessmentMode | Nested in patchSettings |

## Special Handling

### 1. Default Value

**Default:** "ImageDefault"

**Implementation:**
- Set in `variables.tf`: `optional(string, "ImageDefault")`
- This matches provider default: `Default: string(virtualmachinescalesets.LinuxPatchAssessmentModeImageDefault)`

### 2. Validation

**Validation 1: Enum Constraint**

From provider schema:
```go
ValidateFunc: validation.StringInSlice([]string{
    string(virtualmachinescalesets.LinuxPatchAssessmentModeAutomaticByPlatform),
    string(virtualmachinescalesets.LinuxPatchAssessmentModeImageDefault),
}, false),
```

**Implementation in `variables.tf`:**
```hcl
validation {
  condition = var.orchestrated_virtual_machine_scale_set_os_profile == null || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration == null || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_assessment_mode == null || contains(["AutomaticByPlatform", "ImageDefault"], var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_assessment_mode)
  error_message = "The patch_assessment_mode must be either 'AutomaticByPlatform' or 'ImageDefault'."
}
```

**Validation 2: Cross-Field Constraint**

From provider Create method:
```go
if patchAssessmentMode == string(virtualmachinescalesets.LinuxPatchAssessmentModeAutomaticByPlatform) && !provisionVMAgent {
    return fmt.Errorf("when `patch_assessment_mode` is set to `%s`, `provision_vm_agent` must be set to `true`", virtualmachinescalesets.LinuxPatchAssessmentModeAutomaticByPlatform)
}
```

**Implementation in `variables.tf`:**
```hcl
validation {
  condition = var.orchestrated_virtual_machine_scale_set_os_profile == null || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration == null || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.patch_assessment_mode != "AutomaticByPlatform" || var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.provision_vm_agent == true
  error_message = "When patch_assessment_mode is set to 'AutomaticByPlatform', provision_vm_agent must be set to true."
}
```

### 3. ForceNew

**Provider Schema:** No `ForceNew: true` flag

**Implementation:** No entry in `replace_triggers_external_values` - field supports in-place updates.

### 4. Sensitive

**Provider Schema:** No `Sensitive: true` flag

**Implementation:** Field placed in `local.body` (not `local.sensitive_body`).

## Deferred Work Completion

Checked `following.md` - no work was deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics

1. **Field not set (null):**
   - Provider applies default: "ImageDefault"
   - Shadow Module: `optional(string, "ImageDefault")` applies same default
   - Result: Semantically identical ✅

2. **Field explicitly set to "ImageDefault":**
   - Identical to default behavior
   - Azure API receives: `assessmentMode: "ImageDefault"`

3. **Field explicitly set to "AutomaticByPlatform":**
   - Requires `provision_vm_agent: true` (validated)
   - Azure API receives: `assessmentMode: "AutomaticByPlatform"`

### Boundary Conditions

1. **Invalid value:**
   - Provider: Validation fails at plan time with `StringInSlice` error
   - Shadow Module: Validation block catches this, matching provider behavior ✅

2. **AutomaticByPlatform without provision_vm_agent:**
   - Provider: Create method returns error
   - Shadow Module: Validation block catches this at plan time (better UX) ✅

3. **Empty string:**
   - Provider: Would fail StringInSlice validation
   - Shadow Module: Validation block would reject (not in allowed list) ✅

### Idempotency

The field is idempotent. Repeated applies with the same value produce no changes. The field is directly mapped without transformations, ensuring consistency.

### Safe References

All references are properly guarded:
- `var.orchestrated_virtual_machine_scale_set_os_profile != null` checked before accessing
- `var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null` checked before accessing
- Direct field access: `linux_configuration.patch_assessment_mode` is safe after parent checks

### Interaction with Other Fields

**Direct Dependency:** `provision_vm_agent` (Task #105)
- When `patch_assessment_mode = "AutomaticByPlatform"`, `provision_vm_agent` must be `true`
- Validation implements this constraint
- Note: Task #105 (provision_vm_agent) is pending, but validation references it correctly

**Related Fields:** `patch_mode` (Task #104)
- Both are siblings within `patchSettings`
- No direct validation dependency between them
- Provider processes them independently

### Structural Considerations

**Merge Strategy:**
The implementation uses nested `merge()` to combine different sections of the Linux configuration:
1. Outer merge: Combines `linuxConfiguration` with other osProfile fields
2. Inner merge: Combines basic fields (`adminUsername`, `disablePasswordAuthentication`) with `patchSettings`

This approach:
- Keeps the structure modular for future tasks
- Avoids key conflicts
- Maintains readability ✅

**patchSettings Object:**
The implementation creates the `patchSettings` object containing `assessmentMode`. Task #104 will add `patchMode` to the same object, completing the structure.

## Checklist

- ✅ Property in correct local: `local.body.properties.virtualMachineProfile.osProfile.linuxConfiguration.patchSettings.assessmentMode`
- ✅ Default value applied: `optional(string, "ImageDefault")` in variables.tf
- ✅ Validations IMPLEMENTED in variables.tf:
  - Enum validation (AutomaticByPlatform or ImageDefault)
  - Cross-field validation (requires provision_vm_agent when AutomaticByPlatform)
- ✅ All logic EXACTLY replicated from provider:
  - Default matches: LinuxPatchAssessmentModeImageDefault
  - Validation matches: StringInSlice check
  - Cross-field constraint matches: provision_vm_agent requirement
- ✅ ForceNew: Not applicable (no ForceNew in schema)
- ✅ Hidden fields checked: None (only assessmentMode and patchMode exposed in patchSettings)
- ✅ Deferred work: None to this task
- ✅ Critical review completed: Null handling, validation, safe references verified
- ✅ Edge Case Analysis: Documented above
- ✅ Proof created: This document
- ✅ track.md will be updated to "Pending for check"
- ✅ Self-Review: Only patch_assessment_mode implemented, no fields from other tasks added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-10
**Task:** #103 - os_profile.linux_configuration.patch_assessment_mode

### Validation Results

✅ **Default Value:** Correctly uses PREFERRED `optional(string, "ImageDefault")` syntax per executor.md line 140. Matches provider default exactly.

✅ **ForceNew Logic:** Not applicable - schema has no ForceNew flag, correctly omitted from replace_triggers_external_values.

✅ **Stable Keys:** Not applicable - no ForceNew logic.

✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, single-phase pattern).

✅ **Type Conversion:** Direct string mapping, no conversion needed.

✅ **Null Handling:** Properly propagates null semantics with safe references and conditional checks.

✅ **Validations:** ALL provider validations implemented in `variables.tf`:
  - Enum validation (lines 953-955): Exact replication of StringInSlice(["AutomaticByPlatform", "ImageDefault"])
  - Cross-field validation (lines 958-960): Exact replication of Create method error condition using Terraform 1.9+ cross-variable validation

✅ **Deferred Work Completion:** Checked `following.md` - no work was deferred to this task.

✅ **Deferred Work Recording:** No deferrals made by this task.

✅ **Nested Merge Structure:** Proper nested merge usage for `linuxConfiguration` (lines 401-416). Single occurrence of parent keys, no shallow merge violations.

✅ **Edge Cases:** Comprehensive analysis provided covering null semantics, boundary conditions (invalid values, empty strings), idempotency, and safe references.

✅ **Assignment Path:** Correctly traced through Go code assignment chain to verify `properties.virtualMachineProfile.osProfile.linuxConfiguration.patchSettings.assessmentMode`.

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The executor:
- Used PREFERRED method for default values (`optional()` syntax)
- Implemented ALL validations in `variables.tf` (not deferred to Azure API)
- Used Terraform 1.9+ cross-variable validation correctly
- Applied proper nested merge structure
- Completed comprehensive edge case analysis

**Status:** APPROVED ✅

---
