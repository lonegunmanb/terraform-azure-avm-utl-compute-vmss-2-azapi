# Task #121: os_profile.windows_configuration.provision_vm_agent

## Summary

Implemented `provision_vm_agent` for Windows configuration with default value `true` and ForceNew behavior. This field indicates whether the Windows VM Agent should be provisioned on the virtual machine.

## Shadow Implementation

**Note:** The implementation shown below has been CORRECTED by the Checker Agent. See "CHECKER VALIDATION" section at the end for details on corrections made.

```hcl
locals {
  replace_triggers_external_values = {
    # ... other fields ...
    windows_configuration_provision_vm_agent = { value = var.orchestrated_virtual_machine_scale_set_os_profile != null && var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent : true } # <-
  }

  body = {
    properties = merge(
      # ... other properties ...
      var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? merge(
        {
          windowsConfiguration = merge(
            # ... other settings ...
            {
              provisionVMAgent = var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent # <-
            },
            # ... other settings ...
          )
        }
      ) : {}
    )
  }
}
```

**Variable Definition (corrected):**
```hcl
# In variables.tf:
windows_configuration = optional(object({
  # ... other fields ...
  provision_vm_agent = optional(bool, true)  # <- Default applied at type level
  # ... other fields ...
}))
```

## Create Phase Verification

**Query Create Method:**
```go
// From resourceOrchestratedVirtualMachineScaleSetCreate
if len(winConfigRaw) > 0 && winConfigRaw[0] != nil {
    osType = virtualmachinescalesets.OperatingSystemTypesWindows
    winConfig := winConfigRaw[0].(map[string]interface{})
    provisionVMAgent := winConfig["provision_vm_agent"].(bool)
    patchAssessmentMode := winConfig["patch_assessment_mode"].(string)
    vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(winConfig, customData)
    
    // Validations involving provisionVMAgent
    if extensionOperationsEnabled && !provisionVMAgent {
        return fmt.Errorf("`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false`")
    }
    
    if patchAssessmentMode == string(virtualmachinescalesets.WindowsPatchAssessmentModeAutomaticByPlatform) && !provisionVMAgent {
        return fmt.Errorf("when `patch_assessment_mode` is set to `%s`, `provision_vm_agent` must be set to `true`", virtualmachinescalesets.WindowsPatchAssessmentModeAutomaticByPlatform)
    }
    // ... more validations related to hotpatching ...
}

// In the expand function
func expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(input map[string]interface{}, customData string) *virtualmachinescalesets.VirtualMachineScaleSetOSProfile {
    winConfig := virtualmachinescalesets.WindowsConfiguration{}
    // ...
    winConfig.ProvisionVMAgent = pointer.To(input["provision_vm_agent"].(bool))
    // ...
    osProfile.WindowsConfiguration = &winConfig
    return &osProfile
}
```

**Pattern Classification:** Single-phase Create
- Field is read and validated in the Create method before the API call
- Field is set via `expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration` which assigns it to `winConfig.ProvisionVMAgent`
- The field is included in the initial `CreateOrUpdateThenPoll` call

**Decision:** Implement in `local.body` (Create phase)

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.osProfile.windowsConfiguration.provisionVMAgent`

**Go Code Evidence:**
```go
// From expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration
func expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(input map[string]interface{}, customData string) *virtualmachinescalesets.VirtualMachineScaleSetOSProfile {
    osProfile := virtualmachinescalesets.VirtualMachineScaleSetOSProfile{}
    winConfig := virtualmachinescalesets.WindowsConfiguration{}
    // ...
    winConfig.ProvisionVMAgent = pointer.To(input["provision_vm_agent"].(bool))
    // ...
    osProfile.WindowsConfiguration = &winConfig
    return &osProfile
}

// In Create method:
vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(winConfig, customData)
virtualMachineProfile.OsProfile = vmssOsProfile
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Assignment Tracing:**
1. `input["provision_vm_agent"]` → `winConfig.ProvisionVMAgent`
2. `winConfig` → `osProfile.WindowsConfiguration`
3. `osProfile` → `virtualMachineProfile.OsProfile`
4. `virtualMachineProfile` → `props.Properties.VirtualMachineProfile`
5. Final path: `properties.virtualMachineProfile.osProfile.windowsConfiguration.provisionVMAgent`

**Verified Path:** `properties.virtualMachineProfile.osProfile.windowsConfiguration.provisionVMAgent`

**Path Comparison:** ✅ Match - Predicted path matches verified path

## Provider Schema

```go
"provision_vm_agent": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  true,
    ForceNew: true,
},
```

**Field Properties:**
- **Type:** Boolean
- **Required:** No (Optional)
- **Default:** `true`
- **ForceNew:** Yes
- **Computed:** No

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

**Property Path:** `body.properties.virtualMachineProfile.osProfile.windowsConfiguration.provisionVMAgent`

**Azure API Documentation:**
> "Indicates whether virtual machine agent should be provisioned on the virtual machine. When this property is not specified in the request body, it is set to true by default. This will ensure that VM Agent is installed on the VM so that extensions can be added to the VM later."

**API Default Behavior:** When not specified, Azure API defaults to `true`

## Hidden Fields

None. The field is directly exposed in the Terraform schema and has a straightforward mapping to the Azure API.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| `provision_vm_agent`   | `provisionVMAgent`   |

## Special Handling

### 1. Default Value Application

**Provider Behavior:**
- Schema specifies `Default: true`
- When user doesn't provide a value, Terraform applies `true`

**Shadow Implementation:**
```hcl
provisionVMAgent = coalesce(
  var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent,
  true
)
```

**Rationale:** Using `coalesce()` to apply the default value of `true` when the field is `null`, matching the provider's default behavior exactly.

### 2. ForceNew Trigger

**Provider Behavior:**
- Field has `ForceNew: true` in schema
- Any change to this field requires resource replacement

**Shadow Implementation:**
```hcl
replace_triggers_external_values = {
  windows_configuration_provision_vm_agent = { 
    value = var.orchestrated_virtual_machine_scale_set_os_profile != null && 
            var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? 
            coalesce(var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent, true) : 
            true 
  }
}
```

**Rationale:** 
- Wrapped in object with `value` key to ensure stable key presence (Mode 1 from executor.md)
- Tracks the actual resolved value including the default
- Ensures replacement is triggered on any value change

### 3. Nested Null Safety

**Implementation Pattern:**
```hcl
var.orchestrated_virtual_machine_scale_set_os_profile != null && 
var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? 
  coalesce(var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent, true) : 
  true
```

**Rationale:** 
- Checks both parent blocks (`os_profile` and `windows_configuration`) exist before accessing the field
- If parent blocks don't exist, returns default value `true`
- Prevents null reference errors

### 4. Cross-Field Validations (Deferred)

**From Create Method:**
```go
if extensionOperationsEnabled && !provisionVMAgent {
    return fmt.Errorf("`extension_operations_enabled` cannot be set to `true` when `provision_vm_agent` is set to `false`")
}

if patchAssessmentMode == string(virtualmachinescalesets.WindowsPatchAssessmentModeAutomaticByPlatform) && !provisionVMAgent {
    return fmt.Errorf("when `patch_assessment_mode` is set to `%s`, `provision_vm_agent` must be set to `true`", virtualmachinescalesets.WindowsPatchAssessmentModeAutomaticByPlatform)
}

// Hotpatching validations
if isHotpatchEnabledImage {
    if !provisionVMAgent {
        return fmt.Errorf("when using a hotpatching enabled image, `provision_vm_agent` must be set to `true`")
    }
}

if patchMode == string(virtualmachinescalesets.WindowsVMGuestPatchModeAutomaticByPlatform) {
    if !provisionVMAgent {
        return fmt.Errorf("when `patch_mode` is set to `%s`, `provision_vm_agent` must be set to `true`", patchMode)
    }
}
```

**Implementation Status:**
These validations involve fields from multiple tasks:
- `extension_operations_enabled` (Task #8)
- `patch_assessment_mode` (Task #119)
- `patch_mode` (Task #120)
- Source image reference (Task #18, #152-156)
- Health extension (Task #43-56)

**Deferred Work:**
All cross-field validations are already tracked in `following.md` row for Task #118 (hotpatching_enabled), which owns the complex validation logic involving these fields. Task #121 (this task) is listed as one of the tasks that the validation is deferred to, but since the validation logic is complex and involves multiple tasks, the actual implementation is being coordinated through Task #118.

## Deferred Work Completion

**From following.md:**
```
| #118 | Multiple (#120, #121, #18, #152-156, #43-56) | Validation | Complex hotpatching validations requiring image reference parsing and cross-field checks. (1) When using hotpatch-enabled images: patch_mode must be AutomaticByPlatform, provision_vm_agent must be true, health extension required, hotpatching_enabled must be true. (2) When NOT using hotpatch-enabled images: hotpatching_enabled must be false. Implementation requires isValidHotPatchSourceImageReference() logic. | Pending |
```

**Status:** This task (#121) is one of the multiple tasks involved in the complex hotpatching validation. The validation requires coordination across multiple fields and image reference parsing logic. Since this validation is complex and involves fields from multiple tasks, it remains tracked in `following.md` for future implementation when all dependent fields are available.

**Note:** This task completes the field implementation for `provision_vm_agent`. The cross-field validation implementation will be coordinated separately as tracked in `following.md`.

## Edge Case Analysis

### 1. Null Value Semantics

**Case:** User provides `null` for `provision_vm_agent`
```hcl
windows_configuration = {
  provision_vm_agent = null
}
```

**Behavior:**
- `coalesce(null, true)` returns `true`
- Field is set to `true` in Azure API
- Matches provider behavior (Default: true)

**Correctness:** ✅ Correct - Provider applies default value when null

### 2. Explicit False Value

**Case:** User explicitly sets `false`
```hcl
windows_configuration = {
  provision_vm_agent = false
}
```

**Behavior:**
- `coalesce(false, true)` returns `false` (first non-null value)
- Field is set to `false` in Azure API
- ForceNew trigger captures value change

**Correctness:** ✅ Correct - Explicit values are preserved

### 3. Parent Block Not Provided

**Case:** User doesn't provide `windows_configuration` block at all
```hcl
os_profile = {
  # No windows_configuration
}
```

**Behavior:**
- Condition `var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null` returns `false`
- Default value `true` is used
- This is a safe fallback, though this block is required when using Windows

**Correctness:** ✅ Correct - Safe fallback to default

### 4. Changing from true to false (ForceNew)

**Case:** User changes value from `true` to `false`

**Behavior:**
- `replace_triggers_external_values` detects value change
- `{ value = true }` → `{ value = false }`
- Resource replacement is triggered

**Correctness:** ✅ Correct - Matches ForceNew behavior

### 5. Changing from false to true (ForceNew)

**Case:** User changes value from `false` to `true`

**Behavior:**
- `replace_triggers_external_values` detects value change
- `{ value = false }` → `{ value = true }`
- Resource replacement is triggered

**Correctness:** ✅ Correct - Matches ForceNew behavior

### 6. Boolean false vs null distinction

**Case:** Terraform distinguishes between `false` and `null`

**Behavior:**
- `coalesce()` function correctly handles this:
  - `coalesce(false, true)` = `false` (false is not null)
  - `coalesce(null, true)` = `true` (null is skipped)
- Type system ensures value is boolean

**Correctness:** ✅ Correct - Proper null vs false handling

### 7. Idempotency

**Case:** Multiple applies with same configuration

**Behavior:**
- Same input → Same resolved value → Same API payload
- No unexpected changes

**Correctness:** ✅ Correct - Idempotent

### 8. Cross-field validation impact

**Case:** User sets `provision_vm_agent = false` but `extension_operations_enabled = true`

**Current Behavior:**
- Field is correctly set to `false`
- Validation is deferred to future implementation (tracked in following.md)

**Future Behavior:**
- Validation will catch this conflict and error

**Correctness:** ✅ Correct - Field implementation is complete, validation is properly tracked as deferred work

## Checklist

- ✅ Property in correct local (`body.properties.virtualMachineProfile.osProfile.windowsConfiguration.provisionVMAgent`)
- ✅ ForceNew wrapped in object: `{ value = ... }`
- ✅ Logic exactly replicated from provider (default value `true`, Boolean type)
- ✅ Validations: Cross-field validations deferred to Task #118 (tracked in following.md)
- ✅ Hidden fields checked: None found
- ✅ Deferred work: Checked following.md - complex validation already tracked under Task #118
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis section added with 8 scenarios
- ✅ Proof created
- ✅ Track.md will be updated to "Pending for check"
- ✅ Self-Review: Only implemented Task #121 field, no content from other tasks added

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #121 - os_profile.windows_configuration.provision_vm_agent

### Issues Identified

#### Issue 1: Default Value Method Priority Violation

**Problem:**
Executor used `optional(bool)` without default in the variable definition, then applied the default using `coalesce()` in locals. This violates executor.md's method priority for default values.

**Executor's Implementation:**
```hcl
# In variables.tf:
provision_vm_agent = optional(bool)

# In migrate_main.tf:
provisionVMAgent = coalesce(var...provision_vm_agent, true)
windows_configuration_provision_vm_agent = { value = ... ? coalesce(...provision_vm_agent, true) : true }
```

**Why This Violates executor.md:**
From executor.md lines 138-141:
> **Defaults:** If schema has `Default`, replicate it:
> - **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
> - **Fallback:** Apply default in locals if optional() syntax not possible

The field is nested inside `windows_configuration` object, which means `optional(bool, true)` syntax IS possible. Executor chose the "Fallback" method (coalesce in locals) when the "PREFER" method (optional with default) was available and technically possible.

**Provider's Actual Behavior:**
```go
"provision_vm_agent": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  true,  // <- Schema defines default value
    ForceNew: true,
},
```

**Expected Behavior:**
- When user provides `null`: Field should be `true` (default applied)
- When user provides `false`: Field should be `false` (explicit value)
- When user provides `true`: Field should be `true` (explicit value)
- Default should be applied at the type level using `optional(bool, true)`, NOT in locals

**Root Cause:**
Executor incorrectly chose the fallback method (coalesce) when the preferred method (optional with default parameter) was technically possible. This is a direct violation of method priority rules in executor.md.

### Corrections Made

#### Fix 1: Use Preferred Method - optional(bool, true)

**Changed Files:**
- `variables.tf`: Changed `provision_vm_agent = optional(bool)` to `provision_vm_agent = optional(bool, true)`
- `migrate_main.tf`: Removed `coalesce()` calls in both `replace_triggers_external_values` and `body` - now directly uses the variable value

**New Implementation:**
```hcl
# In variables.tf (line 921):
provision_vm_agent = optional(bool, true)  # Default applied at type level

# In migrate_main.tf (replace_triggers_external_values):
windows_configuration_provision_vm_agent = { 
  value = var.orchestrated_virtual_machine_scale_set_os_profile != null && 
          var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? 
          var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent : 
          true 
}

# In migrate_main.tf (body):
provisionVMAgent = var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.provision_vm_agent
```

**Why This is EXACT:**
- Matches executor.md's PREFER method for nested fields with defaults
- Default value `true` is applied by Terraform's type system via `optional(bool, true)`
- No manual default application needed in locals (coalesce removed)
- When `windows_configuration` block exists, the field is guaranteed to be non-null (either user value or default)
- When `windows_configuration` block doesn't exist, fallback to `true` is used in replace_triggers

**Verification:**
- Scenario 1: User provides `provision_vm_agent = null` → Type system applies default `true` → Body: `provisionVMAgent = true` ✅
- Scenario 2: User provides `provision_vm_agent = false` → Explicit value preserved → Body: `provisionVMAgent = false` ✅
- Scenario 3: User provides `provision_vm_agent = true` → Explicit value preserved → Body: `provisionVMAgent = true` ✅
- Scenario 4: User omits field entirely → Type system applies default `true` → Body: `provisionVMAgent = true` ✅
- Edge Case: `windows_configuration` doesn't exist → Fallback `true` in replace_triggers → Correct ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The default value is applied using the PREFERRED method (`optional(bool, true)`) instead of the fallback method (coalesce in locals).

**Status:** CORRECTED AND APPROVED ✅

---
