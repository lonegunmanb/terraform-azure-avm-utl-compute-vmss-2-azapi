# Task #117: os_profile.windows_configuration.enable_automatic_updates

## Summary

Implemented the `enable_automatic_updates` field migration from `azurerm_orchestrated_virtual_machine_scale_set` to `azapi_resource`. This boolean field controls whether Automatic Updates are enabled for Windows virtual machines with a default value of `true`. The field maps to `properties.virtualMachineProfile.osProfile.windowsConfiguration.enableAutomaticUpdates` in the Azure API.

## Shadow Implementation

```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_os_profile" {
  # ...
  type = object({
    # ...
    windows_configuration = optional(object({
      # ...
      enable_automatic_updates = optional(bool, true) # <-
      # ...
    }))
  })
}

# migrate_main.tf
locals {
  body = {
    properties = merge(
      # ...
      var.orchestrated_virtual_machine_scale_set_os_profile != null ? {
        virtualMachineProfile = merge(
          {
            osProfile = merge(
              # ...
              var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null ? { # <-
                windowsConfiguration = merge( # <-
                  { # <-
                    enableAutomaticUpdates = var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.enable_automatic_updates # <-
                  }, # <-
                  { # <-
                    # other fields... # <-
                  } # <-
                ) # <-
              } : {} # <-
            )
          }
        )
      } : {}
    )
  }
}
```

## Create Phase Verification

### Pattern Identification

Queried the Create method to understand how `enable_automatic_updates` is processed:

**Pattern:** Single-phase creation

The field is processed during the Create phase through the expand function:

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    osProfileRaw := d.Get("os_profile").([]interface{})

    if len(osProfileRaw) > 0 && osProfileRaw[0] != nil {
        osProfile := osProfileRaw[0].(map[string]interface{})
        winConfigRaw = osProfile["windows_configuration"].([]interface{})
        
        if len(winConfigRaw) > 0 && winConfigRaw[0] != nil {
            osType = virtualmachinescalesets.OperatingSystemTypesWindows
            winConfig := winConfigRaw[0].(map[string]interface{})
            vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(winConfig, customData)
            // ...
        }
        
        virtualMachineProfile.OsProfile = vmssOsProfile
    }
    
    // ...
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Classification:** Create phase → Assign to `local.body`

### Decision

The `enable_automatic_updates` field will be added to `local.body` as it is set during the single-phase create operation before the API call.

## Assignment Path Verification

### Predicted Path

`body.properties.virtualMachineProfile.osProfile.windowsConfiguration.enableAutomaticUpdates`

### Go Code Evidence

From the expand function:

```go
func expandOrchestratedVirtualMachineScaleSetOsProfileWithWindowsConfiguration(input map[string]interface{}, customData string) *virtualmachinescalesets.VirtualMachineScaleSetOSProfile {
    osProfile := virtualmachinescalesets.VirtualMachineScaleSetOSProfile{}
    winConfig := virtualmachinescalesets.WindowsConfiguration{}
    patchSettings := virtualmachinescalesets.PatchSettings{}

    if len(input) > 0 {
        // ... other fields ...
        
        winConfig.EnableAutomaticUpdates = pointer.To(input["enable_automatic_updates"].(bool))
        
        // ... other fields ...
    }

    osProfile.WindowsConfiguration = &winConfig

    return &osProfile
}
```

The assignment chain:
1. `winConfig.EnableAutomaticUpdates` is set from Terraform config
2. `osProfile.WindowsConfiguration = &winConfig`
3. `virtualMachineProfile.OsProfile = vmssOsProfile` (where `vmssOsProfile` is the returned `osProfile`)
4. `props.Properties.VirtualMachineProfile = &virtualMachineProfile`

The complete path: `VirtualMachineScaleSet.Properties.VirtualMachineProfile.OsProfile.WindowsConfiguration.EnableAutomaticUpdates`

### Verified Path

`body.properties.virtualMachineProfile.osProfile.windowsConfiguration.enableAutomaticUpdates`

### Path Comparison

✅ **MATCH** - Predicted path matches the verified assignment chain from Go source code.

## Provider Schema

From the provider schema function:

```go
"enable_automatic_updates": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  true,
},
```

**Key Properties:**
- **Type:** Bool
- **Optional:** Yes
- **Default:** `true`
- **Required:** No
- **ForceNew:** No
- **Sensitive:** No
- **Computed:** No
- **ValidateFunc:** None

## Azure API Schema

**Type:** Bool (optional)

**Description:** "Indicates whether Automatic Updates is enabled for the Windows virtual machine. Default value is true. For virtual machine scale sets, this property can be updated and updates will take effect on OS reprovisioning."

**Path:** `body.properties.virtualMachineProfile.osProfile.windowsConfiguration.enableAutomaticUpdates`

## Hidden Fields

No hidden fields detected for this specific argument.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|---|---|---|
| enable_automatic_updates | enableAutomaticUpdates | Boolean, default: true |

## Special Handling

### Default Value

The field has a default value of `true` in the provider schema. This has been replicated using Terraform's `optional(bool, true)` syntax in the variable definition.

**Implementation:**
- Variable: `enable_automatic_updates = optional(bool, true)`
- Logic: When the user doesn't provide a value, Terraform automatically uses `true`
- Locals: Direct assignment without null check since the optional() default handles it

### No ForceNew

The field does NOT have `ForceNew: true`, meaning changes to this field can be applied via Update without recreating the resource. Therefore, it should NOT be added to `replace_triggers_external_values`.

### No Validation

The field has no custom validation function. It's a simple boolean value.

### API Update Behavior

According to the Azure API documentation, this property "can be updated and updates will take effect on OS reprovisioning." This means:
- The property accepts updates via the Azure API
- Changes take effect when VMs are reprovisioned
- No special handling needed for updates

## Validation

### Category 1 - Value Constraints

No value constraints - simple boolean field with no validation.

### Category 2 - Cross-Field Constraints

No cross-field constraints detected in the schema.

### Category 3 - Custom Logic

No custom validation logic in the provider.

## Critical Review & Edge Cases

### Null Semantics

- **`null` value:** When `enable_automatic_updates` is not set, the optional() default of `true` applies
- **Explicit `true`:** Explicitly enables automatic updates
- **Explicit `false`:** Explicitly disables automatic updates
- **Behavior:** The field always has a value (either user-provided or default `true`)

### Boundary Conditions

1. **Boolean only:** Field accepts only `true` or `false` values
2. **Default application:** When not specified, defaults to `true` via optional() syntax
3. **No null propagation:** Since optional() provides a default, the field is never null

### Idempotency

The implementation is idempotent:
- Same input always produces same output
- Boolean value directly assigned without transformation
- Default value consistently applied when not specified

### Safe References

The reference `var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration.enable_automatic_updates` is safe because:
1. Parent null check: `var.orchestrated_virtual_machine_scale_set_os_profile.windows_configuration != null` guards the entire block
2. Field default: `optional(bool, true)` ensures the field always has a value
3. No nested access after this field

### Edge Case Analysis

**Edge Case 1: Coordination with Patch Mode**

From the Create method, there are validations that involve patch settings when `patch_mode` is set to `AutomaticByPlatform`. However, there is no direct validation between `enable_automatic_updates` and `patch_mode`. The provider allows both to be configured independently.

**Edge Case 2: Default Value Behavior**

The default value of `true` is important because:
- Windows VMs typically want automatic updates enabled by default
- Matches Azure's default behavior
- Users must explicitly set to `false` to disable

**Edge Case 3: OS Reprovisioning Note**

The Azure API documentation states that updates "take effect on OS reprovisioning." This is informational and doesn't affect our implementation - the provider simply passes the value to the API, and Azure handles the reprovisioning logic.

**Edge Case 4: Windows Only**

This field only applies when `windows_configuration` is set. The parent conditional check ensures this field is only included for Windows VMs, not Linux VMs.

## Completion Checklist

- ✅ Property in correct local (`local.body`)
- ✅ Field placed inside windowsConfiguration object (not at osProfile level)
- ✅ ForceNew: Not applicable (field is not ForceNew)
- ✅ Validations: No validations required
- ✅ Default value: Implemented using `optional(bool, true)` in variables.tf
- ✅ Hidden fields: None
- ✅ Critical review completed
- ✅ Edge case analysis included
- ✅ Proof document created
- ✅ `track.md` will be updated
- ✅ Self-Review: Only `enable_automatic_updates` field implemented, no other fields added

## Notes

1. **Default Value:** The default of `true` has been implemented using Terraform's `optional(bool, true)` syntax, which is the preferred method for nested object defaults per executor instructions.

2. **Placement:** This field is placed INSIDE the `windowsConfiguration` object, unlike some other windows_configuration schema fields (like `admin_username`, `admin_password`) which are placed at the parent `osProfile` level.

3. **No Validation:** The field requires no validation - it's a simple boolean with no constraints.

4. **Update Support:** The field supports in-place updates (no ForceNew), so changes don't require resource recreation.

5. **Related Fields:** This field works in coordination with patch settings (`patch_mode`, `patch_assessment_mode`) but has no explicit cross-field validation requirements.

6. **Windows Specific:** This field only exists in Windows configuration and has no Linux equivalent (Linux uses different patch management mechanisms).
