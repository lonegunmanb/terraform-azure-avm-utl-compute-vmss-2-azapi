# Task #89: os_disk.storage_account_type

## Summary

Implemented `storage_account_type` field within the `os_disk` block for orchestrated VMSS. This Required field specifies the storage account type for OS managed disks and is ForceNew (changes require resource replacement). The field maps to `body.properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.storageAccountType` in Azure API.

## Shadow Implementation

```hcl
# migrate_main.tf
locals {
  replace_triggers_external_values = {
    # ... other triggers ...
    os_disk_storage_account_type = { value = var.orchestrated_virtual_machine_scale_set_os_disk != null ? var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type : "" } # <-
  }

  body = {
    properties = merge(
      # ... other properties ...
      var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
        virtualMachineProfile = {
          storageProfile = {
            osDisk = {
              caching = var.orchestrated_virtual_machine_scale_set_os_disk.caching
              managedDisk = { # <-
                storageAccountType = var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type # <-
              } # <-
            }
          }
        }
      } : {}
    )
  }
}
```

```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_os_disk" {
  # ... existing structure ...
  
  validation { # <-
    condition = ( # <-
      var.orchestrated_virtual_machine_scale_set_os_disk == null || # <-
      contains(["Standard_LRS", "Premium_LRS", "StandardSSD_LRS", "Premium_ZRS", "StandardSSD_ZRS"], var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type) # <-
    ) # <-
    error_message = "The storage_account_type must be one of: Standard_LRS, Premium_LRS, StandardSSD_LRS, Premium_ZRS, StandardSSD_ZRS. Note: UltraSSD_LRS and PremiumV2_LRS are not supported for OS Disks." # <-
  } # <-
}
```

## Create Phase Verification

### Query and Pattern Identification

Queried the Create method using `query_terraform_block_implementation_source_code` with `entrypoint_name=create`:

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... setup code ...
    
    if v, ok := d.GetOk("os_disk"); ok {
        virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)
    }
    
    // ... more setup ...
    
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    
    log.Printf("[DEBUG] Creating Orchestrated %s.", id)
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
    // ... rest of method ...
}
```

### Pattern Classification

**Pattern:** Single-phase creation
- Field is set via `ExpandOrchestratedVirtualMachineScaleSetOSDisk` before the `CreateOrUpdateThenPoll` call
- No two-phase pattern (no Update call after Create)

**Phase:** Create phase
- Field is assigned to `virtualMachineProfile.StorageProfile.OsDisk` before create operation
- Placement: `local.body`

## Assignment Path Verification

### Predicted Path
Based on schema analysis:
- Terraform: `os_disk.storage_account_type`
- Azure API: `body.properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.storageAccountType`

### Go Code Evidence

From `ExpandOrchestratedVirtualMachineScaleSetOSDisk`:

```go
func ExpandOrchestratedVirtualMachineScaleSetOSDisk(input []interface{}, osType virtualmachinescalesets.OperatingSystemTypes) *virtualmachinescalesets.VirtualMachineScaleSetOSDisk {
    raw := input[0].(map[string]interface{})
    disk := virtualmachinescalesets.VirtualMachineScaleSetOSDisk{
        Caching: pointer.To(virtualmachinescalesets.CachingTypes(raw["caching"].(string))),
        ManagedDisk: &virtualmachinescalesets.VirtualMachineScaleSetManagedDiskParameters{
            StorageAccountType: pointer.To(virtualmachinescalesets.StorageAccountTypes(raw["storage_account_type"].(string))),
        },
        // ...
    }
    // ...
    return &disk
}
```

Assignment trace in Create method:
1. `d.GetOk("os_disk")` extracts Terraform config
2. `ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)` returns `*virtualmachinescalesets.VirtualMachineScaleSetOSDisk`
3. Assigned to `virtualMachineProfile.StorageProfile.OsDisk`
4. `props.Properties.VirtualMachineProfile = &virtualMachineProfile` adds VirtualMachineProfile to Properties

### Verified Path

Following the struct assignments:
- `raw["storage_account_type"]` → `disk.ManagedDisk.StorageAccountType`
- `disk` (type: `VirtualMachineScaleSetOSDisk`) → `virtualMachineProfile.StorageProfile.OsDisk`
- `virtualMachineProfile` → `props.Properties.VirtualMachineProfile`
- Result: `properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.storageAccountType`

### Path Comparison

✅ **MATCH**: Predicted path matches verified path exactly.

## Provider Schema

From `OrchestratedVirtualMachineScaleSetOSDiskSchema()`:

```go
"storage_account_type": {
    Type:     pluginsdk.TypeString,
    Required: true,
    // whilst this appears in the Update block the API returns this when changing:
    // Changing property 'osDisk.managedDisk.storageAccountType' is not allowed
    ForceNew: true,
    ValidateFunc: validation.StringInSlice([]string{
        // NOTE: OS Disks don't support Ultra SSDs or PremiumV2_LRS
        string(virtualmachinescalesets.StorageAccountTypesPremiumLRS),
        string(virtualmachinescalesets.StorageAccountTypesPremiumZRS),
        string(virtualmachinescalesets.StorageAccountTypesStandardLRS),
        string(virtualmachinescalesets.StorageAccountTypesStandardSSDLRS),
        string(virtualmachinescalesets.StorageAccountTypesStandardSSDZRS),
    }, false),
},
```

**Key Attributes:**
- **Type:** String
- **Required:** Yes
- **ForceNew:** true (with comment explaining API restriction)
- **Validation:** StringInSlice with 5 allowed values (UltraSSD_LRS and PremiumV2_LRS explicitly excluded for OS disks)

## Azure API Schema

Query: `body.properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.storageAccountType`

**Type:** String

**Documentation:** "Specifies the storage account type for the managed disk. NOTE: UltraSSD_LRS can only be used with data disks, it cannot be used with OS Disk. (Possible values: Standard_LRS,Premium_LRS,StandardSSD_LRS,UltraSSD_LRS,Premium_ZRS,StandardSSD_ZRS,PremiumV2_LRS)"

**Azure API Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.storageAccountType`

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| `storage_account_type` | `storageAccountType` |

**Parent Context:**
- Terraform: `os_disk` (block)
- Azure API: `osDisk.managedDisk` (nested object)

## Special Handling

### 1. Validation

Implemented validation in `variables.tf`:

```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_os_disk == null ||
    contains(["Standard_LRS", "Premium_LRS", "StandardSSD_LRS", "Premium_ZRS", "StandardSSD_ZRS"], var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type)
  )
  error_message = "The storage_account_type must be one of: Standard_LRS, Premium_LRS, StandardSSD_LRS, Premium_ZRS, StandardSSD_ZRS. Note: UltraSSD_LRS and PremiumV2_LRS are not supported for OS Disks."
}
```

**Rationale:**
- Provider has explicit StringInSlice validation excluding UltraSSD_LRS and PremiumV2_LRS
- Comment in provider source: "NOTE: OS Disks don't support Ultra SSDs or PremiumV2_LRS"
- Azure API documentation confirms: "NOTE: UltraSSD_LRS can only be used with data disks, it cannot be used with OS Disk"
- Validation replicates exact provider behavior with helpful error message

### 2. ForceNew Trigger

Added to `replace_triggers_external_values`:

```hcl
os_disk_storage_account_type = { value = var.orchestrated_virtual_machine_scale_set_os_disk != null ? var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type : "" }
```

**Rationale:**
- Schema has `ForceNew: true`
- Provider comment states: "Changing property 'osDisk.managedDisk.storageAccountType' is not allowed"
- Uses Mode 1 (Direct Value Tracking) wrapped in object to maintain stable key
- Empty string when os_disk is null maintains key stability

### 3. Nested Structure

Field is nested within `managedDisk` object:

```hcl
managedDisk = {
  storageAccountType = var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type
}
```

**Rationale:**
- Provider creates `ManagedDisk` struct with `StorageAccountType` field
- Azure API expects `osDisk.managedDisk.storageAccountType` path
- Nested structure matches provider's exact mapping

## Deferred Work Completion

Checked `following.md` - no work was deferred to Task #89.

## Critical Review & Edge Case Analysis

### Null Semantics
- **When `os_disk` is null:** Entire `osDisk` block is omitted from body (conditional merge)
- **ForceNew trigger:** Set to empty string when null, maintaining stable key
- **Validation:** Passes when `os_disk` is null (short-circuit OR condition)

### Boundary Conditions
- **Empty string:** Prevented by validation (not in allowed values list)
- **Invalid values:** Caught by validation at plan time
- **Case sensitivity:** Azure API values are case-sensitive; validation uses exact case matching

### Type Safety
- **Required field:** Cannot be null or omitted when `os_disk` block is present
- **Type:** String in both Terraform and Azure API
- **No default:** Field is Required, no default value provided or needed

### Idempotency
- **Simple value:** Direct string assignment, inherently idempotent
- **No ordering concerns:** Single field, not part of collection
- **Stable keys:** ForceNew trigger always present in map (Mode 1 pattern)

### Safe References
- **Null safety:** Protected by parent null check (`os_disk != null`)
- **Nested access:** Direct field access from object, no intermediate null checks needed
- **ForceNew expression:** Uses ternary operator to safely handle null parent

### Special Considerations

1. **OS Disk vs Data Disk Distinction:**
   - OS disks have restricted storage types (no UltraSSD_LRS or PremiumV2_LRS)
   - Data disks (Task #35) allow UltraSSD_LRS with additional constraints
   - Validation explicitly documents this distinction

2. **API Restriction:**
   - Provider comment confirms: "Changing property 'osDisk.managedDisk.storageAccountType' is not allowed"
   - This is an Azure API limitation, not just provider preference
   - ForceNew ensures clean resource replacement rather than failed update

3. **Required Field in Optional Block:**
   - `os_disk` block itself is optional
   - When block is provided, `storage_account_type` is required
   - Validation only checks values when parent block exists

## Checklist

- ✅ Property in correct local (`body.properties.virtualMachineProfile.storageProfile.osDisk.managedDisk`)
- ✅ ForceNew wrapped: `{ value = ... }` (Mode 1 - Direct Value Tracking)
- ✅ ALL logic EXACTLY replicated from provider (validation, ForceNew, nested structure)
- ✅ Validations IMPLEMENTED in variables.tf (StringInSlice with OS disk restrictions)
- ✅ Hidden fields checked (none for this field)
- ✅ Deferred work checked (none to this task)
- ✅ Critical review completed (null safety, idempotency, type safety)
- ✅ Edge Case Analysis documented
- ✅ Proof created
- ✅ Self-Review: Only implemented storage_account_type field, did not add fields from other tasks

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #89 - os_disk.storage_account_type

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew (schema `ForceNew: true`) correctly implemented with Mode 1 (Direct Value Tracking) - wrapped in object with `value` key
✅ **Stable Keys:** Key `os_disk_storage_account_type` always present in `replace_triggers_external_values`, uses empty string when null
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, assigned before CreateOrUpdateThenPoll)
✅ **Type Conversion:** Direct string-to-string mapping, no conversion needed
✅ **Null Handling:** Correctly propagates null semantics via parent os_disk conditional check
✅ **Validations:** Provider's StringInSlice validation EXACTLY replicated in variables.tf with 5 allowed values (excluding UltraSSD_LRS and PremiumV2_LRS for OS disks)
✅ **Assignment Path:** Verified path `body.properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.storageAccountType` matches provider's expand function
✅ **Shared Path Merge:** No violations - storageProfile appears only once, nested merge used correctly for dataDisks/osDisk
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null semantics, required field behavior, type safety, idempotency)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The validation matches the provider's StringInSlice exactly with the same 5 allowed values and explicitly excludes UltraSSD_LRS and PremiumV2_LRS as documented in the provider. The ForceNew trigger uses the correct Mode 1 pattern with stable keys. The nested structure within managedDisk matches the provider's expand function. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
