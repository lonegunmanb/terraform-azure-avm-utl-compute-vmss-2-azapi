# Task #67: network_interface.network_security_group_id

## Shadow Implementation

```hcl
locals {
  body = {
    properties = {
      virtualMachineProfile = {
        networkProfile = {
          networkInterfaceConfigurations = [
            for nic in var.orchestrated_virtual_machine_scale_set_network_interface : {
              properties = merge(
                {
                  enableAcceleratedNetworking = nic.enable_accelerated_networking
                  enableIPForwarding          = nic.enable_ip_forwarding
                },
                nic.network_security_group_id != null && nic.network_security_group_id != "" ? {
                  networkSecurityGroup = {
                    id = nic.network_security_group_id
                  }
                } : {}
              )
            }
          ]
        }
      }
    }
  }
}
```

## Summary

Implemented `network_interface[].network_security_group_id` as a conditionally included property that maps to `networkSecurityGroup.id` in the Azure API. The field is optional and only included in the API payload when provided and non-empty.

## Create Phase Verification

**Query Result:** Create method uses single-phase pattern with `CreateOrUpdateThenPoll`.

**Go Code Evidence:**
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... initialization ...
    
    if v, ok := d.GetOk("network_interface"); ok {
        networkInterfaces, err := ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(v.([]interface{}))
        if err != nil {
            return fmt.Errorf("expanding `network_interface`: %w", err)
        }

        networkProfile.NetworkInterfaceConfigurations = networkInterfaces
        virtualMachineProfile.NetworkProfile = networkProfile
    }
    
    // ... set virtualMachineProfile on props ...
    
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Classification:** Create phase - field is set before the `CreateOrUpdateThenPoll` call.

**Decision:** Implement in `local.body`.

## Assignment Path Verification

**Predicted Path:**
```
local.body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.networkSecurityGroup.id
```

**Go Code Evidence:**

From `ExpandOrchestratedVirtualMachineScaleSetNetworkInterface`:
```go
func ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(input []interface{}) (*[]virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration, error) {
    output := make([]virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration, 0)

    for _, v := range input {
        raw := v.(map[string]interface{})
        // ...
        config := virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration{
            Name: raw["name"].(string),
            Properties: &virtualmachinescalesets.VirtualMachineScaleSetNetworkConfigurationProperties{
                // ... other properties ...
                EnableAcceleratedNetworking: pointer.To(raw["enable_accelerated_networking"].(bool)),
                EnableIPForwarding:          pointer.To(raw["enable_ip_forwarding"].(bool)),
                IPConfigurations:            ipConfigurations,
                Primary:                     pointer.To(raw["primary"].(bool)),
            },
        }

        if nsgId := raw["network_security_group_id"].(string); nsgId != "" {
            config.Properties.NetworkSecurityGroup = &virtualmachinescalesets.SubResource{
                Id: pointer.To(nsgId),
            }
        }

        output = append(output, config)
    }

    return &output, nil
}
```

Struct assignment trace:
1. `config.Properties.NetworkSecurityGroup` is set to `&SubResource{Id: pointer.To(nsgId)}`
2. `config.Properties` points to `VirtualMachineScaleSetNetworkConfigurationProperties`
3. `config` is appended to array of `VirtualMachineScaleSetNetworkConfiguration`
4. Array returned and assigned to `networkProfile.NetworkInterfaceConfigurations`
5. `networkProfile` assigned to `virtualMachineProfile.NetworkProfile`
6. `virtualMachineProfile` assigned to `props.Properties.VirtualMachineProfile`

**Verified Path:**
```
properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.networkSecurityGroup.id
```

**Path Comparison:** ✅ Match

## Provider Schema

From `OrchestratedVirtualMachineScaleSetNetworkInterfaceSchema`:
```go
"network_security_group_id": {
    Type:         pluginsdk.TypeString,
    Optional:     true,
    ValidateFunc: networksecuritygroups.ValidateNetworkSecurityGroupID,
},
```

**Field Properties:**
- Type: String
- Required: No (Optional)
- ForceNew: No (not specified)
- Default: None
- Validation: `networksecuritygroups.ValidateNetworkSecurityGroupID` (Azure Resource ID format)
- Sensitive: No
- Computed: No

## Azure API Schema

**Query:** `body.properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.networkSecurityGroup`

**Schema Result:**
```
ObjectWithOptionalAttrs(map[string]Type{"id":String}, []string{"id"})
```

**Property Type:** Object with optional `id` field (String)

## Hidden Fields

None. The expand function only sets fields explicitly provided by the user. No hidden fields or hardcoded values are added.

## Mapping

| Terraform Field | Azure API Path | Task |
|----------------|----------------|------|
| `network_interface[].network_security_group_id` | `networkInterfaceConfigurations[].properties.networkSecurityGroup.id` | #67 |

**Name Transformation:**
- `network_security_group_id` → `networkSecurityGroup.id`
- Snake case to camelCase
- Note: `id` remains lowercase as it's an Azure API convention

## Special Handling

### 1. Conditional Inclusion

The field uses conditional inclusion logic:
```go
if nsgId := raw["network_security_group_id"].(string); nsgId != "" {
    config.Properties.NetworkSecurityGroup = &virtualmachinescalesets.SubResource{
        Id: pointer.To(nsgId),
    }
}
```

The `networkSecurityGroup` object is **only included** when:
- The value is not `nil`
- The value is not an empty string

This is replicated in the Shadow Module using:
```hcl
nic.network_security_group_id != null && nic.network_security_group_id != "" ? {
  networkSecurityGroup = {
    id = nic.network_security_group_id
  }
} : {}
```

### 2. No ForceNew Behavior

**Schema Analysis:** No `ForceNew: true` in schema definition.

**CustomizeDiff Analysis:** Reviewed resource function - no CustomizeDiff logic for this field.

**Update Method Evidence:**
```go
func resourceOrchestratedVirtualMachineScaleSetUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    if d.HasChange("network_api_version") || d.HasChange("network_interface") {
        if updateProps.VirtualMachineProfile.NetworkProfile == nil {
            updateProps.VirtualMachineProfile.NetworkProfile = &virtualmachinescalesets.VirtualMachineScaleSetUpdateNetworkProfile{}
        }

        updateProps.VirtualMachineProfile.NetworkProfile.NetworkApiVersion = pointer.To(virtualmachinescalesets.NetworkApiVersion(d.Get("network_api_version").(string)))

        networkInterfacesRaw := d.Get("network_interface").([]interface{})
        networkInterfaces, err := ExpandOrchestratedVirtualMachineScaleSetNetworkInterfaceUpdate(networkInterfacesRaw)
        if err != nil {
            return fmt.Errorf("expanding `network_interface`: %w", err)
        }

        updateProps.VirtualMachineProfile.NetworkProfile.NetworkInterfaceConfigurations = networkInterfaces
    }
}
```

The Update expand function `ExpandOrchestratedVirtualMachineScaleSetNetworkInterfaceUpdate` uses identical logic:
```go
if nsgId := raw["network_security_group_id"].(string); nsgId != "" {
    config.Properties.NetworkSecurityGroup = &virtualmachinescalesets.SubResource{
        Id: pointer.To(nsgId),
    }
}
```

**Conclusion:** Field is fully updateable with no ForceNew trigger. Changes are applied via standard update flow.

### 3. Validation

**Provider Validation:**
- `networksecuritygroups.ValidateNetworkSecurityGroupID` - validates Azure Resource ID format

**Shadow Module Decision:** Per executor.md rules, skip Azure Resource ID format validations as these are verified by resource references. The field already exists in `variables.tf` as `optional(string)` with no validation block, which is appropriate.

### 4. Null vs Empty String Semantics

The provider treats both `null` and empty string (`""`) as "not set":
- When `nil` → field not included in API payload
- When `""` → field not included in API payload
- When non-empty string → field included with value

This semantic is preserved in the Shadow Module implementation.

## Edge Case Analysis

**1. Null Handling:**
- `null` → Object not included in merge (empty object returned)
- Provider behavior: `networkSecurityGroup` not set
- ✅ Matches provider

**2. Empty String:**
- `""` → Object not included (condition explicitly checks `!= ""`)
- Provider behavior: `networkSecurityGroup` not set
- ✅ Matches provider

**3. Valid NSG ID:**
- Non-empty string → Object included with `id` field
- Provider behavior: `networkSecurityGroup.id` set
- ✅ Matches provider

**4. Idempotency:**
- Same value on subsequent applies → No change
- Value changes → Update applies new value
- Remove value (set to null) → Removes `networkSecurityGroup` from config
- ✅ Idempotent

**5. Multiple Network Interfaces:**
- Each NIC in the array independently evaluates its own `network_security_group_id`
- Provider behavior: Per-NIC conditional logic
- ✅ Matches provider

## Deferred Work Completion

No `following.md` file exists, indicating no work was deferred to this task.

## Checklist

- ✅ Property in correct local (`body.properties.virtualMachineProfile.networkProfile`)
- ✅ Not ForceNew (no wrapping needed)
- ✅ All logic exactly replicated from provider (conditional inclusion on non-empty)
- ✅ Validations reviewed (skip Resource ID validation per rules)
- ✅ No hidden fields
- ✅ No work deferred to other tasks
- ✅ No deferred work to complete
- ✅ Critical review completed (null/empty semantics, idempotency)
- ✅ Edge Case Analysis section included
- ✅ Proof created
- ✅ Track.md ready for update
- ✅ Self-review: Only implemented Task #67 field, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #67 - network_interface.network_security_group_id

### Validation Results

✅ **ForceNew Logic:** Not applicable (no ForceNew in schema or CustomizeDiff)
✅ **Stable Keys:** Not applicable (field not in replace_triggers_external_values)
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Correct - String to String with proper null handling
✅ **Null Handling:** Correctly handles both null and empty string (both excluded from API payload)
✅ **Validations:** Correctly skipped Azure Resource ID validation per executor.md rules (line 102: "Skip ONLY Azure Resource ID format validations")
✅ **Deferred Work Completion:** No deferred work for this task (no following.md exists)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null, empty string, valid ID, idempotency, multiple NICs)
✅ **Shared Path Merge:** No issues - field is within single merge block per network interface
✅ **Assignment Path:** Correctly traced and verified against provider source code
✅ **Conditional Inclusion:** Exactly matches provider's logic (check both != null && != "")

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The conditional inclusion logic matches the provider's expand function precisely, checking both for null and empty string before including the `networkSecurityGroup` object. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
