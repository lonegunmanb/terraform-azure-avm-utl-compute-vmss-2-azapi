# Task #75: Implement network_interface.ip_configuration.subnet_id

## Summary

Implemented the `subnet_id` field within the `network_interface.ip_configuration` block. This optional field maps to `properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.subnet.id` in the Azure API and is conditionally added only when non-empty.

## Shadow Implementation

```hcl
properties = merge(
  {
    primary = ip_config.primary
  },
  ip_config.subnet_id != null && ip_config.subnet_id != "" ? {  # <-
    subnet = {                                                   # <-
      id = ip_config.subnet_id                                   # <-
    }                                                            # <-
  } : {},                                                        # <-
  {
    # privateIPAddressVersion = ... # Task #76
```

## Create Phase Verification

**Query:** `query_terraform_block_implementation_source_code(block_type="resource", entrypoint_name="create", terraform_type="azurerm_orchestrated_virtual_machine_scale_set")`

**Pattern Identified:** Single-phase creation

**Go Evidence:**
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    if v, ok := d.GetOk("network_interface"); ok {
        networkInterfaces, err := ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(v.([]interface{}))
        if err != nil {
            return fmt.Errorf("expanding `network_interface`: %w", err)
        }

        networkProfile.NetworkInterfaceConfigurations = networkInterfaces
        virtualMachineProfile.NetworkProfile = networkProfile
    }
    // ...
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    
    log.Printf("[DEBUG] Creating Orchestrated %s.", id)
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Classification:** Create phase - field is set before `CreateOrUpdateThenPoll` call

**Decision:** Implemented in `local.body`

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.subnet.id`

**Go Code Evidence:**

From `expandOrchestratedVirtualMachineScaleSetIPConfiguration`:
```go
func expandOrchestratedVirtualMachineScaleSetIPConfiguration(raw map[string]interface{}) (*virtualmachinescalesets.VirtualMachineScaleSetIPConfiguration, error) {
    // ...
    ipConfiguration := virtualmachinescalesets.VirtualMachineScaleSetIPConfiguration{
        Name: raw["name"].(string),
        Properties: &virtualmachinescalesets.VirtualMachineScaleSetIPConfigurationProperties{
            Primary:                               pointer.To(primary),
            PrivateIPAddressVersion:               pointer.To(version),
            ApplicationGatewayBackendAddressPools: applicationGatewayBackendAddressPoolIds,
            ApplicationSecurityGroups:             applicationSecurityGroupIds,
            LoadBalancerBackendAddressPools:       loadBalancerBackendAddressPoolIds,
        },
    }

    if subnetId := raw["subnet_id"].(string); subnetId != "" {
        ipConfiguration.Properties.Subnet = &virtualmachinescalesets.ApiEntityReference{
            Id: pointer.To(subnetId),
        }
    }
    // ...
}
```

From `ExpandOrchestratedVirtualMachineScaleSetNetworkInterface`:
```go
func ExpandOrchestratedVirtualMachineScaleSetNetworkInterface(input []interface{}) (*[]virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration, error) {
    // ...
    for _, v := range input {
        raw := v.(map[string]interface{})
        ipConfigurations := make([]virtualmachinescalesets.VirtualMachineScaleSetIPConfiguration, 0)
        ipConfigurationsRaw := raw["ip_configuration"].([]interface{})
        for _, configV := range ipConfigurationsRaw {
            configRaw := configV.(map[string]interface{})
            ipConfiguration, err := expandOrchestratedVirtualMachineScaleSetIPConfiguration(configRaw)
            if err != nil {
                return nil, err
            }

            ipConfigurations = append(ipConfigurations, *ipConfiguration)
        }

        config := virtualmachinescalesets.VirtualMachineScaleSetNetworkConfiguration{
            Name: raw["name"].(string),
            Properties: &virtualmachinescalesets.VirtualMachineScaleSetNetworkConfigurationProperties{
                // ...
                IPConfigurations:            ipConfigurations,
                // ...
            },
        }
        // ...
    }
}
```

From Create method:
```go
networkProfile.NetworkInterfaceConfigurations = networkInterfaces
virtualMachineProfile.NetworkProfile = networkProfile
// ...
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Verified Path:** `properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.subnet.id`

**Path Comparison:** ✅ Match - The predicted path matches the verified path from Go code

## Provider Schema

From `orchestratedVirtualMachineScaleSetIPConfigurationSchema`:
```go
"subnet_id": {
    Type:         pluginsdk.TypeString,
    Optional:     true,
    ValidateFunc: commonids.ValidateSubnetID,
},
```

**Key Properties:**
- **Type:** String
- **Required:** false (Optional)
- **ForceNew:** false (not specified, so updates allowed)
- **ValidateFunc:** `commonids.ValidateSubnetID` (validates subnet ID format)
- **Default:** none

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

**Property Path:** `properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.subnet`

**Azure API Structure:**
```json
{
  "subnet": {
    "id": "string"
  }
}
```

The subnet field uses `ApiEntityReference` type which has an `id` property containing the subnet resource ID.

## Hidden Fields

No hidden fields detected. The expand function only sets `subnet.id` when the field is provided and not empty.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|----------------------|-------|
| `subnet_id` | `subnet.id` | Nested in `ApiEntityReference` object |

## Special Handling

### Validation

**From Provider Schema:**
```go
ValidateFunc: commonids.ValidateSubnetID,
```

**Decision:** Skip validation - Resource ID format validation is not required per executor.md Category 1 rules. The field references an existing Azure subnet resource, and the validation is handled through Terraform's resource reference mechanism.

### ForceNew

**Schema Check:** No `ForceNew: true` in schema

**CustomizeDiff Check:** No CustomizeDiff logic found for this field

**Decision:** No ForceNew handling required

### Conditional Logic

**Condition:** Field is only set when `subnet_id` is not null and not empty string

**Go Evidence:**
```go
if subnetId := raw["subnet_id"].(string); subnetId != "" {
    ipConfiguration.Properties.Subnet = &virtualmachinescalesets.ApiEntityReference{
        Id: pointer.To(subnetId),
    }
}
```

**Implementation:** Used merge pattern with conditional:
```hcl
ip_config.subnet_id != null && ip_config.subnet_id != "" ? {
  subnet = {
    id = ip_config.subnet_id
  }
} : {}
```

### Nested Structure

The field is nested within the IP configuration properties and requires creating a subnet object with an id property, following the Azure API's `ApiEntityReference` pattern.

## Deferred Work Completion

**Check:** Reviewed `following.md` - No work deferred TO Task #75

## Critical Review & Edge Case

### Null Semantics
- **null:** Subnet not configured for this IP configuration (valid scenario for public IPs without subnet)
- **empty string (""):** Treated as null - subnet object not created
- **valid ID:** Subnet object with id property created

### Boundary Conditions
- Empty string is explicitly checked to prevent creating empty subnet objects
- Field is optional, so null is perfectly valid

### Idempotency
- Conditional merge ensures consistent behavior across applies
- No subnet object created when field is null or empty
- Same input always produces same output

### Safe References
- Null check prevents errors when field is not provided
- Empty string check prevents invalid API calls with empty subnet IDs

### Edge Case Analysis

1. **Null subnet_id:** Valid - IP configuration can exist without subnet (e.g., standalone public IP)
2. **Empty string subnet_id:** Handled correctly - treated as null, no subnet object created
3. **Multiple IP configurations:** Handled correctly - each IP config independently evaluated
4. **Subnet change:** Allowed - no ForceNew, so updates permitted by provider

## Checklist

- ✅ Property in correct local (`body`)
- ✅ Conditional logic exactly matches provider (null and empty string checks)
- ✅ Validations reviewed - Resource ID validation skipped per executor.md rules
- ✅ Hidden fields checked - none found
- ✅ Deferred work checked - none for this task
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis section added
- ✅ Proof document created
- ✅ Self-Review: Only subnet_id field implemented, no content from other tasks added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-09
**Task:** #75 - network_interface.ip_configuration.subnet_id

### Validation Results

✅ **ForceNew Logic:** No ForceNew required (correctly identified from schema and CustomizeDiff analysis)
✅ **Stable Keys:** Conditional merge pattern is correctly implemented for this nested property
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase confirmed by Go evidence)
✅ **Type Conversion:** String to string (no conversion needed)
✅ **Null Handling:** Correctly checks both null and empty string, matching provider behavior exactly
✅ **Validations:** Resource ID validation correctly skipped per executor.md Category 1 rules
✅ **Deferred Work Completion:** No deferred work for this task (following.md checked)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null, empty string, multiple IP configs, subnet changes)
✅ **Assignment Path:** Correctly implements `properties.virtualMachineProfile.networkProfile.networkInterfaceConfigurations[].properties.ipConfigurations[].properties.subnet.id`
✅ **Conditional Logic:** Exact replication of provider's empty string check from Go code
✅ **Nested Structure:** Properly uses ApiEntityReference pattern with `subnet.id` structure

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The conditional logic matches the Go code precisely, checking both null and empty string before creating the subnet object. The nested merge pattern correctly places all IP configuration properties at the same level. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
