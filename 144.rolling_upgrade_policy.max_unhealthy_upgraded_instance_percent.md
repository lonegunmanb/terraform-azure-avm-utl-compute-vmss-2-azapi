# Task #144: rolling_upgrade_policy.max_unhealthy_upgraded_instance_percent

## Summary

Implements the `max_unhealthy_upgraded_instance_percent` argument within the `rolling_upgrade_policy` block, mapping it directly to Azure API's `maxUnhealthyUpgradedInstancePercent` property as a required integer field.

## Shadow Implementation

```hcl
locals {
  body = merge(
    {
      properties = merge(
        var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy != null ? {
          upgradePolicy = {
            rollingUpgradePolicy = {
              maxBatchInstancePercent = var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy.max_batch_instance_percent
              maxUnhealthyInstancePercent = var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy.max_unhealthy_instance_percent
              maxUnhealthyUpgradedInstancePercent = var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy.max_unhealthy_upgraded_instance_percent # <-
            }
          }
        } : {},
      )
    }
  )
}
```

## Create Phase Verification

**Query Create Method:**

From `resourceOrchestratedVirtualMachineScaleSetCreate`:

```go
rollingUpgradePolicy, err := ExpandVirtualMachineScaleSetRollingUpgradePolicy(d.Get("rolling_upgrade_policy").([]interface{}), len(zones) > 0, false)
if err != nil {
    return fmt.Errorf("expanding `rolling_upgrade_policy`: %w", err)
}

props.Properties.UpgradePolicy = &virtualmachinescalesets.UpgradePolicy{
    Mode:                 pointer.To(upgradeMode),
    RollingUpgradePolicy: rollingUpgradePolicy,
}

// ... later ...

if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Orchestrated %s: %w", id, err)
}
```

**Pattern:** Single-phase Create (CreateOrUpdate).

**Classification:** This field is set in the Create phase (before the create call), assigned to `props.Properties.UpgradePolicy.RollingUpgradePolicy` before `CreateOrUpdateThenPoll`.

**Decision:** Implement in `local.body.properties.upgradePolicy.rollingUpgradePolicy`.

## Assignment Path Verification

**Predicted Path:** `body.properties.upgradePolicy.rollingUpgradePolicy.maxUnhealthyUpgradedInstancePercent`

**Go Code Evidence:**

From expand function `ExpandVirtualMachineScaleSetRollingUpgradePolicy`:

```go
func ExpandVirtualMachineScaleSetRollingUpgradePolicy(input []interface{}, isZonal, overProvision bool) (*virtualmachinescalesets.RollingUpgradePolicy, error) {
    if len(input) == 0 {
        return nil, nil
    }

    raw := input[0].(map[string]interface{})

    rollingUpgradePolicy := &virtualmachinescalesets.RollingUpgradePolicy{
        MaxBatchInstancePercent:             pointer.To(int64(raw["max_batch_instance_percent"].(int))),
        MaxUnhealthyInstancePercent:         pointer.To(int64(raw["max_unhealthy_instance_percent"].(int))),
        MaxUnhealthyUpgradedInstancePercent: pointer.To(int64(raw["max_unhealthy_upgraded_instance_percent"].(int))),
        PauseTimeBetweenBatches:             pointer.To(raw["pause_time_between_batches"].(string)),
        PrioritizeUnhealthyInstances:        pointer.To(raw["prioritize_unhealthy_instances_enabled"].(bool)),
        MaxSurge:                            pointer.To(raw["maximum_surge_instances_enabled"].(bool)),
    }
    // ...
    return rollingUpgradePolicy, nil
}
```

From Create method:

```go
props.Properties.UpgradePolicy = &virtualmachinescalesets.UpgradePolicy{
    Mode:                 pointer.To(upgradeMode),
    RollingUpgradePolicy: rollingUpgradePolicy,  // Expanded from above
}
```

**Trace:**
1. Field retrieved: `raw["max_unhealthy_upgraded_instance_percent"]`
2. Assigned to: `rollingUpgradePolicy.MaxUnhealthyUpgradedInstancePercent`
3. Assigned to: `props.Properties.UpgradePolicy.RollingUpgradePolicy`

**Verified Path:** `properties.upgradePolicy.rollingUpgradePolicy.maxUnhealthyUpgradedInstancePercent`

**Path Comparison:** Match ✅

## Provider Schema

From `VirtualMachineScaleSetRollingUpgradePolicySchema`:

```go
"max_unhealthy_upgraded_instance_percent": {
    Type:     pluginsdk.TypeInt,
    Required: true,
},
```

**Schema Properties:**
- **Type:** `TypeInt`
- **Required:** `true`
- **Optional:** Not applicable (Required)
- **ForceNew:** The parent block `rolling_upgrade_policy` has `ForceNew: true`
- **Default:** None
- **Validation:** None in schema
- **DiffSuppressFunc:** None

## Azure API Schema

**API Path:** `body.properties.upgradePolicy.rollingUpgradePolicy.maxUnhealthyUpgradedInstancePercent`

**Type:** `Number`

**From API schema query:**
```
"maxUnhealthyUpgradedInstancePercent":Number
```

The field is part of the `rollingUpgradePolicy` object which is optional within `upgradePolicy`.

## Hidden Fields

None. The expand function shows all fields are sourced from Terraform configuration.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| `max_unhealthy_upgraded_instance_percent` | `maxUnhealthyUpgradedInstancePercent` |

## Special Handling

### 1. Required Field

The field is `Required: true` in the provider schema. Since it's within an optional parent block (`rolling_upgrade_policy`), it's only required when the parent block is specified. The variable correctly defines it as a required field (not `optional()`).

### 2. ForceNew - Parent Block Level

The parent block `rolling_upgrade_policy` has `ForceNew: true`, meaning changes to any field within the block trigger resource replacement. This is already handled at Task #141 (rolling_upgrade_policy block skeleton) in the `replace_triggers_external_values`:

```hcl
rolling_upgrade_policy = { value = var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy != null ? jsonencode(var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy) : "" }
```

No additional ForceNew handling required for this individual field.

### 3. Type Conversion

The provider schema defines this as `TypeInt`, and the expand function casts it to `int64`. The Azure API expects `Number`. This is straightforward - HCL numbers map directly to JSON numbers.

### 4. No Validations

The provider schema has no validation functions for this field. While numeric constraints would be logical (0-100 as a percentage), the provider doesn't enforce them, so we don't add them either per exact replication rule.

## Deferred Work Completion

Checked `following.md` - no work was deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics

**Parent Block Null:** When `var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy` is `null`, the entire `upgradePolicy.rollingUpgradePolicy` object is not included in the body (conditional merge).

**Field Required:** Since this is a required field within the parent object, it MUST be present when the parent block is specified. The variable definition enforces this correctly with `number` (not `optional(number)`).

### Boundary Conditions

**Type:** Integer (int64 in Go, Number in API)

**Expected Range:** Logically 0-100 (percentage), but provider doesn't validate. We replicate exact provider behavior.

**Edge Values:**
- `0`: Valid - no unhealthy upgraded instances allowed
- `100`: Valid - all upgraded instances can be unhealthy
- Negative values: Not validated by provider
- Values > 100: Not validated by provider

Provider behavior is to pass values as-is to Azure API, which will validate and potentially reject invalid values. We replicate this exact behavior.

### Idempotency

Direct integer assignment - idempotent by nature. Same input value always produces same output.

### Safe References

The field access is safe:
```hcl
var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy.max_unhealthy_upgraded_instance_percent
```

Protected by parent null check:
```hcl
var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy != null ? { ... } : {}
```

### Parent Block Conditional Logic

The parent block is conditional on `upgrade_mode == "Rolling"`. This validation is already implemented in `variables.tf` (line 1391-1398):

```hcl
validation {
  condition = (
    (var.orchestrated_virtual_machine_scale_set_upgrade_mode == null || var.orchestrated_virtual_machine_scale_set_upgrade_mode == "Manual") && var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy == null ||
    var.orchestrated_virtual_machine_scale_set_upgrade_mode == "Rolling" && var.orchestrated_virtual_machine_scale_set_rolling_upgrade_policy != null ||
    var.orchestrated_virtual_machine_scale_set_upgrade_mode == "Automatic"
  )
  error_message = "rolling_upgrade_policy cannot be specified when upgrade_mode is 'Manual' (or null/default) and is required when upgrade_mode is 'Rolling'."
}
```

This ensures the field is only used when appropriate, matching provider behavior exactly.

## Checklist

- ✅ Property in correct local: `body.properties.upgradePolicy.rollingUpgradePolicy.maxUnhealthyUpgradedInstancePercent`
- ✅ ForceNew handled: Parent block ForceNew (Task #141) covers all fields
- ✅ All logic exactly replicated: Direct integer mapping, no transformations
- ✅ Validations implemented: None required (provider has none)
- ✅ Hidden fields checked: None found
- ✅ Deferred work recorded: None to defer
- ✅ Deferred work completed: None was deferred to this task
- ✅ Critical review completed: Null handling, boundary conditions, safe references analyzed
- ✅ Edge Case Analysis: Documented above
- ✅ Self-Review: Only added `maxUnhealthyUpgradedInstancePercent` field, no other modifications

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-11
**Task:** #144 - rolling_upgrade_policy.max_unhealthy_upgraded_instance_percent

### Validation Results

✅ **ForceNew Logic:** Parent block ForceNew (Task #141) correctly handles this field via jsonencode of entire rolling_upgrade_policy object in replace_triggers_external_values with stable key
✅ **Stable Keys:** Key `rolling_upgrade_policy` in replace_triggers_external_values is stable (always present, empty string when null)
✅ **Phase Detection:** Field correctly placed in local.body (Create phase, set before CreateOrUpdateThenPoll)
✅ **Type Conversion:** Correct direct mapping from TypeInt (provider) → int64 (Go) → Number (API)
✅ **Null Handling:** Correctly propagates null semantics - field only exists when parent block is non-null
✅ **Validations:** None required (provider has no validations for this field) - exact replication confirmed
✅ **Deferred Work Completion:** No deferred work for this task (following.md checked)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null semantics, boundary conditions, safe references)
✅ **Variable Definition:** Correctly defined as required `number` field (not optional) in object type at variables.tf:1375
✅ **Assignment Path:** Verified path matches: body.properties.upgradePolicy.rollingUpgradePolicy.maxUnhealthyUpgradedInstancePercent
✅ **Merge Structure:** No shared path issues - upgradePolicy appears only once in merge
✅ **Proof Document:** Contains all required sections with Go code evidence, no forbidden phrases

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is a simple required integer within the rolling_upgrade_policy block, with ForceNew handled at the parent block level. Direct value mapping with no transformations or validations matches the provider's implementation precisely. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
