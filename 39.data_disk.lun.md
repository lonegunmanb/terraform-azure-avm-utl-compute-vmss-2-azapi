# Task #39 - data_disk.lun - Completed

## Summary

Implemented the `data_disk.lun` field which specifies the Logical Unit Number of the data disk. The provider treats lun as optional/computed with a condition checking if the value is >= 0. When lun is null or not specified, it defaults to 0, making the field effectively always assigned in the API request.

## Shadow Implementation

```hcl
locals {
  body = merge(
    {
      properties = merge(
        var.orchestrated_virtual_machine_scale_set_sku_name != null ? {
          virtualMachineProfile = merge(
            var.orchestrated_virtual_machine_scale_set_data_disk != null || var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
              storageProfile = merge(
                var.orchestrated_virtual_machine_scale_set_data_disk != null ? {
                  dataDisks = [
                    for data_disk in var.orchestrated_virtual_machine_scale_set_data_disk : {
                      caching = data_disk.caching
                      managedDisk = merge(
                        {
                          storageAccountType = data_disk.storage_account_type
                        },
                        data_disk.disk_encryption_set_id != null && data_disk.disk_encryption_set_id != "" ? {
                          diskEncryptionSet = {
                            id = data_disk.disk_encryption_set_id
                          }
                        } : {}
                      )
                      createOption = data_disk.create_option
                      diskSizeGB   = data_disk.disk_size_gb != null && data_disk.disk_size_gb > 0 ? data_disk.disk_size_gb : null
                      lun          = data_disk.lun != null ? data_disk.lun : 0  # <-
                      diskIOPSReadWrite = data_disk.ultra_ssd_disk_iops_read_write != null && data_disk.ultra_ssd_disk_iops_read_write > 0 ? data_disk.ultra_ssd_disk_iops_read_write : null
                      diskMBpsReadWrite = data_disk.ultra_ssd_disk_mbps_read_write != null && data_disk.ultra_ssd_disk_mbps_read_write > 0 ? data_disk.ultra_ssd_disk_mbps_read_write : null
                    }
                  ]
                } : {}
              )
            } : {}
          )
        } : {}
      )
    }
  )
}
```

```hcl
variable "orchestrated_virtual_machine_scale_set_data_disk" {
  type = list(object({
    caching                        = string
    create_option                  = optional(string, "Empty")
    disk_encryption_set_id         = optional(string)
    disk_size_gb                   = optional(number)
    lun                            = optional(number)  # <-
    storage_account_type           = string
    ultra_ssd_disk_iops_read_write = optional(number)
    ultra_ssd_disk_mbps_read_write = optional(number)
    write_accelerator_enabled      = optional(bool)
  }))
  default     = null
  description = <<-EOT
 - `caching` - (Required) The type of Caching which should be used for this Data Disk. Possible values are None, ReadOnly and ReadWrite.
 - `create_option` - (Optional) The create option which should be used for this Data Disk. Possible values are Empty and FromImage. Defaults to `Empty`. (FromImage should only be used if the source image includes data disks).
 - `disk_encryption_set_id` - (Optional) The ID of the Disk Encryption Set which should be used to encrypt the Data Disk. Changing this forces a new resource to be created.
 - `disk_size_gb` - (Optional) The size of the Data Disk which should be created. Required if `create_option` is specified as `Empty`.
 - `lun` - (Optional) The Logical Unit Number of the Data Disk, which must be unique within the Virtual Machine. Required if `create_option` is specified as `Empty`.  # <-
 - `storage_account_type` - (Required) The Type of Storage Account which should back this Data Disk. Possible values include `Standard_LRS`, `StandardSSD_LRS`, `StandardSSD_ZRS`, `Premium_LRS`, `PremiumV2_LRS`, `Premium_ZRS` and `UltraSSD_LRS`.
 - `ultra_ssd_disk_iops_read_write` - (Optional) Specifies the Read-Write IOPS for this Data Disk. Only settable when `storage_account_type` is `PremiumV2_LRS` or `UltraSSD_LRS`.
 - `ultra_ssd_disk_mbps_read_write` - (Optional) Specifies the bandwidth in MB per second for this Data Disk. Only settable when `storage_account_type` is `PremiumV2_LRS` or `UltraSSD_LRS`.
 - `write_accelerator_enabled` - (Optional) Specifies if Write Accelerator is enabled on the Data Disk. Defaults to `false`.
EOT

  validation {  # <-
    condition = (  # <-
      var.orchestrated_virtual_machine_scale_set_data_disk == null ||  # <-
      alltrue([  # <-
        for disk in var.orchestrated_virtual_machine_scale_set_data_disk :  # <-
        disk.lun == null || (disk.lun >= 0 && disk.lun <= 2000)  # <-
      ])  # <-
    )  # <-
    error_message = "The lun must be between 0 and 2000."  # <-
  }  # <-
}
```

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Create Method Pattern:** Single-phase Create

The Create method follows a single-phase pattern with `CreateOrUpdateThenPoll`:

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	if v, ok := d.GetOk("data_disk"); ok {
		ultraSSDEnabled := d.Get("additional_capabilities.0.ultra_ssd_enabled").(bool)
		dataDisks, err := ExpandOrchestratedVirtualMachineScaleSetDataDisk(v.([]interface{}), ultraSSDEnabled)
		if err != nil {
			return fmt.Errorf("expanding `data_disk`: %w", err)
		}
		virtualMachineProfile.StorageProfile.DataDisks = dataDisks
	}
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Orchestrated %s: %w", id, err)
	}
}
```

**Classification:** Create phase - the lun field is assigned to `virtualMachineProfile.StorageProfile.DataDisks` before the `CreateOrUpdateThenPoll` call.

**Decision:** Field belongs in `local.body` (not `local.post_creation_updates`).

## Assignment Path Verification

**Predicted Path:** `body.properties.virtualMachineProfile.storageProfile.dataDisks[].lun`

**Go Code Evidence:**

From the expand function:
```go
func ExpandOrchestratedVirtualMachineScaleSetDataDisk(input []interface{}, ultraSSDEnabled bool) (*[]virtualmachinescalesets.VirtualMachineScaleSetDataDisk, error) {
	disks := make([]virtualmachinescalesets.VirtualMachineScaleSetDataDisk, 0)

	for _, v := range input {
		raw := v.(map[string]interface{})
		// ...
		disk := virtualmachinescalesets.VirtualMachineScaleSetDataDisk{
			// ...
		}
		// ...
		if lun := raw["lun"].(int); lun >= 0 {
			disk.Lun = int64(lun)
		}
		// ...
		disks = append(disks, disk)
	}

	return &disks, nil
}
```

From the Create method:
```go
virtualMachineProfile.StorageProfile.DataDisks = dataDisks
// ...
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Struct Assignment Chain:**
1. `disk.Lun = int64(lun)` - Direct assignment to VirtualMachineScaleSetDataDisk struct
2. `virtualMachineProfile.StorageProfile.DataDisks = dataDisks` - Assigned to StorageProfile
3. `props.Properties.VirtualMachineProfile = &virtualMachineProfile` - Assigned to Properties

**Verified Path:** `properties.virtualMachineProfile.storageProfile.dataDisks[].lun`

**Path Comparison:** ✅ Match - predicted path matches verified path from provider code.

## Provider Schema

**Source:** `OrchestratedVirtualMachineScaleSetDataDiskSchema` function

```go
"lun": {
	Type:         pluginsdk.TypeInt,
	Optional:     true,
	Computed:     true,
	ValidateFunc: validation.IntBetween(0, 2000), // TODO: confirm upper bounds
},
```

**Schema Properties:**
- **Type:** Int
- **Optional:** true
- **Computed:** true
- **Required:** false
- **ForceNew:** false (not specified)
- **Validation:** IntBetween(0, 2000)

## Azure API Schema

**Query Result:** Successfully queried Azure API documentation.

**API Property:** `properties.virtualMachineProfile.storageProfile.dataDisks[].lun`

**Type:** integer (int64 in Go SDK)

## Hidden Fields

None. The lun field is explicitly defined in the provider schema with no hidden transformations or hardcoded values.

## Mapping

**Terraform (snake_case):** `lun`  
**Azure API (camelCase):** `lun`  

No transformation needed - both use the same name (lun is an acronym for Logical Unit Number).

## Special Handling

### 1. Validation (IMPLEMENTED)

Added validation block in `variables.tf`:

```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_data_disk == null ||
    alltrue([
      for disk in var.orchestrated_virtual_machine_scale_set_data_disk :
      disk.lun == null || (disk.lun >= 0 && disk.lun <= 2000)
    ])
  )
  error_message = "The lun must be between 0 and 2000."
}
```

This replicates the provider's `IntBetween(0, 2000)` validation.

### 2. Default Value Handling

**Provider Logic:**
```go
if lun := raw["lun"].(int); lun >= 0 {
	disk.Lun = int64(lun)
}
```

**Key Observation:** The provider checks `lun >= 0`, meaning:
- When lun is null/unset in Terraform, it defaults to 0 (int default)
- The condition `lun >= 0` is true for value 0
- Therefore, lun is ALWAYS assigned in practice (0 is a valid LUN value)

**Shadow Module Implementation:**
```hcl
lun = data_disk.lun != null ? data_disk.lun : 0
```

This replicates the provider's behavior where:
- If lun is explicitly set, use that value
- If lun is null, default to 0
- The result is lun is always present in the API payload

### 3. No ForceNew

The field does NOT have `ForceNew: true` in the schema, so changes to lun do not require resource replacement. No entry needed in `replace_triggers_external_values`.

### 4. Not Sensitive

The lun field is not marked as Sensitive and does not contain sensitive data. It remains in `local.body`.

## Deferred Work Completion

Checked `following.md` - file does not exist, indicating no work was deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics
- **Null meaning:** When lun is null, it defaults to 0 (the first LUN)
- **Provider behavior:** The condition `lun >= 0` means the field is always assigned
- **Shadow module behavior:** Replicates this with `data_disk.lun != null ? data_disk.lun : 0`

### Boundary Conditions
- **Minimum:** 0 (valid LUN value)
- **Maximum:** 2000 (provider validation upper bound)
- **Zero handling:** 0 is explicitly valid and commonly used as the first LUN

### Edge Cases
1. **Multiple data disks with duplicate LUNs:**
   - Provider does NOT validate uniqueness in schema
   - Azure API will reject duplicate LUNs at deployment time
   - This is acceptable - let Azure API handle uniqueness validation

2. **LUN gaps:**
   - LUNs do not need to be sequential (e.g., 0, 1, 5, 10 is valid)
   - No validation needed in shadow module

3. **Create option interaction:**
   - Documentation states "Required if create_option is Empty"
   - However, provider schema marks it as Optional/Computed with default 0
   - The default value 0 satisfies the "required when Empty" condition
   - Shadow module correctly defaults to 0, making it effectively required

### Idempotency
- The implementation is idempotent: same input produces same output
- No order-dependent operations
- Direct value assignment with deterministic default

### Safe References
- Null-safe: checks `data_disk.lun != null` before using the value
- Always provides a valid default value (0)
- No nested access requiring null checks

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ ForceNew: N/A (field does not have ForceNew)
- ✅ Logic exactly replicated from provider (condition `lun >= 0` replicated with default to 0)
- ✅ Validation IMPLEMENTED in variables.tf (IntBetween(0, 2000))
- ✅ Hidden fields checked (none)
- ✅ Deferred work checked (no following.md file exists)
- ✅ Critical review completed (null semantics, boundary conditions, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis section added
- ✅ Proof document created
- ✅ track.md ready for update to "Pending for check"
- ✅ Self-Review: Only implemented data_disk.lun field as required by Task #39

## Implementation Verification

The implementation:
1. ✅ Adds lun field to the data_disk object in `local.body`
2. ✅ Uses conditional with default: `data_disk.lun != null ? data_disk.lun : 0`
3. ✅ Replaces the comment placeholder `# lun = ... # Task #39`
4. ✅ Adds validation block in `variables.tf` for IntBetween(0, 2000)
5. ✅ Matches exact provider behavior with default to 0

This implementation exactly replicates the provider's behavior where lun is optional but defaults to 0, making it effectively always present in the API request.

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-08
**Task:** #39 - data_disk.lun

### Issues Identified

#### Issue 1: Violation of Method Priority for Default Values

**Problem:**
Executor used fallback method (applying default in locals with coalesce) when the PREFERRED method (`optional()` modifier with default) was technically possible.

**Executor's Implementation:**
```hcl
# variables.tf
lun = optional(number)

# migrate_main.tf
lun = data_disk.lun != null ? data_disk.lun : 0
```

**Why This Violates executor.md:**

From executor.md lines 124-127:
> **Defaults:** If schema has `Default`, replicate it:
> - **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
> - **Fallback:** Apply default in locals if optional() syntax not possible

From checker.md lines 99-125:
> **Method Priority:**
> PREFER: optional(string, "default") in object type
>    ↓
> Fallback: coalesce() in locals (ONLY if optional() impossible)

**Provider's Actual Behavior:**
```go
"lun": {
	Type:         pluginsdk.TypeInt,
	Optional:     true,
	Computed:     true,  // Defaults to 0 (Go int zero value)
	ValidateFunc: validation.IntBetween(0, 2000),
},

// In expand function:
if lun := raw["lun"].(int); lun >= 0 {
	disk.Lun = int64(lun)
}
```

The provider defaults lun to 0 when not specified (Computed: true on Optional field).

**Expected Behavior:**
- Field is in `list(object({...}))` structure
- `optional(number, 0)` syntax IS possible in this context
- Terraform 1.3+ supports `optional()` with defaults at any nesting level
- MUST use PREFERRED method, not fallback

**Root Cause:**
Executor incorrectly chose the fallback implementation method (coalesce in locals) when the preferred method (`optional()` modifier with default value) was technically possible. This violates the strict method priority hierarchy defined in executor.md.

### Corrections Made

#### Fix 1: Use Preferred `optional()` Method with Default

**Changed Files:**
- `variables.tf`: Changed `lun = optional(number)` to `lun = optional(number, 0)`
- `migrate_main.tf`: Changed `lun = data_disk.lun != null ? data_disk.lun : 0` to `lun = data_disk.lun`

**New Implementation:**

In `variables.tf`:
```hcl
variable "orchestrated_virtual_machine_scale_set_data_disk" {
  type = list(object({
    caching                        = string
    create_option                  = optional(string, "Empty")
    disk_encryption_set_id         = optional(string)
    disk_size_gb                   = optional(number)
    lun                            = optional(number, 0)  # ✅ PREFERRED method
    storage_account_type           = string
    ultra_ssd_disk_iops_read_write = optional(number)
    ultra_ssd_disk_mbps_read_write = optional(number)
    write_accelerator_enabled      = optional(bool)
  }))
  # ...
}
```

In `migrate_main.tf`:
```hcl
dataDisks = [
  for data_disk in var.orchestrated_virtual_machine_scale_set_data_disk : {
    caching = data_disk.caching
    managedDisk = merge(
      {
        storageAccountType = data_disk.storage_account_type
      },
      # ...
    )
    createOption = data_disk.create_option
    diskSizeGB   = data_disk.disk_size_gb != null && data_disk.disk_size_gb > 0 ? data_disk.disk_size_gb : null
    lun          = data_disk.lun  # ✅ No coalesce needed - guaranteed non-null
    diskIOPSReadWrite = data_disk.ultra_ssd_disk_iops_read_write != null && data_disk.ultra_ssd_disk_iops_read_write > 0 ? data_disk.ultra_ssd_disk_iops_read_write : null
    diskMBpsReadWrite = data_disk.ultra_ssd_disk_mbps_read_write != null && data_disk.ultra_ssd_disk_mbps_read_write > 0 ? data_disk.ultra_ssd_disk_mbps_read_write : null
  }
]
```

**Why This is EXACT:**

1. **Method Priority Compliance:** Uses PREFERRED method (`optional(number, 0)`) instead of fallback
2. **Technical Feasibility:** Field is in `list(object({...}))` where `optional()` with defaults IS supported
3. **Provider Behavior Match:** Exactly replicates provider's default of 0 for unspecified lun
4. **Simplification:** Removes unnecessary conditional logic in locals - the default is applied by Terraform's type system
5. **Consistency:** Matches the pattern used for other fields like `create_option = optional(string, "Empty")`

**Verification:**
- Scenario 1: `lun = null` (omitted) → Terraform applies default → `lun = 0` ✅
- Scenario 2: `lun = 5` (specified) → Uses provided value → `lun = 5` ✅
- Scenario 3: `lun = 0` (explicit) → Uses provided value → `lun = 0` ✅
- Edge Case: Value guaranteed non-null in for loop, no risk of null reference ✅

### Validation Results

✅ **ForceNew Logic:** Not applicable (field does not have ForceNew)
✅ **Stable Keys:** Not applicable (no replace_triggers_external_values entry)
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Correct - `number` (Terraform) → `int64` (Azure API)
✅ **Null Handling:** ✅ **CORRECTED** - Now uses `optional(number, 0)` per method priority
✅ **Validations:** Correctly implemented IntBetween(0, 2000) in variables.tf
✅ **Deferred Work Completion:** No deferred work for this task (no following.md)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed in original proof
✅ **Shared Path Merge:** No shared path conflicts in implementation

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The implementation uses the PREFERRED `optional()` modifier method for defaults, complying with the strict method priority hierarchy.

**Status:** CORRECTED AND APPROVED ✅

---
