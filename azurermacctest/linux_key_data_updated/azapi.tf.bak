module "vmss_replicator" {
  source = "../.."

  name                        = "acctestOVMSS-${random_integer.number.result}"
  resource_group_id           = azurerm_resource_group.test.id
  location                    = azurerm_resource_group.test.location
  platform_fault_domain_count = 2

  sku_name  = "Standard_F2"
  instances = 1

  os_profile = {
    linux_configuration = {
      admin_username       = "ubuntu"
      computer_name_prefix = "prefix"
      admin_ssh_key = toset([
        {
          username   = "ubuntu"
          public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDvXYZAjVUt2aojUV3XIA+PY6gXrgbvktXwf2NoIHGlQFhogpMEyOfqgogCtTBM7MNCS3ELul6SV+mlpH08Ki45ADIQuDXdommCvsMFW096JrsHOJpGfjCsJ1gbbv7brB3Ag+BSGb4qO3pRsEVTtZCeJDwfH5D7vmqP5xXcELKR4UAtKQKUhLvt6mhW90sFLTJeOTiYGbavIKqfCUFSeSMQkUPr8o3uzOfeWyCw7tc7szLuvfwJ5poGHuve73KKAlUnDTPUrhyj7iITZSDl+/i+bpDzPyCyJWDMsC0ON7q2fDr2mEz0L9ACrsI5Nx3lt5fe+IaHSrjivqnL8SqUWSN45o9Qp99sGWFiuTfos8f1jp+AXzC4ArVtKyRg/CnzKRiK0CGSxBJ5s9zAoa7yBBmjCszq89vFa0eMgpEIZFwa6kKJKt9AfRBXgO9YGPV4uaN7topy92/p2pE+vF8IafarbvnTDOQt62mS07tXYqYg1DhecrmBVWKlq9oafBweoeTjoq52SoGsuDc/YAOzIgWVIuvV8yKoh9KbXPWowjLtxDhRIS/d1nMMNdNI8X0TQivgi5+umMgAXhsVAKSNDUauLt4jimYkWAuE+R6KoCqVFdaB9bQDySBjAziruDSe3reToydjzzluvHMjWK8QiDynxs41pi4zZz6gAlca3QPkEQ== hello@world.com"
        }
      ])
    }
  }

  os_profile_custom_data         = "Y3VzdG9tIGRhdGEh"
  os_profile_custom_data_version = 1

  network_interface = [
    {
      name    = "TestNetworkProfile"
      primary = true
      ip_configuration = [
        {
          name                                   = "TestIPConfiguration"
          primary                                = true
          subnet_id                              = azurerm_subnet.test.id
          load_balancer_backend_address_pool_ids = toset([azurerm_lb_backend_address_pool.test.id])
        }
      ]
    }
  ]

  os_disk = {
    storage_account_type = "Standard_LRS"
    caching              = "ReadWrite"
  }

  source_image_reference = {
    publisher = "Canonical"
    offer     = "0001-com-ubuntu-server-jammy"
    sku       = "22_04-lts"
    version   = "latest"
  }
}

resource "azapi_resource" "this" {
  type                             = module.vmss_replicator.azapi_header.type
  name                             = module.vmss_replicator.azapi_header.name
  location                         = module.vmss_replicator.azapi_header.location
  parent_id                        = module.vmss_replicator.azapi_header.parent_id
  tags                             = module.vmss_replicator.azapi_header.tags
  body                             = module.vmss_replicator.body
  ignore_null_property             = module.vmss_replicator.azapi_header.ignore_null_property
  sensitive_body                   = module.vmss_replicator.sensitive_body
  sensitive_body_version           = module.vmss_replicator.sensitive_body_version
  replace_triggers_external_values = module.vmss_replicator.replace_triggers_external_values
  locks                            = module.vmss_replicator.locks

  dynamic "identity" {
    for_each = can(module.vmss_replicator.azapi_header.identity) ? [module.vmss_replicator.identity] : []
    content {
      type         = identity.value.type
      identity_ids = try(identity.value.identity_ids, null)
    }
  }

  retry = module.vmss_replicator.retry

  dynamic "timeouts" {
    for_each = module.vmss_replicator.timeouts != null ? [module.vmss_replicator.timeouts] : []
    content {
      create = timeouts.value.create
      delete = timeouts.value.delete
      read   = timeouts.value.read
      update = timeouts.value.update
    }
  }
}

resource "azapi_update_resource" "update0" {
  type           = module.vmss_replicator.post_creation_updates[0].azapi_header.type
  name           = module.vmss_replicator.post_creation_updates[0].azapi_header.name
  parent_id      = module.vmss_replicator.post_creation_updates[0].azapi_header.parent_id
  body           = module.vmss_replicator.post_creation_updates[0].body
  sensitive_body = try(module.vmss_replicator.post_creation_updates[0].sensitive_body, null)
  depends_on     = [azapi_resource.this]
  lifecycle {
    ignore_changes = all
  }
}
