Test Case: linux_instances
================================================================================

Still failed after 2 fix attempts

Initial Error:
Error: Unsupported attribute
  on azapi.tf line 97, in resource "azapi_update_resource" "update0":
  97:     ignore_changes = [all]
This object has no argument, nested block, or exported attribute named "all".

Attempted Fix Methods:

Attempt 1:
- Problem Analysis: The lifecycle block uses ignore_changes = [all] with brackets, but Terraform requires ignore_changes = all without brackets when ignoring all attributes.
- Fix Method: Remove brackets around 'all' in the ignore_changes statement
- Result: Success - syntax error fixed, but revealed deeper issue during apply

Attempt 2:
- Problem Analysis: Azure API error "NetworkApiVersionMustBeSpecifiedWithNetworkInterfaceConfigurations" - when updating the VMSS after state migration, Azure requires networkApiVersion to be explicitly specified in the network profile. The azurerm provider implicitly sets default "2020-11-01" which wasn't persisted to Azure resource. When AzAPI tries to update (to remove diskSizeGB computed value), Azure rejects request without explicit networkApiVersion.
- Fix Method: Added network_api_version = "2020-11-01" parameter to module call
- Result: Failure - same error persists. Module appears to not include networkApiVersion in the body during updates when migrating from azurerm-created resources.

Final Error:
Error: Failed to create/update resource
  with azapi_resource.this,
  on azapi.tf line 57, in resource "azapi_resource" "this":
  57: resource "azapi_resource" "this" {

creating/updating Resource: PUT https://management.azure.com/subscriptions/.../virtualMachineScaleSets/acctestOVMSS-75987
RESPONSE 400: 400 Bad Request
ERROR CODE: NetworkApiVersionMustBeSpecifiedWithNetworkInterfaceConfigurations
{
  "error": {
    "code": "NetworkApiVersionMustBeSpecifiedWithNetworkInterfaceConfigurations",
    "message": "Network api version in network profile of virtual machine ... must be specified if network interface configurations are specified."
  }
}

Conclusion:
This is a module implementation bug that cannot be fixed at the test configuration level. The module's logic for handling network_api_version during state migration from azurerm to azapi is flawed:

1. azurerm provider creates VMSS without explicitly setting networkApiVersion in Azure (uses implicit default)
2. During state migration with moved blocks, Azure resource has no networkApiVersion in its properties
3. When azapi tries to update the resource (to apply acceptable drift like diskSizeGB null), Azure requires networkApiVersion be present
4. Module's current logic includes networkApiVersion in body only during create (line 716 in migrate_main.tf)
5. During updates after state migration, networkApiVersion is not being included in the PUT body, causing Azure to reject the request

Root cause: Module needs to ensure networkApiVersion is included in body not just during initial creation, but also during updates after state migration from azurerm, especially when network_interface is configured.

Recommendation: Module should be enhanced to handle this edge case where azurerm-created resources lack explicit networkApiVersion.
