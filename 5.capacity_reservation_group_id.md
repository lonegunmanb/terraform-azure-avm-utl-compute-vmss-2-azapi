# Task #5: capacity_reservation_group_id - Root-Level Argument

## Summary

Implemented `capacity_reservation_group_id` as an optional root-level argument with ForceNew behavior. The field maps to `properties.virtualMachineProfile.capacityReservation.capacityReservationGroup.id` in the Azure API. Added validations for resource ID format and cross-field conflicts with `proximity_placement_group_id` and `single_placement_group`.

## Shadow Implementation

```hcl
locals {
  replace_triggers_external_values = {
    capacity_reservation_group_id = { value = var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id } # <-
  }

  body = merge(
    {
      properties = merge(
        {
          orchestrationMode = "Flexible"
        },
        var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id != null ? { # <-
          virtualMachineProfile = merge( # <-
            var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id != null ? { # <-
              capacityReservation = { # <-
                capacityReservationGroup = { # <-
                  id = var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id # <-
                } # <-
              } # <-
            } : {} # <-
          ) # <-
        } : {} # <-
      )
    }
  )
}
```

```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_capacity_reservation_group_id" {
  validation {
    condition = ( # <-
      var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id == null || # <-
      can(regex("^/subscriptions/[a-fA-F0-9]{8}-([a-fA-F0-9]{4}-){3}[a-fA-F0-9]{12}/resourceGroups/[^/]+/providers/Microsoft\\.Compute/capacityReservationGroups/[^/]+$", var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id)) # <-
    ) # <-
    error_message = "The capacity_reservation_group_id must be a valid Capacity Reservation Group ID." # <-
  } # <-

  validation { # <-
    condition = ( # <-
      var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id == null || # <-
      var.orchestrated_virtual_machine_scale_set_proximity_placement_group_id == null # <-
    ) # <-
    error_message = "The capacity_reservation_group_id cannot be specified when proximity_placement_group_id is set (ConflictsWith)." # <-
  } # <-
}
```

## Create Phase Verification

**Pattern:** Single-phase Create

**Evidence from Create method:**

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    client := meta.(*clients.Client).Compute.VirtualMachineScaleSetsClient
    // ...
    
    virtualMachineProfile := virtualmachinescalesets.VirtualMachineScaleSetVMProfile{
        StorageProfile: &virtualmachinescalesets.VirtualMachineScaleSetStorageProfile{},
    }
    
    // ...
    
    if v, ok := d.GetOk("capacity_reservation_group_id"); ok {
        if d.Get("single_placement_group").(bool) {
            return fmt.Errorf("`single_placement_group` must be set to `false` when `capacity_reservation_group_id` is specified")
        }

        virtualMachineProfile.CapacityReservation = &virtualmachinescalesets.CapacityReservationProfile{
            CapacityReservationGroup: &virtualmachinescalesets.SubResource{
                Id: pointer.To(v.(string)),
            },
        }
    }
    
    // ...
    
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    
    // ...
    
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Classification:** The field is assigned to `virtualMachineProfile.CapacityReservation` before the `CreateOrUpdateThenPoll` call, making it part of the **Create phase**.

**Decision:** Add to `local.body`.

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.capacityReservation.capacityReservationGroup.id`

**Go Code Evidence:**

From the Create method:
```go
virtualMachineProfile.CapacityReservation = &virtualmachinescalesets.CapacityReservationProfile{
    CapacityReservationGroup: &virtualmachinescalesets.SubResource{
        Id: pointer.To(v.(string)),
    },
}
```

From the resource structure assignment:
```go
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Traced Assignment:**
1. `virtualMachineProfile.CapacityReservation` (CapacityReservationProfile struct)
2. `.CapacityReservationGroup` (SubResource struct)
3. `.Id` (string pointer)
4. `props.Properties.VirtualMachineProfile` assignment adds the `properties.virtualMachineProfile` prefix

**Verified Path:** `properties.virtualMachineProfile.capacityReservation.capacityReservationGroup.id`

**Path Comparison:** ✅ Match - Predicted path matches the verified path.

## Provider Schema

```go
"capacity_reservation_group_id": {
    Type:         pluginsdk.TypeString,
    Optional:     true,
    ForceNew:     true,
    ValidateFunc: capacityreservationgroups.ValidateCapacityReservationGroupID,
    ConflictsWith: []string{
        "proximity_placement_group_id",
    },
},
```

**Key Attributes:**
- **Type:** String
- **Optional:** true
- **ForceNew:** true
- **ValidateFunc:** `capacityreservationgroups.ValidateCapacityReservationGroupID` - validates Azure resource ID format
- **ConflictsWith:** `proximity_placement_group_id`

## Azure API Schema

From Azure API `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`:

```
properties.virtualMachineProfile.capacityReservation: ObjectWithOptionalAttrs(
  map[string]Type{
    "capacityReservationGroup": ObjectWithOptionalAttrs(
      map[string]Type{
        "id": String
      }, 
      []string{"id"}
    )
  }, 
  []string{"capacityReservationGroup"}
)
```

**Property Path:** `body.properties.virtualMachineProfile.capacityReservation.capacityReservationGroup.id`

## Hidden Fields

**Analysis:** No hidden fields detected. The provider code shows a straightforward assignment without any additional computed or hardcoded values within the CapacityReservation structure.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| capacity_reservation_group_id | properties.virtualMachineProfile.capacityReservation.capacityReservationGroup.id |

## Special Handling

### 1. ForceNew Behavior

**Schema Evidence:**
```go
ForceNew: true
```

**Implementation:** Added to `replace_triggers_external_values` with stable key:
```hcl
capacity_reservation_group_id = { value = var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id }
```

**Rationale:** No CustomizeDiff logic found for this field. Simple ForceNew from schema - any change to the value triggers replacement.

### 2. Validations

**Validation 1 - Resource ID Format:**

**Provider Schema:**
```go
ValidateFunc: capacityreservationgroups.ValidateCapacityReservationGroupID,
```

The validation function checks for Azure resource ID format: `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/capacityReservationGroups/{capacityReservationGroupName}`

**Implementation in variables.tf:**
```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id == null ||
    can(regex("^/subscriptions/[a-fA-F0-9]{8}-([a-fA-F0-9]{4}-){3}[a-fA-F0-9]{12}/resourceGroups/[^/]+/providers/Microsoft\\.Compute/capacityReservationGroups/[^/]+$", var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id))
  )
  error_message = "The capacity_reservation_group_id must be a valid Capacity Reservation Group ID."
}
```

**Validation 2 - ConflictsWith proximity_placement_group_id:**

**Provider Schema:**
```go
ConflictsWith: []string{
    "proximity_placement_group_id",
},
```

**Implementation in variables.tf:**
```hcl
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id == null ||
    var.orchestrated_virtual_machine_scale_set_proximity_placement_group_id == null
  )
  error_message = "The capacity_reservation_group_id cannot be specified when proximity_placement_group_id is set (ConflictsWith)."
}
```

**Validation 3 - Cross-field with single_placement_group:**

**Provider Create Method:**
```go
if v, ok := d.GetOk("capacity_reservation_group_id"); ok {
    if d.Get("single_placement_group").(bool) {
        return fmt.Errorf("`single_placement_group` must be set to `false` when `capacity_reservation_group_id` is specified")
    }
    // ...
}
```

**Implementation:** This validation was already implemented in Task #16 in the `single_placement_group` variable (ownership rule - the validation belongs to the variable that contains the condition):
```hcl
# In variables.tf (from Task #16)
variable "orchestrated_virtual_machine_scale_set_single_placement_group" {
  validation {
    condition     = var.orchestrated_virtual_machine_scale_set_single_placement_group != true || var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id == null
    error_message = "`single_placement_group` must be set to `false` when `capacity_reservation_group_id` is specified."
  }
}
```

### 3. Conditional Inclusion

The field is only included in the body when not null, following the provider's `GetOk` pattern:

```hcl
var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id != null ? {
  capacityReservation = {
    capacityReservationGroup = {
      id = var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id
    }
  }
} : {}
```

## Edge Case Analysis

### 1. Null Semantics
- **Null meaning:** "Do not set capacity reservation" - resource will not be associated with any capacity reservation group
- **Provider behavior:** Uses `GetOk` pattern - only sets the field if explicitly provided
- **Implementation:** Conditional merge ensures field is omitted when null

### 2. Empty String
- **Not applicable:** Field is string type but validation ensures it must be null or a valid resource ID
- **Validation prevents:** Empty strings will fail the regex validation

### 3. ForceNew Boundary Conditions
- **Change from null to value:** Triggers replacement ✅
- **Change from value to null:** Triggers replacement ✅
- **Change from value1 to value2:** Triggers replacement ✅
- **Stable key:** Key always present in replace_triggers_external_values, value changes trigger replacement

### 4. Cross-field Interactions
- **With proximity_placement_group_id:** Mutual exclusion enforced by validation
- **With single_placement_group:** Must be false (or null) when capacity_reservation_group_id is set, enforced by validation in single_placement_group variable
- **Safe references:** Both referenced variables exist and are checked for null before comparison

### 5. Idempotency
- **Deterministic:** Direct value mapping, no transformations
- **No order dependency:** Single field, no collections involved
- **Stable output:** Same input always produces same output

## Checklist

- ✅ Property in correct local (`body`)
- ✅ ForceNew wrapped with stable key in `replace_triggers_external_values`
- ✅ ALL logic EXACTLY replicated from provider (direct value assignment, no additional logic)
- ✅ Validations IMPLEMENTED in variables.tf (resource ID format, ConflictsWith proximity_placement_group_id)
- ✅ Cross-field validation with single_placement_group already exists from Task #16
- ✅ Hidden fields checked (none found)
- ✅ Critical review completed (null semantics, boundary conditions, safe references, idempotent)
- ✅ Edge Case Analysis documented
- ✅ Proof created
- ✅ Ready for track.md update

## Implementation Matches Provider Behavior

This implementation exactly replicates the provider behavior:
1. ✅ Field is optional and causes ForceNew on any change
2. ✅ Value is directly assigned without transformation
3. ✅ Resource ID format validation matches provider's ValidateFunc
4. ✅ ConflictsWith proximity_placement_group_id enforced
5. ✅ Cross-validation with single_placement_group enforced (from Task #16)
6. ✅ Conditional inclusion matches provider's GetOk pattern
7. ✅ Correct API path: `properties.virtualMachineProfile.capacityReservation.capacityReservationGroup.id`

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-04
**Task:** #5 - capacity_reservation_group_id

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew correctly implemented with stable key in replace_triggers_external_values
✅ **Stable Keys:** Key `capacity_reservation_group_id` always present in replace_triggers_external_values
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Direct string assignment, no conversion needed
✅ **Null Handling:** Correctly propagates null semantics via conditional merge
✅ **Validations:** All provider validations implemented:
  - Resource ID format validation (regex matching provider's ValidateFunc)
  - ConflictsWith proximity_placement_group_id (mutual exclusion enforced)
  - Cross-field validation with single_placement_group (implemented in Task #16)
✅ **Assignment Path:** Correct path `properties.virtualMachineProfile.capacityReservation.capacityReservationGroup.id`
✅ **Edge Cases:** All edge cases properly analyzed and handled (null semantics, ForceNew boundaries, cross-field interactions, idempotency)
✅ **Conditional Logic:** Proper two-level conditional structure:
  - Outer: Create virtualMachineProfile if any child field exists
  - Inner: Add capacityReservation only when capacity_reservation_group_id is not null

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The field is correctly placed in the Create phase, all validations are implemented in variables.tf, ForceNew behavior is properly tracked, and the API path matches the provider's implementation exactly.

**Status:** APPROVED ✅

---
