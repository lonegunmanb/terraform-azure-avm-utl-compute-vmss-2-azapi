# Task #102: os_profile.linux_configuration.disable_password_authentication

## Shadow Implementation

```hcl
# variables.tf
variable "orchestrated_virtual_machine_scale_set_os_profile" {
  type = object({
    linux_configuration = optional(object({
      disable_password_authentication = optional(bool, true) # <-
      # ... other fields
    }))
  })
}

# migrate_main.tf
locals {
  body = {
    properties = merge(
      # ... other properties ...
      var.orchestrated_virtual_machine_scale_set_os_profile != null ? {
        virtualMachineProfile = merge(
          # ... other profile properties ...
          var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null ? merge(
            {
              computerNamePrefix = local.linux_configuration_computer_name_prefix
            },
            {
              linuxConfiguration = {
                adminUsername                   = var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.admin_username # <-
                disablePasswordAuthentication   = var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.disable_password_authentication # <-
                # ... other linux_configuration properties ... # <-
              }
            }
          ) : {},
          # ... other merges ...
        )
      } : {}
    )
  }
}
```

## Summary

Implements `disable_password_authentication` for Linux VMs. This optional field specifies whether password authentication should be disabled, defaulting to `true` (password authentication is disabled by default).

## Create Phase Verification

### Pattern Identification

Queried the Create method to understand how `disable_password_authentication` is processed.

**Pattern:** Single-phase creation

The field is processed during the Create phase through the expand function:

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... setup code ...
	
	osProfileRaw := d.Get("os_profile").([]interface{})
	
	if len(osProfileRaw) > 0 && osProfileRaw[0] != nil {
		osProfile := osProfileRaw[0].(map[string]interface{})
		linConfigRaw = osProfile["linux_configuration"].([]interface{})
		
		if len(linConfigRaw) > 0 && linConfigRaw[0] != nil {
			osType = virtualmachinescalesets.OperatingSystemTypesLinux
			linConfig := linConfigRaw[0].(map[string]interface{})
			vmssOsProfile = expandOrchestratedVirtualMachineScaleSetOsProfileWithLinuxConfiguration(linConfig, customData)
			// ... other processing ...
		}
		
		virtualMachineProfile.OsProfile = vmssOsProfile
	}
	
	props.Properties.VirtualMachineProfile = &virtualMachineProfile
	
	if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Orchestrated %s: %w", id, err)
	}
}
```

**Classification:** Create phase - the field is set before the `CreateOrUpdateThenPoll` call.

**Decision:** Add to `local.body` (not `post_creation_updates`).

## Assignment Path Verification

### Predicted Path

`body.properties.virtualMachineProfile.osProfile.linuxConfiguration.disablePasswordAuthentication`

### Go Code Evidence

```go
func expandOrchestratedVirtualMachineScaleSetOsProfileWithLinuxConfiguration(input map[string]interface{}, customData string) *virtualmachinescalesets.VirtualMachineScaleSetOSProfile {
	osProfile := virtualmachinescalesets.VirtualMachineScaleSetOSProfile{}
	linConfig := virtualmachinescalesets.LinuxConfiguration{}
	
	if len(input) > 0 {
		// ... other field assignments ...
		linConfig.DisablePasswordAuthentication = pointer.To(input["disable_password_authentication"].(bool))
		// ... other field assignments ...
	}
	
	osProfile.LinuxConfiguration = &linConfig
	
	return &osProfile
}
```

Assignment flow:
1. `input["disable_password_authentication"]` → `linConfig.DisablePasswordAuthentication`
2. `&linConfig` → `osProfile.LinuxConfiguration`
3. Return `&osProfile` which is assigned to `virtualMachineProfile.OsProfile`
4. `&virtualMachineProfile` → `props.Properties.VirtualMachineProfile`

### Verified Path

`body.properties.virtualMachineProfile.osProfile.linuxConfiguration.disablePasswordAuthentication`

### Path Comparison

✅ **Match** - Predicted path matches the verified path from Go code.

## Provider Schema

```go
"disable_password_authentication": {
	Type:     pluginsdk.TypeBool,
	Optional: true,
	Default:  true,
},
```

**Key Details:**
- **Type:** Bool
- **Optional:** Yes
- **Required:** No
- **Default:** `true` (password authentication is disabled by default)
- **ForceNew:** No
- **Computed:** No
- **Sensitive:** No
- **DiffSuppressFunc:** None
- **ValidateFunc:** None
- **ConflictsWith:** None

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`

**Property Path:** `body.properties.virtualMachineProfile.osProfile.linuxConfiguration.disablePasswordAuthentication`

**Type:** `Bool`

**Description:** "Specifies whether password authentication should be disabled."

## Hidden Fields

No hidden fields identified for this argument.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| `disable_password_authentication` | `disablePasswordAuthentication` |

## Special Handling

### Default Value

**Provider Default:** `true`

**Implementation:**
```hcl
disable_password_authentication = optional(bool, true)
```

The default value of `true` means password authentication is disabled by default, which is a security best practice for Linux VMs. Users can explicitly set it to `false` if they want to allow password authentication.

### No Validation Required

The field is a boolean with no additional validation rules in the provider schema.

### No ForceNew

The field is NOT marked as `ForceNew`, meaning changes can be applied via Update operations without replacing the resource.

### No DiffSuppressFunc

The field does not have a `DiffSuppressFunc`, so standard boolean comparison applies.

## Deferred Work Completion

Checked `following.md` - no work was deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics

When `var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.disable_password_authentication` is accessed:
- If the parent `linux_configuration` is `null`, the field is not evaluated (short-circuit in conditional)
- The field has a default value of `true` via `optional(bool, true)`, so it will never be `null` when `linux_configuration` exists

### Boundary Conditions

**Boolean Field:**
- Values: `true` or `false`
- Default: `true` (password authentication disabled)
- No additional validation required

### Idempotency

✅ **Idempotent** - Boolean comparison is deterministic. Terraform's state management ensures the value is correctly tracked across applies.

### Safe References

✅ **Safe** - The field is only accessed when:
1. `var.orchestrated_virtual_machine_scale_set_os_profile != null` (checked in outer condition)
2. `var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration != null` (checked in merge condition)

The conditional nesting ensures we never access the field when parent blocks are `null`.

### Edge Cases

1. **Security Best Practice:** The default value of `true` aligns with Azure security recommendations for Linux VMs
2. **Password vs SSH:** When `disable_password_authentication` is `true`, SSH key authentication should be configured (handled by other tasks)
3. **Update Behavior:** Since not ForceNew, users can toggle this setting without replacing the VM scale set

## Checklist

- ✅ Property in correct local (`body`)
- ✅ Default value replicated (`optional(bool, true)`)
- ✅ No ForceNew wrapping needed (field is not ForceNew)
- ✅ Logic exactly replicated from provider (direct boolean assignment)
- ✅ No validations to implement (boolean type only)
- ✅ Hidden fields checked (none found)
- ✅ No work deferred to other tasks
- ✅ No deferred work from other tasks
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Ready to update `track.md` to Pending for check
- ✅ Self-review: Only implemented Task #102 scope

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-10
**Task:** #102 - os_profile.linux_configuration.disable_password_authentication

### Issues Identified

#### Issue 1: Missing Cross-Variable Validation (CRITICAL VIOLATION)

**Problem:**
The executor failed to implement the mandatory cross-variable validation between `admin_password` and `disable_password_authentication`. The variable description in `variables.tf` line 949 explicitly states: "When an `admin_password` is specified `disable_password_authentication` must be set to `false`."

**Executor's Implementation:**
No validation blocks were implemented for this cross-variable constraint. Task #100 (admin_password) incorrectly stated "Provider doesn't enforce this relationship in schema - User responsible for logical consistency", which is FALSE. The relationship IS documented in the provider schema description and MUST be enforced.

**Why This Violates executor.md:**
From executor.md line 117-118:
> **Category 2 - Cross-Field Constraints (MUST ALL):**
> `ConflictsWith`, `RequiredWith`, `ExactlyOneOf`, `AtLeastOneOf` → Modify field's variable in `variables.tf` to add `validation` block (ownership rule).

And from executor.md line 119-125:
> **⚠️ IMPORTANT - Terraform 1.9+ Cross-Variable Validation:**
> Starting from Terraform 1.9, `variable` validation blocks CAN reference other variables. This means cross-variable validations (e.g., when field A is set, field B must also be set, where A and B are different variables) MUST be implemented in `variables.tf` validation blocks, NOT in `migrate_validation.tf`.

The validation was not deferred to following.md, and Task #100 missed implementing it. According to checker.md, bidirectional validation must be implemented on BOTH variables.

**Provider's Actual Behavior:**
From the variable description:
```
disable_password_authentication - (Optional) When an `admin_password` is specified `disable_password_authentication` must be set to `false`. Defaults to `true`.
```

This describes a bidirectional constraint:
- When `admin_password` is set → `disable_password_authentication` must be `false`
- When `disable_password_authentication` is `true` (default) → `admin_password` must be `null`

**Expected Behavior:**
1. When user sets `admin_password`, Terraform should error at plan time if `disable_password_authentication` is not explicitly set to `false`
2. When user keeps `disable_password_authentication` as `true` (default), Terraform should error at plan time if `admin_password` is set
3. Validation must occur at plan time (fast feedback), not deferred to Azure API

**Root Cause:**
Task #100 executor misunderstood the provider behavior and incorrectly concluded that "Provider doesn't enforce this relationship in schema". The executor failed to recognize that the description text IS part of the schema contract and documents required validation logic that must be replicated exactly.

### Corrections Made

#### Fix 1: Added Bidirectional Cross-Variable Validation

**Changed Files:**
- `migrate_variables.tf`: Added validation to `admin_password` variable
- `variables.tf`: Added validation to `os_profile` variable

**New Implementation in migrate_variables.tf:**
```hcl
# In variable "migrate_orchestrated_virtual_machine_scale_set_os_profile_linux_configuration_admin_password"
validation {
  condition = (
    var.migrate_orchestrated_virtual_machine_scale_set_os_profile_linux_configuration_admin_password == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.disable_password_authentication == false
  )
  error_message = "When admin_password is specified, disable_password_authentication must be set to false."
}
```

**New Implementation in variables.tf:**
```hcl
# In variable "orchestrated_virtual_machine_scale_set_os_profile"
validation {
  condition = (
    var.orchestrated_virtual_machine_scale_set_os_profile == null ||
    var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration == null ||
    !var.orchestrated_virtual_machine_scale_set_os_profile.linux_configuration.disable_password_authentication ||
    var.migrate_orchestrated_virtual_machine_scale_set_os_profile_linux_configuration_admin_password == null
  )
  error_message = "When disable_password_authentication is true (the default), admin_password must not be specified."
}
```

**Why This is EXACT:**
1. **Bidirectional enforcement:** Both directions of the constraint are validated
2. **Null-safe:** Properly handles null parent objects with short-circuit evaluation
3. **Correct logic:** 
   - When `admin_password` is set → requires `disable_password_authentication == false`
   - When `disable_password_authentication` is true → requires `admin_password == null`
4. **Terraform 1.9+ compliant:** Uses cross-variable references in validation blocks as mandated by executor.md
5. **Plan-time validation:** Errors occur during `terraform plan`, not during API calls

**Verification:**
- Scenario 1: `admin_password = "secret123"` + `disable_password_authentication = false` → ✅ Valid
- Scenario 2: `admin_password = "secret123"` + `disable_password_authentication = true` → ❌ Error from migrate_variables.tf validation
- Scenario 3: `admin_password = "secret123"` + `disable_password_authentication` not set (defaults to true) → ❌ Error from migrate_variables.tf validation
- Scenario 4: `admin_password = null` + `disable_password_authentication = true` → ✅ Valid
- Scenario 5: `admin_password = null` + `disable_password_authentication = false` → ✅ Valid
- Edge Case: `linux_configuration = null` → ✅ Valid (short-circuit prevents evaluation)

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The cross-variable validation that was missed by both Task #100 and Task #102 executors has been implemented with bidirectional enforcement on both variables.

**Status:** CORRECTED AND APPROVED ✅

---
