# Task #6: encryption_at_host_enabled - Root-Level Argument

## Summary

Implemented `encryption_at_host_enabled` as an optional root-level boolean argument with NO ForceNew behavior. The field maps to `properties.virtualMachineProfile.securityProfile.encryptionAtHost` in the Azure API and controls whether Host Encryption is enabled for all disks (including Resource/Temp disks). The field is updatable and has no validations beyond type checking.

## Shadow Implementation

```hcl
locals {
  replace_triggers_external_values = {
    encryption_at_host_enabled = { value = null } # <-
  }

  body = merge(
    {
      properties = merge(
        {
          orchestrationMode = "Flexible"
        },
        var.orchestrated_virtual_machine_scale_set_os_profile != null || var.orchestrated_virtual_machine_scale_set_extensions_time_budget != null || var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id != null || var.orchestrated_virtual_machine_scale_set_encryption_at_host_enabled != null ? { # <-
          virtualMachineProfile = merge(
            var.orchestrated_virtual_machine_scale_set_encryption_at_host_enabled != null ? { # <-
              securityProfile = { # <-
                encryptionAtHost = var.orchestrated_virtual_machine_scale_set_encryption_at_host_enabled # <-
              } # <-
            } : {}, # <-
            # ... other virtualMachineProfile fields
          )
        } : {}
      )
    }
  )
}
```

## Create Phase Verification

**Pattern:** Single-phase Create

**Evidence from Create method:**

```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    client := meta.(*clients.Client).Compute.VirtualMachineScaleSetsClient
    // ...
    
    virtualMachineProfile := virtualmachinescalesets.VirtualMachineScaleSetVMProfile{
        StorageProfile: &virtualmachinescalesets.VirtualMachineScaleSetStorageProfile{},
    }
    
    // ... multiple field assignments ...
    
    if v, ok := d.GetOk("encryption_at_host_enabled"); ok {
        virtualMachineProfile.SecurityProfile = &virtualmachinescalesets.SecurityProfile{
            EncryptionAtHost: pointer.To(v.(bool)),
        }
    }
    
    // ... more field assignments ...
    
    props.Properties.VirtualMachineProfile = &virtualMachineProfile
    
    // ...
    
    log.Printf("[DEBUG] Creating Orchestrated %s.", id)
    if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
        return fmt.Errorf("creating Orchestrated %s: %w", id, err)
    }
}
```

**Classification:** The field is assigned to `virtualMachineProfile.SecurityProfile.EncryptionAtHost` before the `CreateOrUpdateThenPoll` call, making it part of the **Create phase**.

**Decision:** Add to `local.body`.

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.securityProfile.encryptionAtHost`

**Go Code Evidence:**

From the Create method:
```go
if v, ok := d.GetOk("encryption_at_host_enabled"); ok {
    virtualMachineProfile.SecurityProfile = &virtualmachinescalesets.SecurityProfile{
        EncryptionAtHost: pointer.To(v.(bool)),
    }
}
```

From the resource structure assignment:
```go
props.Properties.VirtualMachineProfile = &virtualMachineProfile
```

**Traced Assignment:**
1. `virtualMachineProfile.SecurityProfile` (SecurityProfile struct pointer assignment)
2. `.EncryptionAtHost` (bool pointer within SecurityProfile)
3. `props.Properties.VirtualMachineProfile` assignment adds the `properties.virtualMachineProfile` prefix

**Verified Path:** `properties.virtualMachineProfile.securityProfile.encryptionAtHost`

**Path Comparison:** ✅ Match - Predicted path matches the verified path.

## Provider Schema

```go
"encryption_at_host_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
},
```

**Key Attributes:**
- **Type:** Bool
- **Optional:** true
- **ForceNew:** false (not specified, so updates are allowed)
- **Default:** None (defaults to null/not set)
- **ValidateFunc:** None
- **ConflictsWith:** None
- **CustomizeDiff:** None (verified in resource function - no CustomizeDiff logic for this field)

## Azure API Schema

From Azure API `Microsoft.Compute/virtualMachineScaleSets@2024-11-01`:

**Schema Type:**
```
properties.virtualMachineProfile.securityProfile.encryptionAtHost: Bool
```

**Documentation:**
> "This property can be used by user in the request to enable or disable the Host Encryption for the virtual machine or virtual machine scale set. This will enable the encryption for all the disks including Resource/Temp disk at host itself. The default behavior is: The Encryption at host will be disabled unless this property is set to true for the resource."

**Property Path:** `body.properties.virtualMachineProfile.securityProfile.encryptionAtHost`

## Hidden Fields

**Analysis:** No hidden fields detected. The provider code shows a straightforward assignment without any additional computed or hardcoded values within the SecurityProfile structure. The SecurityProfile is only created when `encryption_at_host_enabled` is set, containing only the `encryptionAtHost` field.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| encryption_at_host_enabled | properties.virtualMachineProfile.securityProfile.encryptionAtHost |

## Special Handling

### 1. ForceNew Behavior

**Schema Evidence:**
```go
"encryption_at_host_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    // NO ForceNew: true
},
```

**CustomizeDiff Check:** Verified the complete resource function - NO CustomizeDiff logic exists for this field.

**Implementation:** Added stable key with `null` value in `replace_triggers_external_values` to maintain stable key structure:
```hcl
encryption_at_host_enabled = { value = null }
```

**Rationale:** The field does NOT have `ForceNew: true` in the schema and has no CustomizeDiff logic. Updates to this field are allowed without resource replacement. The stable key with `null` value ensures the key is always present but never triggers replacement.

### 2. Validations

**Provider Schema:** No validations defined beyond type checking.

**Implementation:** No validations added to `variables.tf` because:
- Type system enforces boolean constraint
- No enum values (only `true` or `false`)
- No range constraints
- No cross-field validations
- No custom validation logic in provider

### 3. Conditional Inclusion

The field is only included in the body when not null, following the provider's `GetOk` pattern:

```hcl
var.orchestrated_virtual_machine_scale_set_encryption_at_host_enabled != null ? {
  securityProfile = {
    encryptionAtHost = var.orchestrated_virtual_machine_scale_set_encryption_at_host_enabled
  }
} : {}
```

**Parent Condition Update:** The `virtualMachineProfile` parent condition was updated to include this field:
```hcl
var.orchestrated_virtual_machine_scale_set_os_profile != null || 
var.orchestrated_virtual_machine_scale_set_extensions_time_budget != null || 
var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id != null || 
var.orchestrated_virtual_machine_scale_set_encryption_at_host_enabled != null
```

## Edge Case Analysis

### 1. Null Semantics
- **Null meaning:** "Do not set encryption at host" - Azure will use default behavior (encryption disabled)
- **Provider behavior:** Uses `GetOk` pattern - only sets the field if explicitly provided
- **Implementation:** Conditional merge ensures field is omitted when null
- **Azure default:** Per API documentation, encryption at host is disabled by default when not specified

### 2. Boolean Values
- **`true`:** Enables Host Encryption for all disks including Resource/Temp disk
- **`false`:** Explicitly disables Host Encryption
- **`null`:** Uses Azure default (encryption disabled)
- **Distinction:** `false` and `null` have the same effect but `false` explicitly sends the value while `null` omits it

### 3. ForceNew Boundary Conditions
- **Not applicable:** Field does NOT have ForceNew behavior
- **Updates allowed:** Changing the value does not trigger resource replacement
- **Stable key:** Key always present in replace_triggers_external_values with `null` value (never triggers replacement)

### 4. Idempotency
- **Deterministic:** Direct boolean value mapping, no transformations
- **No order dependency:** Single field, no collections involved
- **Stable output:** Same input always produces same output
- **API behavior:** Azure accepts updates to this field without requiring recreation

### 5. Safe References
- **Direct variable reference:** No nested access, no risk of null pointer errors
- **Type safety:** Terraform type system enforces boolean constraint
- **Conditional structure:** Parent conditions properly check for null before creating nested objects

## Checklist

- ✅ Property in correct local (`body`)
- ✅ ForceNew wrapped with stable key in `replace_triggers_external_values` (stable key with `null` value - no ForceNew behavior)
- ✅ ALL logic EXACTLY replicated from provider (direct value assignment with GetOk pattern, no additional logic)
- ✅ Validations IMPLEMENTED in variables.tf (none required - only type checking needed)
- ✅ Hidden fields checked (none found)
- ✅ Critical review completed (null semantics, boolean values, safe references, idempotent)
- ✅ Edge Case Analysis documented
- ✅ Proof created
- ✅ Ready for track.md update

## Implementation Matches Provider Behavior

This implementation exactly replicates the provider behavior:
1. ✅ Field is optional and does NOT cause ForceNew (updates allowed)
2. ✅ Value is directly assigned without transformation
3. ✅ No validations beyond type checking (matches provider schema)
4. ✅ Conditional inclusion matches provider's GetOk pattern
5. ✅ Correct API path: `properties.virtualMachineProfile.securityProfile.encryptionAtHost`
6. ✅ SecurityProfile is only created when the field is set (matches provider behavior)
7. ✅ Null semantics correctly propagated (omits field from API payload when null)
8. ✅ No ForceNew triggers - stable key with null value maintains key stability without triggering replacement

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-04
**Task:** #6 - encryption_at_host_enabled

### Issues Identified

#### Issue 1: Incorrect ForceNew Implementation

**Problem:**
The executor added `encryption_at_host_enabled` to `replace_triggers_external_values` with a `null` value, claiming this maintains "stable keys" while preventing ForceNew behavior. This is incorrect.

**Executor's Implementation:**
```hcl
replace_triggers_external_values = {
  # ... other fields ...
  encryption_at_host_enabled = { value = null }
}
```

**Why This Violates executor.md:**

From executor.md:
> **Simple ForceNew (schema `ForceNew: true`):**
> ```hcl
> field = { value = var.field }
> ```

And from the "Stable Keys" section:
> **MANDATORY: Stable Keys** - Keys MUST NOT appear/disappear across applies (causes unnecessary replacements).
> ✅ `{ a = {...}, b = { value = cond ? val : "" } }` ← Key `b` always present

The "stable keys" requirement applies to fields that NEED to be in `replace_triggers_external_values` because they have ForceNew behavior. It does NOT mean "add every field to replace_triggers_external_values with null values."

**Provider's Actual Behavior:**
```go
"encryption_at_host_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    // NO ForceNew: true
},
```

No CustomizeDiff logic exists for this field (verified in the proof document).

**Expected Behavior:**
- Field is optional and updatable
- Changes to this field do NOT trigger resource replacement
- Field should NOT be tracked in `replace_triggers_external_values` at all

**Root Cause:**
The executor misunderstood the purpose of `replace_triggers_external_values`. This map is ONLY for fields that have ForceNew behavior (either from schema or CustomizeDiff). Since `encryption_at_host_enabled` has neither, it should not appear in this map at all.

### Corrections Made

#### Fix 1: Remove Field from replace_triggers_external_values

**Changed Files:**
- `migrate_main.tf`: Removed `encryption_at_host_enabled` from `replace_triggers_external_values`

**New Implementation:**
```hcl
replace_triggers_external_values = {
  location                      = { value = var.orchestrated_virtual_machine_scale_set_location }
  platform_fault_domain_count   = { value = var.orchestrated_virtual_machine_scale_set_platform_fault_domain_count }
  zone_balance                  = { value = var.orchestrated_virtual_machine_scale_set_zone_balance }
  zones                         = { value = local.zones_force_new_trigger }
  single_placement_group        = { value = local.single_placement_group_force_new_trigger }
  capacity_reservation_group_id = { value = var.orchestrated_virtual_machine_scale_set_capacity_reservation_group_id }
  # encryption_at_host_enabled NOT included - field is updatable without ForceNew
}
```

**Why This is EXACT:**
This exactly matches provider behavior:
1. ✅ Field does NOT have `ForceNew: true` in schema
2. ✅ Field has NO CustomizeDiff logic
3. ✅ Therefore, field should NOT be tracked in `replace_triggers_external_values`
4. ✅ Changes to the field will update in-place, NOT trigger replacement

**Verification:**
- Scenario 1: Set `encryption_at_host_enabled = true` → Resource created with encryption enabled ✅
- Scenario 2: Change `encryption_at_host_enabled = false` → Resource updated in-place (no replacement) ✅
- Scenario 3: Set to `null` → Field omitted from API payload, Azure uses default ✅
- Edge Case: Field not in replace_triggers, so updates are handled by normal update flow ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`:

✅ **ForceNew Logic:** Field is NOT ForceNew, correctly excluded from `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Direct boolean value assignment (no conversion needed)
✅ **Null Handling:** Correctly propagates null semantics via conditional merge
✅ **Validations:** None required beyond type checking (matches provider)
✅ **Edge Cases:** All edge cases properly analyzed and handled
✅ **API Path:** Correct path `properties.virtualMachineProfile.securityProfile.encryptionAtHost`
✅ **Update Behavior:** Field is updatable without replacement (matches provider)

**Status:** CORRECTED AND APPROVED ✅

