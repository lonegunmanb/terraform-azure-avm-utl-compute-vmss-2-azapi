# Task #90: Implement `os_disk.disk_encryption_set_id`

## Summary
Implemented the `disk_encryption_set_id` argument for the `os_disk` block. This field specifies the ID of the Disk Encryption Set for encrypting the OS Disk. It is ForceNew and optional.

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern Identified:** Single-phase creation pattern

**Go Code Evidence:**
```go
func resourceOrchestratedVirtualMachineScaleSetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	if v, ok := d.GetOk("os_disk"); ok {
		virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)
	}
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, props, virtualmachinescalesets.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Orchestrated %s: %w", id, err)
	}
	// ...
}
```

**Classification:** Create phase field - assigned before the CreateOrUpdateThenPoll call

**Decision:** Place in `local.body` (not `local.post_creation_updates`)

## Assignment Path Verification

**Predicted Path:** `properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.diskEncryptionSet.id`

**Go Code Evidence:**

From `ExpandOrchestratedVirtualMachineScaleSetOSDisk`:
```go
func ExpandOrchestratedVirtualMachineScaleSetOSDisk(input []interface{}, osType virtualmachinescalesets.OperatingSystemTypes) *virtualmachinescalesets.VirtualMachineScaleSetOSDisk {
	raw := input[0].(map[string]interface{})
	disk := virtualmachinescalesets.VirtualMachineScaleSetOSDisk{
		Caching: pointer.To(virtualmachinescalesets.CachingTypes(raw["caching"].(string))),
		ManagedDisk: &virtualmachinescalesets.VirtualMachineScaleSetManagedDiskParameters{
			StorageAccountType: pointer.To(virtualmachinescalesets.StorageAccountTypes(raw["storage_account_type"].(string))),
		},
		// ...
	}
	
	if diskEncryptionSetId := raw["disk_encryption_set_id"].(string); diskEncryptionSetId != "" {
		disk.ManagedDisk.DiskEncryptionSet = &virtualmachinescalesets.SubResource{
			Id: pointer.To(diskEncryptionSetId),
		}
	}
	// ...
	return &disk
}
```

From Create method:
```go
virtualMachineProfile.StorageProfile.OsDisk = ExpandOrchestratedVirtualMachineScaleSetOSDisk(v.([]interface{}), osType)
```

Assignment chain:
1. Field read from `raw["disk_encryption_set_id"]`
2. Assigned to `disk.ManagedDisk.DiskEncryptionSet.Id`
3. Returned as `VirtualMachineScaleSetOSDisk`
4. Assigned to `virtualMachineProfile.StorageProfile.OsDisk`
5. `virtualMachineProfile` → `props.Properties.VirtualMachineProfile`

**Verified Path:** `properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.diskEncryptionSet.id`

**Path Comparison:** ✅ Match - predicted path matches verified path

## Provider Schema

**Source:** `OrchestratedVirtualMachineScaleSetOSDiskSchema()` function

```go
"disk_encryption_set_id": {
	Type:     pluginsdk.TypeString,
	Optional: true,
	// whilst the API allows updating this value, it's never actually set at Azure's end
	// presumably this'll take effect once key rotation is supported a few months post-GA?
	// however for now let's make this ForceNew since it can't be (successfully) updated
	ForceNew:     true,
	ValidateFunc: validate.DiskEncryptionSetID,
},
```

**Key Properties:**
- **Type:** String
- **Optional:** Yes
- **ForceNew:** Yes (changing requires replacement)
- **Validation:** DiskEncryptionSetID (Azure Resource ID format - skipped per executor.md)

## Azure API Schema

**Path:** `body.properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.diskEncryptionSet.id`

**Schema Type:** `String`

**Description:** "Resource Id"

**API Structure:**
```
diskEncryptionSet: {
  id: string
}
```

## Hidden Fields

None - this is a direct argument field.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|----------------------|-------|
| `disk_encryption_set_id` | `diskEncryptionSet.id` | Direct mapping to SubResource.Id |

## Special Handling

### ForceNew Handling

The field has `ForceNew: true` in the provider schema. Added to `replace_triggers_external_values`:

```hcl
os_disk_disk_encryption_set_id = { value = var.orchestrated_virtual_machine_scale_set_os_disk != null ? var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id : "" }
```

**Rationale:** Per provider comments, while the API allows updates, they don't actually take effect at Azure's end, so ForceNew is required.

### Conditional Logic

The provider only sets `diskEncryptionSet` when the field is non-empty:

```go
if diskEncryptionSetId := raw["disk_encryption_set_id"].(string); diskEncryptionSetId != "" {
	disk.ManagedDisk.DiskEncryptionSet = &virtualmachinescalesets.SubResource{
		Id: pointer.To(diskEncryptionSetId),
	}
}
```

**Shadow Implementation:**
```hcl
managedDisk = merge(
  {
    storageAccountType = var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type
  },
  var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id != null && var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id != "" ? {
    diskEncryptionSet = {
      id = var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id
    }
  } : {}
)
```

### Validation

**Provider Validation:**
```go
ValidateFunc: validate.DiskEncryptionSetID,
```

This validates Azure Resource ID format. Per executor.md instructions:
> ❌ Skip ONLY Azure Resource ID format validations (e.g., `/subscriptions/.../resourceGroups/...`) - these are verified by resource references

**Decision:** No validation added to variables.tf - Resource ID format validation is skipped per executor.md rules.

## Deferred Work Completion

Checked `following.md` - no work was deferred to Task #90.

## Critical Review & Edge Case Analysis

### Null Semantics
- `null` → Field omitted from API payload (default behavior - no encryption set)
- `""` (empty string) → Field omitted from API payload (same as null, due to condition check)
- Non-empty string → `diskEncryptionSet.id` set in API payload

### Boundary Conditions
- Empty string treated same as null (field omitted)
- Non-empty string must be valid Resource ID (validated by provider, not replicated per executor.md)

### Idempotency
- ✅ Idempotent: Same input produces same output
- ✅ Conditional merge ensures field only present when non-null and non-empty

### Safe References
- ✅ Safe: Checks `os_disk != null` before accessing nested field
- ✅ Safe: Checks both `!= null` and `!= ""` before creating nested object

### ForceNew Stability
- ✅ Stable key: Uses wrapped `{ value = ... }` pattern in `replace_triggers_external_values`
- ✅ Handles null case: Returns `""` when `os_disk` is null
- ✅ Exact provider behavior: Replicates the empty string check from provider

### Edge Cases
1. **Switching from null to empty string:** No change in API payload (both omit field)
2. **Switching from empty to non-empty:** Triggers replacement (ForceNew behavior)
3. **Changing encryption set ID:** Triggers replacement (ForceNew behavior)
4. **Parent os_disk null:** Returns empty string in replace_triggers, no error

## Shadow Implementation

```hcl
# In migrate_main.tf - local.body
var.orchestrated_virtual_machine_scale_set_os_disk != null ? {
  osDisk = {
    caching = var.orchestrated_virtual_machine_scale_set_os_disk.caching
    managedDisk = merge(
      {
        storageAccountType = var.orchestrated_virtual_machine_scale_set_os_disk.storage_account_type
      },
      var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id != null && var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id != "" ? {
        diskEncryptionSet = {
          id = var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id
        }
      } : {}
    )
    # Other os_disk fields handled by other tasks...
  }
} : {}

# In migrate_main.tf - replace_triggers_external_values
replace_triggers_external_values = {
  # ... other fields ...
  os_disk_disk_encryption_set_id = { value = var.orchestrated_virtual_machine_scale_set_os_disk != null ? var.orchestrated_virtual_machine_scale_set_os_disk.disk_encryption_set_id : "" }
}
```

## Completion Checklist

- ✅ Property in correct local (`body`)
- ✅ ForceNew wrapped: `{ value = var.field }` in `replace_triggers_external_values`
- ✅ ALL logic EXACTLY replicated from provider (conditional empty string check)
- ✅ Validations IMPLEMENTED in variables.tf (N/A - Resource ID validation skipped per executor.md)
- ✅ TODO comment added to original field (N/A - not a sensitive field)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md (none - no work deferred)
- ✅ Deferred work from following.md (none - no work was deferred to this task)
- ✅ Critical review (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof (completed above)
- ✅ Proof created
- ✅ `track.md` ready to update to Pending for check
- ✅ Self-Review: Only Task #90 content added, no other task content included

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent  
**Date:** 2025-12-09  
**Task:** #90 - os_disk.disk_encryption_set_id

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew correctly implemented with stable key pattern `{ value = ... }` in `replace_triggers_external_values` (line 101)

✅ **Stable Keys:** Key `os_disk_disk_encryption_set_id` always present in `replace_triggers_external_values`, returns `""` when parent null

✅ **Shared Path Merge:** No violations - `managedDisk` appears once with nested merge for children (line 478)

✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, assigned before CreateOrUpdateThenPoll)

✅ **Type Conversion:** Direct string assignment, no conversion needed

✅ **Null Handling:** Correctly replicates provider logic - checks both `!= null` AND `!= ""` before creating nested object (line 482)

✅ **Validations:** Resource ID validation correctly skipped per executor.md rule: "Skip ONLY Azure Resource ID format validations"

✅ **Assignment Path:** Verified path matches: `properties.virtualMachineProfile.storageProfile.osDisk.managedDisk.diskEncryptionSet.id`

✅ **Deferred Work Completion:** No deferred work for this task (verified in following.md)

✅ **Deferred Work Recording:** No deferrals made (no cross-field dependencies)

✅ **Edge Cases:** Comprehensive analysis completed - null semantics, empty string handling, boundary conditions, idempotency, and safe references all verified

✅ **Sensitive Field Placement:** Correctly in `body` (not Sensitive/WriteOnly field)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:

1. **Exact conditional logic:** Both `!= null` AND `!= ""` checks match provider's Go code
2. **Correct nesting:** `diskEncryptionSet.id` structure matches Azure API schema
3. **ForceNew handling:** Wrapped value pattern with stable key per executor.md Mode 1
4. **No deviations:** Zero simplifications or "safer alternatives" - pure replication

**Status:** APPROVED ✅

---
