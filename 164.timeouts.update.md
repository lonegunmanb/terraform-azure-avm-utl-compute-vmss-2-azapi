# Task #164: timeouts.update - Timeout Default Implementation

## Summary
Updated the `update` timeout field default value to "60m" based on provider schema. This is a Terraform provider meta-argument that controls operation timeout duration, not an Azure API property.

## Shadow Module Code

**No shadow module implementation required.** The `timeouts` block is a Terraform provider meta-argument handled directly by the parent module's `azapi_resource` block, not in shadow module locals.

```hcl
# NO CHANGES to migrate_main.tf, migrate_variables.tf, migrate_validation.tf
# 
# The parent module will use the timeout like this:
# resource "azapi_resource" "this" {
#   # ... other fields ...
#   
#   timeouts {
#     create = var.timeouts != null ? var.timeouts.create : null
#     delete = var.timeouts != null ? var.timeouts.delete : null
#     read   = var.timeouts != null ? var.timeouts.read : null
#     update = var.timeouts != null ? var.timeouts.update : null  # <- Uses default "60m" from variable
#   }
# }
```

## Create Phase Verification

**Pattern:** Meta-argument (Terraform provider-level, not Azure API)

From `resourceOrchestratedVirtualMachineScaleSet()`:

```go
Timeouts: &pluginsdk.ResourceTimeout{
    Create: pluginsdk.DefaultTimeout(60 * time.Minute),
    Read:   pluginsdk.DefaultTimeout(5 * time.Minute),
    Update: pluginsdk.DefaultTimeout(60 * time.Minute),
    Delete: pluginsdk.DefaultTimeout(60 * time.Minute),
},
```

**Evidence:**
- Default value for `Update`: **60 minutes** (`60 * time.Minute`)
- This is a resource-level meta-argument controlling how long Terraform waits for Azure API operations
- Not part of Azure API request body

**Decision:** No shadow module implementation needed. Updated variable default value in `variables.tf`.

## Assignment Path Verification

**N/A** - The `timeouts` block is not part of the Azure API request/response body. It's a Terraform provider construct that controls operation timeout behavior.

## Provider Schema

From provider source code (`resource_orchestrated_virtual_machine_scale_set.go`):

```go
Schema: map[string]*pluginsdk.Schema{
    // ... other fields ...
    
    Timeouts: &pluginsdk.ResourceTimeout{
        Create: pluginsdk.DefaultTimeout(60 * time.Minute),
        Read:   pluginsdk.DefaultTimeout(5 * time.Minute),
        Update: pluginsdk.DefaultTimeout(60 * time.Minute),
        Delete: pluginsdk.DefaultTimeout(60 * time.Minute),
    },
}
```

**Field details:**
- **Type:** `string` (Go duration format, e.g., "60m", "1h30m")
- **Optional:** Yes
- **Default:** `60 * time.Minute` = "60m"

## Azure API Schema

**N/A** - Timeouts are not part of the Azure REST API schema. They are Terraform provider meta-arguments.

## Hidden Fields

None - this is a Terraform provider meta-argument with no Azure API correspondence.

## Mapping

**N/A** - No property name mapping required as this doesn't map to Azure API.

## Special Handling

### Implementation Location

Per `timeouts.md` instructions:

1. **Updated `variables.tf`:**
   - Changed `update = optional(string)` to `update = optional(string, "60m")`
   - Updated description to reflect the 60 minutes default
   - Location: lines 1546-1560

2. **Added output in `migrate_outputs.tf`:**
   - Added `output "timeouts" { value = var.timeouts }` to allow parent module to access the timeouts configuration
   - This output enables parent module to pass timeouts directly to `azapi_resource` block

3. **No shadow module local changes:**
   - Timeouts are NOT added to `local.body`, `local.sensitive_body`, or any other shadow module computation
   - Parent module applies timeouts directly to its `azapi_resource` block

### Format

Timeout values use Go duration string format:
- "60m" = 60 minutes
- "1h" = 1 hour
- "1h30m" = 1 hour 30 minutes
- "90m" = 90 minutes

### Validation

Type validation is automatically enforced by Terraform's type system:
- Must be a string in Go duration format
- Terraform will validate the format at plan time
- Invalid formats (e.g., "60", "one hour") will cause validation errors

## Deferred Work Completion

**No deferred work** found in `following.md` for this task.

## Edge Case Analysis

1. **Null semantics:** 
   - If `timeouts` variable is null → Terraform uses provider default (60m for update)
   - If `timeouts.update` is null → Terraform uses provider default (60m)
   - Empty `timeouts {}` block → All fields use provider defaults

2. **Boundary conditions:**
   - Very short timeouts (e.g., "1m") may cause operations to timeout prematurely
   - Very long timeouts (e.g., "24h") are valid but may mask underlying issues
   - Zero or negative durations are invalid and will cause Terraform errors

3. **Idempotency:**
   - Timeout values don't affect resource state or API calls
   - Changing timeout values doesn't trigger resource recreation
   - Same timeout value always produces same wait behavior

4. **Safe references:**
   - Variable access is always safe: `var.timeouts.update`
   - Optional with default ensures non-null value when accessed through the type
   - Parent module safely passes through: `var.timeouts != null ? var.timeouts.update : null`

## Checklist

- ✅ Property in correct location (variables.tf - default value updated)
- ✅ ForceNew handling (N/A - meta-argument doesn't affect resource replacement)
- ✅ All logic exactly replicated (Default matches provider: 60m)
- ✅ Validations implemented (Type validation via Terraform type system)
- ✅ Hidden fields checked (None - meta-argument)
- ✅ Deferred work recorded (N/A)
- ✅ Deferred work completed (None for this task)
- ✅ Critical review completed
- ✅ Edge case analysis included
- ✅ Proof created
- ✅ track.md will be updated
- ✅ Self-review: Only updated timeout default value and added output, no inappropriate additions
- ✅ Output added to migrate_outputs.tf (required per timeouts.md section 4)

## Critical Notes

**Why no implementation in shadow module:**

1. The `timeouts` block is NOT part of the Azure REST API request/response
2. Shadow modules transform Terraform config → Azure API calls
3. Timeouts control Terraform's behavior when WAITING for API operations
4. The `azapi_resource` in the PARENT module (not shadow module) handles timeouts
5. The shadow module's responsibility ends at providing correct `body`, `sensitive_body`, etc.

**Changes made:**

1. **variables.tf (line 1551):** Changed `update = optional(string)` to `update = optional(string, "60m")`
2. **variables.tf (line 1558):** Description already correct: "Defaults to 60 minutes"
3. **migrate_outputs.tf:** Added `output "timeouts" { value = var.timeouts }` to enable parent module access

**Parent module usage:**

The parent module that instantiates this shadow module will access the timeout through the output and pass it directly to its `azapi_resource` block's `timeouts` argument:

```hcl
module "migrate" {
  source = "./migrate"
  # ... other variables ...
  timeouts = var.orchestrated_virtual_machine_scale_set_timeouts
}

resource "azapi_resource" "this" {
  # ... other fields ...
  
  timeouts {
    create = module.migrate.timeouts != null ? module.migrate.timeouts.create : null
    delete = module.migrate.timeouts != null ? module.migrate.timeouts.delete : null
    read   = module.migrate.timeouts != null ? module.migrate.timeouts.read : null
    update = module.migrate.timeouts != null ? module.migrate.timeouts.update : null
  }
}
```

## Compliance with timeouts.md

✅ **Step 1: Read Default Timeout Values** - Extracted from provider schema: `Update: pluginsdk.DefaultTimeout(60 * time.Minute)`

✅ **Step 2: Update Variable Defaults** - Changed `update = optional(string)` to `update = optional(string, "60m")` in variables.tf line 1551

✅ **Step 3: Update Variable Description** - Description already correct at line 1558: "Defaults to 60 minutes"

✅ **Step 4: Shadow Module Implementation** - Correctly identified as N/A; added required output to migrate_outputs.tf

✅ **Step 5: Proof Document** - Created with all required sections and evidence

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-12
**Task:** #164 - timeouts.update

### Validation Results

✅ **Timeout Default Value:** Correctly extracted from provider schema (`60 * time.Minute`) and converted to string format ("60m")
✅ **Variable Implementation:** Default value properly set in `variables.tf` line 1551: `update = optional(string, "60m")`
✅ **Variable Description:** Correctly states "Defaults to 60 minutes" at line 1558
✅ **Output Configuration:** Required `output "timeouts"` exists in `migrate_outputs.tf` (lines 33-35)
✅ **Shadow Module:** Correctly identified as N/A - no changes to migrate_main.tf, migrate_variables.tf, or migrate_validation.tf
✅ **Proof Document:** Complete with all required sections and proper evidence
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Compliance with timeouts.md:** All 5 steps correctly followed
✅ **Edge Cases:** Properly analyzed (null semantics, boundary conditions, idempotency, safe references)

### Compliance Statement

This implementation EXACTLY follows the rules specified in `executor.md` and the special override document `timeouts.md`. The executor correctly:

1. Queried the provider schema and extracted the default timeout value (60 minutes)
2. Converted the Go duration to Terraform string format ("60m")
3. Updated the variable default using `optional(string, "60m")` syntax
4. Ensured the variable description matches the default value
5. Added the required output to migrate_outputs.tf
6. Correctly identified that timeouts are Terraform provider meta-arguments, not Azure API properties
7. Did not attempt to implement timeouts in shadow module locals (correct behavior)

No deviations, simplifications, or issues found.

**Status:** APPROVED ✅

---
